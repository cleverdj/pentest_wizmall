<?php
/* 
제작자 : 폰돌
제작자 URL : http://www.shop-wiz.com
제작자 Email : master@shop-wiz.com
Free Distributer 

*** Updating List ***
*/
include "./lib/cfg.common.php";

include "./lib/class.common.php";
$common = new common();
$cfg["member"] = $common->getLogininfo();//로그인 정보를 가져옮

if(!$_COOKIE[MEMBER_ID]) {
ECHO "
<script language=javascript>
window.alert('\\n\\n정회원만이 이용하실 수 있습니다. \\n\\n 회원가입후 이용해 주세요');
location.replace('./wizmember.php?query=login');
</script>";
exit;
}
$MicroTsmp = split(" ",microtime());
$START_TIME = $MicroTsmp[0]+$MicroTsmp[1];

if($SAVE_VALUE == "INPUT"){// 장바구니담기
$no=$sort3;
        /*******************************************************************************
        CART파일의 생성시간을 구해서 2시간(mktime()기준 - 7200)이 경과된 경우 자동삭제..
        *******************************************************************************/
        $LOG_DIR = opendir("./wizmember_tmp/mall_buyers");
//        while($LOG_FILE = readdir($LOG_DIR) && $LOG_FILE !="." && $LOG_FILE !="..") {
while($LOG_FILE = readdir($LOG_DIR)) {
	if($LOG_FILE !="." && $LOG_FILE !=".."){
	    if(file_exists("./wizmember_tmp/mall_buyers/$LOG_FILE") && mktime() - filemtime("./wizmember_tmp/mall_buyers/$LOG_FILE") > 7200) {
                        unlink("./wizmember_tmp/mall_buyers/$LOG_FILE");
        }
	} //if($LOG_FILE !="." && $LOG_FILE !="..") 닫음
}
        closedir($LOG_DIR);
        if (!$_COOKIE[CART_CODE_ESTIM] || !file_exists("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]")) {
                $CART_CODE_ESTIM = substr(str_replace(".", "", $START_TIME), 0, 13); // 장바구니고유코드
                setcookie("CART_CODE_ESTIM","$CART_CODE_ESTIM",0,"/");
                $fp = fopen("./wizmember_tmp/mall_buyers/$CART_CODE_ESTIM", "w");
               fwrite($fp, "$no|$BUYNUM|$Option1|$Option4|\n");
                fclose($fp);
        }
        else {
                if (file_exists("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]")){
                $Cart_Data = file("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]");
                $fp = fopen("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]", "w");
                while ($Cart_Data_f = each($Cart_Data)) {
                $C_dat = split("\|", chop($Cart_Data_f[1]));
                        if("$C_dat[0]-$C_dat[2]-$C_dat[3]" == "$no-$Option1-$Option4") {
                                $BNUM = $BUYNUM + $C_dat[1];
                                fwrite($fp, "$no|$BNUM|$Option1|$Option4|\n");
                       }
                        else {
                                fwrite($fp, chop($Cart_Data_f[1])."\n");
                        }
                }
                fclose($fp);
                }
                if (!$BNUM) {
                $fp = fopen("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]", "a");
                fwrite($fp, "$no|$BUYNUM|$Option1|$Option4|\n");
                fclose($fp);
                }
        }
        ECHO "<HTML><META http-equiv='refresh' content='0;url=wizcalcu.php'></HTML>";

        exit;

}



if ( $query == 'delete') { // 장바구니 택일삭제
        if (file_exists("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]")){
        $Cart_Data = file("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]");
        $fp = fopen("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]", "w");
        while ($Cart_Data_f = each($Cart_Data)) {
        $C_dat = split("\|", chop($Cart_Data_f[1]));
                if("$C_dat[0]-$C_dat[2]-$C_dat[3]" != "$value") {
                        fwrite($fp, chop($Cart_Data_f[1])."\n");
                }
        }
        fclose($fp);
        }
        ECHO "<HTML><META http-equiv='refresh' content='0;url=wizcalcu.php'></HTML>";
        exit;
}

if ( $query == 'modify') { // 장바구니 택일수정
        if (file_exists("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]")){
        $Cart_Data = file("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]");
        $fp = fopen("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]", "w");
        while ($Cart_Data_f = each($Cart_Data)) {
        $C_dat = split("\|", chop($Cart_Data_f[1]));
                if("$C_dat[0]-$C_dat[2]-$C_dat[3]" == "$value") {
                        fwrite($fp, "$C_dat[0]|$BUYNUM|$C_dat[2]|$C_dat[3]|\n");
                }
                else {
                        fwrite($fp, chop($Cart_Data_f[1])."\n");
                }
        }
        fclose($fp);
        }
        ECHO "<HTML><META http-equiv='refresh' content='0;url=wizcalcu.php'></HTML>";
        exit;
}
if ( $query == 'trash') { // 장바구니 비우기
        if (file_exists("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]")){
        unlink("./wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE_ESTIM]");
        setcookie("CART_CODE_ESTIM","",0,"/");
        }
        ECHO "<HTML><META http-equiv='refresh' content='0;url=wizcalcu.php'></HTML>";
        exit;

}

?>
<?
$EstimSkin = "default";
include ("./config/cfg.core.php");
include ("./config/db_info.php");
include "./lib/class.database.php";
$dbcon	= new database($cfg["sql"]);
if(file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php");
if ($query == 'cart') {
include ("./skinwiz/estimate/$EstimSkin/cart_save.php");
}
?>
<table width="100%" border="0" cellpadding="0" cellspacing="0">
  <tr> 
    <td> 
      <!-- top menu start -->
      <?
if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php");
?>
      <!-- top menu end -->
    </td>
  </tr>
  <tr> 
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td width="170" valign="top"> 
            <!-- left menu start -->
            <?
if ($cfg["skin"]["MenuSkin_Inc"] == 'checked') include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_left.php");
?>
            <!-- left menu end -->
          </td>
          <td width="10">&nbsp;</td>
          <td valign="top"><table width="2" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td height="1"> </td>
                    </tr>
                  </table>
            <table width="720" border="0" cellspacing="0" cellpadding="0">
              <tr> 
                <td> 
                  <!-- main menu start -->
                  <?
if($query == "estim_view")include ("./skinwiz/estimate/$EstimSkin/estim_view.php");
else include ("./skinwiz/estimate/$EstimSkin/default.php");
?>
                  <!-- main menu end -->
                </td>
              </tr>
            </table> </td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td> 
      <!-- bottom menu start -->
      <?
if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php");
?>
      <!-- bottom menu end -->
    </td>
  </tr>
</table>
<?
include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_close.php");
?>