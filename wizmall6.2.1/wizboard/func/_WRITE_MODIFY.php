<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/
?>
<?
set_time_limit (0);

if(!$CATEGORY) $CATEGORY = 0;

if(!$NAME) $NAME	=  $cfg["member"]["mname"];
$NAME				= addslashes($NAME);

/* DB에 저장될 DATA를 한 번 처리를 한다. */
include "./wizboard/func/FILTERING_Word.php";
if(!$SDATE && $SDATE != 0) $SDATE = time();
$CONTENTS		= $common->puttrimstr($CONTENTS, $TxtType);
$SUB_CONTENTS1	= $common->puttrimstr($SUB_CONTENTS1, $TxtType);
$SUB_CONTENTS2	= $common->puttrimstr($SUB_CONTENTS2, $TxtType);
$NAME			= addslashes($NAME);
$SUBJECT		= addslashes($SUBJECT);
$CONTENTS		= addslashes($CONTENTS);
		
/*** ADMIN 패스워드 가져오기 ******/
$ADMIN_STR = "SELECT Pass FROM wizTable_Main WHERE BID='$BID' and GID='$GID'";
$ADMIN_QRY = mysql_query($ADMIN_STR);
$ADMINPWD = mysql_fetch_array($ADMIN_QRY) or die(mysql_error());;

/*** 글 작성자 패스워드 및 업로딩 파일 가져오기 *****/
	$SQL_STR="SELECT ID, PASSWD, UPDIR1 FROM $BOARD_NAME WHERE UID='$UID'";
	$SQL_QRY=mysql_query($SQL_STR);
	$LIST=mysql_fetch_array($SQL_QRY);
//	$UPDIRF = split("\|", $LIST[UPDIR1]); /* 현재 업로딩 된 파일 가져오기 */
	$LIST[PASSWD]=trim($LIST[PASSWD]);
	if($PASSWD && $PASSWD != $LIST[PASSWD] && $PASSWD !=$ADMINPWD[Pass]) { // 비회원 게시판으로 패스워드를 입력하는 폼이라면 입력된 패스워드를 상효 비교한다.
		$common->js_alert("글작성시 패스워드를 입력해주세요.");
	}else if (($_COOKIE[MODIFY] != $UID."_".$BID."_".$GID) ){ //회원전용폼으로 패스워드 입력란이 없으면 보드관리자가 아니고 super관리자가 아니면
//현재 로그인된 아이디와 글작성시 아이디를 비교하여 수정여부를 선택한다. 
		$common->js_alert("등록자본인만이 수정가능합니다.");
	}else{ //마지막 까지 update flow start 
	
		if($MultiFileValue){//다중파일 첨부로 넘어오는 경우
			$UPDIR1 = $MultiFileValue;
			$tmp = split("\|", $MultiFileValue);
			foreach($tmp as $key=>$value){
				if($value){
					copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
					unlink("./config/tmp_upload/".$value);
				}
			}
		}else{	
			// 파일 업로딩 시작 
			
			$common->upload_path		= "./config/wizboard/table/".$GID."/".$BID."/updir";
			$common->ProhibitExtention	= $ProhibitExtention;
			$common->uploadmode			= "update";
			$common->oldfilename		= $LIST["UPDIR1"];
			$common->delfile			= $file_del;
			//$option1 = $Filenamereserver;
			$common->uploadfile("file");
			
			if(is_array($common->returnfile)) foreach($common->returnfile as $key=>$value) $UPDIR1 = $value."|";
	 			
			// 파일 업로딩 끝 	
		}	
		// 파일 업로딩 끝 

		/* board DB에 처리된 값들을 INSERT 한다. */
		
		
		$QUERY_STR = "UPDATE $BOARD_NAME SET CATEGORY='$CATEGORY',NAME='$NAME',EMAIL='$EMAIL',URL='$URL',SUBJECT='$SUBJECT',SUB_TITLE1='$SUB_TITLE1',
		SUB_TITLE2='$SUB_TITLE2',CONTENTS='$CONTENTS',SUB_CONTENTS1='$SUB_CONTENTS1',SUB_CONTENTS2='$SUB_CONTENTS2',UPDIR1='$UPDIR1',SPARE1='$SPARE1',SDATE='$SDATE'
		
		WHERE UID='$UID'";
		
		$RESULT=mysql_query($QUERY_STR) or die(mysql_error());
		if($flag == "write_only") $tmode = "write";
		else $tmode = "";
		ECHO"<script>location.replace('./wizboard.php?BID=$BID&GID=$GID&mode=$tmode&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY_IN&mode=view&UID=$UID&cp=$cp&BOARD_NO=$BOARD_NO')</script>";
		exit;
	}
?>