<?
/* 
제작자 : 폰돌
제작자 URL : http://www.shop-wiz.com
제작자 Email : master@shop-wiz.com
Free Distributer 
*** Updating List ***
*/

include "../lib/cfg.common.php";

include("./admin_check.php");
include("../config/db_info.php");

include "../lib/class.database.php";
$dbcon		= new database($cfg["sql"]);

include "../lib/class.common.php";
$common		= new common();

include "../lib/class.board.php";
$board		= new board();
$board->get_object($dbcon, $common);

if(!$GID) $GID = "root";
if(!$m_gid) $m_gid = "root";//예약그룹, root:게시판용(일반, 쇼핑몰, 아바타용), intra:(인트라용, 웹메일용), cafe:카페용
if(!strcmp($query,"make_grp")){  //그룹만들기
	$sqlstr = "select max(GrpCode) from wizTable_Grp";
	$result = $dbcon->get_one($sqlstr);
	$GrpCode = $result ? $result+1:1;
	$Mdate = time();
	
	$sqlstr = "insert into wizTable_Grp (GID, AdminName, Pass, Grade, GrpName, GrpCode, Mdate)
	VALUES('$GID','$AdminName','$Pass','$Grade','$GrpName','$GrpCode','$Mdate')"; 
	$dbcon->_query($sqlstr);
	$common->js_alert("새그룹 $GrpName 이 생성되었습니다.", $PHP_SELF);
}else if(!strcmp($query,"change_grp_name")){ //그룹이름 변경하기
	$sqlstr = "update wizTable_Grp set GrpName = '$NewGrpName' where GrpCode = '$Grp_code'";
	$dbcon->_query($sqlstr);
	$common->js_alert("그룹이름이 변경되었습니다.", "$PHP_SELF?Grp=$Grp_code");
}else if(!strcmp($query,"delete_grp_name")){ //그룹 삭제 하기 
/* 현재 그룹에 속한 테이블의 유무를 책크후 테이블이 있으면 back 시킨다. */
	$sqlstr = "select count(UID) from wizTable_Main where Grp = '$Grp_code'";
	$result = $dbcon->get_one($sqlstr);
		if($result) $common->js_alert("그룹에 속한 테이블이 있습니다. \\n\\n 먼저 테이블을 삭제 후 작업을 진행해 주세요 \\n\\n", "$PHP_SELF?GID=$GID&Grp=$Grp_code");

	/* wizTable_Grp 로 부터 그룹명을 삭제한다. */
	$sqlstr = "delete from wizTable_Grp where GrpCode = '$Grp_code' and GID='$GID'";
	//echo $sqlstr;
	$dbcon->_query($sqlstr);
	$common->js_alert("선택하신 그룹이 삭제 되었습니다.", "$PHP_SELF?GID=$GID&Grp=$Grp_code");
}

if(!strcmp($smode,"maketable")){## 테이블 생성
//echo "$m_bid, $m_gid, $TABLE_DES, $AdminName, $Pass, $group, $SetupPath, $SourcePath,$default_option";
	$board->createTable($m_bid, $m_gid, $TABLE_DES, $AdminName, $Pass, $group);
	
}else if(!strcmp($smode,"ChangeIt")){/* 테이블설명 및 패스워드 변경 */
	$sqlstr = "UPDATE wizTable_Main SET BoardDes ='$BoardDes', AdminName='$AdminName', Pass='$Pass' WHERE BID ='$BID' and GID='$GID'";
	$dbcon->_query($sqlstr);
}
?>
<html>
<head>
<title>관리자님을 환영합니다.[위즈보드 관리자모드]</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<script language=javascript src="../js/wizmall.js"></script>
<SCRIPT>
<!--
function DeleteThisTable(BID,GID,cp, ListCount){
con =  confirm("정말로 삭제하시겠습니까? \n\n 삭제된 테이블은 복구불가능합니다.")
if (con==true){
	window.open("./tabledelete.php?BID="+BID+"&GID="+GID+"&cp="+cp+"&ListCount="+ListCount+"&mode=ok","","scrollbars=no, toolbar=no, width=340, height=150, top=220, left=350");
}
			

}

function really(){
	con = confirm("그룹을 삭제합니다. \n\n 그룹삭제전 테이블을 먼저 삭제하셔야 합니다.. \n\n 그룹을 삭제하시겠습니까?")
	if (con==true) return true;
	else return false;
}

function downforExel(){
	location.href="downforexcel.php?DownForExel=yes";
}

function gotoURL(url){
	window.open(url,'','')
}
//-->
</SCRIPT>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td width="200" valign="top">&nbsp;</td>
    <td width="10" valign="top"></td>
    <td align="right" valign="top"><span class="style1"><a href="../" target="_blank">홈</a></span> | <a href="admin_log_out.php">로그아웃</a> </td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td width="200" valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td height="31" align="center" bgcolor="E0E4E8"><strong>그룹관리</strong></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <?		  
$sqlstr = "select count(1) from wizTable_Main where Grp != '0'";
$tcount = $dbcon->get_one($sqlstr);
?>
              <tr>
                <td>&nbsp; -> <a href="<?=$PHP_SELF?>?ListCount=<?=$ListCount?>"> <font color="#3366CC"> 전체보드리스트(
                  <?=number_format($tcount)?>
                  ) </font></a></td>
              </tr>
              <?
$sqlstr = "select GrpName, GrpCode from wizTable_Grp order by GrpName asc";
$result = $dbcon->_query($sqlstr);
$cnt=0;
while($list = $dbcon->_fetch_array($result)):
	$count = $dbcon->get_one("select count(*) from wizTable_Main where Grp = '".$list[GrpCode]."'");
?>
              <tr>
                <td>&nbsp; -> <a href="<?=$PHP_SELF?>?Grp=<?=$list[GrpCode]?>&ListCount=<?=$ListCount?>"> <font color="#3366CC">
                  <?if($Grp == $list[GrpCode]) echo "<b>";?>
                  <?=$list[GrpName]?>
                  (
                  <?=number_format($count)?>
                  )
                  <?if($Grp == $list[GrpCode]) echo "</b>";?>
                  </font></a></td>
              </tr>
              <?
$cnt++;
endwhile;
?>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <form name="make_grp" metbod=post>
                <input type="hidden" name="query" value="make_grp">
                <tr>
                  <td><input name="GrpName" type="text" size="10"></td>
                  <td align="right"><button type="submit" name="btn" title="새 그룹생성">새 그룹생성</button></td>
                </tr>
              </form>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <form name="make_grp" metbod=post>
                <input type="hidden" name="query" value="change_grp_name">
                <input type="hidden" name="Grp_code" value="<?=$Grp?>">
                <tr>
                  <td><input name="NewGrpName" type="text" size="10"></td>
                  <td align="right"><button type="submit" name="btn" onClick="DeleteThisTable('<?=$BOARD_LIST[BID];?>','<?=$BOARD_LIST[GID];?>','<?=$cp;?>','<?=$ListCount?>')" title="그룹이름변경">그룹이름변경</button></td>
                </tr>
              </form>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <form name="delete_grp" metbod=post onSubmit="return really()">
                <input type="hidden" name="query" value="delete_grp_name">
                <input type="hidden" name="Grp_code" value="<?=$Grp?>">
                <input type="hidden" name="GID" value="<?=$GID?>">
                <tr>
                  <td>선택된 그룹을 <br>
                    삭제합니다.</td>
                  <td align="right"><button type="submit" name="btn" onClick="DeleteThisTable('<?=$BOARD_LIST[BID];?>','<?=$BOARD_LIST[GID];?>','<?=$cp;?>','<?=$ListCount?>')" title="그룹삭제">그룹삭제</button></td>
                </tr>
              </form>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
      </table></td>
    <td width="10" valign="top"></td>
    <td valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td><table class="table_main">
              <FORM action="<?=$PHP_SELF?>" method="post" name="CreateForm">
                <input type="hidden" name="smode" value="maketable">
                <input type="hidden" name="Grp_code" value="<?=$Grp?>">
                <input type="hidden" name="ListCount" value="<?=$ListCount?>">
                <tr bgcolor="#FFFFFF">
                  <td width="79" align="center" bgcolor="E0E4E8">테이블이름</td>
                  <td width="202"><input type="text" name="m_bid" onKeyUp="javascript:onlyAlphaNum(this);">
                    <br>
                    영/숫자만 입력</td>
                  <td width="77" align="center" bgcolor="E0E4E8"> 테이블설명</td>
                  <td width="202"><input type="text" name="TABLE_DES">
                  </td>
                  <td width="61" align="center" bgcolor="E0E4E8">패스워드</td>
                  <td width="359"><input type="text" name="Pass">
                  </td>
                  <td align="center" width="105"><button type="submit" name="btn" title="생성">생성</button></td>
                </tr>
              </FORM>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <form action="<?=$PHP_SELF?>" name="ListCountForm" method="get">
                <input type="hidden" name="Grp" value="<?=$Grp?>">
                <tr>
                  <td>리스트수:
                    <select name="ListCount" onChange="submit()">
                      <option value="10" <? if($ListCount == 10) echo "selected";?>>10</option>
                      <option value="15" <? if($ListCount == 15) echo "selected";?>>15</option>
                      <option value="20" <? if($ListCount == 20) echo "selected";?>>20</option>
                      <option value="30" <? if($ListCount == 30) echo "selected";?>>30</option>
                      <option value="50" <? if($ListCount == 50) echo "selected";?>>50</option>
                      <option value="100" <? if($ListCount == 100) echo "selected";?>>100</option>
                    </select>
                    <select name="stitle">
                      <option value="BoardDes" <? if($stitle =="BoardDesd") echo "selected";?>>테이블설명</option>
                      <option value="BID" <? if($stitle =="BID") echo "selected";?>>테이블명</option>
                    </select>
                    <input type="text" name="keyword" value="<?=$keyword?>">
                    <input type="submit" name="Submit3" value="검색"></td>
                </tr>
              </form>
            </table></td>
        </tr>
        <tr>
          <td><?
if($Grp) $whereis = "WHERE Grade != 'A' AND Grp='$Grp'";
else $whereis = "WHERE Grade != 'A' ";
if($stitle && $keyword) $whereis .= "and $stitle like '%$keyword%'";
$TargetBoard = "wizTable_Main";
/* 총 갯수 구하기 */
$TOTAL_STR = "SELECT count(UID) FROM $TargetBoard $whereis";
$TOTAL = $dbcon->get_one($TOTAL_STR);
if(!isset($ListCount) || !$ListCount) $ListCount = 10;
$ListNo=$ListCount; /* 페이지당 출력 리스트 수 */
$PageNo=10; /* 페이지 밑의 출력 수 */
if(empty($CP) || $CP <= 0) $CP = 1;
?>
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td align="right"><button name="btn" onClick="downforExel();" title="엑셀출력">엑셀출력</button>
                     </td>
              </tr>
            </table>
            <table class="table_main">
              <tr align="center" bgcolor="E0E4E8">
                <td width="0" bgcolor="E0E4E8">테이블명</td>
                <td width="0" bgcolor="#B9C2CC">테이블설명</td>
                <td width="0" bgcolor="E0E4E8">패스워드<br>
                  ( 게시판 관리시 사용)</td>
                <td width="0" bgcolor="#B9C2CC">경로</td>
                <td width="0">적용스킨</td>
                <td width="0" bgcolor="#B9C2CC">수정</td>
                <td width="0">옵션</td>
                <td width="0" bgcolor="#B9C2CC">&nbsp;</td>
                <td width="0">&nbsp;</td>
                <td width="0" bgcolor="#B9C2CC">&nbsp;</td>
              </tr>
              <? 

$START_NO = ($CP - 1) * $ListNo;
$BOARD_NO=$TOTAL-($ListNo*($CP-1));

$orderby = "BID@ASC";
$qry = $dbcon->get_select('*',$TargetBoard,$whereis, $orderby, $START_NO, $ListNo);	
$cnt=0;
while( $BOARD_LIST = $dbcon->_fetch_array($qry)) :
include "../config/wizboard/table/$BOARD_LIST[GID]/$BOARD_LIST[BID]/config.php";
?>
              <tr bgcolor="#FFFFFF"onmouseover="style.background = '#E0E4E8'" onMouseOut="style.background = '#FFFFFF'">
                <FORM ACTION=<?=$PHP_SELF?>>
                  <input type="hidden" name="BID" value="<?=$BOARD_LIST[BID]?>">
                  <input type="hidden" name="GID" value="<?=$BOARD_LIST[GID]?>">
                  <input type="hidden" name="smode" value="ChangeIt">
                  <input type="hidden" name="Grp" value="<?=$Grp?>">
                  <input type="hidden" name="CP" value="<?=$CP?>">
                  <input type="hidden" name="ListCount" value="<?=$ListCount?>">
                  <input type="hidden" name="stitle" value="<?=$stitle?>">
                  <input type="hidden" name="keyword" value="<?=$keyword?>">
                  <td height="28" align="center"><?=$BOARD_LIST[BID]?>
                  </td>
                  <td height="28" align="center"><input type="text" name="BoardDes" value="<?=$BOARD_LIST[BoardDes]?>" size="15">
                  </td>
                  <td height="28" align="center"><input type="text" name="Pass" value="<?=$BOARD_LIST[Pass]?>" size="15" maxlength="15">
                  </td>
                  <td height="28">wizboard.php?BID=<? echo $BOARD_LIST[BID]; ?>&GID=<? echo $BOARD_LIST[GID]; ?></td>
                  <td height="28" align="center"><?=$cfg["wizboard"]["BOARD_SKIN_TYPE"]?>
                  </td>
                  <td height="28" align="center"><button type="submit" name="chpwd">변경</button>
                    <br>
                  </td>
                  <td height="28" align="center"><button name="option" onClick="wizwindow('./admin1.php?BID=<?=$BOARD_LIST[BID]?>&GID=<?=$BOARD_LIST[GID]?>','옵션보기','scrollbars=yes,resizable=yes,width=630,height=500')"
      title="옵션수정"><font color="#2A7F55">옵션수정</font></button></td>
                  <td height="28" align="center"><button name="option" onClick="javascript:location.href='<?=${PHP_SELF}?>?AdminBID=<?=$BOARD_LIST[BID]?>&AdminGID=<?=$BOARD_LIST[GID]?>&CP=<?=$CP?>&Grp=<?=$Grp?>&ListCount=<?=$ListCount?>&stitle=<?=$stitle?>&keyword=<?=$keyword?>'"
      title="게시물관리">게시물관리</button></td>
                  <td height="28" align="center"><button name="btn" onClick="gotoURL('../wizboard.php?BID=<?=$BOARD_LIST[BID]?>&GID=<?=$BOARD_LIST[GID]?>');" title="옵션 처리">보기</button></td>
                  <td height="28" align="center"><button name="btn" onClick="DeleteThisTable('<?=$BOARD_LIST[BID];?>','<?=$BOARD_LIST[GID];?>','<?=$cp;?>','<?=$ListCount?>')" title="옵션 처리">삭제</button></td>
                </form>
              </tr>
              <?
endwhile;
?>
            </table>
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td align="center"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$page_arg1 = $PHP_SELF."?BID=$BID&Grp=$Grp&stitle=$stitle&keyword=".urlencode($keyword)."&ListCount=$ListCount";
$page_arg2 = array("listno"=>$ListNo,"pageno"=>$PageNo,"cp"=>$CP,"total"=>$TOTAL); 
//$page_arg3 = array("pre"=>"./img/pre.gif","next"=>"./img/next.gif");
echo $common->paging($page_arg1,$page_arg2,$page_arg3);
?>
                </td>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td><?
if($AdminBID):
	switch ( $mode )
	{
        case ( "list" ) :
        include ("./boardlist.php");
        break;
        case ( "view" ) :
        include ("./boardview.php");
        break;
        case ( "write" ) :
        include ("./boardwrite.php");
        break;
        case ( "reply" ) :
        include ("./boardwrite.php");
        break;		
        case ( "modify" ) :
        include ("./boardwrite.php");
        break;
        case ( "delete" ) :
       include ("./boarddelete.php");
       break;
        default :
      include ("./boardlist.php");
	}
endif;
?>
                </td>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
      </table></td>
  </tr>
</table>
<br>
</body>
</html>
