<?php
class database
{
	var $dbcon		= 0;

	var $query_id	= 0;
	var $row_array	= array();
	var $row		= 1;

	##  blob 
	var $blob_id = 0;
	var $blob_mode = -1;
	var $byte_text;

	function database($cfg){
		$this->dbcon = !$this->dbcon ? mysql_connect($cfg["host"], $cfg["id"], $cfg["pwd"]): "";
		mysql_select_db($cfg["dbname"], $this->dbcon);
		if ( !$this->dbcon ) {echo "sql 데이터 베이스에 연결할 수 없습니다."; exit;}
		//mysql_query("set names euckr"); 나중에 변수 받아 자동으로 처리되게 조정
		//mysql_query("set names utf-8");
	}
	

########## database 관련 에러문 출력	
	function alert($msg) {
		printf("<b>database error:</b> %s<br>\n", $msg);
		exit;
	}
	
	function error($msg, $flag=TRUE) {##플래그 내용은 _query 참조
		echo "<br> ------------------------------ <br>";
		echo "Error : ".mysql_error()."<br>";
		echo "OutPut Message : ".$msg;
		echo "<br> ------------------------------ <br>";
		if ($flag) exit;
	}

	function print_error($header = "None haeder"){
		printf("<b>%s : %s:%s <br>\n", $header, $this->errno, $this->alert);
	}


	function check_error($result_id) {
		if (!strcmp($result_id, " "))	{ 		// Found error
			$this->alert = mysql_error($result_id);
			return 0;
		}
		else {        				// Not found error
			$this->alert = " ";
			return 1;
		}
	}

		

########## database 관련 기본 명령 재 정의	
	function _query($str, $flag=TRUE){##
	##플래그 값 TRUE : 에러가 존재시 멈춤, FALSE : 에러존재시 계속진행(롤백관련)
		if(!$str) $this->error("string 이 존재 하지 않습니다.", $flag);
		if(is_numeric($flag)){
			if($flag == 1) echo $str;
			if($flag == 2){ echo $str;exit;}
		}
		if($flag == FALSE){
			$result = mysql_query($str, $this->dbcon);//에러 무시하고 바로 진행
		}else{
			$result = mysql_query($str, $this->dbcon) or $this->error($str, $flag);
		}

		$this->query_id = $result;
		return $result;
	}
/*
	function query($query_string, $type = 0) {
	$this->connect();
	
	if( $this->debug ) echo $query_string."<hr>";
	
	$this->query_id = mysql_query($query_string, $this->link_id);
	
	$this->row   = 1;
	if (!$this->query_id) {
	if($this->check_error($this->link_id)){
	$this->print_error("query() - 2");
	$this->alert("Invalid SQL: ".$query_string);
	}
	}

	*/
	//$this->query_id = mysql_query($query_string, $this->link_id);
	function _fetch_array($qry=null, $type=3){
		#type : MYSQL_ASSOC, MYSQL_NUM, MYSQL_BOTH;
		if(is_int($qry)){$type = $qry;$qry=null;}//현재 타입을 배고하여 _fetch_array(3) 이런식으로 넘어온 값들을 변환
		$qry = $qry ? $qry : $this->query_id;
		if(!$qry){ $this->error("query 결과값이 없습니다", $flag); exit;}
		return mysql_fetch_array($qry, $type);
	}
	
	function _fetch_assoc($result=null){
		$result = $result ? $result : $this->query_id;
		return mysql_fetch_assoc($result);
	}

	function _num_rows($result=null){
		$result = $result ? $result : $this->query_id;
		return mysql_num_rows($result);
	}

	function _affected_rows($result=null){
		$result = $result ? $result : $this->query_id;
		return msql_affected_rows($result);
	}

	function __num_rows($result=null){
		$result = $result ? $result : $this->query_id;
		return msql_num_rows($result);
	}

	function _data_seek($result=null, $cnt){
		$result = $result ? $result : $this->query_id;
		return @mysql_data_seek($result, $cnt);
	}

	function _insert_id(){
		return mysql_insert_id();
	}

	function _close(){
		mysql_close($this->dbcon);
	}

	function _drop_table($tablename){
		$sqlstr = "DROP TABLE IF EXISTS `$tablename`";
		$this->_query($sqlstr);
	}

	function _result($row, $cnt, $result=null){
		$result = $result ? $result : $this->query_id;
		return mysql_result($result, $row, $cnt);
	}

	function _free_result(){
		mysql_free_result();
	}

########## database 관련 간략 사용
	function get_rows( $type=3 ){## 사용하지 말것 이후 string으로 변경
		if($this->query_id > 0){
			$this->row_array = $this->_fetch_array($type);		
			if(!$this->check_error($this->link_id)) $this->print_error("next_record()");
			$stat = is_array($this->row_array);
			if (!$stat) {
				if($this->blob_id) $this->_free_result($this->query_id);
				$this->query_id = 0;
			}else return $this->row_array;
		}else return 0;
	}
	
	function get_row($str, $flag=TRUE){
		$this->_query($str, $flag);
		$list = $this->_fetch_array();
		return $list;
	}

	function get_one($str){
		$this->_query($str);
		$list = $this->_fetch_array();
		return $list[0];
	}




	function is_table($tablename){
		$this->_query("SHOW TABLES");
		while($list = $this->_fetch_array()):
			if ( strtolower( (string)$list[0] ) == strtolower( (string)$tablename ) ) return true;
		endwhile;
		return false;
	}



########## database 세부 사용

	function _getone($str){//<-- 위의 것으로 통일(함수 규칙을 위해)
		$this->_query($str);
		$list = $this->_fetch_array();
		return $list[0];
	}
	
	function get_count($select, $from, $where, $orderby){


	}
	
	function get_select($select, $from, $where, $orderby=null, $limit1=null, $limit2=null, $op=null){
		# $orderby 인자값 : 필드명@정렬 으로 전송, 혹은 field1 asc, field2 desc
		$tmp = split("\@", $orderby);
		if ($tmp[1]) $orderby = $tmp[0]." ".$tmp[1];
		$sqlstr = "select ".$select." from ".$from;
		if($where) $sqlstr .= " ".$where;
		if($orderby) $sqlstr .= " order by ".str_replace("order by", "", $orderby);
		if(is_int($limit1)) $sqlstr .= " limit ".$limit1;
		if($limit2) $sqlstr .= " ,".$limit2;
		if($op == 1) echo $sqlstr;//출력
		$result = $this->_query($sqlstr);
		return $result;		
	}
########## database 롤백관련
	function _rollback($flag=0){#롤백관련
		switch($flag){
			case 1:$str="commit"; $this->_rollback(3);break;
			case 2:$str="rollback";break;
			case 3:$str="set autocommit=1";break;
			default:$str="set autocommit=0";break;
		}
			
		/*switch($flag){
			case 1:$str="submit";break;
			case 2:$str="rollback";break;
			//case 3:$str="set autocommit=1";break;
			default:$str="begin";break;
		}*/
		$this->_query($str);
	}
	
	function _exe_rollback($arr){#롤백관련, $arr:배열
		$cnt = count($arr);
		foreach($arr as $val) if($val) $cnt--;
		return $cnt==0 ? $this->_rollback(1) : $this->_rollback(2) ;
	}
	
	function _rollbackMsg(){
		echo "table type : MYISAM : 불가 , InnoDB : 가능";
		echo " create table test (.............)type=BDB;";
	}

	
########## database 시스템 정보 관련
	function _get_system_info(){
		echo "<br>-------------------------------------<br>";
		echo "client_info:".mysql_get_client_info()."<br>"; 
		echo "host_info:".mysql_get_host_info()."<br>"; 
		echo "proto_info:".mysql_get_proto_info()."<br>"; 
		echo "server_info:".mysql_get_server_info()."<br>"; 
		echo "<br>-------------------------------------<br>";
	}
		
/*
	var $database = "";
	var $user     = "";
	var $password = "";
	var $hostname = "";
	
	var $link_id  = 0;
	var $query_id = 0;
	var $record   = array();
	var $row      = 1;
	
	var $errno    = 0;
	var $alert    = "";
	
	##  blob 
	var $blob_id = 0;
	var $blob_mode = -1;
	var $byte_text;
	function debug( $arg ) {
		$this->debug = $arg;
	}
	

	

	
	// 1 is using scroll cursor
	function query($query_string, $type = 0) {
	$this->connect();
	
	if( $this->debug ) echo $query_string."<hr>";
	
	$this->query_id = mysql_query($query_string, $this->link_id);
	
	$this->row   = 1;
	if (!$this->query_id) {
	if($this->check_error($this->link_id)){
	$this->print_error("query() - 2");
	$this->alert("Invalid SQL: ".$query_string);
	}
	}
	
	
	return $this->query_id;
	}
	
	function next_record( $type=3 ){
		if($this->query_id > 0){
			$this->record = mysql_fetch_array($this->query_id,$type);
			
			if(!$this->check_error($this->link_id))
			$this->print_error("next_record()");
			
			$stat = is_array($this->record);
			
			if (!$stat) {
				if($this->blob_id)
				mysql_free_result($this->query_id);
				$this->query_id = 0;
			}
			return $stat;
		}
	return 0;
	}
	
	function next_record_array(){
		return $this->record;
	}
	
	function next_record_ex(&$record){
	if($this->query_id > 0){
	$record = mysql_fetch_array($this->query_id);
	
	if(!$this->check_error($this->link_id))
	$this->print_error("next_record_ex()");
	
	$stat = is_array($record);
	
	if (!$stat) {
	if($this->blob_id)
	mysql_free_result($this->query_id);
	$this->query_id = 0;
	}
	return $stat;
	}
	return 0;
	}
	
	function seek($pos) {
	$this->row = $pos;
	if($this->row > 0)
	mysql_data_seek($this->query_id, $this->row - 1 );
	
	}
	
	function affected_rows() {
	return mysql_affected_rows($this->link_id);
	}
	
	function num_rows() {
	return mysql_num_rows($this->query_id);
	}
	
	function num_fields() {
	return mysql_num_fields($this->query_id);
	}
	
	function nf() {
	return $this->num_rows();
	}
	
	function np() {
	print $this->num_rows();
	}
	
	function f($Name) {
	return $this->record[$Name];
	}
	
	function p($Name) {
	print $this->record[$Name];
	}
	

	

	
	function print_error($header = "None haeder"){
	printf("<b>%s : %s:%s <br>\n", $header, $this->errno, $this->alert);
	}
	}
	
	function _db_to_blob(&$content){
	return "'$content'";
	}
	
	function _db_date_format($field){
	return "DATE_FORMAT($field, '%Y-%m-%d') as date";
	}
	
	function _db_date_format_noalias($field){
	return "DATE_FORMAT($field, '%Y-%m-%d')";
	}
	
	$_DB_HINT_FAST_FIRST_ROWS = "";
	$_DB_HINT_BOARD_DOC_INDEX = "";
	$_DB_HINT_TOTAL_DOC_INDEX = "";
	
	#current virsion support scroll & sequence cursor 
	$_DB_CURSOR_TYPE = 1 //if 1, use scroll cursor, 
	//but DB is not support, then set = 1
	
	//대표적인 예
	//$query = "select count(1) from 테이명 group by 필드명";
	//$db->query($query);
	//$total = $db->num_rows();
	
	
	//$query = "select count(1) from 테이블명";
	//$db->query($query);
	//$db->next_record();
	//$total = $db->f(0);
	
	//$sqlstr = "select * from 테이블명";
	//$db->query($sqlstr);
	//while( $db->next_record() ) {
	//	extract( $db->next_record_array() );//필드명에 맞추어 변수 반환
	//}
	*/
}			
?>