<?
/*
제작자 : 폰돌
URL : http://www.shop-wiz.com
email : master@shop-wiz.com
*** Updating List ***
*/

include ("../../lib/cfg.common.php");
include ("../../config/cfg.core.php");
include ("../../config/db_info.php");

include "../../lib/class.database.php";
$dbcon		= new database($cfg["sql"]);

include "../../lib/class.common.php";
$common = new common();
$common->db_connect($dbcon);

include "../../lib/class.member.php";
$member = new member();
$member->db_connect($dbcon);


if(trim($id) == "root" || trim($id) == "admin"){
	$str = "root나 admin은 예약어로 사용하실 수 없습니다..\\n\\n";
	$common->js_alert($str);
}

$RegDate = time();

if(!$tel1) $tel1=$tel1_1."-".$tel1_2."-".$tel1_3;
if(!$tel2) $tel2=$tel2_1."-".$tel2_2."-".$tel2_3;
if(!$tel3) $tel3=$tel3_1."-".$tel3_2."-".$tel3_3;
if(!$fax) $fax=$fax1."-".$fax2."-".$fax3;
$zip1 = ${zip1_1}."-".${zip1_2};
$zip2 = ${zip2_1}."-".${zip2_2};

if(!$companynum) $companynum = $companynum1."-".$companynum2."-".$companynum3;
if(!$email) $email = $email_1."@".$email_2;
$birthdate = $birthyy."/".$birthmm."/".$birthdd;
$marrdate = $marryy."/".$marrmm."/".$marrdd;
if(!$mgrade) $mgrade=10;
$mgrantsta=$cfg["mem"]["EGrantSta"];  // 현재 승인상태를 확인(관리자모드의 기본 정보가 들어옮)


/**********************************************************************/
if ( !$id || !$passwd || !$name ) {
	$str = "\\n\\n비정상적인 방법으로 접근하였습니다.\\n\\n";
	$common->js_alert($str);
}

$id_exists = $dbcon->get_one( "select count(1) from wizMembers where mid='$id'"); 
if ($id_exists) {
	$str = "\\n\\n이미 등록된 아이디입니다.\\n\\n";
	$common->js_alert($str);
}

$jumin_exists = $dbcon->get_one("select count(1) from wizMembers_ind where jumin1='$jumin1' AND jumin2='$jumin2'"); 
if ($jumin_exists && trim($jumin1)) {//주민번호 입력이 없을경우 바로 
	$str = "\\n\\n이미 등록된 주민등록번호입니다.\\n\\n관리자에게 문의하십시오\\n\\n";
	$common->js_alert($str);
}


/*****************************************************************************
  추천인에게 포인트 적립해주기.
*****************************************************************************/
if ($recid && $cfg["mem"]["RPoint"]) {
	$reqer_exists = $dbcon->get_one("select count(1) from wizMembers where mid='$recid'"); 
	if ($reqer_exists) {
		$content = "$name($id)회원의 추천보너스입니다.";
		$common->point_fnc($recid, $cfg["mem"]["RPoint"], 3);
	}
}
/**************************************************************************************************
  DB CONNECT -> INSERT INTO wizMembers ; DB연결후 회원데이터를 저장한다. 1차 기본 정보 입력
**************************************************************************************************/

$sqlstr = "INSERT INTO wizMembers (
mid,mpasswd,mname,mregdate,mgrantsta,mtype,mgrade,mailreceive,msmsreceive,mloginnum,mlogindate
)
VALUES(
'$id','$passwd','$name','".time()."','$mgrantsta','$type','$mgrade','$mailreceive','$smsreceive',0,'".time()."'
)";	
$dbcon->_query($sqlstr);

$sqlstr = "insert into wizMembers_ind (
id,nickname,pwdhint,pwdanswer,gender,jumin1,jumin2,birthdate,birthtype,marrdate,marrstatus,email,mailreceive,job,scholarship,company,companynum,telflag,tel1,tel2,tel3,fax,zip1,addressflag,address1,address2,zip2,address3,address4,url,recid
)
values(
'$id','$nickname','$pwdhint','$pwdanswer','$gender','$jumin1','$jumin2','$birthdate','$birthtype','$marrdate','$marrstatus','$email','$mailreceive','$job','$scholarship','$company','$companynum','$telflag','$tel1','$tel2','$tel3','$fax','$zip1','$addressflag','$address1','$address2','$zip2','$address3','$address4','$url','$recid'
)";	
$dbcon->_query($sqlstr);

## 메일 발송용 기본 정보를 배열에 입력
$infomail["id"]		= $id;
$infomail["passwd"]	= $passwd;
$infomail["name"]	= $name;
$infomail["email"]	= $email;

## 회원가입보너스 지급
if($cfg["mem"]["EPoint"])$common->point_fnc($id, $cfg["mem"]["EPoint"], 1);

/**************************************************************************************************
  DB CONNECT -> INSERT INTO wizMembersMore ; DB연결후 회원데이터를 저장한다. 2차 기본 정보 입력
**************************************************************************************************/
/* 파일 업로딩 시작 */
unset($UPDIR);
$filepath = "../../config/wizmember_tmp/user_image/";
for($i=0; $i<sizeof($file); $i++){
	if($file[$i]!="none" && $file[$i]){
    	if (file_exists($filepath.$file_name[$i])) {
	    $file_name[$i] = date("is")."_$file_name[$i]";
		
    	}    
	    if(!copy($file[$i], $filepath.$file_name[$i])) {
    	echo "파일 업로드에 실패 하였습니다.";
	    exit;}
	$UPDIR .=$file_name[$i]."|";
	}	
}
/* 파일 업로딩 끝 */

/****************************************************************************/
if($WhereRegis == "Admin" || $file=="admin"){
	echo "/intra/main.php?menushow=menu6&THEME=member/member1";
	$common->js_location($goto, $flag=null);
}


/*******************************************************************************
지금 부터 본격적인 회원로긴(쿠키값 설정 및 파일 생성)이 시작된다
*******************************************************************************/
$member->savepath	= "../../config/wizmember_tmp/login_user";//파일처리시 저장경로 설정
$member->loginform	= "regis";
$member->login_check($id, $passwd);//로그인처리


/* 메일 발송 */
if($cfg["mem"]["SendMail"] == "yes") include("./MEMBER_REGIS_MAIL.php");

$str = "\\n가입이 정상적으로 이루어졌습니다. \\n회원으로 가입해 주신 ".$name."님께 진심으로 감사드립니다.";
$common->js_alert($str, "alert");

if($ispopup == "yes"){// 팝업창에서 값이 넘어 온 경우
	$common->js_windowclose();
}else if ($goto=="MEMBER_REGIST_DONE") { // 회원가입완료페이지로 
	$goto = "../../wizmember.php?query=regis_done";
	$common->js_location($goto);
}else if ($goto=="REGIST_PAYMEMBER") { // 유료회원가입페이지
	$goto = "../../wizmember.php?query=regis_paymember";
	$common->js_location($goto);
}else { // 장바구니 - 현재방식
	$goto = "../../";
	$common->js_location($goto);
}
?>