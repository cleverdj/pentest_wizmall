<?php
/*

 제작자 : 폰돌                     
 URL : http://www.shop-wiz.com    
 Email : master@shop-wiz.com       
 Copyright (C) 2003  shop-wiz.com 
*/
if(!$cfg["member"]){
	$common->js_alert("로그인후 이용해주시기 바랍니다.","wizmember.php?query=login");
}
if($cfg["member"]["mgrade"] == "admin"){//관리자 단에서 넘어올경우 몇몇 변수값을 변경한다.
	$cfg["member"]["mid"] = $mid;
}


?>
<script language="javascript">
<!--
	function gotoOrderInfo(oid){
		location.href = "<?=$PHP_SELF?>?query=order_spec&OrderID="+oid; 
	}
	
	function Repay(oid){
		location.href = "wizbag.php?query=step3&RepayOrderID="+oid; 
	}
	
	function getDeliveryStatus(targeturl, arg, argvalue, method){//리스트에서 주문조회용
		var url = "./skinwiz/common/delivery.php?targeturl="+targeturl+"&arg="+arg+"&argvalue="+argvalue+"&method="+method;
		wizwindow(url,'DeliveryCheckWindow','');
		//사용법 <a href="getDeliveryStatus('<?=$d_inquire_url?>','<?=$d_code?>', '<?=$InvoiceNo?>', '<?=$d_method?>')">배송조회</a>
	}
//-->
</script>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td height="40" valign="top"><table width="100%" height="18" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
        <tr bgcolor="#F6F6F6">
          <td width="15" height="22">&nbsp;</td>
          <td width="18" height="22" valign="middle"><img src="<?=$mem_skin_path?>/images/sn_arrow.gif" width="13" height="13"></td>
          <td height="22">Home &gt; <strong>주문조회</strong></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td align="center"><table width="95%" border="0" cellspacing="0" cellpadding="5" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
        <tr>
          <td bgcolor="#EEEEEE">- 고객님께서 주문하신 내역입니다.</td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td align="center"><table width="95%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td align="center">&nbsp;</td>
        </tr>
        <tr>
          <td align="right">&nbsp;</td>
        </tr>
        <tr>
          <td align="right"><table width="100%" border="0" cellpadding="0" cellspacing="0" class="company">
              <tr>
                <td><table width="100%" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                    <tr>
                      <td><img src="<?=$mem_skin_path?>/images/point_cart_01.gif" width="8" height="11"></td>
                      <td>회원가입후 현재까지 <strong><? ECHO $cfg["member"]["mname"]."(".$cfg["member"]["mid"].")";?></strong> 의 주문내역 
                        입니다. </td>
                    </tr>
                    <tr>
                      <td><img src="<?=$mem_skin_path?>/images/point_cart_01.gif" width="8" height="11"></td>
                      <td> 주문번호를 클릭하면 자세한 사항을 보실 수 있습니다.</td>
                    </tr>
                  </table></td>
              </tr>
              <tr>
                <td><table width="100%" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                    <tr>
                      <td height="3" colspan="9" bgcolor="#CCCCCC"></td>
                    </tr>
                    <tr>
                      <td width="46" height="27" bgcolor="#f3f3f3">&nbsp;</td>
                      <td height="27" align="center" bgcolor="#F2F2F2"><font color="#000000">주문번호</font></td>
                      <td height="27" align="center" bgcolor="#F2F2F2"><font color="#000000">상품명</font></td>
                      <td align="center" bgcolor="#F2F2F2"><font color="#000000">구매금액</font></td>
                      <td align="center" bgcolor="#F2F2F2"><font color="#000000"> 결제방식</font></td>
                      <td align="center" bgcolor="#F2F2F2"><font color="#000000"> 거래상태</font></td>
                      <td align="center" bgcolor="#F2F2F2"><font color="#000000">주문일시</font></td>
                      <td width="80" align="center" bgcolor="#F2F2F2"><font color="#000000">상세내역</font></td>
                      <td width="60" align="center" bgcolor="#F2F2F2"><font color="#000000">재결재</font></td>
                    </tr>
                    <tr>
                      <td height="1" colspan="9" bgcolor="#cfcfcf"></td>
                    </tr>
<?
$ListNo = "15";
$PageNo = "20";
if(empty($cp) || $cp <= 0) $cp = 1;
$START_NO = ($cp - 1) * $ListNo;

$whereis = "WHERE b.MemberID='".$cfg["member"]["mid"]."'";
$sqlstr = "SELECT count(1) FROM wizBuyers b $whereis";
$TOTAL=$dbcon->get_one($sqlstr);
$TOTAL_SMONEY = $dbcon->get_one( "SELECT SUM(TotalAmount) FROM wizBuyers b $whereis");


$NO = $TOTAL-($ListNo*($cp-1));
$orderby = "b.UID DESC";
$sqlqry = $dbcon->get_select('b.*, d.d_name, d.d_code, d.d_url, d.d_inquire_url, d.d_method','wizBuyers b left join wizdeliver d on b.Deliverer = d.uid',$whereis, $orderby, $START_NO, $ListNo);
while( $list = $dbcon->_fetch_array($sqlqry)) :
	$SUB_SMONEY		= $SUB_SMONEY + $list["TotalAmount"];
	$PayMethod		= $list["PayMethod"];
	$OrderStatus	= $list["OrderStatus"];
	$BuyDate		= $list["BuyDate"];
	$OrderID		= $list["OrderID"];
	$InvoiceNo		= $list["InvoiceNo"];
	
	$d_name			= $list["d_name"];
	$d_code			= $list["d_code"];
	$d_url			= $list["d_url"];
	$d_inquire_url	= $list["d_inquire_url"];
	$d_method		= $list["d_method"];
	
?> 
                    <tr>
                      <td width="46" height="27" bgcolor="#f3f3f3"><font color="#144179"><img src="<?=$mem_skin_path?>/images/point_list_01.gif" width="21" height="9">
                        <?=$NO?>
                        </font></td>
                      <td height="27" align="center"><strong><a href="javascript:gotoOrderInfo('<?=$OrderID?>')">
                        <?=$OrderID?>
                        </a></strong></td>
                      <td height="27"><?
				  
$substr = "select m.*, c.uid as cuid, c.*  from wizMall m left join wizCart c on m.UID = c.pid where c.oid = '".$OrderID."' order by c.uid asc";
$subqry = $dbcon->_query($substr);
$i=0;
$SUM_MONEY = 0;
$TOTAL_MONEY = 0;
$subcnt=0;

while($sublist = $dbcon->_fetch_array($subqry)):
	$Picture = split("\|", $sublist[Picture]);
	if($subcnt==0){
		if($sublist[Model]) echo "(".$sublist[Model].")";
		echo $sublist[Name];
	}
	$subcnt++;
endwhile;

if($subcnt > 1) echo " 외 ".($subcnt-1)."건";

?></td>
                      <td align="center"><?=number_format($list[TotalAmount])?>
                        원</td>
                      <td align="center"><?=$PaySortArr[$PayMethod]?></td>
                      <td align="center"><?=$DeliveryStatusArr[$OrderStatus];?></td>
                      <td align="center"><?=date("Y.m.d",$BuyDate)?></td>
                      <td align="center"><input type="button" name="button" id="button" value="상세내역" style="cursor:pointer" onclick="gotoOrderInfo('<?=$OrderID?>')"></td>
                      <td align="center"><input type="button" name="button2" id="button2" value="결제" style="cursor:pointer" onclick="Repay('<?=$OrderID?>')">                      </td>
                    </tr>
                    <tr>
                      <td height="1" colspan="9" bgcolor="#cfcfcf"></td>
                    </tr>
                    <?
$NO--;
endwhile;
?>
                    <tr align="center">
                      <td height="27" colspan="9" align="right" bgcolor="#f3f3f3">현재페이지 합계금액 : <strong><font color="E37509">
                        <?=number_format($SUB_SMONEY)?>
                        원</font></strong>| 총 주문금액 : <strong><font color="703EAE">
                        <?=number_format($TOTAL_SMONEY);?>
                        원 </font></strong></td>
                    </tr>
                    <tr>
                      <td height="1" colspan="9" bgcolor="#cfcfcf"></td>
                    </tr>
                    <tr align="center">
                      <td height="27" colspan="9"><table border="0" cellspacing="0" cellpadding="0">
                          <tr>
                            <td>
<?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$page_arg1 = $PHP_SELF."?query=order";
$page_arg2 = array("listno"=>$ListNo,"pageno"=>$PageNo,"cp"=>$cp,"total"=>$TOTAL); 
//$page_arg3 = array("pre"=>"./img/pre.gif","next"=>"./img/next.gif");
echo $common->paging($page_arg1,$page_arg2,$page_arg3);
?>
</td>
                          </tr>
                        </table></td>
                    </tr>
                    <tr>
                      <td height="1" colspan="9" bgcolor="#cfcfcf"></td>
                    </tr>
                  </table></td>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td align="right">&nbsp;</td>
        </tr>
      </table></td>
  </tr>
</table>