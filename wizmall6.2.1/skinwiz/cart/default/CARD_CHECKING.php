<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/
/* 결제방법당 각각의 필드에 정보를 입력한다.*/

$mid = $cfg["member"]["mid"];

$total_check = str_replace("," , "" , $total_check);
if ($paytype == 'online' || !$paytype){
	$olineamount = $total_check;
}else if ($paytype == 'all') {
	if ($olineamount) $olineamount = str_replace("," , "" , $olineamount);
	if ($pointamount) $pointamount = str_replace("," , "" , $pointamount);
	if ($pgamount) $pgamount = str_replace("," , "" , $pgamount);
	if ($olineamount + $pointamount + $pgamount != $total_check) {
		echo "
		<script language=javascript>
		window.alert('\n\n다중구매로 선택하셨으나, 합산금액이 일치하지 않습니다.    \n다시한번 확인하여 주세요..\n\n온라인입금 : ".number_format($olineamount)."원\n신용카드결제 : ".number_format($pgamount)."원\n포인트사용 : ".number_format($pointamount)."원\n-----------------------------------\n다중구매합계 : ".number_format($olineamount + $pointamount + $pgamount)."원\n실제품구매액 : ".number_format($total_check)."원\n\n');
		history.go(-1);
		</script>
		";
		exit;
	}
}else{#기타 결제는 PG사창에서 처리하므로 일괄적으로 넣는다.
	$pgamount = $total_check;
}

//현재 동일 데이타가 있는지 책크
$sqlstr = "select count(UID) from wizBuyers where OrderID = '".$CART_CODE."'";
$result = $dbcon->get_one($sqlstr);

$OrderID = $CART_CODE; // 장바구니고유코드
$MemberID = $mid;
$Message = addslashes($Message);
$RAddress1 = addslashes($RAddress1);
$RAddress2 = addslashes($RAddress2);
$STel1 = $STel1_1."-".$STel1_2."-".$STel1_3;
$STel2 = $STel2_1."-".$STel2_2."-".$STel2_3;
$SZip = $SZip1."-".$SZip2;
$RTel1 = $RTel1_1."-".$RTel1_2."-".$RTel1_3;
$RTel2 = $RTel2_1."-".$RTel2_2."-".$RTel2_3;
$RZip = $RZip1."-".$RZip2;

$PayDate = mktime($OHour,0,0,$OMonth,$ODay,$OYear);
$BuyDate = time();

if(!$result){  /*OrderID값이 없으면 처음 입력되는 것이고 OrderID값이 있으면 수정모드이다 */
	
	$QUERY1 = "INSERT INTO wizBuyers (
	SName,RCompany,SEmail,STel1,STel2,SZip,SAddress1,SAddress2,RName,RTel1,RTel2,RZip,
	RAddress1,RAddress2,ExpectDate,Message,PayMethod,BankInfo,Inputer,AmountPoint,AmountOline,
	AmountPg,TotalAmount,OrderID,OrderStatus,MemberID,PayDate,BuyDate)
	VALUES(
	'$SName','$RCompany','$SEmail','$STel1','$STel2','$SZip','$SAddress1','$SAddress2','$RName','$RTel1','$RTel2','$RZip',
	'$RAddress1','$RAddress2','$Year.$Month.$Day','$Message','$paytype','$BankInfo','$Inputer','$pointamount','$olineamount',
	'$pgamount','$TOTAL_MONEY','$OrderID','10','$MemberID','$PayDate','$BuyDate')";


//echo $QUERY1."<br>";
	$QUERY1_RESULT = $dbcon->_query($QUERY1);
	$sqlstr = "update wizCart set ostatus = '10' where  oid = '$OrderID'";
	$dbcon->_query($sqlstr);

}else{
	$QUERY_UPDATE = "UPDATE wizBuyers SET 
	SName='$SName',
	SEmail='$SEmail',
	STel1='$STel1',
	STel2='$STel2',
	SZip='$SZip',
	SAddress1='$SAddress1',
	SAddress2='$SAddress2',
	RName='$RName',
	RTel1='$RTel1',
	RTel2='$RTel2',
	RZip='$RZip',
	RAddress1='$RAddress1',
	RAddress2='$RAddress2',
	ExpectDate='$Year.$Month.$Day',
	Message='$Message',
	PayMethod='$paytype',
	BankInfo='$BankInfo',
	Inputer='$Inputer',
	AmountPoint='$pointamount',
	AmountOline='$olineamount',
	AmountPg='$pgamount',
	TotalAmount='$TOTAL_MONEY',
	OrderStatus='10',
	MemberID='$MemberID',
	PayDate='$PayDate',
	BuyDate='$BuyDate' 
	WHERE  OrderID='$OrderID' ";
	$QUERY1_RESULT = $dbcon->_query($QUERY_UPDATE);
	
	//현재 ostatus 진행상태를 10으로 변경한다.
}
?>
<iframe frameborder="O" scrolling="no" id="PayIFrame"  src="./blank.php" width="500" height="500" style="display:none"> </iframe>
<?
$goods_name = strip_tags($goods_name);
/******* 결제페이지이동 *****************************************************************/
if ($paytype == 'online' || !$paytype): 
echo "<script>location.href='".$PHP_SELF."?query=step4&paytype=$paytype&OrderID=$OrderID';</script>";
exit;
else :
echo "<script>PayIFrame.location=\"./skinwiz/cardmodule/".$cfg["pay"]["CARD_PACK"]."/pay.php?OrderID=$OrderID&paytype=$paytype\";</script>";
endif;
?>
<table width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
  <tr bgcolor="#F6F6F6">
    <td width="15" height="22" class="company">&nbsp;</td>
    <td width="18" height="22" valign="middle"><img src="./skinwiz/cart/<?=$cfg["skin"]["CartSkin"]?>/images/sn_arrow.gif" width="13" height="13"></td>
    <td height="22" class="company">Home &gt; 결제진행중</td>
  </tr>
</table>
<br>
<table width="95%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td align="center"><table width="96%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td height="60">&nbsp;</td>
        </tr>
        <tr height="8">
          <td align="center"><!--<table width="600" border="0" cellpadding="1" cellspacing="0">
        <tr>
          <td bgcolor="#CCCCCC"><table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
              <tr> 
                <td width="132" valign="top"><img src="./skinwiz/cart/<?=$cfg["skin"]["CartSkin"]?>/images/img_card.gif" width="182" height="169"></td>
                <td height="172"> <table width="95%" border="0" cellpadding="0" cellspacing="0" style="font-family:돋움,굴림,Verdana,Arial; font-size:9pt; text-decoration:none;color:#cccccc;">
                    <tr> 
                      <td width="399"><table width="100%" border="0" cellspacing="0" cellpadding="0">
                          <tr> 
                            <td style="font-size:20px;line-height: 25px;"><strong><font color="#FF3300">결제진행중입니다.</font></strong></td>
                          </tr>
                          <tr> 
                            <td>- 현재결제가진행되고 있습니다.<img src="./skinwiz/cart/<?=$cfg["skin"]["CartSkin"]?>/images/img_card03.gif" width="88" height="13" align="absmiddle"></td>
                          </tr>
                          <tr> 
                            <td>- 결제창이 뜰때까지 네트워크사정에 따라 약5초에서 10초간의 시간이 소요됩니다.</td>
                          </tr>
                          <tr> 
                            <td>- 결제창이 뜨면 지시에 따라 진행해 주시기 바랍니다.</td>
                          </tr>
                          <tr>
                                  <td>- 만약 <font color="#0000FF">결제창이 뜨지 않으면 브라우저의 
                                    팝업허용이 차단된 상태이므로 해지후 새로고침 혹은 이전페이지 가기</font>를 
                                    해 주시기 바랍니다.<br>
                                    [<a href="javascript:;" onClick="location.reload();"><strong><font color="#FF0000" style="font-size:20px">새로고침</font></strong></a>][<a href="/wizbag.php?query=step3"><strong><font color="#FF0000" style="font-size:20px">이전페이지 
                                    가기</font></strong></a>]</td>
                          </tr>
                        </table> 
                              <br>
                              <br>
                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr> 
                                  <td style="font-size:20px;line-height: 25px;"><strong><font color="#FF3300">결제가 
                                    실패했을 경우</font></strong></td>
                                </tr>
                                <tr> 
                                  <td>- 이전 페이지에서 입력한 내용대로 다시 결제하시려면 ‘<font color="#0000FF">결제 재시도하기</font>’를 
                                    클릭하세요</td>
                                </tr>
                                <tr> 
                                  <td>- 입력정보를 수정하기 원하시면 '<font color="#0000FF">배송장소정보 
                                    재입력하기</font>’를 클릭하세요.</td>
                                </tr>
                                <tr> 
                                  <td><br>
                                    [<a href="javascript:;" onClick="location.reload();"><strong><font color="#FF0000" style="font-size:18px">결제 재시도하기</font></strong></a>][<a href="/wizbag.php?query=step3"><strong><font color="#FF0000" style="font-size:18px">배송장소정보 재입력하기</font></strong></a>]</td>
                                </tr>
                              </table></td>
                    </tr>
                  </table></td>
              </tr>
            </table></td>
        </tr>
      </table>-->
            <img src="./skinwiz/cart/<?=$cfg["skin"]["CartSkin"]?>/images/pay_img.gif" width="591" height="311" border="0" usemap="#PayProcessing">
            <map name="PayProcessing">
              <area shape="rect" coords="127,212,242,235" href="javascript:location.reload();">
              <area shape="rect" coords="254,212,414,235" href="/wizbag.php?query=step3">
            </map></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td align="right">&nbsp;</td>
  </tr>
  <tr>
    <td align="right">&nbsp;</td>
  </tr>
  <tr>
    <td align="right"><table width="564" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td height="36" align="center" valign="bottom"><br>
          </td>
        </tr>
      </table></td>
  </tr>
</table>
