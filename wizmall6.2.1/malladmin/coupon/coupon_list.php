<?
/*
powered by 폰돌
Reference URL : http://www.shop-wiz.com
Contact Email : master@shop-wiz.com
Free Distributer : 
Copyright shop-wiz.com
*** Updating List ***

*/

if ($query == "delete") {// 삭제하기
	//이미 발급된 쿠폰에 대해 삭제하기를 할 경우 문제가 발생 
	// 발급수 조회후 절차에 따라서 해야 한다.
	//따라서 이후는 업데이트 형식으로 해야 한다.
	// 현재는 걍 ...
	$sqlstr = "delete from wizCoupon where uid = '$uid'";
	$dbcon->_query($sqlstr);
	
	$sqlstr = "delete from wizCouponapply where couponid = '$uid'"; 
	$dbcon->_query($sqlstr);
}


$whereis = "WHERE 1";
$orderby = " order by uid desc";


if($searchEnable){//검색절 시작
	if($sword){
		if($skey) $whereis .= " and $skey like '%$sword%'";
		else $whereis .= " and cname like '%$sword%' or cdesc like '%$sword%' ";
	}
	
	if(is_array($s_ctype)){
		$whereis .= " and (";
		$cnt=0;
		foreach($s_ctype as $key => $value){
			if($cnt) $whereis.= " or ";
			$whereis .= " ctype = '$value'";
			$cnt++;
		}
		$whereis .= ")";
	}
	
	if(is_array($s_cpubtype)){
		$whereis .= " and (";
		$cnt=0;	
		foreach($s_cpubtype as $key => $value){
			if($cnt) $whereis.= " or ";
			$whereis .= " cpubtype = '$value'";
			$cnt++;
		}
		$whereis .= ")";
	}	
}

/* 페이징과 관련된 수식 구하기 */
if(empty($ListNo)) $ListNo = "15";
$PageNo = "20";
if(empty($CP) || $CP <= 0) $CP = 1;
$START_NO = ($CP - 1) * $ListNo;
$TOTAL_STR = "SELECT count(*) FROM wizCoupon ";
$REALTOTAL = $dbcon->get_one($TOTAL_STR);

$sqlstr = "SELECT count(*) FROM wizCoupon $whereis";
$TOTAL = $dbcon->get_one($sqlstr);

//--페이지 나타내기--
$TP = ceil($TOTAL / $ListNo) ; /* 페이지 하단의 총 페이지수 */
$CB = ceil($CP / $PageNo);
$SP = ($CB - 1) * $PageNo + 1;
$EP = ($CB * $PageNo);
$TB = ceil($TP / $PageNo);

//--페이지링크를 작성하기--
$sqlstr = "SELECT * FROM wizCoupon $whereis $orderby LIMIT $START_NO,$ListNo";
//echo "sqlstr = $sqlstr <br>";
$dbcon->_query($sqlstr) or(mysql_error()."<br>".$sqlstr);
?>
<script language=JavaScript>
<!--
function gotoWrite(uid){
	if(uid == undefined){
		var uid = "";
	}
	location.href = "<?=$PHP_SELF;?>?menushow=<?=$menushow;?>&theme=coupon/coupon_write&uid="+uid;
}

function gotocoponManage(uid){
	if(uid == undefined){
		var uid = "";
	}
	location.href = "<?=$PHP_SELF;?>?menushow=<?=$menushow;?>&theme=coupon/coupon_write_manage&uid="+uid;
}

function gotocoponview(uid){
	if(uid == undefined){
		var uid = "";
	}
	location.href = "<?=$PHP_SELF;?>?menushow=<?=$menushow;?>&theme=coupon/coupon_view&uid="+uid;
}

function delCoupon(uid){
	if(confirm('삭제된 데이타타는 복구되지 않습니다.\n정말로 삭제하시겠습니까?')){
		location.href = "<?=$PHP_SELF;?>?query=delete&menushow=<?=$menushow;?>&theme=<?=$theme;?>&uid="+uid;
	}else{
	
	}
}

function searchthis(f){
	f.searchEnable.value = "1";
	f.submit();
}

function gotoList(){
	location.href = "<?=$PHP_SELF;?>?menushow=<?=$menushow;?>&theme=<?=$theme;?>";
}

//-->	
</script>

<table class="table_outline">
  <tr>
    <td valign="top"><table class="table_title">
        <tr>
          <td bgcolor=#ffffff><b><font color="#FF6600">쿠폰리스트</font></b></td>
        </tr>
        <tr>
          <td bgcolor=#ffffff><table cellspacing=0 cellpadding=0 width="100%" border=0 class="s1">
              <tr>
                <td align=middle width=57><font color=#ff6600>[note]</font> </td>
                <td width="697">즉시발급쿠폰의 경우는 '발급하기'를 클릭하여 직접 회원에게 발급해야 합니다.<br />
                  자동으로 발급되는 쿠폰들은 '조회하기'를 누르면 쿠폰발급내용과 발급받은 회원을 조회할 수 있습니다.</td>
              </tr>
            </table></td>
        </tr>
      </table>
      <br>
      <br>
      <table width="100%" cellpadding="0" cellspacing="0" bgcolor="white" border="0" class="s1">
        <tr>
          <td valign="top" style="padding-left:12px"> 쿠폰리스트<span>고객에게 발급된 쿠폰을 관리하거나 쿠폰을 발급합니다.
            <table class="table_main">
              <form method="post" action="<?=$PHP_SELF;?>" name="searchForm">
                <input type="hidden" name="menushow" value="<?=$menushow;?>" />
                <input type="hidden" name="theme" value="<?=$theme;?>" />
                <input type="hidden" name="CP" value="<?=$CP;?>" />
                <input type="hidden" name="searchEnable" value="" />
                <tr>
                  <td bgcolor="E0E4E8">쿠폰검색</td>
                  <td bgcolor="#FFFFFF"><select name=skey>
                      <option value="">전체검색</option>
                      <option value="cname"<? if($skey == "cname") echo " selected";?>> 쿠폰명</option>
                      <option value="cdesc"<? if($cdesc == "cname") echo " selected";?>> 쿠폰설명</option>
                    </select>
                    <input type=text name=sword value="<?=$sword;?>">
                  </td>
                  <td bgcolor="E0E4E8">쿠폰기능</td>
                  <td bgcolor="#FFFFFF"><input type=checkbox name='s_ctype[]' value='1'<? if($common->checkStatus("1", $s_ctype)) echo " checked";?>>
                    할인
                    <input type=checkbox name='s_ctype[]' value='2'<? if($common->checkStatus("2", $s_ctype)) echo " checked";?>>
                    적립 </td>
                </tr>
                <tr>
                  <td bgcolor="E0E4E8">쿠폰발급방식</td>
                  <td colspan=3 bgcolor="#FFFFFF"><input type=checkbox name='s_cpubtype[]' value='1'<? if($common->checkStatus("1", $s_cpubtype)) echo " checked";?>>
                    운영자발급
                    <input type=checkbox name='s_cpubtype[]' value='2'<? if($common->checkStatus("2", $s_cpubtype)) echo " checked";?>>
                    회원직접다운로드
                    <input type=checkbox name='s_cpubtype[]' value='3'<? if($common->checkStatus("3", $s_cpubtype)) echo " checked";?>>
                    회원가입자동발급
                    <input type=checkbox name='s_cpubtype[]' value='4'<? if($common->checkStatus("4", $s_cpubtype)) echo " checked";?>>
                    구매후 자동발급 </td>
                </tr>
                <tr>
                  <td colspan="4" align="center" bgcolor="#FFFFFF"><input type="button" name="button2" id="button2" value="검색" onclick="searchthis(document.searchForm)" style="cursor:pointer">
                   &nbsp; 
                  <input type="button" name="button4" id="button4" value="리스트" onclick="gotoList()" style="cursor:pointer" /></td>
                </tr>
              </form>
            </table>
            <br />
            <table width="760" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td align="right"><input type="button" name="button3" id="button3" value="쿠폰만들기" onclick="gotoWrite()" /></td>
              </tr>
            </table>
            <table class="table_main">
              <tr>
                <td align="center" bgcolor="E0E4E8">번호</td>
                <td align="center" bgcolor="#B9C2CC">쿠폰명</td>
                <td align="center" bgcolor="E0E4E8">쿠폰종류</td>
                <td align="center" bgcolor="#B9C2CC">쿠폰생성일</td>
                <td align="center" bgcolor="E0E4E8">기능</td>
                <td align="center" bgcolor="#B9C2CC">할인금액(율)</td>
                <td align="center" bgcolor="E0E4E8">적용기간</td>
                <td align=center bgcolor="#B9C2CC" style="padding-left:3">발급/조회(발급수)</td>
                <td align="center" bgcolor="E0E4E8">수정/삭제</td>
              </tr>
              <?
$NO = $TOTAL-($ListNo*($CP-1));	
while( $list = $dbcon->_fetch_array( ) ) :
$uid				= $list["uid"];
$cname				= $list["cname"];
//$cdesc				= $list[""];
$cpubtype			= $list["cpubtype"];
//$cpubdowncnt		= $list[""];
//$cpubapplyall		= $list[""];
//$cpubapplycontinue	= $list[""];
$ctype				= $list["ctype"];
$csaleprice			= $list["csaleprice"];
$csaletype			= $list["csaletype"];
//$capplytype			= $list[""];
//$capplycategory		= $list[""];
//$capplyproduct		= $list[""];
//$cimg				= $list[""];
$ctermtype			= $list["ctermtype"];
$cterm				= $list["cterm"];
$ctermf				= $list["ctermf"];
$cterme				= $list["cterme"];
$crestric			= $list[""];
$wdate				= $list["wdate"];

switch($cpubtype){
	case "1"://운영자발급
		$btn_str = "<input type='button' name='button' id='button' value='회원발급하기' onClick='gotocoponManage(".$uid.")'>";
	break;
	default:
		$btn_str = "<input type='button' name='button' id='button' value='발급내용보기' onClick='gotocoponview(".$uid.")'>";
	break;
}


switch($ctermtype){
	case "1"://시작일, 종료일
		$ctermstr = date("Y.m.d H:i", $ctermf)."<br>~".date("Y.m.d H:i", $cterme);
	break;
	case "2"://기간설정
		$ctermstr = "발급 후 ".$cterm."일";
	break;
}


?>
              <tr height=35>
                <td align=center bgcolor="#FFFFFF"><?=$NO?></td>
                <td align=center bgcolor="#FFFFFF"><?=$cname?></td>
                <td align=center bgcolor="#FFFFFF"><?=$cpubtypeArr[$cpubtype]?></td>
                <td align=center bgcolor="#FFFFFF"><?=date("Y.m.d H:i:s", $wdate)?></td>
                <td align=center bgcolor="#FFFFFF"><?=$ctypeArr[$ctype]?></td>
                <td align=center bgcolor="#FFFFFF"><?=$csaleprice?>
                <?=$csaletypeArr[$csaletype]?></td>
                <td align=center bgcolor="#FFFFFF" style="word-break:break-all;"><?=$ctermstr?></td>
                <td align=left bgcolor="#FFFFFF"><?=$btn_str?>
                  <font color=EA0095><b>(
                  <?=$mall->getCouponCnt($uid);?>
                  )</b></font></td>
                <td align=center bgcolor="#FFFFFF"><input type="button" name="button" id="button" value="수정" onclick="gotoWrite(<?=$uid?>)" style="cursor:pointer">
                  <input type="button" name="button" id="button" value="삭제" onclick="delCoupon(<?=$uid?>)" style="cursor:pointer">
                </td>
              </tr>
              <?
$NO--; 
endwhile;
?>
            </table>
            <table cellspacing=0 cellpadding=0 width="760" 
border=0 class="s1">
              <tr>
                <td align="center">&nbsp;
                  <?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo "<a href='javascript:gotoPage($PREV_PAGE,document.searchForm)'><img src='./img/pre.gif' hspace='5' border='0'></a>";
} else {
echo "";
 }
/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CP == $i){$NUMBER_SHAPE= "<font color = 'gray'><B>${i}</B></font>";}
else $NUMBER_SHAPE="<font color = 'gray'>".${i}."</font>";
ECHO"&nbsp;<a href='javascript:gotoPage($i,document.searchForm)'>$NUMBER_SHAPE</a>";
}
/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO "&nbsp;<a href='javascript:gotoPage($NEXT_PAGE,document.searchForm)'><img src='./img/next.gif' hspace='5' border='0'></a>";
} else {

ECHO"";
}
?></td>
              </tr>
            </table>
            </form></td>
        </tr>
      </table>
      <br>
      <b></b> </td>
  </tr>
</table>
