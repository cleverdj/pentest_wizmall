<?
include("../../config/cfg.core.php");
?>
<html>
<HEAD>
<base target="_self">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<TITLE>Insert Image</TITLE>
<style>
  <!-- html, body, button, div, input, select, fieldset, td { font-family: MS Shell Dlg; font-size: 8pt; };-->
  button, input, select, td { font-family: MS Shell Dlg; font-size: 8pt; };
.style2 {color: #CC33CC}
</style>
<?
$dir = "../../wizstock";
$urlpath = $cfg["admin"]["MART_BASEDIR"]."/wizstock";
$mode = $_POST["mode"];
// ????? ?????
$old = array(
	"mid",
	"rmi",
	"midi",
	"asx",
	"wax",
	"wax",
	"m3u",
	"mvx",
	"mov",
	"qt",
	"asf",
	"wm",
	"wma",
	"wmv",
	"mpeg",
	"mpg",
	"m1v",
	"mp2",
	"mp3",
	"avi",
	"wmv",
	"wav",
	"snd",
	"au",
	"aif",
	"aifc",
	"aiff",
	"rm",
	"ra",
	"ram",
	"swf"
);





ECHO "<html>";

ECHO "<head>";
ECHO "</head>";

ECHO "<BODY>";





$referer = explode('/',preg_replace("/http:\/\//",'',$_SERVER['HTTP_REFERER']));

if ($referer[0] <> $_SERVER['HTTP_HOST']) {
	ECHO "";
	exit;
}



if($_SERVER['REQUEST_METHOD'] <> 'POST') {
	ECHO "";
	exit;
}







// ??? ????? ??? ?? 

if (!@is_dir($dir)) {

	ECHO "


	";

	exit;

}



// ??? ??? ??? 707?? ??

if(((substr(PHP_OS,0,1) == 'W') ? 1 : 0) != 1){

	if(substr(decoct(fileperms($dir)),2) <> 707){

	ECHO "


	";

//	exit;

	}

} // end if



// ??? ??, ??? ??

$link = addslashes(trim($_POST['link']));







/***************************************************************************************

*************************   ?? ??

****************************************************************************************/



if(empty($_POST['wr']) && empty($link) && is_uploaded_file($_FILES['upfile']['tmp_name']) && ($_FILES['upfile']['size'] > 0)) {



	$ext = substr($_FILES['upfile']['name'],strrpos(stripslashes($_FILES['upfile']['name']),'.')+1);

	$upfile = time().'.'.$ext;



	// ???, ??? ??

	$tmp_dir = $dir.'/'.(($_POST['mode']==1) ? 'img' : 'mid');
	$tmp_urlpath = $urlpath.'/'.(($_POST['mode']==1) ? 'img' : 'mid');

	if(!is_dir($tmp_dir)){

		@mkdir($tmp_dir,0707);

		@chmod($tmp_dir,0707);

	} // end if





	// ?????..

	if($_POST['mode']==1){

		$tmp_file = @getimagesize($_FILES['upfile']['tmp_name'],&$type);



		// (1) = gif, (2) = jpg, (3) = png, (4) = swf, (5) = psd, (6) = bmp

		if(($tmp_file[2] != 1) && ($tmp_file[2] != 2) && ($tmp_file[2] != 3) && ($tmp_file[2] != 6)) {

			ECHO "


			";

			exit;

		}

	}

	// ?????..

	else{

		$media_chk = '';

		foreach($old as $key => $value){

			if($value == $ext){

				$media_chk = 1;

				break;

			}

		}



		if($media_chk <> 1){

			ECHO "


			";

			exit;

		}

	} // end if





	if(!@move_uploaded_file($_FILES['upfile']['tmp_name'],$tmp_dir.'/'.$upfile)) {

		@unlink($tmp_dir.'/'.$upfile);

		ECHO "


		";

		exit;

	}

	@chmod($tmp_dir.'/'.$upfile,0606);

} // end if









/***************************************************************************************

*************************   ??? ???? ??

****************************************************************************************/


if(is_file($tmp_dir.'/'.$upfile) || !empty($link)){



	$imgsize = (int)$_POST['imgsize'];

	$title = addslashes($_POST['title']);

	$alignment = $_POST['alignment'];

	$upfile_ok = $tmp_dir.'/'.addslashes($upfile);
    $real_urlpath = $tmp_urlpath.'/'.addslashes($upfile);
	$file_path = $_POST['url'].'/'.$upfile_ok;

}
?>

<SCRIPT defer>
  var elmImage;
  var intAlignment;
  var htmlSelectionControl = "Control";
  var globalDoc = window.dialogArguments;
  var grngMaster = globalDoc.selection.createRange();
  
   
  idstr = "\" id=\"556e697175657e537472696e67";     // new image creation ID

    grngMaster.execCommand("InsertImage", false, idstr);
    elmImage = globalDoc.all['556e697175657e537472696e67'];
    elmImage.removeAttribute("id");
    elmImage.removeAttribute("src");
    grngMaster.moveStart("character", -1);
 
 //elmImage.style.width = '100';
  //elmImage.style.height = '100';


  //txtFileName.value.length = 200

  
 // elmImage.src = txtFileName.value;
   elmImage.src ='<?=$real_urlpath?>'
  
  elmImage.hspace = 0;
  elmImage.vspace = 0;
  elmImage.alt = '';
  elmImage.border = 0;

  elmImage.align = '';
  grngMaster.collapse(false);
  grngMaster.select();
  window.close();
</script>

<?
/*
<script language="javascript">
//window.returnValue = oTransValue;<BR>
window.opener.HTMLPaste(<?=$real_urlpath?>)
window.close();
</script>
*/
?>
</BODY>
</HTML>