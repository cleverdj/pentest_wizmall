<?php
/* 
제작자 : 폰돌
제작자 URL : http://www.shop-wiz.com
제작자 Email : master@shop-wiz.com
Free Distributer 

*** Updating List ***
*/
include "./lib/cfg.common.php";

include ("./config/db_info.php");
include "./config/cfg.core.php";

include "./lib/class.database.php";
$dbcon		= new database($cfg["sql"]);

include "./lib/class.common.php";
$common = new common();
$cfg["member"] = $common->getLogininfo();//로그인 정보를 가져옮
$common->db_connect($dbcon);

include "./lib/class.board.php";
$board = new board();
$board->db_connect($dbcon);
$board->common($common);

##클라스에 각종 변수값 입력
$geturl = $common->getdecode($_GET["getdata"]);//get 방식으로 호출된 data값 변환

$BID			= $geturl["BID"]?$geturl["BID"]:$BID;
$GID			= $geturl["GID"]?$geturl["GID"]:$GID;
$cp	= $geturl["cp"] ? $geturl["cp"]:$cp;//현재페이지
$UID			= $geturl["UID"]?$geturl["UID"]:$UID;
$category		= $geturl["category"]?$geturl["category"]:$category;
$mode			= $geturl["mode"]?$geturl["mode"]:$mode;
if(!$mode) $mode = "list";
$adminmode		= $geturl["adminmode"]?$geturl["adminmode"]:$adminmode;
$optionmode		= $geturl["optionmode"]?$geturl["optionmode"]:$optionmode;
$search_term	= $geturl["search_term"]?$geturl["search_term"]:$search_term;
$SEARCHTITLE	= $geturl["SEARCHTITLE"]?$geturl["SEARCHTITLE"]:$SEARCHTITLE;
$searchkeyword	= $geturl["searchkeyword"]?urldecode($geturl["searchkeyword"]):$searchkeyword;

$board->bid				= $BID;
$board->gid				= $GID;
$board->page_var["cp"]	= $cp ? $cp:1;//현재페이지
$board->uid				= $UID;
$board->cagegory		= $category;
$board->mode			= $mode;
$board->adminmode		= $adminmode;
$board->optionmode		= $optionmode;
$board->search_term		= $search_term;
$board->SEARCHTITLE		= $SEARCHTITLE;
$board->searchkeyword	= $searchkeyword;


if ( !$BID || !$GID || !is_dir("./config/wizboard/table/$GID/$BID")) $common->js_alert("\\n\\n존재하지 않는 보드입니다.\\n\\n", "cur");

$config_include_path = "./config/wizboard/table/$GID/$BID";
include $config_include_path."/config.php";#보드관련 세부 config 관련 정보
if(!$board->listcnt) $board->listcnt = $cfg["wizboard"]["ListNo"];
if(!$board->pagecnt) $board->pagecnt = $cfg["wizboard"]["PageNo"];
$board->cfg = $cfg;//환경설정 파일들을 입력한다.
# 회원모드이면 로그인 상태와 회원등급을 책크하여 글을 읽을 수 있는 권한을 부여한다.
$board->checkperm($cfg["member"]);

#그룹정보가져오기
$sqlstr = "select Grp from wizTable_Main where BID = '$BID' and GID = '$GID'";
$sqlqry=$dbcon->get_one($sqlstr);

#카테고리정보가져오기
//$sqlstr = "select ordernum, catname from wizTable_Category  where bid = '$BID' and gid = '$GID'";
//$sqlqry = $dbcon->_query($sqlstr);
//while($list = $dbcon->get_rows()):
//	$ordernum = $list["ordernum"];
//	$catname = $list["catname"];
///	$categoryname[$ordernum] = $catname;
//endwhile;

include ("./config/cfg.core.php");;



/****[스킨은 다르지만 동일한 데이트를 사용할때, 즉 SameDB가 있을 때] *******/

if(!$SameDB){
	 $BOARD_NAME="wizTable_${GID}_${BID}";
	 $UpdirPath = $GID."/".$BID;
}else{
	$BOARD_NAME="wizTable_${SameDB}";
	$UpdirPath = $SameDB;
}
$board->boardname = $BOARD_NAME;


/****[확장DB사용시] *******/
if($ExtendDB && $ExtendDBUse=="checked")
$BOARD_NAME="$ExtendDB";
/******************************************************************************/

/* 리플을 등록한다 */
if(!strcmp($REPLE_MODE, "WRITE") || !strcmp($REPLE_MODE, "update")){
include "./wizboard/func/WRITE_ONELINE_REPLE.php";
}

if($mode == "view"){//보기상태일경우 일반적인 책크 부분

	if($NoticeBID){ //공지 테이블이 있으면 현재 BID 를 NoticeBID로 교체한다. 
		$BOARD_NAME = "wizTable_".$NoticeBID;
		//보드 교체후 view page가 끝나는 곳에서 반드시 원래 보드로 복귀시켜준다.
	}
	/* 잘못된 경로에서의 접근이면 list.php로 돌린다 */
	if(!$UID) ECHO "<script>location.replace('$PHP_SELF')</script>";
	
	## channel에 카운트 넣기
	## 보드별 통계치(Channel)를 만든다.
	$board->MakeChannel();
	
	## 이전글 다음글에서 이전글의 UID 와 다음글의 UID를 구한다 
	
	$board->getpreitem($UID, $cfg["wizboard"]["SubjectLength"]);// 이전글 클라스내에 생성 $listpre
	$board->getpnextitem($UID, $cfg["wizboard"]["SubjectLength"]);//다음글 클라스내에 생성 $listnext

	## COUNT를 1씩 올린다. */
	$board->addviewcount($UID);
	
	## RECOMMAND(추천)글이면 추천 RECCOUNT를 1씩 올린다.
	if(!strcmp($RECOMMAND,"OK")) $board->addreccount($UID);
	
	##  상세보기 관련 모든 내용 가져오기
	$boardview = $board->getview($UID);

	## 비밀글 읽을 권한 책크
	$board->is_secret_perm($boardview["Secret"], $boardview["FID"]);

}

/************************************************ mode가 write일때 **********************************************************/
if(!strcmp($mode,"write") && $bmode=="write"){

	$board->is_spam($spamfree);
	include "./wizboard/func/wizboard_qry.php";
}

/************************************ bmode가 modify일때 ******************************************************************/
if(!strcmp($mode,"modify") && !strcmp($bmode,"modify")){
	include "./wizboard/func/wizboard_qry.php";
}

/**************************************************** mode가 reply일때 *****************************************************/
if(!strcmp($mode,"reply") && !strcmp($bmode,"reply")){
	$board->is_spam($spamfree);
	include "./wizboard/func/wizboard_qry.php";
}



/****************** 본격적으로 본론 진입 ***********************/
if(!strcmp($cfg["wizboard"]["INCLUDE_MALL_SKIN"],"yes") && tableskin!="skip" && $adminmode != "true" && $optionmode != "frame"):/* Board에 스킨 인클루드 책크시나 관리자단에서 보는 것이 아니거나 옵션모드가 프래임(프래임을 이용하여 wizboard삽입)이 아닐경우 */
if(is_file("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php");
?>
<table width="100%" border="0" cellpadding="0" cellspacing="0">
  <tr> 
    <td> 
      <!-- top menu start -->
      <?
if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php");
?>
      <!-- top menu end -->
    </td>
  </tr>
  <tr> 
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td width="170" valign="top"> 
            <!-- left menu start -->
            <?
if ($cfg["skin"]["MenuSkin_Inc"] == 'checked') include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_left.php");
?>
            <!-- left menu end -->
          </td>
          <td width="10">&nbsp;</td>
          <td valign="top"><table width="2" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td height="1"> </td>
                    </tr>
                  </table>
            <table width="720" border="0" cellspacing="0" cellpadding="0">
              <tr> 
                <td> 
                  <!-- main menu start -->
<?
/* Board에 스킨 인클루드 책크시 */
endif;
?>
<?				  
if($adminmode == "true" || $optionmode == "frame"){
include "./wizboard/default/top.php";
}else if(is_file($config_include_path."/top.php") && $tableskin!="skip"){
include $config_include_path."/top.php";
}
if(!$TABLE_WIDTH) $TABLE_WIDTH = "100%";
if(!$TABLE_ALIGN) $TABLE_ALIGN = "DEFAULT";
?>
<script language="javascript" src="./js/wizmall.js"></script>
<script language="javascript" src="./js/wizboardjs.php?UID=<?=$UID?>&BID=<?=$BID?>&GID=<?=$GID;?>&BOARD_SKIN_TYPE=<?=$cfg["wizboard"]["BOARD_SKIN_TYPE"]?>"></script>
<!-- wizboard 관련하여 공통 자바스크립트 사용 -->
                  <table width="<?=$TABLE_WIDTH?>" border="0" cellpadding="0" cellspacing="0" align="<?=$TABLE_ALIGN?>">
                    <tr> 
                      <td valign="top" align="<?=$TABLE_ALIGN?>"> 

<?
switch ( $mode ){
	case ( "view" ) :
		$board->getcategorylist(); ## 카테고리정보구하기
		include ("./wizboard/skin/".$cfg["wizboard"]["BOARD_SKIN_TYPE"]."/view.php");
		## 리스트 페이지 삽입 
		if($cfg["wizboard"]["ListEnable"] == "yes"):
			$ThisFileName = basename(__FILE__); // get the file name
			$path = str_replace($ThisFileName,"",__FILE__);   // get the directory path
			include "${path}/list.php"; 
		endif;		
		if($NoticeBID){ //공지테이블에서 원래 테이블로 변경한다. 
			$BOARD_NAME = "wizTable_".$BID;
		}
	break;
	case ( "write" ) :
	case ( "reply" ) :
	case ( "modify" ) :
		$board->getcategorylist(); ## 카테고리정보구하기
		include ("./wizboard/skin/".$cfg["wizboard"]["BOARD_SKIN_TYPE"]."/write.php");
	break;
	case ( "delete" ) :
		include ("./wizboard/boarddelete.php");
	break;
	case ( "login" ) :
		include ("./wizboard/member_login.php");
	break;
	case ( "modlogin" ) :
	case ( "secret" ) :
		include ("./wizboard/member_login_secret.php");
	break;
	case ( "down" ) :
		include ("./wizboard/member_login.php");
	break;							
	default ://리스트
		$board->getorderby($oderflag); ##정열값 구하기
		$board->getwhere($skey, $sstr); ## 검색 키워드 및 WHERE 구하기
		$board->get_total_cnt(); ##총갯수 구하기
		$board->getpagevar(); ## 페이징 관련 변수 구하기
		$board->getcategorylist(); ## 카테고리정보구하기
		include ("./wizboard/skin/".$cfg["wizboard"]["BOARD_SKIN_TYPE"]."/list.php");
	break;
}
?>
                      </td>
                    </tr>
                  </table>
<?
if($adminmode == "true" || $optionmode == "frame"){
include "./wizboard/default/bottom.php";
}else if(file_exists($config_include_path."/bottom.php")){
include $config_include_path."/bottom.php";
}

if(!strcmp($cfg["wizboard"]["INCLUDE_MALL_SKIN"],"yes") && tableskin!="skip" && $adminmode != "true"  && $optionmode != "frame"):/* Board에 스킨 인클루드 책크시 */				  
?>
                  <!-- main menu end -->
                </td>
              </tr>
            </table> </td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td> 
      <!-- bottom menu start -->
<?
if (is_file("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php") && tableskin!="skip") include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php");
?>
      <!-- bottom menu end -->
    </td>
  </tr>
</table>
<?
include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_close.php");
/* Board에 스킨 인클루드 책크시 */
endif;
$dbcon->_close();
?>