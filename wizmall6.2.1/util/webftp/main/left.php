<?php
/**
* 왼쪽 프레임
*
* @filename : main/left.php
* @version  : v 1.0 2003.07.18 18:27:55
* @author   : nsl <smpoem@magicn.com>
*/

// @param string  $cd : 디렉토리
// @param integer $toppos : 스크롤바 위치


$_SKYDIR_URL = '../';

// 기본 설정 초기화
include '../common/skydir_init.php';

$startTime = getMicroTime();

// ftp class 초기화
$ftp = new SkyFtp($rcfg->ftpHost, $rcfg->ftpPort, $rcfg->ftpUserID, $rcfg->ftpUserPW);

// ftp 연결
if (!$ftp->ftpLogin()) {

    $ftp->ftpClose();
    notConnectMsg();
    exit;
}

// 디렉토리 값이 없으면 초기 경로로 설정
if (empty($cd)) {

    $cd = $rcfg->initDirRight;
//                                    &&   경로 수정후 바로 리로드시 에러 방지
} else if ($rcfg->initDirRight != "/" && $changeDir != "ok") {

    $cd = $rcfg->initDirRight . $cd;
} else {

    $cd = $cd;
}




$curdir =  $cd;

// 디렉토리 이동
$ftp->ftp_chdir($curdir);

// 디렉토리 분할 / 가 아닌 /home/test --> 지정한 디렉토리부터 출력한 위한 것
$initPath = explode('/',  $rcfg->initDirRight);
$initTotal = count($initPath);
if ($initTotal >= 1) $initTotal--;

// / 루트이면 0
if (!trim($initPath[1])) $initTotal = 0;

// 디렉토리 분할 (하위 디렉토리 출력하기 위해서)
$curdirPath = explode('/',  $curdir);

// /home/test/user 
// 1. /home
// 2. /home/test
// 3. /home/test/user 로 분리
for ($z = 1; $z < count($curdirPath); $z++ ) {

    $curdirPathNew[$z] .=  $temp . DIRECTORY_SEPARATOR . $curdirPath[$z];
    $temp = $curdirPathNew[$z];

}

// 출력할 디렉토리 구함
$curDirListPrint = getDirList($rcfg->initDirRight, 'left');

// ftp close
$ftp->ftpClose();



$endTime = getMicroTime();
$totalTime = round($endTime - $startTime, 3);

include (HEADER_FILE);
?>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" <?=$dcfg->body?>>
<script language="javascript">
<!--

	// 현재 프레임의 스크롤바 위치 top
	function getLeftScrollTop() {

		if (isExplorer) return document.body.scrollTop;
		else            return window.pageYOffset;
    }

    // 클릭시 오른쪽 프레임에 경로 전달
    function leftClick(cdVal) {

        window.parent.right.location.href = '<?="$dcfg->rightFile?cd="?>' + cdVal;

        return;
    }

    // 더블 클릭시
    function leftDblClick(cdVal) {

        // 왼쪽 스크롤바 위치
        var leftScrollTop = getLeftScrollTop()

        window.parent.right.location.href = '<?="$dcfg->rightFile?cd="?>' + cdVal;

        // 하위 디렉토리를 출력해야 하므로 필요함.
        window.parent.left.location.href = '<?="$dcfg->leftFile?cd="?>' + cdVal  + '&toppos=' + leftScrollTop;
        return;
    }

    // 선택된 디렉토리 배경색 변경
    function setBgcolor(number) {

        if (isExplorer) {

            // 1. 이전 레이어 색을 바꾸고
            var mm = document.layerCode.layer_id.value;  // 이전에 선택된 레이어 번호
            if (mm != '')
            document.all[mm].style.background='#FFFFFF';
              
            // 2. 선택된 레이어 색을 바꾸고
            var mm =  number;
            if (mm != '')
            document.all[mm].style.background='<?=$dcfg->divBgcolor?>';

        }else{

            //1. 이전 레이어 색을 바꾸고
            var mm =  document.layerCode.layer_id.value;
            document.layers[mm].background='#FFFFFF';
              
            //2. 선택된 레이어 색을 바꾸고
            var mm = number;
            document.layers[mm].background='<?=$dcfg->divBgcolor?>';
        }


        // 선택된 레이어 값을 저장 
        document.layerCode.layer_id.value = number;
    }

//-->
</script>
<table border=0 cellpadding=0 cellspacing=0 width=100%>
<tr>
 <td id="home" style="cursor: default;padding:0;maring:0;" nowrap>
    <a href="javascript:OnClick=leftDblClick('/');setBgcolor('home');"><img src='<?=$dcfg->iconFolder?>' width=16 height=16 align='absmiddle' border='0' >&nbsp;Home</a>
 </td>
</tr>
<tr>
  <td>
    <?=$curDirListPrint?>
  </td>
</tr>
</table>

<div id='left0'></div>
<table border=0 cellpadding=1 cellspacing=0 width=100%>
<tr>
  <form name=layerCode method=post action=>
  <input type=hidden name=layer_id value=0>
  <td></td>
  </form>
</tr>
</table>
<script language="javascript">
<!--

<?  // 왼쪽 스크롤 위치 제자리로
    if ($toppos > 0) {
?>
        window.scroll(0, <?=$toppos?>);
<? } ?>
    
setBgcolor("<?=$curdirLayerID?>");
//-->
</script>
</body>
</html>

<?
/**
* 현재 디렉토리 목록을 구한다
* 
* @param  string  $curdirName  : 목록을 구할 디렉토리 /home/test/user -> home
* @param  string  $layerName   : 사용할 레이어 이름
*/
function getDirList($curdirName, $layerName = '', $space = '0') {

    global $dcfg;
    global $rcfg;

    global $curdir;         // 현재 경로 /home/test

    global $curdirPath;     // 현재 경로를 / 로 분리한 배열
    global $curdirPathNew;  // 현재 경로를 단계별로 분리한 배열 /home, /home/test

    global $curdirLayerID;

    global $initTotal;

    global $ftp; // ftp class

    // 경로가 없다면 루트로
    if (!$curdirName) $curdirName = $rcfg->initDirRoot;

    $space -= $initTotal;
    //if ($space > -2) $space += 2;
    for ($x = 1; $x <= $space; $x++)
            $leftSpace .= "<img src='$dcfg->iconVline' width='19' height='16' border='0' align='absmiddle'>";

   
    // 현재 디렉토리의 디렉토리목록, 파일 목록 구하기
    list($curDirListOri, ) = $ftp->ftp_rawlist($curdirName, false); //$ftp->ftp_pwd());


    //^^^^^^^^^^^^^^^^^^^^^ 디렉토리 정렬 ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    foreach($curDirListOri as $qKey => $qVal) {

        $dirname[]     = $qVal['name']; //;                 // 디렉토리명 (순수한)
        $dirnameTemp[] = strtolower($qVal['name']); // 디렉토리명 (정렬용)
    }

    $initdir = &$dirnameTemp;
    @asort($initdir); 

    
    if (count($initdir) > 0) {

        foreach ($initdir as $dirKey => $dirValue) {

            $curDirList[] = $dirname[$dirKey];            // 디렉토리명
        }
    }
    //^^^^^^^^^^^^^^^^^^^^^ /디렉토리 정렬 ^^^^^^^^^^^^^^^^^^^^^^^^^^^


    // 디렉토리 총 갯수
    $curDirTotal = count($curDirList);
    $curDirTotalM1 =  $curDirTotal - 1;

    // 1차 디렉토리 일 경우만
    if ($space == '0')
        $tplList = "<table border=0 cellpadding=0 cellspacing=0>";


    // 디렉토리 수만큼 출력
    for($z = 0; $z < $curDirTotal; $z++ ) {

        // 레이어 이름
        $layerID = $layerName . ($z + 1);

        // 출력용  test (/home/user/test 아님)
        $dirname = $curDirList[$z];

        // 루트가 아니면
        // /image (현재 디렉토리) -> /home/user/htdocs + /image
        if ($curdirName != $rcfg->initDirRoot)
            $dirnameTemp = $curdirName . DIRECTORY_SEPARATOR . $dirname; // 링크 및 퍼미션 구할때 사용
        else
            $dirnameTemp = $curdirName .  $dirname; 


        // 현재 열린 디렉토리가 아닐 경우 +
        if ( is_array($curdirPathNew) && !in_array($dirnameTemp, $curdirPathNew) ) {

            $iconFolder = $dcfg->iconFolder;

            // 맨 마지막이 아니면 아이콘에 꼬리 있음 |____
            //                                       |
            if ($z != $curDirTotalM1)
                $iconMark   = $dcfg->iconPlusB;
            else
                $iconMark   = $dcfg->iconPlusA;
            // 맨 마지막 아이콘에 꼬리 없음 |____
            //                                       

            $dirnameTempSub = $dirnameTemp;

        } else {
        // 현재 열린 디렉토리 일 경우 -

            $iconFolder = $dcfg->iconFolderOpen;

            if ($z != $curDirTotalM1)
                $iconMark   = $dcfg->iconMinusB;
            else
                $iconMark   = $dcfg->iconMinusA;

            // - 클릭, 더블클릭 했을 경우 한단계 앞 디렉토리로 이동하게 위해서
            // /home/test/user -> /home/test
            $dirnameTempSub = substr($dirnameTemp, 0, strrpos($dirnameTemp, '/'));

            if (!$dirnameTempSub)
                $dirnameTempSub = '/';

        }

        // 비교용 /home/test/user (단, 클릭에서도 사용한다)
    	$dirLinkOrigin = $dirnameTemp;

        // 디렉토리 퍼미션을 구한다
        //$dirperms = SkyFile::getPerms($dirnameTemp);
        $dirperms = 777; // 임시


         //  퍼미션 세번째 것이 5 가 아니면 접근할 수 없다.
        if ($ftp->isDirAccessPerms($dirperms, $dcfg->dirPerms)) {

            // 루트가 아니면
            if ($rcfg->initDirRight != "/") {
            
                $dirLinkOriginNew = ereg_replace($rcfg->initDirRight, "", $dirLinkOrigin);

                // 링크용 /home/test/user 
            	$dirLink =  urlencode(ereg_replace($rcfg->initDirRight, "", $dirnameTempSub));
            } else {

                $dirLinkOriginNew = $dirLinkOrigin;

                // 링크용 /home/test/user 
            	$dirLink =  urlencode($dirnameTempSub);

            }


            // 클릭했을 경우 클릭은 항상 $dirLinkOrigin 사용
            $clickLink = "OnClick=\"leftClick('" . urlencode($dirLinkOriginNew) . "');setBgcolor('$layerID');\"";

            // +, - 아이콘을 클릭했을 경우
            $clickIconLink = "OnClick=\"leftDblClick('$dirLink');setBgcolor('$layerID');\"";

            // 더블 클릭했을 경우
            $dblClickLink = "OnDblClick=\"leftDblClick('$dirLink');setBgcolor('$layerID');\"";
            $dBgColor = '';

            $layerIDTemp = '';
        }else{
        // 접근할 수 있는 디렉토리

           // 클릭했을 경우
           $clickLink = "";

           // 더블 클릭했을 경우
           $dblClickLink = ""; //"OnDblClick=\"alert('* Permissions : $dirperms !');\"";

           $dBgColor = ' bgcolor=' . $dcfg->dirNotBgcolor;

           $layerID = '';
        }


       // 현재 디렉토리이면 배경색을 다르게 하기 위해서 layer 이름 저장
       if ($dirLinkOrigin == $curdir) {
           
           $curdirLayerID = $layerID;
           $curdirLayerStyle = "background:$dcfg->divBgcolor";
       } else {

           $curdirLayerStyle  = '';
       }

    	$tplList .="
        <tr>
          <td id='$layerID' $dBgColor $dblClickLink $clickLink style=\"cursor: default;padding:0;maring:0;$curdirLayerStyle\" nowrap>
            $leftSpace<img src='$iconMark' width='19' height='16' border='0' align='absmiddle' $clickIconLink><img src='$iconFolder' width=16 height=16 align='absmiddle' border='0'>&nbsp;$dirname $layerIDTemp
          </td>
        </tr>";


        // /home/test 풀 패스로 비교할 것
        // 15 단계까지만
        // 소스 개선
        for ($zTemp = 1; $zTemp <= 15; $zTemp++) {

            // 선택된 디렉토리이면
            if ($dirLinkOrigin == $curdirPathNew[$zTemp]) {

                // left_a_ ...
                $leftLayerCode = "left_" . chr($zTemp + 96) . "_"; // 97(z) ~ 122(z)

                $tplList .= getDirList($curdirPathNew[$zTemp], $leftLayerCode , $zTemp);

            }
        }

        //if ($dirLinkOrigin  == $curdirPathNew[1])
        //    $tplList .= getDirList($curdirPathNew[1], 'lefta', 1);

        //else if ($dirLinkOrigin  == $curdirPathNew[2])
        //    $tplList .= getDirList($curdirPathNew[2], 'leftb', 2);

       
    } // foreach End


    // 1차 디렉토리 일 경우만
    if ($space == '0')
        $tplList .= "</table>";

    return $tplList;

} // getDirList


?>