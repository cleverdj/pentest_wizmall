<?php
/**
* 찾기
*
* @filename : php/file_search.php
* @version  : v 1.0 2003.07.18 18:28:12
* @author   : nsl <smpoem@magicn.com>
*/

set_time_limit(0);
$_HEADER_TITLE = ':: 찾기 :: ';

$_SKYDIR_URL = '../';

// 기본 설정 초기화
include '../common/skydir_init.php';

if ($wmode == "win")
    $bodyOnload = 'OnLoad="self.focus();window.onblur=function(){ if(!opener.closed) window.focus()};"';

include '../class/sky_html_class.php';
include '../class/PEAR/Find.php';
$find = new File_Find();

// 검색이면
if ($isSearch == 1) {

    // 파일, 디렉토리 검색시 옵션
    $ucfg->searchFileOption    = $searchFileOption;     // 파일
    $ucfg->searchFolderOption  = $searchFolderOption;   // 디렉토리
    $ucfg->searchEngOption     = $searchEngOption;      // 대소문자 구분
    $ucfg->searchSubdirOption     = $searchSubdirOption;      // 하위 폴더

    // 파일, 디렉토리 검색시 옵션 - 이번 검색시에도 적용을 위해서
    $rcfg->searchFileOption    = $searchFileOption;     // 파일
    $rcfg->searchFolderOption  = $searchFolderOption;   // 디렉토리
    $rcfg->searchEngOption     = $searchEngOption;     // 대소문자 구분
    $rcfg->searchSubdirOption     = $searchSubdirOption;      // 하위 폴더

    // 환경설정 저장 실패이면
    if ( !setConfigFile($dcfg->uconfigFile, $ucfg) ) {

       // 환경설정을 저장하는데 실패했습니다!
       jsAlertErrorMsg(":: $lg->configSaveError");   
    }

    // 검색어 ', " => 공백처리
    $keyword = preg_replace("/'/",  "", $keyword);
    $keyword = preg_replace("/\"/",  "", $keyword);

} // if End


// 옵션 체크
$fileOptionChk   = ( $ucfg->searchFileOption == 1 )   ? 'checked' : '';
$folderOptionChk = ( $ucfg->searchFolderOption == 1 ) ? 'checked' : '';
$engOptionChk    = ( $ucfg->searchEngOption == 1 )    ? 'checked' : '';
$subdirOptionChk    = ( $ucfg->searchSubdirOption == 1 )    ? 'checked' : '';


list($dirList, ) =  SkyFile::getCurDirList($rcfg->userHomeDir . getInitDirRight(), false);

array_unshift($dirList, '.');
// html 시작부
include (HEADER_FILE);

?>
<script language="javascript">
<!--

    function setWinClose() {

        if ( opener.closed )  window.close()
    }
//   setInterval("setWinClose()", 100); 


//-->
</script>
</head>
<body  leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" bgcolor="<?=$rcfg->winColor?>" <?=$dcfg->body?>>
<table border=0 cellpadding=0 cellspacing=0 width=98% height=98% align=center style="margin:5px">
<tr>
  <td>


<table style="border-width:0; border-color:white; border-style:solid;" border="1" width="100%" height="100%" bordercolordark="white" bordercolorlight="#333333" cellpadding=10>
<tr>

<td valign=top>

   <fieldset style="padding:5pt; width=95%" align=center>
    <legend><?=$lg->topSearch?></legend> 


      <script language="javascript">
      <!--

          function inputCheck() {

              var f = document.input;

              if (f.keyword.value == "") {
                  // 검색어를 입력하세요
                  alert(":: <?=$lg->searchKeywordError?>");
                  f.keyword.focus();
                  return false;
              }
          }
        //-->
       </script>
      <table border=0 cellpadding=0 cellspacing=0 valign=middle style="line-height:105%; margin-top:5px" width=100%>
      <tr>

      <form name=input method=post action="<?=$_SERVER['PHP_SELF']?>?>" OnSubmit="return inputCheck()">
      <input type=hidden name=wmode value="<?=$wmode?>">
      <input type=hidden name=isSearch value="1">

        <td>
        
        <table border=0>
          <tr>
            <td width=40><img src="../image/top_search.gif"></td>
            <td valign=top><?=$lg->searchMsg?></td>
          </tr>
        </table>            
          
          </td>
      </tr>     
      <tr>
        <td height=5></td>
      </tr>      
      <tr>
        <td height=20><?=$lg->searchLocation?></td>
      </tr>
      <tr>
        <td><?=SkyHtml::setSelectMenu('folder', $dirList, $dirList, $folder, '' , '  ', '')?></td>
      </tr>
      <tr>
        <td height=5></td>
      </tr>
      <tr>
        <td height=2><?=$lg->searchText?> : <span class="boldfont"><?=$lg->configExample?>) index.php, php, gif</span></td>
      </tr>
      <tr>
        <td> <input type=text name=keyword size=60 value='<?=$keyword?>' OnFocus="setSearchBut()"></td>
      </tr>
      <tr>
        <td height=5></td>
      </tr>
      <tr>
        <td height=20><?=$lg->searchOption?></td>
      </tr>
      <tr>
        <td>
           <input type=checkbox name=searchFileOption   value=1 <?=$fileOptionChk?>> <?=$lg->searchOptionFile?>&nbsp;&nbsp;
           <input type=checkbox name=searchFolderOption value=1 <?=$folderOptionChk?>> <?=$lg->searchOptionDirectory?>&nbsp;
           <input type=checkbox name=searchEngOption    value=1 <?=$engOptionChk?>> <?=$lg->searchOptionLower?>&nbsp;
           <input type=checkbox name=searchSubdirOption    value=1 <?=$subdirOptionChk?>> <?=$lg->searchOptionSubDirectory?>&nbsp;
        </td>
      </tr>
      <tr>
        <td height=15></td>
      </tr>
      <tr>
        <td>
        <table border=0 width=430>
        <tr>
          <td align=right><input type=submit value=" 찾 기 " class=but_config name=searchBut></td>
        </tr>
        </table>         
          
          </td>
      </tr>
      </table>

     </fieldset>

   <fieldset style="padding:5pt; width=95%" align=center>
    <legend><?=$lg->searchResult?></legend> 

      <table border=0 cellpadding=0 cellspacing=0 valign=middle style="line-height:105%; margin-top:5px" width=100%>
      <tr>
        <td height=5></td>
      </tr>      
      <tr>
        <td height=20>

        <table border=1 cellpadding=0 cellspacing=0 width=100%>
        <tr>
          <td>
<?
// preg_match 사용을 위해서 
$keywordNew = "/" . preg_quote($keyword) . "/";

// 대소문자 구분이 아니면
if ($rcfg->searchEngOption != 1)
    $keywordNew .= "i";

if ($folder != '.')
    $folder = $rcfg->userHomeDir . getInitDirRight() . '/' . $folder;
else
    $folder = $rcfg->userHomeDir . getInitDirRight();


if ( $isSearch == 1 && !empty($keyword) ) {

    // 디렉토리 검색 유무
    $isDirSearch  = ($rcfg->searchFolderOption == 1) ? true : false;

    // 파일 검색 유무
    $isFileSearch = ($rcfg->searchFileOption == 1) ? true : false;

    // 하위 디렉토리 까지 검색 유무
    $isSubdirSearch = ($rcfg->searchSubdirOption == 1) ? true : false;


    // 디렉토리 , 파일을 찾는다
    list($resultDir, $resultFile) = $find->search ($keywordNew, $folder, 'perl', $isDirSearch, $isFileSearch, $isSubdirSearch);

    $dirTotal = count($resultDir);
    // 디렉토리 검색결과
    foreach($resultDir AS $qKey => $qVal) {

        $qKeyPrint = $qKey + 1;

         // 루트가 아니면 
         $qVal = ereg_replace($rcfg->userHomeDir . getInitDirRight(), "", $qVal);


        // 디렉토리까지 색 변하는 것 수정하기
        $qVal = preg_replace("/($keyword)/i", "<font color=blue>\\1</font>", $qVal);


        $tplDir .=  "<tr><td>$qKeyPrint : $qVal </td></tr>\n";
    } // foreach End

    $fileTotal = count($resultFile);
    // 파일 검색결과
    foreach($resultFile AS $qKey => $qVal) {

        $qKeyPrint = $qKey + 1;

         // 루트가 아니면
        $qVal = ereg_replace($rcfg->userHomeDir . getInitDirRight(), "", $qVal);

        // 디렉토리까지 색 변하는 것 수정하기
        $qVal = preg_replace("/($keyword)/i", "<font color=blue>\\1</font>", $qVal);


        $tplFile .=  "<tr><td>$qKeyPrint : $qVal </td></tr>\n";
    } // foreach End
} // if End
?>
  <!-- 디렉토리 검색 결과 -->
  <fieldset style="padding:5pt; width=95%" align=center>
    <legend><?=$lg->searchOptionDirectory?> (Search : <font color=blue><?=$dirTotal?></font>) </legend> 

    <table border=0 cellpadding=0 cellspacing=0 valign=middle style="line-height:105%; margin-top:5px" width=100%>
    <tr>
      <td height=5></td>
    </tr>      
    <?=$tplDir?>
    </table>
  </fieldset>
  
  <!-- 파일 검색 결과 -->
  <fieldset style="padding:5pt; width=95%" align=center>
    <legend><?=$lg->searchOptionFile?> (Search : <font color=blue><?=$fileTotal?></font>)</legend> 

    <table border=0 cellpadding=0 cellspacing=0 valign=middle style="line-height:105%; margin-top:5px" width=100%>
    <tr>
      <td height=5></td>
    </tr>      
    <?=$tplFile?>
    </table>
  </fieldset>    


          </td>
        </tr>
        </table>

        </td>
      </tr>
    
      <tr>
        <td height=15></td>

      </tr>
      </table>

     </fieldset>
</td>
</tr>
</table>





  </td>
</tr>
<tr>
  <td height=30 valign=middle>

  <table border=0 cellpadding=0 cellspacing=0 valign=middle  align=center width=95%>
  <tr>
    <td height=5></td>
  </tr>
  <tr>
    <td align=right>
      <input type=button value="<?=$lg->butClose?> " class=but_config OnClick="window.close()"> 
    </td>

    </form>
  </tr>
  </table>

</tr>
<tr>
  <td height=5></td>
</tr>
</table>
<script language="javascript">
<!--

    // 찾기버튼 활성화
    function setSearchBut() {

        document.input.searchBut.disabled = false;
    }

//-->
</script>
</body>
</html>