<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/
?>
<?
set_time_limit (0);
//ini_set(max_input_time, 0);
//ini_set(max_execution_time, 0); 
//ini_set(upload_max_filesize, "100M");
//ini_set(post_max_size, "100M");
//ini_set(upload_tmp_dir, "/home/shopwiz/public_html/wizstock");
/* CATEGORY 가 없을 경우 $CATEGORY에 $BID를 넣는다. $CATEGORY는 한 테이블에서 여러가지 카테고리를 나눌경우 샤용 */
if(!$CATEGORY) $CATEGORY = 0;

$SUBJECT = trim($SUBJECT);
if(!$SUBJECT) $common->js_alert("제목이 빠졌네요^^");

/* DB에 저장될 DATA를 한 번 처리를 한다. */
//include "./wizboard/func/FILTERING.php";

include "./wizboard/func/FILTERING_Word.php";
if(!$NAME) $NAME	=  $cfg["member"]["mname"];
$NAME				= addslashes($NAME);
if(!$ID) $ID		=  $cfg["member"]["mid"];
if(!$EMAIL) $EMAIL	=  $cfg["member"]["email"];
if(!$IP) $IP		= $REMOTE_ADDR;

$CONTENTS = $common->puttrimstr($CONTENTS, $TxtType);
$SUB_CONTENTS1 = $common->puttrimstr($SUB_CONTENTS1, $TxtType);
$SUB_CONTENTS2 = $common->puttrimstr($SUB_CONTENTS2, $TxtType);
$SUBJECT = addslashes($SUBJECT);
$CONTENTS = addslashes($CONTENTS);
$THREAD = "A";
$COUNT = 1;
$W_DATE=time();
if(!$SDATE) $SDATE = time();


if($MultiFileValue){//다중파일 첨부로 넘어오는 경우(변도의 스킨 존재)
	$UPDIR1 = $MultiFileValue;
	$tmp = split("\|", $MultiFileValue);
	foreach($tmp as $key=>$value){
		if($value){
			copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
			unlink("./config/tmp_upload/".$value);
		}
	}
}else{
	$common->upload_path = "./config/wizboard/table/".$GID."/".$BID."/updir";
	$common->ProhibitExtention = $ProhibitExtention;
	
	//$option1 = $Filenamereserver;
	$common->uploadfile("file");
	
	if(is_array($common->returnfile)) foreach($common->returnfile as $key=>$value) $UPDIR1 = $value."|";

	//uploadfile($funcmode="insert", $file_field_name="file", $upload_path, $return1="UPDIR1", $return2="UPDIR2", $oldfilename1, $oldfilename2, $prohibitextension, $option1, $option2);
}
// 파일 업로딩 끝 
//$cfg["member"]["mid"]
//$cfg["member"]["mpasswd"]
//$cfg["member"]["mname"]
//$cfg["member"]["mgrade"]
//$cfg["member"]["mgrantsta"]
//$cfg["member"]["mlogindate"]
//$cfg["member"]["mpoint"]
//$cfg["member"]["mpointlogindate"]
//$cfg["member"]["adult"]
//$cfg["member"]["email"]



/* 패밀리 아이디 생성 */
$QUERY_STR = "SELECT max(FID)+1 FROM ${BOARD_NAME}";
$LIST = mysql_query($QUERY_STR);
$FID = mysql_result($LIST,0,0);

/* board DB에 처리된 값들을 INSERT 한다. */
$QUERY_STR = "INSERT INTO $BOARD_NAME (CATEGORY,ID,NAME,PASSWD,EMAIL,URL,SUBJECT,SUB_TITLE1,SUB_TITLE2,CONTENTS,SUB_CONTENTS1,SUB_CONTENTS2,THREAD,FID,COUNT,RECCOUNT,DOWNCOUNT,UPDIR1,IP,SPARE1,SDATE,W_DATE) 
VALUES('$CATEGORY','$ID','$NAME','$PASSWD','$EMAIL','$URL','$SUBJECT','$SUB_TITLE1','$SUB_TITLE2','$CONTENTS','$SUB_CONTENTS1','$SUB_CONTENTS2','$THREAD','$FID','$COUNT','$RECCOUNT','$DOWNCOUNT','$UPDIR1','$IP','$SPARE1','$SDATE','$W_DATE')"; 
//echo "\$QUERY_STR = $QUERY_STR";
//exit;
$RESULT=mysql_query($QUERY_STR) or die(mysql_error());
$insertedid = mysql_insert_id();
if(!$RESULT) $result_message = "data 입력중 오류가 발생하였습니다.";

//엮인글(트랙백)에 데이타 날리기
include_once ("./lib/class.trackback.php");
$tracback_wirte	= new tracbackcls();
$tracback_wirte->cfg = $cfg;
$url = $MART_BASEDIR."/wizboard.php?GID=".$GID."&BID=".$BID."&UID=".$insertedid."&mode=view";
$tracback_wirte->send_trackback($tb_url, $url, $SUBJECT, $NAME, $CONTENTS);

#포인트 입력하기
if($ID && $WritingPointEnable){
	$point = $WritingPoint;
	$content = "글작성포인트.";
	PointInsert($ID, $uid, $content, $point);	
}

/* 어드민에게 공지 메일 날리기 */
if($MailToAdmin == "1"){
if(file_exists("./config/admin_info.php")) include "./config/admin_info.php";
 $SEND_CONTENT = "<a href=\"$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID&category=$CATEGORY\">$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&category=$CATEGORY&mode=view&UID=$UID</a> <br> 작성자 : $NAME <br> <br> $CONTENTS ";
			$TO = $ADMIN_EMAIL;
			$from = "$NAME <$EMAIL>";
			$SUBJECT = "$NAME 님이 게시판에 글을 남겼습니다.";
			$SEND_CONTENT = "<IFRAME SRC='$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID' WIDTH=780 HEIGHT=700 FRAMEBORDER=0></IFRAME>";
			$from = "From:$from\nContent-Type:text/html";
			$result = mail($TO, $SUBJECT , $SEND_CONTENT , $from);
			if(!$result) echo "<script>window.alert('메일발송이 실패 하였습니다.');</script>";
			//echo "\$TO=$TO, \$SUBJECT = \$SUBJECT, \$from = $from <br>";
			//exit;
}
/* 메일보내기 끝 */



ECHO"<script>window.alert('자료가 성공적으로 등록되었습니다');location.replace('./wizboard.php?BID=$BID&GID=$GID&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY')</script>";
exit;


?>