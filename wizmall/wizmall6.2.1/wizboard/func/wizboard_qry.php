<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/

set_time_limit (0);
//ini_set(max_input_time, 0);
//ini_set(max_execution_time, 0); 
//ini_set(upload_max_filesize, "100M");
//ini_set(post_max_size, "100M");
if(!$TxtType) $TxtType=0;
if(!$RepleMail) $RepleMail=0;
if(!$Secret) $Secret=0;
if(!$MainDisplay) $MainDisplay=0;
$SPARE1 = $TxtType."|".$RepleMail."|".$Secret."|".$MainDisplay;
	

if(!$CATEGORY) $CATEGORY = 0;
$SUBJECT = trim($SUBJECT);
if(!$SUBJECT) $common->js_alert("제목이 빠졌네요^^");

## DB에 저장될 DATA를 한 번 처리를 한다. */
# 금지 단어 추출
$board->prohibitword($CONTENTS);
$board->prohibitword($SUBJECT);

if(!$NAME) $NAME	=  $cfg["member"]["mname"];
$NAME				= addslashes(trim($NAME));
//if(!$NAME) $NAME =  "admin";
		
if(!$ID) $ID		=  $cfg["member"]["mid"];
if(!$EMAIL) $EMAIL	=  $cfg["member"]["email"];
if(!$IP) $IP		= $REMOTE_ADDR;

$W_DATE=time();
if(!$SDATE) $SDATE = time();

$CONTENTS = $common->puttrimstr($CONTENTS, $TxtType);
$SUB_CONTENTS1 = $common->puttrimstr($SUB_CONTENTS1, $TxtType);
$SUB_CONTENTS2 = $common->puttrimstr($SUB_CONTENTS2, $TxtType);
$SUBJECT = addslashes($SUBJECT);
$CONTENTS = addslashes($CONTENTS);
	
	
				
		
switch($bmode){
	case "write":
		$THREAD = "A";
		$COUNT = 1;
		if($MultiFileValue){//다중파일 첨부로 넘어오는 경우(별도의 스킨 존재)
			$UPDIR1 = $MultiFileValue;
			$tmp = split("\|", $MultiFileValue);
			foreach($tmp as $key=>$value){
				if($value){
					copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
					unlink("./config/tmp_upload/".$value);
				}
			}
		}else{
			$common->upload_path = "./config/wizboard/table/".$GID."/".$BID."/updir";
			$common->ProhibitExtention = $cfg["wizboard"]["ProhibitExtention"];
			
			//$option1 = $Filenamereserver;
			$common->uploadfile("file");
			$UPDIR1 = "";
			if(is_array($common->returnfile)) foreach($common->returnfile as $key=>$value) $UPDIR1 .= $value."|";
		
			//uploadfile($funcmode="insert", $file_field_name="file", $upload_path, $return1="UPDIR1", $return2="UPDIR2", $oldfilename1, $oldfilename2, $prohibitextension, $option1, $option2);
		}
		// 파일 업로딩 끝 

		/* 패밀리 아이디 생성 */
		$FID = $dbcon->get_one(" select max(FID)+1 from ".$BOARD_NAME);

		
		/* board DB에 처리된 값들을 INSERT 한다. */
		$QUERY_STR = "INSERT INTO $BOARD_NAME (CATEGORY,ID,NAME,PASSWD,EMAIL,URL,SUBJECT,SUB_TITLE1,SUB_TITLE2,CONTENTS,SUB_CONTENTS1,SUB_CONTENTS2,THREAD,FID,COUNT,RECCOUNT,DOWNCOUNT,UPDIR1,IP,SPARE1,SDATE,W_DATE) 
		VALUES('$CATEGORY','$ID','$NAME','$PASSWD','$EMAIL','$URL','$SUBJECT','$SUB_TITLE1','$SUB_TITLE2','$CONTENTS','$SUB_CONTENTS1','$SUB_CONTENTS2','$THREAD','$FID','$COUNT','$RECCOUNT','$DOWNCOUNT','$UPDIR1','$IP','$SPARE1','$SDATE','$W_DATE')"; 

		$dbcon->_query($QUERY_STR);
		$insertedid = $dbcon->_insert_id();
		
		//엮인글(트랙백)에 데이타 날리기
		include_once ("./lib/class.trackback.php");
		$tracback_wirte	= new tracbackcls();
		$tracback_wirte->cfg = $cfg;
		$url = $MART_BASEDIR."/wizboard.php?GID=".$GID."&BID=".$BID."&UID=".$insertedid."&mode=view";
		$tracback_wirte->send_trackback($tb_url, $url, $SUBJECT, $NAME, $CONTENTS);
		
		#포인트 입력하기
		if($ID && $WritingPointEnable){
			$point = $WritingPoint;
			$content = "글작성포인트.";
			PointInsert($ID, $uid, $content, $point);	
		}
		
		/* 어드민에게 공지 메일 날리기 */
		if($MailToAdmin == "1"){
		 $SEND_CONTENT = "<a href=\"$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID&category=$CATEGORY\">$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&category=$CATEGORY&mode=view&UID=$UID</a> <br> 작성자 : $NAME <br> <br> $CONTENTS ";
					$TO = $cfg["admin"]["ADMIN_EMAIL"];
					$from = "$NAME <$EMAIL>";
					$SUBJECT = "$NAME 님이 게시판에 글을 남겼습니다.";
					$SEND_CONTENT = "<IFRAME SRC='$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID' WIDTH=780 HEIGHT=700 FRAMEBORDER=0></IFRAME>";
					$from = "From:$from\nContent-Type:text/html";
					$result = mail($TO, $SUBJECT , $SEND_CONTENT , $from);
					if(!$result) echo "<script>window.alert('메일발송이 실패 하였습니다.');</script>";
					//echo "\$TO=$TO, \$SUBJECT = \$SUBJECT, \$from = $from <br>";
					//exit;
		}
		/* 메일보내기 끝 */
				$getdata = $common->getencode("BID=$BID&GID=$GID&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY");
				$goto = "./wizboard.php?getdata=".$getdata;
				$str = "자료가 성공적으로 등록되었습니다";
				$common->js_alert($str, $goto);
		
	break;
	case "modify":
		/*** ADMIN 패스워드 가져오기 ******/
		$ADMINPWD = $dbcon->get_one("SELECT Pass FROM wizTable_Main WHERE BID='".$BID."' and GID='".$GID."'");
		
		//현재 수정하기 직적에 막기 때문에 이부분에 대한 프로그램 새로 할 것
		/*** 글 작성자 패스워드 및 업로딩 파일 가져오기 *****/
			$dbcon->_query("SELECT ID, PASSWD, UPDIR1 FROM $BOARD_NAME WHERE UID='$UID'");
			$LIST=$dbcon->_fetch_array();
		//	$UPDIRF = split("\|", $LIST[UPDIR1]); /* 현재 업로딩 된 파일 가져오기 */
			$LIST[PASSWD]=trim($LIST[PASSWD]);
			if($PASSWD && $PASSWD != $LIST[PASSWD] && $PASSWD !=$ADMINPWD[Pass]) { // 비회원 게시판으로 패스워드를 입력하는 폼이라면 입력된 패스워드를 상효 비교한다.
				$common->js_alert("글작성시 패스워드를 입력해주세요.");
			}else if (($_COOKIE[MODIFY] != $UID."_".$BID."_".$GID) ){ //회원전용폼으로 패스워드 입력란이 없으면 보드관리자가 아니고 super관리자가 아니면
		//현재 로그인된 아이디와 글작성시 아이디를 비교하여 수정여부를 선택한다. 
				$common->js_alert("등록자본인만이 수정가능합니다.");
			}else{ //마지막 까지 update flow start 
			
				if($MultiFileValue){//다중파일 첨부로 넘어오는 경우
					$UPDIR1 = $MultiFileValue;
					$tmp = split("\|", $MultiFileValue);
					foreach($tmp as $key=>$value){
						if($value){
							copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
							unlink("./config/tmp_upload/".$value);
						}
					}
				}else{	
					// 파일 업로딩 시작 
					
					$common->upload_path		= "./config/wizboard/table/".$GID."/".$BID."/updir";
					$common->ProhibitExtention	= $cfg["wizboard"]["ProhibitExtention"];
					$common->uploadmode			= "update";
					$common->oldfilename		= $LIST["UPDIR1"];
					$common->delfile			= $file_del;
					//$option1 = $Filenamereserver;
					$common->uploadfile("file");
					$UPDIR1 = "";
					if(is_array($common->returnfile)) foreach($common->returnfile as $key=>$value) $UPDIR1 .= $value."|";
					// 파일 업로딩 끝 	
				}	
				// 파일 업로딩 끝 
		
				/* board DB에 처리된 값들을 INSERT 한다. */
				
				
				$QUERY_STR = "UPDATE $BOARD_NAME SET CATEGORY='$CATEGORY',NAME='$NAME',EMAIL='$EMAIL',URL='$URL',SUBJECT='$SUBJECT',SUB_TITLE1='$SUB_TITLE1',
				SUB_TITLE2='$SUB_TITLE2',CONTENTS='$CONTENTS',SUB_CONTENTS1='$SUB_CONTENTS1',SUB_CONTENTS2='$SUB_CONTENTS2',UPDIR1='$UPDIR1',SPARE1='$SPARE1',SDATE='$SDATE'
				
				WHERE UID='$UID'";
				$RESULT=$dbcon->_query($QUERY_STR);

				if($flag == "write_only") $tmode = "write";
				else $tmode = "";
				$getdata = $common->getencode("BID=$BID&GID=$GID&mode=$tmode&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY_IN&mode=view&UID=$UID&cp=$cp&BOARD_NO=$BOARD_NO");
				$common->js_location("./wizboard.php?getdata=".$getdata);
			}
	break;
	case "reply":
		if(substr($SUBJECT,0,4)=="Re: ") $SUBJECT=substr($SUBJECT,4);
		//echo "\$CONTENTS1 = $CONTENTS <br>";
		$CONTENTSOri = split("\[원본내용]", $CONTENTS);
		$CONTENTS = addslashes($CONTENTSOri[0]);
		$THREAD = "A";
		$COUNT = 1;
		$NEW_THREAD="A";
		
		
		if($MultiFileValue){//다중파일 첨부로 넘어오는 경우
			$UPDIR1 = $MultiFileValue;
			$tmp = split("\|", $MultiFileValue);
			foreach($tmp as $key=>$value){
				if($value){
					copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
					unlink("./config/tmp_upload/".$value);
				}
			}
		}else{
			// 파일 업로딩 시작 
			if($GID) $upload_path = "./config/wizboard/table/".$GID."/".$BID."/updir";
			else $upload_path = "./config/wizboard/table/".$BID."/updir";
			$prohibitextension = $cfg["wizboard"]["ProhibitExtention"];
			$option1 = $Filenamereserver;
			uploadfile($funcmode="insert", $file_field_name="file", $upload_path, $return1="UPDIR1", $return2="UPDIR2", $oldfilename1, $oldfilename2, $prohibitextension, $option1, $option2);
			// 파일 업로딩 끝 
		}
		
				$dbcon->_query("SELECT FID,THREAD,EMAIL,SPARE1 FROM $BOARD_NAME WHERE UID='$UID'");
				$LIST = $dbcon->_fetch_array();
				$CURRENT_FID	= $LIST["FID"];
				$CURRENT_THREAD	= $LIST["THREAD"];
				$CURRENT_EMAIL	= $LIST["EMAIL"];
				
				if(!$CURRENT_FID){//참조아이디가 없거나 삭제된경우
					$common->js_alert("존재하지 않는 게시물에 리플을 달수가 없습니다.");
				}		

				$LIST = $dbcon->get_one("SELECT right(THREAD,1) from $BOARD_NAME WHERE FID='$CURRENT_FID' and length('$CURRENT_THREAD')+1=length(THREAD) and locate('$CURRENT_THREAD',THREAD)=1 order by THREAD DESC limit 0,1");
				if($LIST) {
					$MORE_THREAD=$LIST[0];
					$FUTURE_THREAD=$CURRENT_THREAD.chr(ord($MORE_THREAD)+1);
				} else {
					$FUTURE_THREAD=$CURRENT_THREAD."A";
				}
		
		
		$SQL_STR="INSERT INTO $BOARD_NAME set CATEGORY='$CATEGORY',ID='$ID', NAME='$NAME', PASSWD='$PASSWD', EMAIL='$EMAIL',URL='$URL', SUBJECT='$SUBJECT', 
		SUB_TITLE1='$SUB_TITLE1', SUB_TITLE2='$SUB_TITLE2',CONTENTS='$CONTENTS', SUB_CONTENTS1='$SUB_CONTENTS1', SUB_CONTENTS2='$SUB_CONTENTS2',
		 FID='$CURRENT_FID', THREAD='$FUTURE_THREAD', W_DATE='$W_DATE',COUNT='$COUNT', UPDIR1='$UPDIR1', SPARE1='$SPARE1',SDATE='$SDATE'";
		
		$SQL_QRY=$dbcon->_query($SQL_STR);
				
		#포인트 입력하기
		if($ID && $WritingPointEnable){
			$point = $WritingPoint;
			$content = "글작성포인트.";
			PointInsert($ID, $uid, $content, $point);	
		}
		
		/* Mail_Receive = 1 이면 Writer_Email 메일을 보낸다. */
		if($RepleMail == "1" && $CURRENT_EMAIL){
			 $SEND_CONTENT = "<a href=\"".$cfg["admin"]["MART_BASEDIR"]."/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID&category=$CATEGORY&tableskin=skip\">".$cfg["admin"]["MART_BASEDIR"]."/wizboard.php?BID=$BID&GID=$GID&category=$CATEGORY&mode=view&UID=$UID</a> <br> 작성자 : $NAME <br> <br> $CONTENTS ";
			$TO = $CURRENT_EMAIL;
			$from = "$NAME <$EMAIL>";
			$SUBJECT = "답변글이 도착하였습니다.";
			$from = "From:$from\nContent-Type:text/html";
			$result = mail($TO, $SUBJECT , $SEND_CONTENT , $from);
			if(!$result) $common->js_alert("메일발송이 실패 하였습니다.", "", "alert");
		}

		if($flag == "write_only") $tmode = "write";
		else $tmode = "";
		$getdata = $common->getencode("BID=$BID&GID=$GID&mode=$tmode&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY&cp=${cp}");
		$common->js_location("./wizboard.php?getdata=".$getdata);
	break;
}
?>