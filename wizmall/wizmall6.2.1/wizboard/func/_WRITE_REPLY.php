<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/
?>
<?
/* CATEGORY 가 없을 경우 $CATEGORY에 $BID를 넣는다. $CATEGORY는 한 테이블에서 여러가지 카테고리를 나눌경우 샤용 */
if(!$CATEGORY) $CATEGORY = 0;
/* DB에 저장될 DATA를 한 번 처리를 한다. */
//include "./wizboard/func/FILTERING.php";
//include "./wizboard/func/FILTERING_Word.php";
if(!$NAME && $_COOKIE[MEMBER_NAME]) $NAME =  "$_COOKIE[MEMBER_NAME]";
else if(!$NAME) $NAME =  "admin";
$NAME = addslashes($NAME);
if(!$ID && $_COOKIE[MEMBER_ID]) $ID =  "$_COOKIE[MEMBER_ID]";
if(!$IP) $IP = $REMOTE_ADDR;

if(substr($SUBJECT,0,4)=="Re: ") $SUBJECT=substr($SUBJECT,4);
//echo "\$CONTENTS1 = $CONTENTS <br>";
$CONTENTSOri = split("\[원본내용]", $CONTENTS);
$SUBJECT = addslashes($SUBJECT);
//echo "\$CONTENTS2 \ $CONTENTSOri[0] <br>";
$CONTENTS = addslashes($CONTENTSOri[0]);
//echo "\$CONTENTS3 \ $CONTENTS <br>";
//exit;
$THREAD = "A";
$W_DATE=time();
$COUNT = 1;
$NEW_THREAD="A";


if($MultiFileValue){//다중파일 첨부로 넘어오는 경우
	$UPDIR1 = $MultiFileValue;
	$tmp = split("\|", $MultiFileValue);
	foreach($tmp as $key=>$value){
		if($value){
			copy("./config/tmp_upload/".$value, "./config/wizboard/table/".$GID."/".$BID."/updir/".$value);
			unlink("./config/tmp_upload/".$value);
		}
	}
}else{
	// 파일 업로딩 시작 
	if($GID) $upload_path = "./config/wizboard/table/".$GID."/".$BID."/updir";
	else $upload_path = "./config/wizboard/table/".$BID."/updir";
	$prohibitextension = $ProhibitExtention;
	$option1 = $Filenamereserver;
	uploadfile($funcmode="insert", $file_field_name="file", $upload_path, $return1="UPDIR1", $return2="UPDIR2", $oldfilename1, $oldfilename2, $prohibitextension, $option1, $option2);
	// 파일 업로딩 끝 
}

		$SQL_STR="SELECT FID,THREAD,EMAIL,SPARE1 FROM $BOARD_NAME WHERE UID='$UID'";
		$SQL_QRY=mysql_query($SQL_STR);

		$CURRENT_FID=mysql_result($SQL_QRY,0,FID);
		$CURRENT_THREAD=mysql_result($SQL_QRY,0,THREAD);
		$CURRENT_EMAIL=mysql_result($SQL_QRY,0,EMAIL);
		
		if(!$CURRENT_FID){//참조아이디가 없거나 삭제된경우
			echo "<script>alert('존재하지 않는 게시물에 리플을 달수가 없습니다.');history.go(-1);</script>";
			exit;
		}		
		//$CURRENT_SPARE1=mysql_result($SQL_QRY,0,SPARE1);
		//$SPARE1 = split("\|", $CURRENT_SPARE1);
		//$TxtType = $SPARE1[0];
		//$RepleMail = $SPARE1[1];
		//$Secret = $SPARE1[2];
		$SQL_STR_REPLY="SELECT right(THREAD,1) from $BOARD_NAME WHERE FID='$CURRENT_FID' and length('$CURRENT_THREAD')+1=length(THREAD) and locate('$CURRENT_THREAD',THREAD)=1 order by THREAD DESC limit 0,1";
		$SQL_QRY=mysql_query($SQL_STR_REPLY);
		if($LIST=@mysql_fetch_array($SQL_QRY)) {
			$MORE_THREAD=$LIST[0];
			$FUTURE_THREAD=$CURRENT_THREAD.chr(ord($MORE_THREAD)+1);
		} else {

			$FUTURE_THREAD=$CURRENT_THREAD."A";
		}


		# $SQL_STR="SELECT UID FROM $BOARD_NAME ORDER BY UID DESC";

		# $SQL_QRY=mysql_query($SQL_STR);



$SQL_STR="INSERT INTO $BOARD_NAME set CATEGORY='$CATEGORY',ID='$ID', NAME='$NAME', PASSWD='$PASSWD', EMAIL='$EMAIL',URL='$URL', SUBJECT='$SUBJECT', 
SUB_TITLE1='$SUB_TITLE1', SUB_TITLE2='$SUB_TITLE2',CONTENTS='$CONTENTS', SUB_CONTENTS1='$SUB_CONTENTS1', SUB_CONTENTS2='$SUB_CONTENTS2',
 FID='$CURRENT_FID', THREAD='$FUTURE_THREAD', W_DATE='$W_DATE',COUNT='$COUNT', UPDIR1='$UPDIR1', SPARE1='$SPARE1',SDATE='$SDATE'";

$SQL_QRY=mysql_query($SQL_STR) or die(mysql_error());

#포인트 입력하기
if($ID && $WritingPointEnable){
	$point = $WritingPoint;
	$content = "글작성포인트.";
	PointInsert($ID, $uid, $content, $point);	
}

/* Mail_Receive = 1 이면 Writer_Email 메일을 보낸다. */
if(is_file("./config/admin_info.php")) include "./config/admin_info.php";
if($RepleMail == "1" && $CURRENT_EMAIL){
 $SEND_CONTENT = "<a href=\"$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&mode=view&UID=$UID&category=$CATEGORY&tableskin=skip\">$MART_BASEDIR/wizboard.php?BID=$BID&GID=$GID&category=$CATEGORY&mode=view&UID=$UID</a> <br> 작성자 : $NAME <br> <br> $CONTENTS ";
			$TO = $CURRENT_EMAIL;
			$from = "$NAME <$EMAIL>";
			$SUBJECT = "답변글이 도착하였습니다.";
			// $SEND_CONTENT = "<IFRAME SRC='$MART_BASEDIR/wizboard.php?BID=$BID&mode=view&UID=$UID' WIDTH=780 HEIGHT=700 FRAMEBORDER=0></IFRAME>";
			$from = "From:$from\nContent-Type:text/html";
			$result = mail($TO, $SUBJECT , $SEND_CONTENT , $from);
			if(!$result) echo "<script>window.alert('메일발송이 실패 하였습니다.');</script>";
			//echo "result = $result <br>";
			//echo "\$TO=$TO, \$SUBJECT = \$SUBJECT, \$from = $from <br>";
			//exit;
}
/* 메일보내기 끝 */
//echo "RepleMail = $RepleMail,CURRENT_EMAIL = $CURRENT_EMAIL <br>";
//exit;
if($flag == "write_only") $tmode = "write";
else $tmode = "";
ECHO "<script>location.replace('./wizboard.php?BID=$BID&GID=$GID&mode=$tmode&adminmode=$adminmode&optionmode=$optionmode&category=$CATEGORY&cp=${cp}');</script>";
exit;

?>