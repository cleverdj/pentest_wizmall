<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/

include "../lib/cfg.common.php";
include "../config/db_info.php";

include "../lib/class.database.php";
$dbcon	= new database($cfg["sql"]);

include "../lib/class.common.php";
$common = new common();
$common->db_connect($dbcon);
$common->pub_path = "../";
$cfg["member"] = $common->getLogininfo();//로그인 정보를 가져옮

$BOARD_NAME="wizTable_${GID}_${BID}";


if($mode=="ok") {
	if($UID=='') {
		$str = "잘못된 경로의 접근입니다.";
		$goto = "../wizboard.php?BID=$BID&GID=$GID";
		$common->js_alert($str, $goto);
	}

/* 현재 삭제될 글의 상세정보를 가져온다 */
$sqlstr="SELECT ID,NAME,PASSWD,EMAIL,THREAD,FID,UPDIR1 FROM $BOARD_NAME WHERE UID='$UID'";
$dbcon->_query($sqlstr);
$LIST=$dbcon->_fetch_array();

/*** ADMIN 패스워드 가져오기 ******/
$sqlstr="SELECT Pass FROM wizTable_Main WHERE BID='$BID' and GID='$GID'";
$ADMINPWD=$dbcon->get_one($sqlstr);

/*** 글 작성자 패스워드 가져오기 *****/
if($member != "1"){ //회원제가 아닐경우
	$LIST[PASSWD]=trim($LIST[PASSWD]);
	if($passwd != $LIST[PASSWD] && $passwd !=$ADMINPWD) {
		$common->js_alert("패스워드가 틀립니다.");
	}
}else if(!$_COOKIE[BOARD_PASS] && !$_COOKIE[ROOT_PASS]){ //회원제일 경우 로그인 여부를 책크 및 로그인 아이디및 게시판 아이디 필드를 비교한다. 
	if(!$cfg["member"]){
		$str = "글을 삭제할 권한이 없습니다 \\n\\n 먼저 로그인 하여 주시기 바랍니다.";
		$common->js_windowclose($str);
	}else if(!trim($LIST[ID]) || ($cfg["member"]["mid"] != $LIST[ID])){
		$str = "글을 삭제할 권한이 없습니다 \\n\\n 글작성시 아이디로 로긴 하여 주시기 바랍니다.";
		$common->js_windowclose($str);
	}
}

##만약지우려는 글에 하위리플(리스트에서의 리플)이 달려있는 경우는 삭제불가능 */
$ReplyComment = $LIST[THREAD]."A";
$Sqlstr = "select count(UID) from $BOARD_NAME where FID = '$LIST[FID]' AND THREAD = '$ReplyComment'";
$count = $dbcon->get_one($Sqlstr);
if($count > 0){
	$str = "리플이 달린 글은 지울수 없습니다.";
	$common->js_windowclose($str);
}


/******** 업로딩된 파일 삭제 **************/
$Updir = split("\|", $LIST[UPDIR1]);
	for($i=0; $i < sizeof($Updir); $i++){
		if($Updir[$i] && is_file("../config/wizboard/table/$GID/${BID}/updir/$Updir[$i]")) {
			unlink("../config/wizboard/$GID/$BID/updir/$Updir[$i]");
		}
	}

	// 현재 wizboard ver에서는 UPDIR2는 업로딩용으로 사용하지 않고 있슴
	//if($LIST[UPDIR2] && file_exists("./table/$BID/updir/$LIST[UPDIR2]")) {
	//	unlink("./table/$BID/updir/$LIST[UPDIR2]");
	//}
	
/******* 리플 테이블로 부터 정보 삭제 *********/
$SQL_STR="DELETE FROM {$BOARD_NAME}_reply WHERE MID='$UID'";

	$dbcon->_query($SQL_STR);

/******* 포인터 점수 삭제 *********/
if($LIST["ID"] && $WritingPointEnable){
	$point = -$WritingPoint;
	$content = "글삭제포인트.";
	PointInsert($LIST["ID"], $uid, $content, $point);
}

/******* 테이블로 부터 정보 삭제 *********/
	$SQL_STR="DELETE FROM $BOARD_NAME WHERE UID='$UID'";
	$dbcon->_query($SQL_STR);
	$common->js_windowclose("게시물을 삭제했습니다.", "../wizboard.php?BID=$BID&GID=$GID&category=$category&adminmode=$adminmode&optionmode=$optionmode&cp=$cp");
}
?>
<head><title>글 삭제</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<script language="JavaScript">
<!--
function sSubmit(){
var f =  document.delete_form;
checkenable = new Array(); 
    if(f.checkenable && !f.member.checked){
    var checkenablelen = f.checkenable.length
        for (i = 0; i < checkenablelen; i++){
            if(f.checkenable[i].value == ""){
            alert(f.checkenable[i].title);
            f.checkenable[i].focus();
            return false;
            }
        }
        if(!checkenablelen && f.checkenable.value == ""){
        alert(f.checkenable.title);
        f.checkenable.focus();
        return false;
        }
    }
	
    f.submit();
}
//-->
</script> 
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<center>
<?
/* 회원 및 비회원게시판일 경우(즉, 패스워드 입력이 있고 없고에 따라 삭제 모드 표시를 달리 한다. */
$sqlstr="SELECT ID FROM $BOARD_NAME WHERE UID='$UID'";
$isID = $dbcon->get_one($sqlstr);

if(!$isID && !$_COOKIE[BOARD_PASS] && !$_COOKIE[ROOT_PASS]): //회원제 전용이 아닐 경우(즉, 패스워드 폼이 필요없을 경우)
?>
  <table width="100%" height="100%" border=0 cellpadding="0" cellspacing="0" style=font-family:'굴림';font-size:12px;line-height:20px;color:#333333>
    <form name="delete_form" action="<?=$PHP_SELF?>" method=post>
      <input type='hidden' name='mode' value='ok'>
      <input type='hidden' name='UID' value='<?=$UID?>'>
	  <input type='hidden' name='GID' value='<?=$GID?>'>
	  <input type='hidden' name='BID' value='<?=$BID?>'>
      <input type='hidden' name='cp' value='<?=$cp?>'>
      <input type='hidden' name='category' value='<?=$category?>'>
	  <input type='hidden' name='adminmode' value='<?=$adminmode?>'>
	  <input type='hidden' name='optionmode' value='<?=$optionmode?>'>
      <tr align="center"> 
        <td height="5" bgcolor="#999999"></td>
      </tr>	  
      <tr align="center"> 
        <td height="50" bgcolor="#EEEEEE">글 작성 시의 <strong><font color="#0000FF">비밀번호</font></strong>를 
          입력해주세요<br>
          삭제된 글은 <font color="#FF0000">복구가 불가능</font>합니다.</td>
      </tr>
      <tr> 
        <td height="30" align="center">비밀번호: 
          <input type="password" name="passwd" size="10" style='BACKGROUND-COLOR: white; BORDER: 1; HEIGHT: 18px; border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid;' id="checkenable" title="비밀번호를 입력해 주세요";>
          <input type="checkbox" name="member" value="1">
          회원제</td>
      </tr>
      <tr> 
        <td align="center" bgcolor="#EEEEEE" height="100%"><input type="button" value="삭제하기" onClick="javascript:sSubmit();" style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; height:40;">&nbsp;<input type="button" value="취소하기" onClick="javascript:window.close();" style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; height:40;"></td>
      </tr>
    </form>
  </table>
  <script language="JavaScript">
<!--
document.delete_form.passwd.focus();
//-->
</script>  
<? 
else: //회원제 전용일 경우 
?>  
  <table width="100%" height="100%" border=0 cellpadding="0" cellspacing="0" style=font-family:'굴림';font-size:12px;line-height:20px;color:#333333>
    <form name="delete_form" action="<?=$PHP_SELF?>" method=post>
      <input type='hidden' name='mode' value='ok'>
      <input type='hidden' name='UID' value='<?=$UID?>'>
      <input type='hidden' name='cp' value='<?=$cp?>'>
      <input type='hidden' name='BID' value='<?=$BID?>'>
	  <input type='hidden' name='GID' value='<?=$GID?>'>
	  <input type='hidden' name='category' value='<?=$category?>'>
	  <input type="hidden" name="member" value="1">
	  <input type='hidden' name='adminmode' value='<?=$adminmode?>'>
	  <input type='hidden' name='optionmode' value='<?=$optionmode?>'>
      <tr align="center"> 
        <td height="5" bgcolor="#999999"></td>
      </tr>	  
      <tr align="center"> 
        <td height="50" bgcolor="#EEEEEE"><br>
          삭제된 글은 <font color="#FF0000">복구가 불가능</font>합니다.</td>
      </tr>
      <tr> 
        <td height="30" align="center">정말삭제하시겠습니까?</td>
      </tr>
      <tr> 
        <td align="center" bgcolor="#EEEEEE" height="100%"><input type="button" value="삭제하기" onClick="javascript:sSubmit();" style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; height:40;">&nbsp;<input type="button" value="취소하기" onClick="javascript:window.close();" style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; height:40;"></td>
      </tr>
    </form>
  </table>  
<?
endif;
?>  
  </center>
</body>
</html>