<?php
/**
* 기본환경설정 저장 uconfig.php
*
* @filename : php/uconfig_save.php
* @version  : v 1.0 2003.07.18 18:30:25
* @author   : nsl <smpoem@magicn.com>
*/

include '../common/skydir_init.php';

// ftp class 초기화
$ftp = new SkyFtp($rcfg->ftpHost, $rcfg->ftpPort, $rcfg->ftpUserID, $rcfg->ftpUserPW);
// ftp 연결
if (!$ftp->ftpLogin()) {

    $ftp->ftpClose();
    $isFtpCon = false;
}
$ftp->ftpClose();
?>
<script language="javascript">
<!--
    // uconfig_save.php 에도 있음
    function configWinClose() {

       <?  
           // 이렇게 구분하지 않으면 자바스크립트 에러남
           // FTP 연결이면
           if ($code == "connect_win") {

                $initDirRight = trim($initDirRight);

                // /home/test/ -> /home/test   
                $initDirRight = trim(preg_replace("/(\/{1,}$)/", "", $initDirRight) );

                // /home/test -> home/test
                $initDirRight = trim(preg_replace("/^(\/{1,})/", "", $initDirRight) );
        ?>
               //var cd = '/<?=$initDirRight?>&changeDir=ok';
               var cd = '';

       <?
           } else if ($isFtpCon) {
       ?>
           var cd =  parent.opener.top.right.layerCode.cd.value;
       <?
           } else { 
           // 접속 실패이면 초기 디렉토리
       ?>
           var cd = '<?=$rcfg->initDirRight?>';
       <? } ?>

       parent.opener.top.dtop.location.href =  '../main/<?=$dcfg->topFile?>' + '?cd=' + cd;
       parent.opener.top.left_top.location.href =  '../main/left_top.php' + '?cd=' + cd;
       parent.opener.top.left.location.href =  '../main/<?=$dcfg->leftFile?>' + '?cd=' + cd;
       parent.opener.top.right.location.href = '../main/<?=$dcfg->rightFile?>?rf=1' + '&cd=' + cd;
      //parent.opener.top.location.reload();
       window.close();
    }

//-->
</script>
<?
switch($code) {

    // 기본 환경
    case 'config_init'  : setConfigInit(); break;

    // 사용자 정보
    case 'config_user'  : setConfigUser(); break;

    // 텍스트 확장자
    case 'config_ascii'  : setConfigAscii(); break;

    // 선택사항
    case 'config_options' : setConfigOptions(); break;

    // 로그
    case 'config_logs' : setConfigLogs(); break;

    // 배경이미지
    case 'config_background' : setConfigBackground(); break;

    // 이미지관련
    case 'config_image' : setConfigImage(); break;

    // FTP 연결정보
    case 'connect_win' : setConnectWin(); break;

    default :

} // switch End

// 환경설정 반영
if ( setConfigFile($dcfg->uconfigFile, $ucfg) ) {

    //  되돌아갈 url  &&     적용 버튼 클릭이면
    if ( !empty($url) && $apply == 'ok' ) {

        metaGo("$url?wmode=$wmode&code=$code&reload=1");
    } else {
    // 확인 버튼 클릭

       echo "<script language=javascript>\n";
       echo "<!--\n";
       echo "configWinClose();";
       echo "//-->\n";
       echo "</script>\n";
    }

} else {

   // 환경설정을 저장하는데 실패했습니다!
   jsAlertErrorMsg(":: $lg->configSaveError");
   
}
exit();


// 기본 환경
function setConfigInit() {

    global $ucfg;
    global $rcfg;
    global $lg;

    // ftp class 초기화
    $ftp = new SkyFtp($rcfg->ftpHost, $rcfg->ftpPort, $rcfg->ftpUserID, $rcfg->ftpUserPW);

    // ftp 연결
    $ftp->ftpLogin();

    @extract($_POST, EXTR_SKIP);

    if ( empty($initDomain) || empty($initDocumentRoot)  ) {

        // 모든 정보를 입력하세요 !
        jsAlertErrorMsg(":: $lg->configSaveInputError");    
    }

    $ucfg->initDocumentRoot = trim($initDocumentRoot);
    $ucfg->initDomain       = trim($initDomain);

//^^^^^^^^^^^^^^^^ $ucfg->initDirRight -> setConnectWin() 로 옮김 ^^^^^^^^^^^^^^^^^^^^
//    $ucfg->initDirRight     = trim($initDirRight);

    // /home/test/ -> /home/test   
//    $ucfg->initDirRight = trim(preg_replace("/(\/{1,}$)/", "", $ucfg->initDirRight) );

    // /home/test -> home/test
//    $ucfg->initDirRight = trim(preg_replace("/^(\/{1,})/", "", $ucfg->initDirRight) );

//^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    // 맨 끝에 / 가 있으면 제거
    if ($ucfg->initDocumentRoot != "/" && substr($ucfg->initDocumentRoot, -1, 1) == "/")
        $ucfg->initDocumentRoot = substr($ucfg->initDocumentRoot, 0, -1);

    if ($ucfg->initDomain != "/" && substr($ucfg->initDomain , -1, 1) == "/")
        $ucfg->initDomain  = substr($ucfg->initDomain , 0, -1);

  
    // 언어
    $ucfg->language = $language;

    if (!@is_dir($ucfg->initDocumentRoot)) // 이 디렉토리는 서버상에 존재하지 않습니다!
        jsAlertErrorMsg("* $initDocumentRoot \\n\\n  $lg->configSaveDirError");    

//    if (!empty($ucfg->initDirRight) && !@ftp_chdir($ftp->ftpCon, $ucfg->initDirRight))
//        jsAlertErrorMsg("* $initDirRight \\n\\n  $lg->configSaveDirError");    

    // ftp close
    $ftp->ftpClose();


} // setConfigInit() End

// 사용자 정보
function setConfigUser() {

    global $ucfg;
    global $lg;

    @extract($_POST, EXTR_SKIP);

    $userid    =    base64_encode($userid);
    $passwd    = getCrypt($passwd);
    $passwdcur = getCrypt($passwdcur);
    $passwdre  = getCrypt($passwdre);

    if ( empty($userid) || empty($passwdcur) || empty($passwd)  || empty($passwdre) ) {

        // 모든 정보를 입력하세요 !
        jsAlertErrorMsg(":: $lg->configSaveInputError");
    }

    if ($ucfg->superPW != $passwdcur) {

        // 현재 비밀번호가 정확하지 않습니다!
        jsAlertErrorMsg(":: $lg->configSaveCurPasswdError");
    }

    if ( empty($passwd) != empty($passwdre) ) {

        // 비밀번호와 비밀번호확인 은 같아야 합니다!
        jsAlertErrorMsg(":: $lg->configPasswdInputError");
    }


    // 사용자 아이디
    $ucfg->superID = $userid;

    // 사용자 비밀번호
    $ucfg->superPW = $passwd;


} // setConfigInit() End


// 텍스트 확장자
function setConfigAscii() {

    global $ucfg;

    @extract($_POST, EXTR_SKIP);

    $ascii = explode("┃", $ascii);

    unset($ascii[0]);
    
    @sort($ascii);

    $ucfg->textViewExt = $ascii;


} // setConfigAscii() End


// 선택사항
function setConfigOptions() {

    global $ucfg;

    @extract($_POST, EXTR_SKIP);
    
    $ucfg->isLog = $isLog; // 로그 남기기 유무
    $ucfg->isOnClickFolderOpen = $isOnClickFolderOpen; // 한번 클릭으로 폴더열기
    $ucfg->isWindowInitSize = $isWindowInitSize; // 마지막 원도우 크기로 실행


} // setConfigOptions() End


// 로그
function setConfigLogs() {

    global $ucfg;

    @extract($_POST, EXTR_SKIP);
    
    $ucfg->isLog = $isLog; // 로그 남기기 유무

    // 로그 지움
    if ($isLogDel)
        setMyLog("", true);

} // setConfigLogs() End

// 배경이미지
function setConfigBackground() {

    global $dcfg;
    global $ucfg;

    @extract($_POST, EXTR_SKIP);
    

    $ucfg->rightBgImage = $bg; // 이미지
    $ucfg->rightBgImageRepeat = $repeat; // 반복
    $ucfg->rightBgImagePos = $pos; // 위치
    $ucfg->rightBgImageOpacity = $opacity; // 투명도

} // setConfigBackground() End

// 이미지관련
function setConfigImage() {

    global $dcfg;
    global $ucfg;

    @extract($_POST, EXTR_SKIP);
    
    // 미리 읽을 이미지 로딩 최대 갯수
    $ucfg->imgReloadMax = $imgReloadMax;

    // 단위 MByte, 1M당 약 20M의 메모리 소요
    $ucfg->imgReloadMaxSize = $imgReloadMaxSize;

    // 이미지 모드
    $ucfg->imgThumbnailWidth  = $imgThumbnailWidth;
    $ucfg->imgThumbnailHeight = $imgThumbnailHeight;

} // setConfigImage() End


// 기본 환경
function setConnectWin() {

    global $sky;
    global $ucfg;
    global $rcfg;
    global $lg;

    @extract($_POST, EXTR_SKIP);

    if ( empty($ftpHost) || empty($ftpUserID) || empty($ftpUserPW) || empty($ftpPort) ) {

        // 모든 정보를 입력하세요 !
        jsAlertErrorMsg(":: $lg->configSaveInputError");  
    }

    $ucfg->ftpHost   = trim($ftpHost);
    $ucfg->ftpUserID = trim($ftpUserID);             
    $ucfg->ftpUserPW = trim($ftpUserPW);
    $ucfg->ftpPort   = trim($ftpPort);
    $ucfg->ftpPassiveMode = trim($ftpPassiveMode);

    // nFTP가 설치된 서버로만 접속가능
    if ($ucfg->ftpHost != "localhost" && $ucfg->ftpHost != $_SERVER['SERVER_ADDR']) {

        // nFTP가 설치된 서버로만 연결이 가능합니다! FTP 주소를 확인해주세요!
        jsAlertErrorMsg(":: $lg->conFtpHostCurError");        
    }

    //^^^^^^^^^^^^^^^^^^^^^^^^^^ 연결 정보가 맞는지 접속 테스트 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    // ftp class 초기화
    $ftp = new SkyFtp($ucfg->ftpHost, $ucfg->ftpPort, $ucfg->ftpUserID, $ucfg->ftpUserPW);

    if (!$ftp->ftpCon()) {

        // FTP 주소, 포트 정보가 틀렸습니다!
        jsAlertErrorMsg(":: $lg->conFtpHostError");
    }

    // ftp 연결
    if (!$ftp->ftpLogin()) {

        // 아이디, 비밀번호가 틀렸습니다!
        jsAlertErrorMsg(":: $lg->conFtpIDError");
    }
    //^^^^^^^^^^^^^^^^^^^^^^^^^^ /연결 정보가 맞는지 접속 테스트 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


    $ucfg->initDirRight     = trim($initDirRight);

    // /home/test/ -> /home/test   
    $ucfg->initDirRight = trim(preg_replace("/(\/{1,}$)/", "", $ucfg->initDirRight) );

    // /home/test -> home/test
    $ucfg->initDirRight = trim(preg_replace("/^(\/{1,})/", "", $ucfg->initDirRight) );

    if (!empty($ucfg->initDirRight) && !@ftp_chdir($ftp->ftpCon, $ucfg->initDirRight)) {
        
        // 이 디렉토리는 서버상에 존재하지 않습니다!
        jsAlertErrorMsg("* $initDirRight \\n\\n  $lg->configSaveDirError"); 
    }


    // ftp close
    $ftp->ftpClose();

} // setConnectWin() End
?>