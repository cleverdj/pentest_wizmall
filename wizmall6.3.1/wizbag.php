<?php
/* 
제작자 : 폰돌
제작자 URL : http://www.shop-wiz.com
제작자 Email : master@shop-wiz.com
Free Distributer 

*** Updating List ***
*/

include "./lib/inc.depth0.php";

include ("./lib/class.cart.php");
$cart = new cart;
$cart->get_object($dbcon,$common);

include ("./lib/class.wizmall.php");
$mall = new mall;
$mall->get_object($dbcon,$common);
$mall->cfg = $cfg;

include "./config/common_array.php";

$CART_CODE = $cart->mkcartcode();##장바구니 코드가 없을 경우 - 장바구니 코드 생성

//재결재 페이지에서 넘어오는 경우 결제시 CART_CODE로 대처
$CART_CODE = $RepayOrderID ? $RepayOrderID : $CART_CODE;
//echo "CART_CODE = ".$CART_CODE."<br>";
if (!strcmp($query,"cmp")) {## 다중 장바구니
	while (list($key,$value) = each($mall_chk)) :
		## 상품중 옵션필드가 있는 경우 리턴시킨다.(추가 프로그램 예정) 
		$cart->wizCartExe($CART_CODE,$key,$BUYNUM,$optionfield);
	endwhile;
	$common->js_location("wizbag.php");
}else if (!strcmp($query,"cart_save")) {  ## 단일 장바구니
	$cart->wizCartExe($CART_CODE, $_POST);
	if($sub_query) $common->js_location("wizbag.php?query=step1");
	else $common->js_location("wizbag.php"); 
}else if (!strcmp($query,"update_qty")){ ## 장바구니 택일수정
	$cart->changeCartqty($cuid, $BUYNUM);
	$common->js_location("wizbag.php"); 
}else if (!strcmp($query,"delete")){ // 장바구니 택일삭제
	$sqlstr = "delete from wizCart where uid = $cuid";
	$dbcon->_query($sqlstr);
	$common->js_location("wizbag.php"); 
}else if (!strcmp($query,"step5")){ // 장바구니 쿠키삭제
	setcookie("CART_CODE","",0,"/");
}else if (!strcmp($query,"trash")){ // 장바구니 비우기
	$sqlstr = "delete from wizCart where oid = '".$CART_CODE."'";
	$dbcon->_query($sqlstr);
	setcookie("CART_CODE","",0,"/");
	if($goto) $common->js_location($goto); 
	else $common->js_location("wizbag.php"); 
}

/*********************************************************************************
결제하기 선택(step1)이고 회원로그인 상태이며 style=B 이면 바로 배송지적리 페이지로 넘긴다.
* style=B는 enushop에서 처음 적용되었으며 결제선택란이 배송지 적는란과 동일한 페이지에 있다.
단점으로는 포인트결제가 되지 않는다.
*********************************************************************************/
	
if (!strcmp($query,"step1") && !strcmp($style,"B") ){
	if ($cfg["member"] || !strcmp($cfg["skin"]["NoneMemOnly"],"checked")) 
	$common->js_location("wizbag.php?query=step2&check=$check"); 
}else if (!strcmp($query,"step1") && !strcmp($style,"inputone") ){#장바구니중 택1 하나만이 결제단으로 넘어간다.
	$filepath = "./config/wizmember_tmp/mall_buyers/$_COOKIE[CART_CODE]";
	if (file_exists($filepath)){
	$Cart_Data = file($filepath);
	$fp = fopen($filepath, "w");
	while ($Cart_Data_f = each($Cart_Data)) {
	$C_dat = split("\|", chop($Cart_Data_f[1]));
			if("$C_dat[0]-$C_dat[3]-$C_dat[4]" == "$value") {
					fwrite($fp, chop($Cart_Data_f[1])."\n");
			}
	}
	fclose($fp);
	}
	
		
	if ($common->getLogininfo() || !strcmp($cfg["skin"]["NoneMemOnly"],"checked")) $common->js_location("wizbag.php?query=step2&check=$check");
}
/*********************************************************************************
결제하기 선택(step1)이고 회원로그인 상태이면 바로 결제방법선택(step2)로 넘어가고,
회원로그인 상태가 아니면 회원로그인 창으로 넘어간다.
*********************************************************************************/
if (!strcmp($query,"step1")){
	if ($common->getLogininfo() || !strcmp($cfg["skin"]["NoneMemOnly"],"checked")) {
		$common->js_location("wizbag.php?query=step2&check=$check");
	}
}else if ($query == 'step2' && $cfg["pay"]["CARD_ENABLE"] != 'checked' && $POINT_ENABLE != 'checked' && $COMPO_ENABLE != 'checked') {
/*********************************************************************************
결제방법선택(step2)에서 카드나 포인트결제가 없으면 바로 온라인결제가 되어 배송지 적기 페이지로 넘긴다,
*********************************************************************************/
 	$common->js_location("wizbag.php?query=step3");
}

$cart_skin_path = "./skinwiz/cart/".$cfg["skin"]["CartSkin"];//

if(file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php");

?>
<script language="javascript" src="./js/wizmall.js"></script>
<!-- top menu start -->
<?
if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php");
?>
<script type="text/javascript" language="javascript" src="./js/jquery-1.3.2.js"></script>
<!-- top menu end -->
<!-- left menu start -->
<?
if ($cfg["skin"]["MenuSkin_Inc"] == 'checked') include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_left.php");

?>
<!-- left menu end -->
<!-- main menu start -->
<div id="body">
  <?
switch ( $query ){
	case ( "cart_save" ) :
		include ($cart_skin_path."/CART_SAVE.php");
	break;
	case ( "step1" ) :
		include ($cart_skin_path."/CART_LOGIN.php");
	break;
	case ( "step2" ) :
	//include ("./skinwiz/cart/".$cfg["skin"]["CartSkin"]."/CART_SELECT.php");
	//break;
	case ( "step3" ) :
		include ($cart_skin_path."/CART_WRITE.php");
	break;
	case ( "step4" ) :
		include ($cart_skin_path."/CART_FINISH.php");
	break;
	case ( "step5" ) :
		$sqlstr = "select * from wizBuyers where OrderID = '$OrderID'";
		$sqlqry = $dbcon->_query($sqlstr);
		$list = $dbcon->_fetch_array();
		$BuyDate=date ("Y.m.d", $list[BuyDate]);
		$cart->stock("oid",$OrderID,"10");## 상품재고처리
		include ($cart_skin_path."/ORDER_MAIL.php");## 주문 메일 발송
		include ($cart_skin_path."/CART_QUERY_FINAL.php");
		
	break;
	case ( "cardchecking" ) :
		include ($cart_skin_path."/CARD_CHECKING.php");
	break;
	default :
		include ($cart_skin_path."/CART_SAVE.php");
	break;
}

?>
</div><!-- #body close-->
<!-- main menu end -->
<!-- bottom menu start -->
<?
if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php");
?>
<!-- bottom menu end -->
<?
include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_close.php");
$dbcon->_close();
?>
