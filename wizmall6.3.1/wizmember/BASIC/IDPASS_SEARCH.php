<?
/*
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/

/********************************** id search 인 경우 아래를 실행한다. **************************/
include_once "./config/common_array.php";

if($action == 'idsearch'){
	if(!strcmp($PasswordHintEnable,"checked")){
		$sqlstr = "select i.email, m.mname, m.mid, m.mpasswd, m.mgrantsta from wizMembers m left join wizMembers_ind i on m.mid=i.id where m.mname='$name' AND i.pwdhint='$pwdhint' AND i.pwdanswer='$pwdanswer'";
	}else{
		$sqlstr = "select i.email, m.mname, m.mid, m.mpasswd, m.mgrantsta from wizMembers m left join wizMembers_ind i on m.mid=i.id where m.mname='$name' AND i.jumin1='$juminno1' AND i.jumin2='$juminno2'";
	}
	$dbcon->_query($sqlstr );
	$result = $dbcon->_fetch_array(); 

	
	$email=$result["email"];	
	if ( !$result ) {
		$result_code = "0001";
		$message_idsearch = "일치하는 데이터를 찾지 못했습니다. <br> 새로 검색해 주시기 바랍니다.";
	}else if($result[mgrantsta] == "00"){
		$result_code = "0002";
		$message_idsearch = "이미 탈퇴된 회원입니다.";
	}else if($mode == "mail"){//아이디 찾기에서 메일발송은 추후 삭제
		$result_code = "0000";
		include ("./wizmember/".$cfg["skin"]["MemberSkin"]."/IDPASS_MAIL.php");
		$message_idsearch = " 아이디와 패스워드를 <font color='blue'>".$result["email"]."</font>로 발송하여 드렸습니다.";
	}else if($mode == "print"){
		$result_code = "0000";
		$message_idsearch = "고객님의 아이디는 <strong><font color='#0092B6'>".$result[mid]."</font></strong> 입니다";
	}
/********************************** pass search 인 경우 아래를 실행한다. **************************/

}else if($action == 'passsearch'){
	if(!strcmp($PasswordHintEnable,"checked")){
		$sqlstr = "select i.email, m.mname, m.mid, m.mpasswd, m.mgrantsta from wizMembers m left join wizMembers_ind i on m.mid=i.id where m.mid='$id' AND i.pwdhint='$pwdhint' AND i.pwdanswer='$pwdanswer'";
	}else{
		$sqlstr = "select i.email, m.mname, m.mid, m.mpasswd, m.mgrantsta from wizMembers m left join wizMembers_ind i on m.mid=i.id where m.mid='$id' AND i.jumin1='$juminno1' AND i.jumin2='$juminno2'";
	}
	$result = $dbcon->get_row($sqlstr );

	$email=$result["email"];
		
	if ( !$result ) {
		$result_code = "1001";
		$message_passsearch = "일치하는 데이터를 찾지 못했습니다. <br> 새로 검색해 주시기 바랍니다.";
	}else if($mode == "mail"){
		$result_code = "1000";
		
		extract($result);
		$tmpemail = split("\@", $email);
		
		##난수를 발생시킨다.
		list($usec, $sec) = explode(' ', microtime()); 
		$seed =  (float)$sec + ((float)$usec * 100000); 
		srand($seed);
		$newpwd = base64_encode(substr($seed, -5));
		
		##현재 패스워드 업데이트
		$sqlstr = "update wizMembers m set mpasswd='".$common->mksqlpwd($newpwd)."' where m.mname='$name' AND m.mid='$id'"; 
		$dbcon->_query($sqlstr);
		
		
		//include "../../config/cfg.core.php";
		$mailformfile = file("../../skinwiz/mailform/default/IDPASS_MAIL.php");
		$mailform = "";
		for($i=0;$i<=sizeof($mailformfile); $i++){
			$mailform .= $mailformfile[$i];
			
		}
		$mailform  = chform($mailform);

	
		if ( $email) {
			$From = $cfg["admin"]["ADMIN_EMAIL"];
			$subject = "개인정보 안내입니다. - ".$cfg["admin"]["ADMIN_TITLE"]." -";
			$from = "From:$From\nContent-Type:text/html";
			$subject = iconv("UTF-8", "EUC-KR", $subject);
			$mailform = iconv("UTF-8", "EUC-KR", $mailform);
			$from = iconv("UTF-8", "EUC-KR", $from);
			//echo $mailform;
			mail ($email, $subject, $mailform, $from);
		}
		
		//include ("./wizmember/".$cfg["skin"]["MemberSkin"]."/IDPASS_MAIL.php");
		$message_passsearch = " 아이디와 패스워드를 <font color='blue'>".$result[email]."</font>로 발송하여 드렸습니다.";
	}else if($mode == "print"){
		$result_code = "1000";
		$message_passsearch = "고객님의 패스워드는 <strong><font color='#0092B6'>".$result[mpasswd]."</font></strong> 입니다";
	}
}

	function chform($str){
		global $cfg, $mname, $mid, $newpwd;
		$str = str_replace("{url}", $cfg["admin"]["MART_BASEDIR"]."/skinwiz/mailform/default", $str);
		$str = str_replace("{username}", $mname, $str);
		$str = str_replace("{userid}", $mid, $str);
		$str = str_replace("{userpwd}", $newpwd, $str);
		$str = str_replace("{admin.title}", $cfg["admin"]["ADMIN_TITLE"], $str);
		$str = str_replace("{admin.name}", $cfg["admin"]["ADMIN_NAME"], $str);
		$str = str_replace("{admin.companynum}", $cfg["admin"]["COMPANY_NUM"], $str);
		$str = str_replace("{admin.companyaddress}", $cfg["admin"]["COMPANY_ADD"], $str);
		$str = str_replace("{admin.companyname}", $cfg["admin"]["COMPANY_NAME"], $str);
		$str = str_replace("{admin.companyceo}", $cfg["admin"]["PRESIDENT"], $str);
		$str = str_replace("{admin.companytel}", $cfg["admin"]["CUSTOMER_TEL"], $str);
		$str = str_replace("{admin.companyfax}", $cfg["admin"]["CUSTOMER_FAX"], $str);
		return $str;
	}
?>
<script language="JavaScript" src="./js/wizmall.js"></script>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td><table width="100%" height="18" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
        <tr bgcolor="#F6F6F6"> 
          <td width="15" height="22" class="company">&nbsp;</td>
          <td width="18" height="22" valign="middle"><img src="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/sn_arrow.gif" width="13" height="13"></td>
          <td height="22" bgcolor="#F6F6F6" class="company">Home &gt; 아이디 및 비밀번호 
            찾기 </td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td>&nbsp;</td>
  </tr>
  <tr> 
    <td align="center"> <table width="95%" border="0" cellspacing="0" cellpadding="5" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
        <tr> 
          <td bgcolor="#EEEEEE">- 회원님!! <font color="#89BE38">아이디 또는 비밀번호</font>를 
            잊으셨나요? 입력하신 후 [확인]단추를 누르세요</td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td align="center"> <table width="95%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td align="center">&nbsp;</td>
        </tr>
        <tr> 
          <td align="right">&nbsp;</td>
        </tr>
        <tr> 
          <td align="center"> <table width="564" border="0" cellpadding="0" cellspacing="0">
              <tr> 
                <td height="16"><img src="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/title_id.gif" width="80" height="21"></td>
              </tr>
              <tr> 
                <td background="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/bg_top.gif" height="16"></td>
              </tr>
              <tr> 
                <td><table width="564" border="0" cellpadding="0" cellspacing="0" bgcolor="F2F2F2" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                    <form action='<?=$PHP_SELF?>' method=post name="idsearch_form">
					 <input type="hidden" name="query" value="idpasssearch">
                      <input type=hidden name="action" value="idsearch">
                      <input type=hidden name="mode" value="print">
                      <tr> 
                        <td width="89">&nbsp;</td>
                        <td width="365"><? if($message_idsearch) echo $message_idsearch; else echo "ID(아이디)를 잊으셨나요?<br>
                          <strong><font color='#FF9900'>이름</font></strong>과 <font color='#FF9900'><strong>주민등록번호</strong></font>를 
                          입력하신 후 <font color='#FF9900'><strong>&quot;찾기</strong></font>&quot;버튼을 눌러주세요"; ?></td>
                        <td width="110">&nbsp;</td>
                      </tr>
                      <tr> 
                        <td>&nbsp;</td>
                        <td><table width="377" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
                            <tr> 
                              <td><font color="#006600"><strong>이름</strong></font></td>
                              <td width="282"> <input name="name" type="text" size="17" tabindex="1" style="font: 9pt 굴림; border:1 solid #cccccc">
                              </td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
<? if(!strcmp($PasswordHintEnable,"checked")):?>							
                            <tr> 
                              <td><font color="#006600"><strong>비밀번호 힌트질문</strong></font></td>
                              <td> <select name=pwdhint class=select id="pwdhint">
                          <option value=''>선택하십시오.</option>
<?
reset($PasswordHintArr);
while(list($key, $value) = each($PasswordHintArr)):
	
	echo "<option value='$value'>$value</option>\n";
endwhile;
?></select></td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
                            <tr> 
                              <td><font color="#006600"><strong>비밀번호 힌트답</strong></font></td>
                              <td> <input name="pwdanswer" type="text" id="pwdanswer" style="font: 9pt 굴림; border:1 solid #cccccc" size="20" maxlength="30" /> </td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
<?
else:
?>	
                            <tr> 
                              <td><font color="#006600"><strong>주민등록번호</strong></font></td>
                              <td> <input name="juminno1" type="text"tabindex="2" size="6" maxlength="6" onkeyup="moveFocus(6,this,document.idsearch_form.juminno2)" style="font: 9pt 굴림; border:1 solid #cccccc" >
                                - 
                                <input name="juminno2" type="text"tabindex="3" size="7" maxlength="7" style="font: 9pt 굴림; border:1 solid #cccccc"></td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>	
<?
endif;
?>																				
                          </table></td>
                        <td align="center"><input name="image" type=image src="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/but_search.gif" tabindex="4"></td>
                      </tr>
                      <tr> 
                        <td height="10">&nbsp;</td>
                        <td height="10">&nbsp;</td>
                        <td height="10" align="center">&nbsp;</td>
                      </tr>
                    </form>
                  </table></td>
              </tr>
              <tr> 
                <td background="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/bg_bottom.gif" height="16"></td>
              </tr>
            </table></td>
        </tr>
        <tr> 
          <td align="center">&nbsp;</td>
        </tr>
        <tr> 
          <td align="center"> <table width="564" border="0" cellpadding="0" cellspacing="0">
              <tr> 
                <td height="16"><img src="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/title_pass.gif" width="91" height="20"></td>
              </tr>
              <tr> 
                <td background="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/bg_top.gif" height="16"></td>
              </tr>
              <tr> 
                <td><table width="564" border="0" cellpadding="0" cellspacing="0" bgcolor="F2F2F2" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                    <form action='<?=$PHP_SELF?>' method=post name="passsearch_form">
					<input type="hidden" name="query" value="idpasssearch">
                      <input type=hidden name="action" value="passsearch">
                      <input type=hidden name="mode" value="mail">
                      <tr> 
                        <td width="89" height="49">&nbsp;</td>
                        <td width="365">
                          <? if($message_passsearch) echo $message_passsearch; else echo "회원님의 비밀번호를 잊으셨나요?<br>
                          <font color='#FF9900'><strong>아이디</strong></font>와 <strong><font color='#FF9900'>주민등록번호</font></strong>를 
                          입력하신 후 <strong><font color='#FF9900'>&quot;찾기&quot;</font></strong>버튼을 눌러주세요"; ?>
                        </td>
                        <td width="110">&nbsp;</td>
                      </tr>
                      <tr> 
                        <td>&nbsp;</td>
                        <td><table width="376" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td  bgcolor="BCBCBC"></td>
                            </tr>
                            <tr> 
                              <td><font color="#006600"><strong>아이디</strong></font></td>
                              <td width="281"> <input name="id" type="text" size="17"tabindex="5" style="font: 9pt 굴림; border:1 solid #cccccc"></td>
                            </tr>
                            <tr height="1"> 
                              <td width="82"bgcolor="BCBCBC"> </td>
                              <td bgcolor="BCBCBC"> </td>
                            </tr>
<? if(!strcmp($PasswordHintEnable,"checked")):?>							
                            <tr> 
                              <td><font color="#006600"><strong>비밀번호 힌트질문</strong></font></td>
                              <td> <select name=pwdhint class=select id="pwdhint">
                          <option value=''>선택하십시오.</option>
<?
reset($PasswordHintArr);
while(list($key, $value) = each($PasswordHintArr)):
	
	echo "<option value='$value'>$value</option>\n";
endwhile;
?></select></td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
                            <tr> 
                              <td><font color="#006600"><strong>비밀번호 힌트답</strong></font></td>
                              <td> <input name="pwdanswer" type="text" id="pwdanswer" style="font: 9pt 굴림; border:1 solid #cccccc" size="20" maxlength="30" /> </td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>
<?
else:
?>	
                            <tr> 
                              <td><font color="#006600"><strong>주민등록번호</strong></font></td>
                              <td> <input name="juminno1" type="text"tabindex="2" size="6" maxlength="6" onkeyup="moveFocus(6,this,document.idsearch_form.juminno2)" style="font: 9pt 굴림; border:1 solid #cccccc" >
                                - 
                                <input name="juminno2" type="text"tabindex="3" size="7" maxlength="7" style="font: 9pt 굴림; border:1 solid #cccccc"></td>
                            </tr>
                            <tr height="1"> 
                              <td width="82" bgcolor="BCBCBC"></td>
                              <td bgcolor="BCBCBC"></td>
                            </tr>	
<?
endif;
?>	
                          </table></td>
                        <td align="center"><input name="image" type=image src="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/but_search.gif" tabindex="8"></td>
                      </tr>
                      <tr> 
                        <td height="10">&nbsp;</td>
                        <td height="10">&nbsp;</td>
                        <td height="10" align="center">&nbsp;</td>
                      </tr>
                    </form>
                  </table></td>
              </tr>
              <tr> 
                <td background="wizmember/<?=$cfg["skin"]["MemberSkin"]?>/images/bg_bottom.gif" height="16"></td>
              </tr>
            </table></td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td align="center">&nbsp;</td>
  </tr>
  <tr>
    <td align="center">&nbsp;</td>
  </tr>
</table>