<?
/* 

제작자 : 폰돌
스킨 : wizboard list skin 
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
*/
$orderby	= $sel_orderby;
if(!$orderby)  $orderby = "m1.UID@DESC";
if ($query == 'search') {
	$keyword = trim($keyword);
	$whereis = "WHERE m2.UID=m2.PID";
	if ($Category) { $whereis .= " AND m1.Category LIKE '%$Category'";}
	if ($price1) {$whereis .= " AND m2.Price >= $price1";}
	if ($price2) {$whereis .= " AND m2.Price <= $price2";}
	if ($Brand) {$whereis .= " AND m2.Brand LIKE '%$Brand%'";}
	if ($keyword && $Target) {
	$upperkeyword = strtoupper ($keyword);
	$lowerkeyword = strtolower ($keyword);
		if ($Target == 'all') {$whereis .= " AND (m2.Name LIKE '%$keyword%' OR m2. Name LIKE '%$upperkeyword%' OR m2.Name LIKE '%$lowerkeyword%' OR m2.Description1 LIKE '%$keyword%' OR m2.Description1 LIKE '%$upperkeyword%' OR m2.Description1 LIKE '%$lowerkeyword%' OR m2.Model LIKE '%$keyword%' OR m2.Model LIKE '%$upperkeyword%' OR m2.Model LIKE '%$lowerkeyword%')";}
		else $whereis .= " AND $Target LIKE '%$keyword%'";
	}
}

if ($query == 'natural') {
	if (!$keyword) {
		ECHO "<script language=javascript>
		window.alert('\\n자연에 검색에 필요한 문장을 입력해 주세요.\\n');
		history.go(-1);
		</script>";
		exit;
	}

	$Natural_Key_Spl = split(" ", $keyword);
	$whereis = "WHERE $Target LIKE '%$Natural_Key_Spl[0]%'";
	
	for ($i = 1; $i < sizeof($Natural_Key_Spl) && $i <= 100; $i++) {
		$whereis .= " $andor $Target LIKE '%$Natural_Key_Spl[$i]%'";
	}
}


/* 페이징과 관련된 수식 구하기 */
$ListNo = "15";
$PageNo = "20";
if(empty($cp) || $cp <= 0) $cp = 1;
$START_NO = ($cp - 1) * $ListNo;
$TOTAL_STR = "SELECT count(*) FROM wizMall";
$REALTOTAL = $dbcon->get_one($TOTAL_STR);

$sqlstr = "SELECT count(1) FROM wizMall m1 left join wizMall m2 on m1.PID = m2.UID $whereis";
$TOTAL = $dbcon->get_one($sqlstr);
?>

<table width="579" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/img_top.gif" width="579" height="4"></td>
  </tr>
  <tr>
    <td height="92" align="center" background="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/bg_body.gif"><table width="550" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td><table width="496" border="0" cellpadding="0" cellspacing="0" style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
              <tr>
                <td width="10"><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/img_serach01.gif" width="86" height="32"></td>
                <td width="486"><strong><font color="#0033CC">
                  <?=$keyword?>
                  </font></strong> 검색어로 <strong>총
                  <?=number_format($TOTAL)?>
                  개</strong>의 상품들을 검색하였습니다.</td>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td height="1" bgcolor="#D2D2D2"></td>
        </tr>
        <tr>
          <td height="59"><table width="550" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td><table width="286" border="0" cellspacing="0" cellpadding="0">
                    <form  action="./wizsearch.php">
                      <input type="hidden" name="query" value="search">
                      <input type="hidden" name="Target" value="all">
                      <tr>
                        <td width="46"><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/img_dbo.gif" width="46" height="35"></td>
                        <td width="140"><input name="keyword" type="text" class="formline" size="23"></td>
                        <td width="88" align="center"><input name="image" type="image" src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/but_serach.gif" width="77" height="27"></td>
                      </tr>
                    </form>
                  </table></td>
                <td width="1" background="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/bg_jumsun.gif"></td>
                <td align="center"><table width="240" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/img_detail.gif" width="142" height="29"></td>
                      <td><A HREF='./wizsearch.php'><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/but_detail.gif" width="84" height="44" border="0"></a></td>
                    </tr>
                  </table></td>
              </tr>
            </table></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td><img src="./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/img_bottom.gif" width="579" height="4"></td>
  </tr>
</table>
<p>&nbsp;</p>
<FORM ACTION='./wizsearch.php'>
  <INPUT TYPE=HIDDEN NAME=query VALUE='<?=$query?>'>
  <INPUT TYPE=HIDDEN NAME=cat VALUE='<?=$cat?>'>
  <INPUT TYPE=HIDDEN NAME=cp VALUE='<?=$cp?>'>
  <INPUT TYPE=HIDDEN NAME=price1 VALUE='<?=$price1?>'>
  <INPUT TYPE=HIDDEN NAME=price2 VALUE='<?=$price2?>'>
  <INPUT TYPE=HIDDEN NAME=Target VALUE='<?=$Target?>'>
  <INPUT TYPE=HIDDEN NAME=keyword VALUE='<?=$keyword?>'>
  <INPUT TYPE=HIDDEN NAME=Brand VALUE='<?=$Brand?>'>
  <INPUT TYPE=HIDDEN NAME=sort VALUE='<?=$sort?>'>
  <INPUT TYPE=HIDDEN NAME=andor VALUE='<?=$andor?>'>
  <B>검색된 제품</B> : <B>
  <?=number_format($TOTAL)?>
  개</B>
  <?=$mall->sel_pd_order($sel_orderby)?>
</FORM>
<FORM ACTION='./wizmall.php' NAME='mall_list' onsubmit='return cmp()'>
  <INPUT TYPE=HIDDEN NAME=query VALUE='cmp'>
  <table id="list">
    <TR HEIGHT='22'>
      <TD width="776" BACKGROUND='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_bg.gif'><IMG SRC='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_2.gif'></TD>
      <TD width="230" BACKGROUND='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_bg.gif'><IMG SRC='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_3.gif'></TD>
      <TD width="152" BACKGROUND='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_bg.gif'><IMG SRC='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_4.gif'></TD>
    </TR>
    <?
//$sqlstr="SELECT m1.UID, m1.PID, m1.Category, m2.Picture, m2.None, m2.Regoption, m2.Model, m2.Name, m2.Price, m2.Category as pcategory 
//		FROM wizMall m1 left join wizMall m2 on m1.PID = m2.UID
//		$whereis ORDER BY $sort DESC LIMIT $START_NO, $ListNo";

//$dbcon->_query($sqlstr);
//$NO = $TOTAL-($ListNo*($cp-1));				
//while( $list = $dbcon->get_rows( ) ) :

$sqlqry = $dbcon->get_select('m1.UID, m1.PID, m1.Category, m2.Picture, m2.None, m2.Regoption, m2.Model, m2.Name, m2.Price, m2.Category as pcategory','wizMall m1 left join wizMall m2 on m1.PID = m2.UID',$whereis, $orderby, $START_NO, $ListNo);
while( $list = $dbcon->_fetch_array($sqlqry)) :

    $Picture	= split("\|", $list[Picture]);
	$Regoption	= $list["Regoption"];
	$Category	= $list["Category"];
	$UID		= $list["UID"];
	$None		= $list["None"];
	$big_code	= substr($Category, -3);
	$link_url 	= "'./wizmart.php?query=view&code=$list[Category]&no=$list[UID]'";
	$Picture 	= split("\|", $list[Picture]);
	$Multi_Disabled = "";
	
	if (($Stock && $Stock <= $Output) || $None == '1' ) {
		$link_url = "'#' onclick=\"javascript:alert('제품이 품절되었습니다. 관리자에게 문의하세요.')\"";
		$Multi_Disabled = " disabled";
	}
	
	$img_folder		= substr($list["pcategory"], -3);
    $View_Pic_Size	= $common->TrimImageSize("./config/uploadfolder/productimg/".$img_folder."/".$Picture[0], 50);
	$categoryName	= $mall->getCategoryFullPath($Category);//카테고리 표시시 사용
?>
    <TR>
      <TD COLSPAN=3 BACKGROUND='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_line.gif' HEIGHT=1></TD>
    </TR>
    <TR>
      <TD><TABLE WIDTH=100% style="font-family: '굴림', '돋움','Arial';font-size: 12px; color:#666666;line-height:140%">
          <TR>
            <TD WIDTH=127 height="53"><A HREF=<?=$link_url?>><img src="./config/uploadfolder/productimg/<?=$img_folder?>/<?=$Picture[0]?>" border="0" <?=$View_Pic_Size?>></A></TD>
            <TD width="634"><A HREF=<?=$link_url?>>
              <?=$list[Name]?>
              </A></TD>
          </TR>
        </TABLE></TD>
      <TD ALIGN=CENTER><?=$list[Brand]?>
      </TD>
      <TD ALIGN=CENTER><FONT COLOR='#EF7518'>
        <?=number_format($list[Price])?>
        원</FONT><BR>
        <?=number_format($list[Point])?>
        포인트</TD>
    </TR>
    <?endwhile;?>
    <TR>
      <TD COLSPAN=3 BACKGROUND='./skinwiz/search/<?=$cfg["skin"]["SearchSkin"]?>/images/list_line.gif' HEIGHT=1></TD>
    </TR>
    <TR align="center">
      <TD height="44" colspan="3"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$page_arg1 = $PHP_SELF."?query=$query&cat=$cat&Target=$Target&keyword=".urlencode($keyword)."&price1=$price1&price2=$price2&Brand=$Brand&sel_orderby=$sel_orderby&andor=$andor";
$page_arg2 = array("listno"=>$ListNo,"pageno"=>$PageNo,"cp"=>$cp,"total"=>$TOTAL); 
//$page_arg3 = array("pre"=>"./img/pre.gif","next"=>"./img/next.gif");
echo $common->paging($page_arg1,$page_arg2,$page_arg3);
?>
      </TD>
    </TR>
  </TABLE>
</FORM>
