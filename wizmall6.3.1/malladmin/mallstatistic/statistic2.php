<?
include "./mallstatistic/common.php";

$total_date = $sta->get_total_sale_price();
/*
if ($total_date[hit]) {
$TOTAL_WIDTH = intval(($total_date[tqty]/$total_date[hit])*100);
}
else {
$TOTAL_WIDTH = 0;
$total_date[hit] = 0;
}
*/
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>제품 조회/판매 통계</legend>
						<div id="notice">[note]</div>
						<div id="comment">제품 조회 통계는 카테고리별, 제품별 조회수를 표시하고 조회별 판매량을 표시합니다.<br />
                  고객의 관심도(성향) 및 실지 구매로의 연결등을 분석함으로써 더욱 효과적인 판매전략을 구상하실 수 있습니다.<br />
                  기본 리스트는 조회순으로 정렬되어있습니다.<br />
                  카테고리별, 제품별 판매량이나 금액은 현재 몰에서 판매되지 않는(삭제된) 제품은 제외되고 배송비 및 카드수수료등의 
                  변수등에 의해 <font color="#FF6600">실제 총판매량이나 총판매액과 다를 수가 있습니다</font>.<br />
                  입고량에 대한 판매비율에서 입고량을 100%로 보고 계산되어짐.</div>
						</fieldset>
						<p></p>	
				
                  
      <table class="table_main">
         
        <tr> 
                      <td bgcolor=#ffffff> 
                        <table cellspacing=0 cellpadding=0 width="100%" 
border=0 class="s1">
                           
                          <tr> 
                            <td valign=top align=right>&nbsp; 
                              <table width="709" border="0">
              <form action='<?=$PHP_SELF?>' method="POST" name="SortForm">
                <input type="hidden" name="menushow" value=<?=$menushow?>>
                <input type="hidden" name=theme value=<?=$theme?>>
                <input type="hidden" name=cp value='1'>
                <input type="hidden" name="category" value="<?=$category?>">
                <input type="hidden" name="uid" value="">
                          <tr> 
                            <td height="23"> <div align="left"> </div></td>
                            <td width="109"><select style="WIDTH: 100px" onChange="SortbyCat(this)">
                      <option value="">대분류</option>
                      <option value="">-----------</option>
                      <?
$mall->getSelectCategory(1, $category);
?>
                    </select> </td>
                            <td width="108"> <select style="WIDTH: 100px"  onChange="SortbyCat(this)">
                      <option value="">중분류</option>
                      <option value="">-----------</option>
                      <?
$mall->getSelectCategory(2, $category);
?>
                    </select> </td>
                            <td width="114"> <select style="WIDTH: 100px"  onChange="SortbyCat(this)">
                      <option value="">소분류</option>
                      <option value="">-----------</option>
                      <?
$mall->getSelectCategory(3, $category);
?>
                    </select> </td>
                            <td width="115"> <div align="right"> 
                                <? $admin->sel_pd_order($orderby);//정렬 ?>
                              </div></td>
                          </tr>
                        </form>
                      </table>
                            </td>
                          </tr>
                           
                        </table>
                      </td>
                    </tr>
                     
                  </table>
                  <br />
                  <table class="table_main">
        
          <tr align=middle bgcolor=E0E4E8> 
            <td width=150> 총등록수</td>
            <td width=100> 총조회수</td>
            <td width=100> 총판매건수</td>
            <td bgcolor="E0E4E8"> 총판매액</td>
          </tr>
          <tr align=middle bgcolor=white height=22> 
            <td width=150> <font color=brown><b> 
                <?=number_format($total_date[count])?>
                EA</b></font></td>
            <td width=100> <font color=brown><b> 
                <?=number_format($total_date[hit])?>
                회</b></font></td>
            <td width=100> <font color=brown><b> 
                <?=number_format($total_date[tqty])?>
                EA</b></font></td>
            <td align=left bgcolor=#FFFFFF> <font color="BROWN"> 
                <b> 
                <?=number_format($total_date[tmount])?>
                원</b></font></td>
          </tr>
      </table>
                  <br />
                  <table class="table_main">
         
        <tr align=middle bgcolor=E0E4E8 height=22> 
            <td width=150> 매장 카테고리</td>
            <td width=100> 조회수</td>
            <td width=100 bgcolor="E0E4E8"> 판매수</td>
            <td width=270> 판매량그래프(오차범위:1%이내)</td>
          </tr>
        <?
$sqlstr="SELECT * FROM wizCategory WHERE length(cat_no)  = 3 ORDER BY cat_order ASC"; 
$sqlqry = $dbcon->_query($sqlstr);
while($list=$dbcon->_fetch_array($sqlqry)):
	$cat_no	= $list[cat_no];
	$substr = "SELECT sum(Hit) as hit, sum(Output) as tqty, sum(Output*Price) as tmount, count(*) as count FROM wizMall WHERE right(Category, 3) = '$cat_no'";
	$cat_list = $dbcon->get_row($substr);
	if ($total_date[tqty] && $cat_list[tqty]) {$cat_width = intval(($cat_list[tqty] / $total_date[tqty])*100);}
	else {$cat_width =0;}
	if ($cat_list[hit] && $cat_list[tqty]) {
	$cat_width1 = intval(($cat_list[tqty] / $cat_list[hit])*100);}
	else {$cat_width1 =0 ;}
?>
          <tr align=middle bgcolor=white height=22> 
            <td align=left bgcolor=#F0F2F4>&nbsp;<?=$list[cat_name]?> 
             <A HREF='<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme;?>&category=<?=$list[cat_no]?>&orderby=<?=$orderby?>&cp=<?=$cp;?>'><img 
                  src="img/more.gif" border=0 width="30" height="15"></a></td>
            <td bgcolor="white"><font color="#0D5086"><?=number_format($cat_list[hit])?>회</font></td>
            <td bgcolor="white"><font color="#0D5086"><?=number_format($cat_list[tqty])?>EA</font></td>
            <td align=left bgcolor=#efefef><img height=9 
                  src="img/5.gif" WIDTH='<?=($cat_width*2)?>'><?=$cat_width?>%</td>
          </tr>
<?
endwhile;
?>
        
      </table>
                  <br />
                  
      <table cellspacing=0 cellpadding=0 width="760" border=0 class="s1">
         
        <tr> 
                      <td><b>현재 카테고리</b> : <A HREF='<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>'><font color=#006633>총 매장</font></a><font 
                  color=gray><?=$sta->get_cat_line($category,$menushow, $theme, $orderby, $cp);?></font></td>
                    </tr>
                    
                  </table>
                  <table class="table_main">
        
          <tr align=middle bgcolor=E0E4E8> 
            <td>제품명/제조사</td>
            <td>가격/포인트</td>
            <td>조회량</td>
            <td>판매량</td>
            <td>입고량에따른 판매율</td>
            <td align="center">제품별통계</td>
          </tr>
          <tr> 
            <td colspan=9 height=1></td>
          </tr>
          <?
$whereis = "where 1 and PID=UID";
$orderby = "hit@desc";
if ($category) $whereis .= " and Category like '%$category'";
 

$TOTAL_STR = "SELECT count(*) FROM wizMall $whereis";
$TOTAL = $dbcon->get_one($TOTAL_STR);

	  
$NO = $TOTAL-($listNo*($cp-1));

	
$cnt=0;
$qry = $dbcon->get_select('UID, Name, Model, Picture,Category, Price, Point, Hit, Output','wizMall',$whereis, $orderby, $START_NO, $ListNo);
while( $list = $dbcon->_fetch_array($qry) ) :
	$UID		= $list["UID"];
	$Name		= stripslashes($list[Name]);
	$Model		= stripslashes($list[Model]);
	$Picture	= split("\|",$list[Picture]); 
	$Category	= $list[Category]; 
	$Price		= $list[Price];
	$Point		= $list[Point];
	$Hit		= $list[Hit];
	$Output		= $list[Output];

	$input		= $sta->get_pd_in($UID);##입고량 가져오기
	if(!$input)  $input  = 0.1;
	$out_per	= (int)(($Output/$input)*100);
	$out_graph	= $out_per > 100 ? 100 : $out_per;
	//echo $Output.",".$input;
	//$out_graph	= $Output%$input;
?>
          <tr bgcolor=#ffffff> 
            <td> <table width="99%" class="s1">
                
                  <tr> 
                    <td width=50><A HREF="../wizmart.php?code=<?=$Category?>&query=view&no=<?=$UID?>" TARGET=_blank><IMG SRC="<?=$common->getpdimgpath($Category, $Picture[0], "../")?>" WIDTH='50' HEIGHT='50' BORDER=0></A></td>
                    <td width="99"><?=$Name?></td>
                  </tr>
                
              </table></td>
            <td align=middle><font 
                  color=#ef7518><b> 
              <?=$Price?>
              원</B></FONT><br /> 
              <?=$Point?>
              포인트 </td>
            <td align=middle><font color="#0D5086"><b> 

              <?=$Hit?>
              회</b></font></td>
            <td align=middle><font color=brown><b> 
              <?=$Output?>
              EA</b></font></td>
            <td>
              <img height=10 src="img/6.gif" WIDTH='<?=$out_graph?>%'> 판매비율(<?=number_format($out_per);?>%)
            <br />(입고:<?=number_format($input)?>, 판매량 : <?=number_format($Output)?>) </font></td>
            <td align="center"><a href="<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=mallstatistic/statistic2_2&gid=<?=$UID?>">보기</a></td>
          </tr>
          <?endwhile;?>
        
      </table>
                  <br />
                  
                    <table width="760" border="0" align="left" class="s1">
                      <tr>
                        <td align="center"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$page_arg1 = $PHP_SELF."?menushow=$menushow&theme=$theme&category=$category&orderby=$orderby";
$page_arg2 = array("listno"=>$listNo,"pageno"=>$PageNo,"cp"=>$cp,"total"=>$TOTAL); 
$page_arg3 = array("pre"=>"./img/pre.gif","next"=>"./img/next.gif");
echo $common->paging($page_arg1,$page_arg2,$page_arg3);
?>
                        </td>
                      </tr>
                    </table>
                    <br />
                  </td>
              </tr>
            </table>