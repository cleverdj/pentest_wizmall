<?
/* 
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
powered by 폰돌
Reference URL : http://www.shop-wiz.com
Contact Email : master@shop-wiz.com
Free Distributer : 
Copyright shop-wiz.com
*** Updating List ***
*/
include_once ("../config/avatar_array.php");
?>
<script language="javascript" src="../../js/jquery.plugins/selectboxes.js"></script>
<script language=javascript>
<!--
function getCategory(v, step) {
	//alert("alue="+v.value+"&step="+step);
	if(step == 1) $("#Category2").removeOption(/./);
	else if(step == 2) $("#Category3").removeOption(/./);
		$.ajax({
			type: "GET",
			url: "./avatar/search_category.php",
			data: "value="+v.value+"&step="+step,//특정변수값을 주어서 결과를 받을때
			
			dataType: "xml",
			success: function(xml) {
				$(xml).find('channel').each(function(){
					var cat_no = $(this).find('cat_no').text();
					var cat_name = $(this).find('cat_name').text();
					//alert(step);
					if(step == 1) $("#Category2").addOption(cat_no, cat_name, false);
					else if(step == 2) $("#Category3").addOption(cat_no, cat_name, false);	
					
				}); //close each(
			}//close function(xml)
		}); //close $.ajax(

} //close $(

function confirm_del(no,item_name) {
	if(confirm(item_name +"을 정말 삭제하시겠습니까?")) {
		location.href="avatar/avatarProc.php?no="+no+"&query=delete&menushow=<?=$menushow;?>&theme=<?=$theme;?>";
	}else  {
		alert("삭제를 취소하셨습니다.");
	}
}

function FaceWindow(no){
	wizwindow('./avatar/facesave.php?no='+no,'FaceWindow','width=400, height=400');

}
//-->
</script>
<fieldset class="desc">
<legend>아바타 목록 보기</legend>
<div id="notice">[note]</div>
<div id="comment"> </div>
</fieldset>
<p></p>

      <form action="<?=$PHP_SELF;?>" method="post" name="list">
        <input type="hidden" name="menushow" value="<?=$menushow?>" />
        <input type="hidden" name="theme" value="<?=$theme?>" />
        
<select name="Category1" onchange="getCategory(this, 1);" id="Category1">
                <option value="" selected>대분류 </option>
                <option value="">----------------</option>
                <?
$mall->getSelectCategory("1", $list["Category"], "wizavatar");
?>
              </select>
              <select name="Category2" id="Category2">
                <option value="" selected>중분류</option>
                <?
if($mode == "update"){
$mall->getSelectCategory("2", $list["Category"], "wizavatar");
}
?>
                <option value="">----------------</option>
              </select>
              <select name="gender">
                <option value="">전체</option>
                <?
$genderArr = array("0"=>"기타", "1"=>"남성", "2"=>"여성");
foreach($genderArr as $key => $value){
	$selected = $gender == $key && $gender <> "" ? "selected":"";
	echo "<option value='$key' $selected>$value</option>\n";
}
?>
              </select>
<select name="s_layer" id="s_layer">
                <option value="">전체</option>
<?
foreach($LayerArr as $key=>$value){
	$selected = $s_layer == $key?"selected":"";
	echo "<option value='$key' $selected>$value</option>\n";
}
?>
?>
        </select>              
        <input name="skeyword" type="text" id="textfield" size="15" /><input type="submit" name="Submit" value="찾기" />
      </form>
      <br>
      <?
/*
function getCategoryName($code){
	global $WIZTABLE;
	$sqlstr = "select cat_name from ".$WIZTABLE["CATEGORY"]." where cat_no = '$code'";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	return $list["cat_name"];
}

function getFaceList($item_id){
	global $WIZTABLE;
	$sqlstr = "select * from ".$WIZTABLE["AVATARFACE"]." where item_id = '$item_id'";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	$facelist[1] = $list["face01"];
	$facelist[2] = $list["face02"];
	$facelist[3] = $list["face03"];
	$facelist[4] = $list["face04"];
	$facelist[5] = $list["face05"];
	return $facelist;
}


function showFace($facearr){
	$path = "../wizavatar/avatarimg/face_img/";
	foreach($facearr as $key => $value){
		$str .= "<img src='".$path.$value."' border=0 width=26, height=26>&nbsp;"; 
	}
	echo $str;
}	
	
*/	
$ListNo=$pg_counts?$pg_counts:20;
$PageNo = 10;




//$whereis = "where 1 and defaultflag = 'n'";
$whereis = "where 1 ";
if($gender <> "") $whereis .= " and t1.gender = '$gender' ";
if($s_layer <> "") $whereis .= " and t1.layer = '$s_layer' ";
if($Category2) $whereis .= " and substr(t1.category, 3, 4) = '".substr($Category2, -4)."' ";
else if($Category1) $whereis .= " and substr(t1.category, 5, 2) = '".substr($Category1, -2)."' ";
if($skeyword) $whereis .= " and t1.name like '%$skeyword%' ";

/* 총 갯수 구하기 */
$TOTAL_STR = "SELECT count(no) FROM ".$WIZTABLE["AVATARITEM"]." t1 $whereis";
$TOTAL = $dbcon->get_one($TOTAL_STR);


if(empty($CP) || $CP <= 0) $CP = 1;

//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CP / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */

$START_NO = ($CP - 1) * $ListNo;
$BOARD_NO1=$TOTAL-($ListNo*($CP-1));


	$sqlstr = "select t1.*  from ".$WIZTABLE["AVATARITEM"]." t1 ";
	$sqlstr .= " $whereis ";
	$sqlstr .= " order by t1.no desc limit $START_NO, $ListNo";
	$sqlqry = $dbcon->_query($sqlstr);
$cnt=0;
while($list=$dbcon->_fetch_array($sqlqry)):
	$no = $list["no"];
	$code = $list["category"];
	$codename = $avatar->getCategoryFullPath($code);
	$tmpgender = $list["gender"];
	switch($tmpgender){
		case "1":
			$genderstr = "남";
		break;
		case "2":
			$genderstr = "여";
		break;		
		default:
			$genderstr = "공동";
		break;	
	}
	$layer = $list["layer"];	
?>
      <table  class="table_main">
        <tr>
          <td width='75' height='75' rowspan='2' align="center" bgcolor="#FFFFFF"><!--  디스플레이 아이템 -->
            <img src='<?=$avatar->getavatarImg($no)?>' width="100" border=0><br>
          </td>
          <td align="left" valign="top" bgcolor="#FFFFFF"><TABLE>
              <tr>
                <td align="center" bgcolor="E0E4E8"><strong>분류</strong></td>
                <td colspan="3" bgcolor="#FFFFFF"><?=$codename?>(고유값-<?=$no?>)</td>
              </tr>
              <tr>
                <td align="center" bgcolor="E0E4E8"><strong>아이템명</strong></td>
                <td bgcolor="#FFFFFF"><?=$list[name]?></td>
                <td align="center" bgcolor="E0E4E8"><strong>성별</strong></td>
                <td width="0" bgcolor="#FFFFFF"><?=$genderstr?></td>
              </tr>
              <tr>
                <td align="center" bgcolor="E0E4E8"><strong>구매금액</strong></td>
                <td bgcolor="#FFFFFF"><?=$list[buy_p]?>
                  &nbsp;</td>
                <td align="center" bgcolor="E0E4E8"><strong>판매금액</strong></td>
                <td bgcolor="#FFFFFF"><?=$list[sale_p]?>
                  &nbsp;</td>
              </tr>
              <tr>
                <td align="center" bgcolor="E0E4E8"><strong>재고</strong></td>
                <td bgcolor="#FFFFFF"><?=$list[jaego]?>
                  &nbsp;</td>
                <td align="center" bgcolor="E0E4E8"><strong>레이어</strong></td>
                <td bgcolor="#FFFFFF"><?=$LayerArr[$layer]?>
                  &nbsp;</td>
              </tr>
              <?
if($layer=="9" || $layer=="13"){//얼굴, 한벌의상
//테이블에서 표정 가져오기
//echo $list["no"];
$facelist = $avatar->getFaceList($list[no]);
//print_r($facelist);
?><!--
              <tr>
                <td align="center" bgcolor="E0E4E8"><strong>표정관리</strong></td>
                <td colspan="2" bgcolor="#FFFFFF">&nbsp;
                  <?=$avatar->showFace($facelist);?>
                  <img src='<?=$avatarpath?>face_img/<?=$list["filename2"]?>' border=0 width=26, height=26 />&nbsp;
                  <? if($list["filename3"]): ?>
                  <img src='<?=$avatarpath?>face_img/<?=$list["filename3"]?>' border=0 width=26, height=26 />&nbsp;
                  <? endif; ?></td>
                <td bgcolor="#FFFFFF"><input type="button" name="" value="표정관리" onClick="FaceWindow('<?=$list["no"]?>');">
                  (26*26)</td>
              </tr>-->
              <?
}
?>
            </table></td>
          <td align='center' bgcolor="#FFFFFF"><a href="<?=$PHP_SELF;?>?menushow=<?=$menushow?>&theme=avatar/avatar_modify&=3&no=<?=$list[no]?>&page=<?=$page?>&Category1=<?=$Category1?>&Category2=<?=$Category2?>&gender=<?=$gender?>" target="_self">[ 수정 ]</a> <a href="javascript:confirm_del('<?=$list["no"]?>','<?=$list["name"]?>')" target="_self">[ 삭제 ]</a></td>
        </tr>
      </table>
      <br>
      <?
$BOARD_NO1--;
$cnt++;
endwhile;
?>
      <br>
      <TABLE cellSpacing=0 borderColorDark=white width="760" bgColor=#c0c0c0 borderColorLight=#dddddd 
border=1 class="s1">
        <tr>
          <td align="center" bgcolor="#ffffff" ><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$TransData = "menushow=$menushow&theme=$theme&Category1=$Category1&Category2=$Category2&gender=$gender&s_layer=$s_layer&skeyword=$skeyword";
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo " <a href='$PHP_SELF?CP=$PREV_PAGE&$TransData'>Prev</a> ";
} else {
echo " Prev ";
 }


/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CP == $i){$NUMBER_SHAPE= "<B>${i}</B>";}
else $NUMBER_SHAPE=${i};
ECHO" <A HREF='$PHP_SELF?CP=$i&$TransData'>$NUMBER_SHAPE</a> ";
}

/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO " <a href='$PHP_SELF?CP=$NEXT_PAGE&$TransData'>Next</a> ";
} else {
ECHO" Next ";
}
?>
          </td>
        </tr>
      </table></td>
  </tr>
</table>
