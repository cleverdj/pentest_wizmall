<?
include "../common/header_pop.php";
include "../../config/avatar_array.php";
include "../../lib/class.avatar.php";

$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;
$avatarpath = $avatar->avatarpath = "../../config/wizavatar/avatarimg/";
$avavar_root = "../";


if($query == "insert") {
	if(!$reg_name) $reg_name = "위즈아바타";
	if(!$reg_home) $reg_home = "http://avatar.shop-wiz.com";
//이미지 업로딩 시작	
	$common->upload_path = $avatarpath;
	//$common->ProhibitExtention = "";
	
	//$option1 = $Filenamereserver;
	$common->uploadfile("file");//업로드 완료후 아래의 $common->returnfile 생성됨
	$imgname = $common->returnfile;
				
	//$avatar->upload_path = $avatarpath;
	//$avatar->replacflag = "on";
	//$avatar->uploadfile("file");
	//$imgname = split("\|", $avatar->attachedfile);
//이미지 업로딩 끝	
	if($Category2) $category = $Category2;
	else if($Category1) $category = $Category1;
	
	unset($reg_option);
	for($i=0; $i < count($reg_optionArr); $i++){
		if(!$Multi_Option[$i]) $Multi_Option[$i] = "0";
		$reg_option .= $Multi_Option[$i]."|";
	}
	$sqlstr = "insert into ".$WIZTABLE["AVATARITEM"]." (name, level, gender, category, layer,reg_name,reg_id,reg_home,memo,buy_p,sale_p,jaego,face_show,reg_option,ref_item,theme_item,wdate) values ('$itemname','$level','$gender','$category','$layer','$reg_name','$reg_id','$reg_home','$memo','$buy_p','$sale_p','$jaego','$face','$reg_option','$ref_item','$theme_item',".time().")";
	$result = $dbcon->_query($sqlstr);
	$no = $dbcon->_insert_id();
	$avatar->move_file($imgname, $no);## 현재 업로드된 파일을 이름을 바꾼후 실 서비스 폴더로 이동하기
	
	if($result){
		echo "<script language='javascript'>alert('아이템이 추가되었습니다.');</script>";
		echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme'>");
	}else{
		echo "<script language='javascript'> alert('아이템 추가에 오류가 발생했습니다');history.go(-1)</script>";
		exit;
	}
}else if($query == "delete") {// 파일지우기
	$sqlstr="select category from ".$WIZTABLE["AVATARITEM"]." where no=$no";
	$list=$dbcon->get_row($sqlstr);

	if($list["category"] == "000000"){
		$common->js_alert('기본아이템은 삭제불가능합니다.');
	}else{
		## 등록이미지 삭제
		$avatar->en_name($no);
		$path = "../../config/wizavatar/avatarimg/";
		$path."avatarpreview/".$avatar->en_name($no);
		$path."avatar/".$avatar->en_name($no);
		## 뒷헤어는 다음에 프로그램 봐가면서
			
		$sqlstr="delete from ".$WIZTABLE["AVATARITEM"]." where no=$no";
		$dbcon->_query($sqlstr);	
		
		## face와 연동시 face 삭제
		
		$sqlstr = "select * from ".$WIZTABLE["AVATARFACE"]." where item_id = '$no'";
		$sqlqry = mysql_query($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		$imgname = $avatarpath."face_img/".$list["face01"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face01a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face02"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face02a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face03"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face03a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face04"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face04a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face05"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = $avatarpath."face_img/".$list["face05a"];
		if(is_file($imgname)) unlink($imgname);	
		
		$sqlstr="delete from ".$WIZTABLE["AVATARFACE"]." where item_id=$no";
		$dbcon->_query($sqlstr);								
	}
	
	echo "<script language='javascript'>alert('삭제 하였습니다!   ');</script>";
	echo("<script>location.href='../main.php?menushow=$menushow&theme=$theme';</script>");

}else if($query == "update"){

	if($Category2) $category = $Category2;
	else if($Category1) $category = $Category1;
	
	unset($reg_option);
	for($i=0; $i < count($reg_optionArr); $i++){
		if(!$Multi_Option[$i]) $Multi_Option[$i] = "0";
		$reg_option .= $Multi_Option[$i]."|";
	}
//이미지 업로딩 시작	
	$common->upload_path		= $avatarpath;
	//$common->ProhibitExtention	= $cfg["wizboard"]["ProhibitExtention"];
	$common->uploadmode			= "update";
	$common->oldfilename		= $oldfilename1;
	$common->delfile			= $del_file;
	//$option1 = $Filenamereserver;
	$common->uploadfile("file");
	$imgname = $common->returnfile;
						
	//$avatar->mode = "update";
	//$avatar->upload_path = $avatarpath;
	//$avatar->replacflag = "on";
	//$avatar->old_attachedfile=$oldfilename1;
	//$avatar->deletefile = $del_file;
	//$avatar->uploadfile("file");
	//$imgname = split("\|", $avatar->attachedfile);
//이미지 업로딩 끝
	$sqlstr = "update ".$WIZTABLE["AVATARITEM"]." set category='$category', name='$itemname', filename1='".$imgname[0]."', filename2='".$imgname[1]."', filename3='".$imgname[2]."', level='$level',gender='$gender', memo='$memo', layer='$layer', buy_p='$buy_p', sale_p='$sale_p', jaego='$jaego', face_show='$face', reg_option='$reg_option', ref_item='$ref_item', theme_item='$theme_item' where no = '$no'";
	//echo "테스트중 .. 잠시만 기다려 주세요 <br>";
	//echo "sqlstr = $sqlstr <br>";
	//exit;
	$result = $dbcon->_query($sqlstr);
	$avatar->move_file($imgname, $no);## 현재 업로드된 파일을 이름을 바꾼후 실 서비스 폴더로 이동하기
	if($result) {
		echo "<script language='javascript'>alert('수정 하였습니다');</script>";
		echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme&page=$page&no=$no&Category1=$Category1&Category2=$Category2&gender=$gender'>");
	}else {
		$common->js_alert('수정에 실패하였습니다.');
	}
}else if($query == "setup" ) {
/* 기타 관리자 기초 사항을 입력한다. */
$fp = fopen("../../config/avatar_config.php", "w");
fwrite($fp,"<?
## 아바타 기본 환경설정
\$avatar_skin = \"$avatar_skin\";
\$display_zero_money = \"$display_zero_money\";
?>"); 
fclose($fp); 
echo "<script language='javascript'>alert('수정 하였습니다');</script>";
echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme&page=$page&no=$no'>");
}
?>
