<?
if(!strcmp($query,"makewizdiarydb")){
	$RESULT= $dbcon->_query( "select count(*) from wizDiary");
		if ( !$RESULT) {
		$QUERY = "CREATE TABLE wizDiary (
		UID int(11) NOT NULL auto_increment,
		Id varchar(30) NOT NULL default '',
		Writer varchar(50) NOT NULL default '',
		PWD varchar(25) NOT NULL default '',		
		Schedule_Date int(11) NOT NULL default '0',
		ScheduleSubject varchar(50) NOT NULL,
		Schedule text NOT NULL,
		Status varchar(25) NOT NULL default '',
		flag varchar(10) NOT NULL default '',
		Spare1 varchar(25) NOT NULL default '',
		Spare2 varchar(25) NOT NULL default '',		
		PRIMARY KEY  (UID)
		) TYPE=MyISAM;";
		$dbcon->_query($QUERY, $DB_CONNECT) OR die(mysql_error());
		}
}
?>
<?
/* 카렌다 DB가 없으면 카렌다 DB를 생성한다. */
if(!$dbcon->is_table("wizpoll")):
?>

<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>ㅅ</legend>
						<div id="notice">[note]</div>
						<div id="comment">ㅇ</div>
						</fieldset>
						<p></p>	<table class="table_title">
        <TBODY>
          <TR>
            <TD bgColor=#ffffff><b><font color="#FF6600">일정관리 DATABASE INSTALL</font></b></TD>
          </TR>
          <TR>
            <TD bgColor=#ffffff><TABLE cellSpacing=0 cellPadding=0 width="100%" border=0 class="s1">
                <TBODY>
                  <TR>
                    <TD vAlign=top align=center width=70><font color=#ff6600>[note]</font> </TD>
                    <TD>아래 일정관리 DB생성하기 버튼을 누르시면 관련 DataBase가 생성됩니다.</TD>
                  </TR>
                </TBODY>
              </TABLE></TD>
          </TR>
        </TBODY>
      </TABLE>
      <br />
      <form>
        <input type='hidden' name='menushow' value='<?=$menushow?>'>
        <input type="hidden" name="theme" value="<?=$theme?>">
        <input type="hidden" name="query" value="makewizdiarydb">
        <input type="image" src="img/util_icon11.gif" width="129" height="20">
      </form></td>
  </tr>
</table>
<?
endif;
?>
<?
if(!strcmp($query,"diarysave")){
$Schedule_Date = mktime("$ScheduleHour", "$ScheduleMinute", "$ScheduleSecond", "$ScheduleMonth", "$ScheduleDay", "$ScheduleYear");
$sqlstr = "insert into wizDiary(Writer,PWD,Schedule_Date,ScheduleSubject,Schedule,Status,Spare1,Spare2)
values('$Writer','$PWD','$Schedule_Date','$ScheduleSubject','$Schedule','$Status','$Spare1','$Spare2')";
$dbcon->_query($sqlstr);
}
else if(!strcmp($query,"diarymodify")){
$Schedule_Date = mktime("$ScheduleHour", "$ScheduleMinute", "$ScheduleSecond", "$ScheduleMonth", "$ScheduleDay", "$ScheduleYear");
$sqlstr = "UPDATE wizDiary SET Writer='$Writer',Schedule_Date='$Schedule_Date',ScheduleSubject='$ScheduleSubject',Schedule='$Schedule',Status='$Status',Spare1='$Spare1',Spare2='$Spare2' WHERE UID='$UID'";
$dbcon->_query($sqlstr);
}else if(!strcmp($query,"diarydelete")){
  $sqlstr = "delete from wizDiary where UID = '$UID'";
 $dbcon->_query($sqlstr);
  echo "<script>alert('게시물을 삭제했습니다.');
location.replace('$PHP_SELF?menushow=$menushow&theme=util/util2&mode=view&Month=$Month&ThedayThetime_value=$ThedayThetime') ;
        </script>";
    exit();
 }
?>
<?
/* 특정달의 일수를 구하는 함수 */
function TotalDaysOfTheMonth($year,$month) {
global $TheDays;
	$TheDays = 1;
	while(checkdate($month,$TheDays,$year)) {
		$TheDays++;
	}
	return $TheDays;
}

/* 특정 년 월을 구하는 함수 */
if(!strcmp($mode,"minus")){

$Month--;
}
elseif(!strcmp($mode,"plus")){
$Month++;
}
elseif(!strcmp($mode,"minusyear")){
$Month=$Month-12;
}
elseif(!strcmp($mode,"plusyear")){
$Month=$Month+12;
}
elseif(!strcmp($mode,"view")){

}
elseif(!strcmp($mode,"write")){

}
else unset($Month);

$first_day = date('w', mktime(0,0,0,date("m")+$Month,1,date("Y")));

$TheMonth = date('m', mktime(0,0,0,date("m")+$Month,1,date("Y")));

$TheYear = date('Y', mktime(0,0,0,date("m")+$Month,1,date("Y")));

TotalDaysOfTheMonth($TheYear, $TheMonth);

?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>일정관리</legend>
						<div id="notice">[note]</div>
						<div id="comment">원하시는 날짜를 클릭하신 후 메모를 넣어주세요</div>
						</fieldset>
						<p></p>
      <table class="table_main">
        <tr>
          <td height="25" colspan=7 align="center" bgcolor="E0E4E8"><a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=minusyear&Month=<?=$Month?>'))">◁◁</a>&nbsp;&nbsp;&nbsp;<a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=minus&Month=<?=$Month?>'))">◁</a>&nbsp;
            <?=date('Y', mktime(0,0,0,date("m")+$Month,date("d"),date("Y")));?>
            년
            <?=date('m', mktime(0,0,0,date("m")+$Month,date("d"),date("Y")));?>
            월
            <?=date('M', mktime(0,0,0,date("m")+$Month,date("d"),date("Y")));?>
            &nbsp; <a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=plus&Month=<?=$Month?>'))">▷</a>&nbsp;&nbsp;&nbsp;<a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=plusyear&Month=<?=$Month?>'))">▷▷</a></td>
        </tr>
        <tr bgcolor=#FFFFFF>
          <td height="26" colspan="7" align="center" bgcolor="#FFFFFF">&nbsp;</td>
        </tr>
        <tr bgcolor="#FFFFFF">
          <td height="25" colspan="7" align="right" bgcolor="#FFFFFF">&nbsp;
            <!-- <a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2'))"><img src="img/util_icon7.gif" width="67" height="20" border="0"></a> --></td>
        </tr>
        <tr>
          <td bgcolor="#FFFFFF"><!-- 날짜 테이블 시작 -->
            <!-- 날짜 테이블 끝 -->
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td bgcolor="#CCCCCC"><table border="0" cellpadding="0" cellspacing=1 bordercolorlight=#CEE1FF  bordercolordark=#E1FFFD  align="center" width="100%" class="s1">
                    <tr bgcolor="E0E4E8">
                      <td width="106" height="24" align="center"><font color="#FF0000">Sun</font></td>
                      <td width="106" align="center">Mon</td>
                      <td width="106" align="center" bgcolor="E0E4E8">Tue</td>
                      <td width="106" align="center">Wed</td>
                      <td width="106" align="center">Thu</td>
                      <td width="106" align="center">Fri</td>
                      <td width="110" align="center">Sat</td>
                    </tr>
                    <tr>
                      <?		  

/* 요일과 날짜가 매치되지않으면 공백채우기 */

unset($count);	
for($i = 0; $i < $first_day; $i++) {
echo " <td bgcolor=#FFFFFF>&nbsp;</td>";
$count++;
}

for($j = 1; $j < $TheDays; $j++) {
?>
                      <form>
                        <?
/* $ThedayThetime은 카렌다의 모든 시간들을 유닉스 시간으로 변경한다. */
$ThedayThetime = mktime(date("H"),date("i"),date("s"),date("$TheMonth"),date("$j"),date("$TheYear"));
?>
                        <td height="40" valign="top" bgcolor=#FFFFFF style=padding-top:2pt;padding-left:2pt;><a href="javascript:void(location.replace('<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=view&Month=<?=$Month?>&ThedayThetime_value=<?=$ThedayThetime?>'))">
                          <?
 if ( date("Ymd") == $TheYear.$TheMonth.sprintf("%02d", $j)) {  // 오늘 날짜랑 같으면 ff0000색으로 표시 

  echo "<font style='color:#0000FF; text-decoration:none;'><b>$j</b></font>"; 

}elseif(!($count%7)){
echo "<font style='color:#FF0000; text-decoration:none;'>$j</font>"; 
}else { echo "<font style='color:#000000; text-decoration:none;'>$j</font>"; } 


$FirstTheDay = mktime(0,0,0,date("m",$ThedayThetime), date("d",$ThedayThetime),date("Y",$ThedayThetime));
$LastTheDay = mktime(0,0,0,date("m",$ThedayThetime), date("d",$ThedayThetime)+1,date("Y",$ThedayThetime));
$sqlstr = "select ScheduleSubject from wizDiary where Schedule_Date < '$LastTheDay' AND Schedule_Date > '$FirstTheDay' order by Schedule_Date ASC";
$dbcon->_query($sqlstr);
while($list=$dbcon->_fetch_array($sqlqry)):
echo "<br />".$list[ScheduleSubject];
endwhile;
?>
                          </a>
                          <input type="hidden" name="ThedayThetime" value="<?=$ThedayThetime?>">
                        </td>
                      </form>
                      <?
$count++; //요일을 계산하여 7이 되면 tr시켜줌



		if($count == 7) {

			echo " </tr> ";

			if($j != $totaldays) { echo "<tr>"; }

			unset($count);

		}

	}



// 달력뒤에 자리가 나오면 공백으로 채줘주기	

	while($count > 0 && $count < 7) {

		echo "<td bgcolor=#ffffff>&nbsp;</td>";

		$count++;

	}



?>
                    </tr>
                  </table></td>
              </tr>
            </table></td>
        </tr>
      </table>
      <br />
      <?
if($ThedayThetime_value):
$FirstTheDay = mktime(0,0,0,date("m",$ThedayThetime_value), date("d",$ThedayThetime_value),date("Y",$ThedayThetime_value));
$LastTheDay = mktime(0,0,0,date("m",$ThedayThetime_value), date("d",$ThedayThetime_value)+1,date("Y",$ThedayThetime_value));
?>
      <table class="table_main">
        <tr>
          <td height="22" align="right" bgcolor="#FFFFFF"><? echo date("Y 년 m 월 d 일", $ThedayThetime_value)?> 나의 스케쥴 </td>
        </tr>
        <tr>
          <td bgcolor="#FFFFFF"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="s1">
              <tr>
                <td width="13%" align="center" bgcolor="E0E4E8"><strong>시간</strong></td>
                <td width="74%" align="center" bgcolor="E0E4E8"><strong>일정</strong></td>
                <td width="13%" bgcolor="E0E4E8">&nbsp;</td>
              </tr>
              <?
$sqlstr = "select * from wizDiary where Schedule_Date < '$LastTheDay' AND Schedule_Date > '$FirstTheDay' order by Schedule_Date ASC";
$dbcon->_query($sqlstr);
$cnt=0;
while($list=$dbcon->_fetch_array($sqlqry)):
?>
              <tr>
                <td height="25"><? echo date("H 시 i 분", $list[Schedule_Date])?> </td>
                <td><a href="<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&mode=modify&Month=<?=$Month?>&ThedayThetime_value=<?=$ThedayThetime_value?>&UID=<?=$list[UID]?>">
                  <?=$list[ScheduleSubject]?>
                  </a> </td>
                <td align="center">&nbsp;</td>
              </tr>
              <tr bgcolor="E0E4E8">
                <td height="1"></td>
                <td></td>
                <td></td>
              </tr>
              <?
$cnt++;
endwhile;
if(!$cnt):/* 게시물이 존재하지 않을 경우 */
?>
              <tr>
                <td height="25">&nbsp;</td>
                <td>등록된 일정이 없습니다.</td>
                <td>&nbsp;</td>
              </tr>
              <tr bgcolor="E0E4E8">
                <td height="1"></td>
                <td></td>
                <td></td>
              </tr>
              <?
endif;
?>
            </table>
            <br />
            <table class="table_main">
              <form action="<?=$PHP_SELF?>">
                <?
if(!strcmp($mode,"modify")){
 $query="diarymodify"; 
 $sqlstr = "select * from wizDiary where UID = '$UID'";
 $dbcon->_query($sqlstr);
 $list = $dbcon->_fetch_array();
 
 }else{ $query="diarysave";}

?>
                <input type="hidden" name="ScheduleYear" value="<?=date("Y",$ThedayThetime_value)?>">
                <input type="hidden" name="ScheduleMonth" value="<?=date("m",$ThedayThetime_value)?>">
                <input type="hidden" name="ScheduleDay" value="<?=date("d",$ThedayThetime_value)?>">
                <input type='hidden' name='menushow' value='<?=$menushow?>'>
                <input type="hidden" name="theme" value="<?=$theme;?>">
                <input type="hidden" name="query" value="<?=$query?>">
                <input type="hidden" name="mode" value="view">
                <input type="hidden" name="Month" value="<?=$Month?>">
                <input type="hidden" name="ThedayThetime_value" value="<?=$ThedayThetime_value?>">
                <input type="hidden" name="UID" value="<?=$UID?>">
                <tr bgcolor="#FFFFFF">
                  <td width="100" height="25" align="right" bgcolor="E0E4E8"><strong>일정시간</strong></td>
                  <td width="10">&nbsp;</td>
                  <td><select name="ScheduleHour">
                      <?
for($i=1; $i<25; $i++){
if($i == date("H",$list[Schedule_Date])) $selected = " selected";
else unset($selected);
echo "<option value='$i'$selected>$i</option>";
}
?>
                    </select>
                    시
                    <select name="ScheduleMinute">
                      <?
for($i=0; $i<60; $i++){
if($i == date("i",$list[Schedule_Date])) $selected = " selected";
else unset($selected);
echo "<option value='$i'$selected>$i</option>";
}
?>
                    </select>
                    분
                    <select name="ScheduleSecond">
                      <?
for($i=0; $i<60; $i++){
if($i == date("s",$list[Schedule_Date])) $selected = " selected";
else unset($selected);
echo "<option value='$i'$selected>$i</option>";
}
?>
                    </select>
                    초</td>
                </tr>
                <tr bgcolor="#FFFFFF">
                  <td height="25" align="right" bgcolor="E0E4E8"><strong>일정제목</strong></td>
                  <td>&nbsp;</td>
                  <td><input type="text" style="width:98%" name="ScheduleSubject" value="<?=$list[ScheduleSubject]?>"></td>
                </tr>
                <tr bgcolor="#FFFFFF">
                  <td height="25" align="right" bgcolor="E0E4E8"><strong>일정내용</strong></td>
                  <td>&nbsp;</td>
                  <td><textarea name="Schedule" style="width:98%" rows="4"><?=$list[Schedule]?>
</textarea></td>
                </tr>
                <tr bgcolor="#FFFFFF">
                  <td colspan="3" align="center"><table border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <? if($mode == "modify"):?>
                        <td><script>nhnButton('수정','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script>
                        </td>
                        <td>&nbsp;</td>
                        <td><script>nhnButton('삭제','black9','<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=util/util2&query=diarydelete&Month=<?=$Month?>&ThedayThetime_value=<?=$ThedayThetime_value?>&UID=<?=$list[UID]?>',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script>
                        </td>
                        <? else: ?>
                        <td><script>nhnButton('등록','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script>
                        </td>
                        <? endif;?>
                        <td>&nbsp;</td>
                      </tr>
                    </table></td>
                </tr>
              </form>
            </table></td>
        </tr>
      </table>
      <?
endif;
?>
    </td>
  </tr>
</table>
