<?
/* 
제작자 : 폰돌
URL : http://www.shop-wiz.com
Email : master@shop-wiz.com
*** Updating List ***
2004-03-05 : 수정단의 버그(히든 값이 안들어가던) 변경

*/

if ($action == 'poll_write') {
$fp = fopen("../config/wizPoll_info.php", "w");
fwrite($fp,"<?
\$Poll_Skin_Name = \"$Poll_Skin_Name\";
\$Poll_ID = \"$Poll_ID\";
\$Poll_PopWidth = \"$Poll_PopWidth\";
\$Poll_PopHeight = \"$Poll_PopHeight\";
?>");
fclose($fp);
}

include "../config/wizPoll_info.php";

if(!$query):	
	if(!$dbcon->is_table("wizpoll")) ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=install');</script>";
	else ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=list');</script>"; 

/***** [Install Page] **********************************************************************************************/
elseif($query == "install"):
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>wizPoll Data Base Install</legend>
						<div id="notice">[note]</div>
						<div id="comment">현재 투표창과 관련하여 DataBase가 생성되지 않았으므로 아래 설치하기를 클릭하여 <br />
                      DataBase를 생성해 주세요</div>
						</fieldset>
						<p></p>	
      <table border=0>
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='query' value='install_ok'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <tr>
            <td align='right'><input type="image" src="img/util_icon11.gif" width="129" height="20"></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?
elseif($query == "install_ok"):
	// 투표 테이블 생성
$Result = $dbcon->_query("
		  CREATE TABLE wizpoll(
          UID INT AUTO_INCREMENT NOT NULL,
		  PID VARCHAR(200) NOT NULL,
		  Subject VARCHAR(255),
		  Contents VARCHAR(255),
		  Vote VARCHAR(255),
		  FromDay int(13),
		  ToDay int(13),
		  PRIMARY KEY(UID, PID)
		)");
if($Result) ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=list');</script>"; 
exit;
?>
<?
/***** [list display] **********************************************************************************************/
elseif($query == "list"):

$BOARD_NAME = "wizpoll";
$ListNo = 10;
$PageNo = 10;
$Todaydate = time();
/* 검색 키워드 및 WHERE 구하기 */
$WHERE = "WHERE UID <> ''";

if($pollquery == "ing") $WHERE .=" and FromDay <= '$Todaydate' and ToDay >= '$Todaydate'";
else if($pollquery == "end") $WHERE .=" and ToDay < '$Todaydate'";
if($stitle && $keyword){
$WHERE .= " AND $stitle LIKE '%$keyword%'";
}

/* 총 갯수 구하기 */

$TOTAL_STR = "SELECT count(UID) FROM $BOARD_NAME $WHERE";
$TOTAL = $dbcon->get_one($TOTAL_STR);

for($i=0; $i<3; $i++){
global $BOARD_NAME, $Todaydate;
	if($i==0) $totalwhere = "";
	else if($i==1) $totalwhere = "where FromDay <= '$Todaydate' and ToDay >= '$Todaydate'";
	else if($i==2) $totalwhere = "where ToDay < '$Todaydate'";
	$totalstr = "select count(*) from $BOARD_NAME $totalwhere";
	$total[$i] = $dbcon->get_one($totalstr);
}	
if(empty($cp) || $cp <= 0) $cp = 1;

?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>wizPoll Listing</legend>
						<div id="notice">[note]</div>
						<div id="comment">현재 투표상황등을 일괄적으로 보실 수 있습니다.<br />
                        메인에서 poll창 생성방법:<br />
                        include &quot;./util/wizpoll/wizpoll_func.php&quot;;<br />
                        include &quot;./config/wizPoll_info.php&quot;; 확인<br />
                        넣고 싶은 위치에 <br />
                        wizpoll_skin_include($Poll_Skin_Name,$Poll_ID,$Poll_PopWidth,$Poll_PopHeight);</div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <tr>
          <td bgcolor="#FFFFFF"> Total :
            <?=$total_no?>
            - Page :
            <?=$page?>
            /
            <?=$total_page?>
            <table width="100%" border=0 cellpadding=2 cellspacing=0 class="s1">
              <tr>
                <td align='center' <?=$bgcolor_all?>><a href='<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=list'>모든 
                  투표[<font color='blue'>
                  <?=$total[0]?>
                  </font>]</a></td>
                <td align='center' $bgcolor_ing><a href='<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=list&pollquery=ing'>진행중인 
                  투표[<font color='blue'>
                  <?=$total[1]?>
                  </font>]</a></td>
                <td align='center' $bgcolor_end><a href='<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=list&pollquery=end'>종료된 
                  투표[<font color='blue'>
                  <?=$total[2]?>
                  </font>]</a> </td>
                <td align='center'><script>nhnButton('등록하기','black9','<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=input_1&pollquery=<?=$poll?>',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
              </tr>
            </table>
            <table width=100% cellspacing=0 border=1 bgcolor=C0C0C0 align="CENTER" bordercolordark="white" bordercolorlight="#DDDDDD" class="s1">
              <tr bgcolor="E0E4E8">
                <td height="25" align='center' nowrap><strong>번호</strong></td>
                <td align='center' nowrap><strong>코드</strong></td>
                <td width='100%' align='center'><strong>주제</strong></td>
                <td align='center' nowrap><strong>투표</strong></td>
                <td width='80' align='center' nowrap><strong>시작일</strong></td>
                <td  width='80' align='center' nowrap><strong>종료일</strong></td>
                <td width='120' nowrap><strong>&nbsp;</strong></td>
              </tr>
              <? 
$START_NO = ($cp - 1) * $ListNo;
$BOARD_NO=$TOTAL-($ListNo*($cp-1));
$SELECT_STR="SELECT * FROM $BOARD_NAME $WHERE ORDER BY UID DESC LIMIT $START_NO, $ListNo";
$SELECT_QRY=$dbcon->_query($SELECT_STR);
$cnt=0;
while($List=@$dbcon->_fetch_array($SELECT_QRY)):
$today = time();
// 총 투표수
$Vote = explode("|",$List[Vote]);
$total_vote = "0";
for($i=0; $i<count($Vote)-1; $i++) $total_vote += $Vote[$i];

?>
              <tr bgcolor="#FFFFFF" onmouseover="this.style.backgroundColor='#ECF0EF'" onmouseout="this.style.backgroundColor=''">
                <td align='center' nowrap><?=$BOARD_NO?>
                  </font> </td>
                <td align='center' nowrap><?=$List[UID]?>
                </td>
                <td width='100%'><?=$List[Subject]?>
                </td>
                <td align='center' nowrap><?=$total_vote?>
                </td>
                <td align='center' nowrap><?=date("Y.m.d",$List[FromDay])?>
                </td>
                <td align='center' nowrap <?=$bgcolor?>><?=date("Y.m.d",$List[ToDay])?>
                </td>
                <td align='center' nowrap bgcolor="#FFFFFF" ><a href=javascript:void()> </a>
                  <table border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td><script>nhnButton('보기','black9','javascript:window.open("../util/wizpoll/DEFAULT/result.php?uid=<?=$List[UID]?>&mode=view&window_open=y","WizPollViewPage_<?=$List[UID]?>","width=300,height=500,srollbar=auto,toolbar=no,statusbar=no");',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                      <td>&nbsp;</td>
                      <td><script>nhnButton('삭제','black9','<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=del&uid=<?=$List[UID]?>&poll=<?=$poll?>&page=<?=$page?>',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                      <td>&nbsp;</td>
                      <td><script>nhnButton('수정','black9','<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&query=modify_1&uid=<?=$List[UID]?>&poll=<?=$poll?>&page=<?=$page?>',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                    </tr>
                  </table></td>
              </tr>
              <?
$cnt++;
$BOARD_NO--;
endwhile;
if(!$cnt):/* 게시물이 존재하지 않을 경우 */
?>
              <tr bgcolor="#FFFFFF" onmouseover="this.style.backgroundColor='#ECF0EF'" onmouseout="this.style.backgroundColor=''">
                <td colspan="7" align='center' nowrap>투표가 없습니다.<a href=javascript:void(window.open('../util/wizpoll/DEFAULT/result.php?uid=<?=$List[UID]?>&query=view&window_open=y','WizPollViewPage_<?=$List[UID]?>','width=<?=$window_width?>,height=<?=$window_height?>,srollbar=auto,toolbar=no,statusbar=no'))></a> </td>
              </tr>
              <?
endif;
?>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' align='center'><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$page_arg1 = $PHP_SELF."?memushow=$memushow&theme=$theme&query=$query&pollquery=$pollquery";
$page_arg2 = array("listno"=>$ListNo,"pageno"=>$PageNo,"cp"=>$cp,"total"=>$TOTAL); 
//$page_arg3 = array("pre"=>"./img/pre.gif","next"=>"./img/next.gif");
echo $common->paging($page_arg1,$page_arg2,$page_arg3);
?>
                </td>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td bgcolor="#FFFFFF">&nbsp;</td>
        </tr>
      </table>
      <table class="table_main">
        <form name="" action="<?=$PHP_SELF?>">
          <input type="hidden" name="memu13" value="show">
          <input type="hidden" name="theme" value="<?=$theme?>">
          <input type="hidden" name="action" value="poll_write">
          <tr bgcolor="E0E4E8">
            <td width="203" height="25" align='center' nowrap><strong>스킨명</strong></td>
            <td width="218" align='center' nowrap><strong>폴코드</strong></td>
            <td width="160" align='center'><strong>폭(Pixel)</strong></td>
            <td width="160" align='center' nowrap><strong>높이(Pixel)</strong></td>
          </tr>
          <tr bgcolor="#FFFFFF" onmouseover="this.style.backgroundColor='#ECF0EF'" onmouseout="this.style.backgroundColor=''">
            <td align='center' nowrap><select style="WIDTH: 160px" name="Poll_Skin_Name">
                <?
$vardir = "../util/wizpoll";
$open_dir = opendir($vardir);
        while($opendir = readdir($open_dir)) {
                if(($opendir != ".") && ($opendir != "..") && ($opendir != "func") && is_dir("$vardir/$opendir")) {
                        if($Poll_Skin_Name == "$opendir") $selected = "selected"; 
						else unset($selected);
                              echo "<option value=\"$opendir\" $selected>$opendir 스킨</option>\n";

                }
        }
closedir($open_dir);
?>
              </select></td>
            <td align='center' nowrap><select style="WIDTH: 160px" name="Poll_ID">
                <?
$sqlsubstr = "select UID from $BOARD_NAME where FromDay <= '$Todaydate' and ToDay >= '$Todaydate' ORDER BY UID DESC";
$sqlsubqry = $dbcon->_query($sqlsubstr);
$cnt = 0;
        while($pidlist = $dbcon->_fetch_array($sqlsubqry)):
			if($Poll_ID == "$pidlist[UID]") $selected = "selected";
			else unset($selected);
					echo "<option value=\"$pidlist[UID]\" $selected>$pidlist[UID]</option>\n";
			$cnt ++;
       endwhile;
	   if(!$cnt) echo "<option value=\"\" $selected>진행중인 설문이 없습니다.</option>\n";
?>
              </select>
              &nbsp; </td>
            <td align="center"><input name='Poll_PopWidth' type='text' class='dd1' size="10" value="<?=$Poll_PopWidth?>">
              pixel </td>
            <td align='center' nowrap><input name='Poll_PopHeight' type='text' class='dd1' size="10" value="<?=$Poll_PopHeight?>">
              pixel </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td colspan='4' align='center'><script>nhnButton('등록하기','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?

## 투표 등록
elseif($query == "input_1"):

	// 등록 양식 출력
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step1[투표등록]</legend>
						<div id="notice">[note]</div>
						<div id="comment">코드는 되도록 영문및 숫자로만 기입해주세요(예, Poll1)<br />
                      주제는 투표의 특성에 가장 적합한 항목을 선택해 주세요(예, 내가 투표하는 이유는?)<br />
                      항목은 주제에 대한 항목의 갯수를 지정해 주세요<br />
                      기간은 투표기간으로서 숫자로만 입력바랍니다(예, 15)</div>
						</fieldset>
						<p></p>
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='query' value='input_2'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><input name='Subject' type='text' size="50" class='dd1'></td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>항목 
              : </strong></td>
            <td><input name='Contents' type='text' size="5" class='dd1'>
              개(숫자로 입력 요망)</td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?
$ThisYear = date("Y");
$ThisMonth = date("m");
$ThisDay = date("d");
if(!$regyear) $regyear = $ThisYear;
if(!$regmonth) $regmonth = $ThisMonth;
if(!$regday) $regday = $ThisDay;
?>
              <select name="fyear">
                <?
for($i=$ThisYear-1; $i <$ThisYear+2; $i++){
if($regyear == "$i") $selected = "selected";
else unset($selected);
 echo "<option value='$i' $selected>$i</option>";
}
?>
              </select>
              년
              <select name="fmonth">
                <?
for($i=01; $i < 13; $i++){
$k = substr("0".$i, -2);
if($regmonth == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              월
              <select name="fday">
                <?
for($i=01; $i < 32; $i++){
$k = substr("0".$i, -2);
if($regday == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              일~
              <select name="tyear">
                <?
for($i=$ThisYear-1; $i <$ThisYear+2; $i++){
if($regyear == "$i") $selected = "selected";
else unset($selected);
 echo "<option value='$i' $selected>$i</option>";
}
?>
              </select>
              년
              <select name="tmonth">
                <?
for($i=01; $i < 13; $i++){
$k = substr("0".$i, -2);
if($regmonth == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              월
              <select name="tday">
                <?
for($i=01; $i < 32; $i++){
$k = substr("0".$i, -2);
if($regday == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              일</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('다음','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?
elseif($query == "input_2"):

	if(CheckField($Subject)|| CheckField($Contents) || CheckField($period)) ECHO"<center>모두 입력 하셔야 다음 단계로 갈수 있습니다.<br />[뒤로가기] 버튼을 누르시고 모두 입력하시기 바랍니다.</center>";
	if(CheckInt($Contents)) ECHO("항목은 숫자로만 이루어 져야 합니다.");
	$FromDay = mktime(0,0,0,$fmonth, $fday, $fyear);
	$ToDay = mktime(0,0,-1, $tmonth, $tday+1, $tyear);
	$period = ($ToDay - $FromDay)/(60*60*24)+1;
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step2[항목입력]</legend>
						<div id="notice">[note]</div>
						<div id="comment">각각의 항목을 넣어주세요</div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <input type='hidden' name='query' value='input_3'>
          <input type='hidden' name='poll' value='<?=$poll?>'>
          <input type='hidden' name='Subject' value='<?=$Subject?>'>
          <input type='hidden' name='FromDay' value='<?=$FromDay?>'>
          <input type='hidden' name='ToDay' value='<?=$ToDay?>'>
          <input type='hidden' name='period' value='<?=$period?>'>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><?=$Subject?>
            </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>항목 
              : </strong></td>
            <td><?=$Contents?>
              개</td>
          </tr>
          <?		
	// 항목 출력
	for($i=1; $i<=$Contents; $i++) {
?>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>
              <?=$i?>
              . </strong></td>
            <td><input name='Contents[]' type='text' size="50" class='dd1'>
            </td>
          </tr>
          <?
	}
?>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?=date("Y년m월d일", $FromDay);?>
              ~
              <?=date("Y년m월d일", $ToDay);?>
              (
              <?=floor($period)?>
              일간)</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('다음','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?


elseif($query == "input_3"):
	if(CheckField($Subject) || CheckField($period))  
	echo "<script>window.alert('항목을 입력하셔야 다음 단계로 갈수가 있습니다. \\n\\n[뒤로가기] 버튼을 눌러서 항목을 입력하세요.'); history.go(-1);</script>";
    // 총 항목수 체크
    for($i=0; $i<count($Contents)-1; $i++) $total .= $Contents[$i];
	if(CheckField($total)) ECHO"<center>항목을 입력하셔야 다음 단계로 갈수가 있습니다.<br />[뒤로가기] 버튼을 눌러서 항목을 입력하세요.</center>";
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step3[확인 단계]</legend>
						<div id="notice">[note]</div>
						<div id="comment">아래 입력 사항으로 등록 하시려면 [등록하기] 버튼을 누르세요.<br />
                      수정하시려면 [이전단계] 버튼을 누르세요.</div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <input type='hidden' name='query' value='input_ok'>
          <input type='hidden' name='poll' value='<?=$poll?>'>
          <input type='hidden' name='Subject' value='<?=$Subject?>'>
          <input type='hidden' name='FromDay' value='<?=$FromDay?>'>
          <input type='hidden' name='ToDay' value='<?=$ToDay?>'>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><?=$Subject?>
            </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>항목 
              : </strong></td>
            <td><?=sizeof($Contents)?>
              개</td>
          </tr>
          <?
	// 항목 출력
    $j = 1;
	for($i=0; $i<count($Contents); $i++) {
		if($Contents[$i]) {
?>
          <input type='hidden' name='Contents[]' value='<?=$Contents[$i]?>'>
          <input type='hidden' name='Vote[]' value='0'>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>
              <?=$j?>
              . </strong></td>
            <td><?=$Contents[$i]?>
            </td>
          </tr>
          <?	
			$j++;
		}
	}
?>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?=date("Y년m월d일", $FromDay);?>
              ~
              <?=date("Y년m월d일", $ToDay);?>
              (
              <?=floor($period)?>
              일간)</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('다음','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?


elseif($query == "input_ok"):

	if(CheckField($Subject) || CheckField($FromDay) || CheckField($ToDay) || CheckField($Contents) || CheckField($Vote)) 
	echo "<script>window.alert('등록중 에러가 발생하였습니다!!'); history.go(-1);</script>";
	for($i=0; $i<count($Vote); $i++) {
		$Contents_ok .= $Contents[$i]."|";
		$vote_ok .= $Vote[$i]."|";
	}


	// 등록 실패 메시지
$Result = $dbcon->_query("insert into wizpoll (Subject,Contents,Vote,FromDay,ToDay) values('$Subject','$Contents_ok','$vote_ok','$FromDay','$ToDay')");
ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=list&poll=$poll&page=$page');</script>";
exit;

/* 이후 수정하기 $Step1 */
## 수정하기
elseif($query == "modify_1"):
	$query = $dbcon->_query("select * from wizpoll where UID='$uid'");
	$List = $dbcon->_fetch_array($query);
    $Contentsexp = explode("|",$List[Contents]);
    $Voteexp = explode("|",$List[Vote]);
    $total_Contents = count($Contentsexp)-1;
// 기간 (종료일에서 등록일을 뺀 값을 가지고 기간을 구한다)
$period = ($List[ToDay]-$List[FromDay])/60/60/24;

?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step1[수정 단계]</legend>
						<div id="notice">[note]</div>
						<div id="comment">수정하시려면 수정할 내용을 변경 후 [다음단계] 버튼을 누르세요.</div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <input type='hidden' name='query' value='modify_2'>
          <input type='hidden' name='poll' value='<?=$poll?>'>
          <input type='hidden' name='page' value='<?=$page?>'>
          <input type='hidden' name='uid' value='<?=$uid?>'>
          <?
		for($i=0; $i<sizeof($Contentsexp); $i++) {
			if($Voteexp[$i] == "") $Voteexp[$i] = "0";
?>
          <input type='hidden' name='Contents[]' value='<?=$Contentsexp[$i]?>'>
          <input type='hidden' name='Vote[]' value='<?=$Voteexp[$i]?>'>
          <?
	    }
?>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><input name='Subject' type='text' value='<?=$List[Subject]?>' size="50" class='dd1'></td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong> 항목 :</strong></td>
            <td><input name='total_Contents' type='text' value='<?=$total_Contents?>' size="5">
            </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?
$ThisYear = date("Y");
$ThisMonth = date("m");
$ThisDay = date("d");
$regyear = date("Y", $List[FromDay]);
$regmonth = date("m", $List[FromDay]);
$regday = date("d", $List[FromDay]);
?>
              <select name="fyear">
                <?
for($i=$ThisYear-1; $i <$ThisYear+2; $i++){
if($regyear == "$i") $selected = "selected";
else unset($selected);
 echo "<option value='$i' $selected>$i</option>";
}
?>
              </select>
              년
              <select name="fmonth">
                <?
for($i=01; $i < 13; $i++){
$k = substr("0".$i, -2);
if($regmonth == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              월
              <select name="fday">
                <?
for($i=01; $i < 32; $i++){
$k = substr("0".$i, -2);
if($regday == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              일~
              <?
$regyear = date("Y", $List[ToDay]);
$regmonth = date("m", $List[ToDay]);
$regday = date("d", $List[ToDay]);
?>
              <select name="tyear">
                <?
for($i=$ThisYear-1; $i <$ThisYear+2; $i++){
if($regyear == "$i") $selected = "selected";
else unset($selected);
 echo "<option value='$i' $selected>$i</option>";
}
?>
              </select>
              년
              <select name="tmonth">
                <?
for($i=01; $i < 13; $i++){
$k = substr("0".$i, -2);
if($regmonth == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              월
              <select name="tday">
                <?
for($i=01; $i < 32; $i++){
$k = substr("0".$i, -2);
if($regday == "$k") $selected = "selected";
else unset($selected);
 echo "<option value='$k' $selected>$k</option>";
}
?>
              </select>
              일</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('다음','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?
elseif($query == "modify_2") :
	if(CheckField($Subject) || CheckField($Contents) || CheckInt($total_Contents) || CheckField($Vote))  
	echo "<script>window.alert('모두 입력하셔야 수정 됩니다.'); history.go(-1);</script>";
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step2[수정 단계]</legend>
						<div id="notice">[note]</div>
						<div id="comment">항목을 수정하시고 [다음단계] 버튼을 누르세요.</div>
						</fieldset>
						<p></p>	
      <?	  
	$FromDay = mktime(0,0,0,$fmonth, $fday, $fyear);
	$ToDay = mktime(0,0,-1, $tmonth, $tday+1, $tyear);
	$period = ($ToDay - $FromDay)/(60*60*24)+1;
?>
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <input type='hidden' name='query' value='modify_3'>
          <input type='hidden' name='poll' value='<?=$poll?>'>
          <input type='hidden' name='page' value='<?=$page?>'>
          <input type='hidden' name='uid' value='<?=$uid?>'>
          <input type='hidden' name='Subject' value='<?=$Subject?>'>
          <input type='hidden' name='FromDay' value='<?=$FromDay?>'>
          <input type='hidden' name='ToDay' value='<?=$ToDay?>'>
          <input type='hidden' name='period' value='<?=$period?>'>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><?=$Subject?>
            </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong> 항목 :</strong></td>
            <td><?=$total_Contents?>
              개 </td>
          </tr>
          <?
	// 항목 출력
	for($i=0; $i<$total_Contents; $i++) {
		$no = $i+1;

		if(!$Vote[$i]) $Vote[$i] = "0";
?>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>
              <?=$no?>
              .</strong></td>
            <td><input name='Contents[]' type='text' value='<?=$Contents[$i]?>' size="50" class='dd1'>
              <input name='Vote[]' type='text' value='<?=$Vote[$i]?>' size="5" class='dd1'></td>
          </tr>
          <?
		$no++;
	}
?>
          <input type='hidden' name='period' value='<?=$period?>'>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?=date("Y년m월d일", $FromDay);?>
              ~
              <?=date("Y년m월d일", $ToDay);?>
              (
              <?=floor($period)?>
              일간)</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('다음','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
</form>
<?
elseif($query == "modify_3") :
	if(CheckField($Subject) || CheckField($Contents) || CheckField($Vote) || CheckField($FromDay) || CheckField($period))  ECHO "<script>window.alert('모두 입력하셔야 수정 됩니다.'); history.go(-1);</script>";
?>
<?
	$total_Contents = count($Contents);
?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>Step3[수정 단계]</legend>
						<div id="notice">[note]</div>
						<div id="comment">아래 내용이 맞으면 [수정완료] 버튼을 누르세요.</div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <form action='<?=$PHP_SELF?>' method='post'>
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type='hidden' name='theme' value='<?=$theme?>'>
          <input type='hidden' name='query' value='modify_ok'>
          <input type='hidden' name='poll' value='<?=$poll?>'>
          <input type='hidden' name='page' value='<?=$page?>'>
          <input type='hidden' name='uid' value='<?=$uid?>'>
          <input type='hidden' name='Subject' value='<?=$Subject?>'>
          <input type='hidden' name='FromDay' value='<?=$FromDay?>'>
          <input type='hidden' name='ToDay' value='<?=$ToDay?>'>
          <tr bgcolor="#FFFFFF">
            <td width="150" height="25" align='right' bgcolor="E0E4E8"><strong>주제 
              : </strong></td>
            <td><?=$Subject?>
            </td>
          </tr>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong> 항목 :</strong></td>
            <td><?=$total_Contents?>
              개 </td>
          </tr>
          <?
	$no = "1";
	for($i=0; $i<$total_Contents; $i++) {
		if($Contents[$i]) {
		if(!$Vote[$i]) $Vote[$i] = "0";
		if(CheckInt($Vote[$i])) $Vote[$i] = "0";
		?>
          <input type='hidden' name='Contents[]' value='<?=$Contents[$i]?>'>
          <input type='hidden' name='Vote[]' value='<?=$Vote[$i]?>'>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>
              <?=$no?>
              .</strong></td>
            <td><?=$Contents[$i]?>
              : [
              <?=$Vote[$i]?>
              ] </td>
          </tr>
          <?
		$no++;
		}
	}
?>
          <tr bgcolor="#FFFFFF">
            <td height="25" align='right' bgcolor="E0E4E8"><strong>기간 
              : </strong></td>
            <td><?=date("Y년m월d일", $FromDay);?>
              ~
              <?=date("Y년m월d일", $ToDay);?>
              (
              <?=floor($period)?>
              일간)</td>
          </tr>
          <tr align="center" bgcolor="#FFFFFF">
            <td colspan="2"><table border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td><script>nhnButton('이전','black9','javascript:history.back();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                  <td>&nbsp;</td>
                  <td><script>nhnButton('<font color=blue>수정완료</font>','black9','javascript:submit();',4,0,'#565656','#FFFFFF','#C4C4C4','#ffffff','#ffffff','#ffffff')</script></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
<?
elseif($query == "modify_ok"):
	if(CheckField($Subject) || CheckField($Contents) || CheckField($Vote) || CheckField($FromDay))  
	ECHO "<script>window.alert('모두 입력하셔야 수정 됩니다.'); history.go(-1);</script>";
	for($i=0; $i<count($Contents); $i++) {
		$Contents_ok .= $Contents[$i]."|";
		$vote_ok .= $Vote[$i]."|";
	}

// 수정
$sqlstr = "UPDATE wizpoll SET Subject = '$Subject',Contents= '$Contents_ok',Vote = '$vote_ok',FromDay = '$FromDay',ToDay = '$ToDay' where UID='$uid'";
$Result =$dbcon->_query($sqlstr);
ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=list&poll=$poll&page=$page');</script>";
exit;	


## 삭제하기
elseif($query == "del"):
	if(!@$dbcon->_query("delete from wizpoll where UID='$uid'")) {
		echo "<script>window.alert('선택한 폴은 삭제되지 않습니다.'); history.go(-1);</script>";
	}
ECHO"<script>location.replace('$PHP_SELF?menushow=$menushow&theme=$theme&query=list&poll=$poll&page=$page&poll=$poll&page=$page');</script>";
exit;		

## 지난 투표
elseif($query == "etc") :
    // 한페이지에 표시될 페이지 링크수 
	$page_num = "10";

	// 한페이지에 보여질 투표 갯수
	$limit = "5";

	// 투표 갯수 뽑아오기
	$total_no = $dbcon->get_one("select count(*) from wizpoll");

    // 페이지 구하기
    if(!$page) $page=1;

    $total_page = intval(($total_no-1)/$limit)+1;
    $first = ($page-1)*$limit;
    $last = $limit;
    if($total_no < $last) $last = $total_no;
    $limit = "limit $first,$last";

    // 게시물 뽑아오기
    $query = $dbcon->_query("select * from wizpoll order by UID desc $limit");
 ?>
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>지난 투표 보기</legend>
						<div id="notice">[note]</div>
						<div id="comment"> </div>
						</fieldset>
						<p></p>	
      <table class="table_title">
        <tr bgcolor="#FFFFFF">
          <td height="25" colspan="2" bgcolor="#FFFFFF"><strong>Total :
            <?=$total_no?>
            - Page :
            <?=$page?>
            /
            <?=$total_page?>
            </strong></td>
        </tr>
        <tr bgcolor="#FFFFFF">
          <td height="25" colspan="2" align='right' bgcolor="#FFFFFF"><table class="table_main">
              <tr bgcolor="E0E4E8">
                <td height="25" align='center' nowrap><strong>번호</strong></td>
                <td nowrap>&nbsp;</td>
                <td align='center' nowrap><strong>주제</strong></td>
                <td nowrap>&nbsp;</td>
                <td width='100%' align='center'><strong>투표</strong></td>
                <td nowrap>&nbsp;</td>
                <td align='center' nowrap><strong>참여</strong></td>
              </tr>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' height='1'></td>
              </tr>
              <?
	// 투표가 하나도 없을때
    if($total_no == "0") {
?>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' align='center'>투표가 없습니다.</td>
              </tr>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' height='1'></td>
              </tr>
              <?	}

	else {

	while($List = $dbcon->_fetch_array($query)) {
		$num = $total_no - $first;
?>
              <tr bgcolor="#FFFFFF">
                <td align='center' valign='top' nowrap><?=$num?>
                  </font> </td>
                <td></td>
                <td valign='top' nowrap><a href=javascript:void(window.open('<?=$PHP_SELF?>?uid=<?=$List[UID]?>&window_open=y&bar_width=<?=$bar_width?>&bar_height=<?=$bar_height?>&bar_color=<?=$bar_color?>&width=<?=$width?>','wizpoll_<?=$List[UID]?>','width=<?=$window_width?>,height=<?=$window_height?>,srollbar=auto,toolbar=no,statusbar=no'))>
                  <?=$List[Subject]?>
                  </a></td>
                <td></td>
                <td width='100%'><table border='0' cellspacing='0' cellpadding='0'>
                    <?

		$Contents = explode("|",$List[Contents]);
		$Vote = explode("|",$List[Vote]);

		// 총 투표수
		for($y=0; $y<count($Contents)-1; $y++) $total_vote += $Vote[$y];

		for($z=0; $z<count($Contents)-1; $z++) {
			//$Contents[$z] = str_replace("58(3A)","|",$Contents[$z]);
			$no_Contents = $z+1;
			$percent = @intval($Vote[$z]/$total_vote*100);
			$bar_width = 99;
			$bar_length = @intval($Vote[$z]/$total_vote*$bar_width)+1;
?>
                    <tr>
                      <td width='100%'><?=$no_Contents?>
                        .</font>
                        <?=$Contents[$z]?>
                      </td>
                      <td align='right' nowarap><table border='0' cellspacing='0' cellpadding='0' height='<?=$bar_height?>' width='<?=$bar_length?>' bgcolor='<?=$bar_color?>'>
                          <tr>
                            <td></td>
                          </tr>
                        </table></td>
                      <td nowrap><font color='red' size='1' face='verdana'>&nbsp;
                        <?=$Vote[$z]?>
                        </font> 표 :
                        <?=$percent?>
                        %&nbsp;</font> </td>
                    </tr>
                    <?
		}
?>
                  </table></td>
                <td></td>
                <td align='center' nowrap><font color='blue' size='1' face='verdana'>
                  <?=$total_vote?>
                  </font></td>
              </tr>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' height='1'></td>
              </tr>
              <?
		$first++;
	}

	}

?>
              <tr bgcolor="#FFFFFF">
                <td colspan='7' align='center'><?
	page_link("$PHP_SELF?menushow=$menushow&theme=$theme&query=etc");
?>
                </td>
              </tr>
            </table>
            <strong></strong></td>
        </tr>
        <?
	$no = "1";
	for($i=0; $i<$total_Contents; $i++) {
		if($Contents[$i]) {
		if(!$Vote[$i]) $Vote[$i] = "0";
		if(CheckInt($Vote[$i])) $Vote[$i] = "0";
		?>
        <input type='hidden' name='Contents[]' value='$_Contents'>
        <input type='hidden' name='Vote[]' value='$Vote[$i]'>
        <?
		$no++;
		}
	}
	// 마감일 구하기
	$endday = $FromDay+($period*24*60*60);
	
	// 정확한 날짜 구하기
	$startday_time = date("Y년m월d일",$FromDay);
	$endday_time = date("Y년m월d일",$endday);
?>
      </table></td>
  </tr>
</table>
<?
endif;
?>
