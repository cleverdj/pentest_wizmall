<?
/*
powered by 폰돌
Reference URL : http://www.shop-wiz.com
Contact Email : master@shop-wiz.com
Free Distributer : 

Copyright shop-wiz.com
*** Updating List ***
*/

$CAT_IMG_ATTACHED = "enable";
if(!$cat_flag) $cat_flag = "wizmall";
$cat_depth = 3;
$new_category_name = addslashes(trim($new_category_name));
$cat_img_path = "../config/uploadfolder/categoryimg";
/*********************************************************************************************************************************/


if ($action == 'in' && $new_category_name ) {
	$lv = strlen($ccode)/3 + 1;//현재 카테고리의 레벨을 구한다.
	$cat_no = $admin->getcatno($lv, $ccode);
	$cat_order = $admin->getcatorder($lv, $ccode);
	/* 파일 업로딩 시작 */
	
	/* 파일 업로딩 시작 */
	$common->upload_path = $cat_img_path;
	$common->uploadmode = "insert";
	$common->uploadfile("file");
	$cat_img = $common->returnfile[0];
	/* 파일 업로딩 끝 */
		
	$sqlstr = "INSERT INTO wizCategory (cat_order,cat_no,cat_name,cat_flag,cat_img) VALUES('$cat_order','$cat_no','$new_category_name','$cat_flag','$cat_img')";
	//echo "\$sqlstr = $sqlstr <br />";
	$dbcon->_query($sqlstr);
}else if ($action == 'up') {
	## 카테고리로 등록된 이미지를 구한다.
	$sqlstr = "select cat_img FROM wizCategory WHERE cat_no = '$ccode' and cat_flag='$cat_flag'";
	$cat_img = $dbcon->get_one($sqlstr);
	
	## 현재 카테고리 정보를 변경한다.
	$sqlstr = "update wizCategory set cat_name = '$new_category_name' WHERE cat_no = '$ccode' and cat_flag='$cat_flag'";
	$dbcon->_query($sqlstr);

	
	## 파일 업로딩 시작
	##database 연결
	$common->db_connect();
	$common->oldfilename = $cat_img;
	$common->upload_path = $cat_img_path;
	$common->uploadmode = "update";
	$common->uploadfile("file");
	$cat_img = $common->returnfile[0];
	## 파일 업로딩 끝
	$common->js_location("$PHP_SELF?menushow=$menushow&theme=$theme&cat_flag=$cat_flag&where=$where&ccode=$ccode");
}else if ($action == 'de') {
	## 하위 카테고리 존재시 삭제를 cancel
	$sqlstr = "select count(1) from wizCategory where cat_no like '%$ccode' and cat_flag='$cat_flag'";
	$cnt = $dbcon->get_one($sqlstr);
	if($cnt > 1){## 자신을 폼함하여 1개 이상 존재시
		$common->js_alert("하위 카테고리가 존재 합니다.\\n\\n먼저 하위 카테고리를 삭제해 주시기 바랍니다.");
	}
	
	## 현카테고리에 상품이 존재하면 삭제를 cancel
	$sqlstr = "select count(1) from wizMall where Category = '$ccode'";
	$cnt = $dbcon->get_one($sqlstr);
	if($cnt > 0){## 제품이 한개 이상 존재시
		$common->js_alert("현재 카테고리에 제품(다중혹은 단일)이 등록되어있습니다..\\n\\n먼저 해당카테고리의 상품을 삭제하거나 변경해 주시기 바랍니다.");
	}	

/* 카테고리 DB에서 지우기 START */
	#첨부된 이미지 삭제하기
	$sqlstr = "select cat_img from wizCategory WHERE cat_no = '$ccode' and cat_flag='$cat_flag'";
	$dbcon->_query($sqlstr);
	$list = $dbcon->_fetch_array();
	if (file_exists($cat_img_path."/".$list[cat_img]) && $list[cat_img]) unlink($cat_img_path."/".$list[cat_img]);
	
	# 카테고리 삭제
	$sqlstr = "DELETE FROM wizCategory WHERE cat_no = '$ccode' and cat_flag='$cat_flag'";
	$dbcon->_query($sqlstr);
 
 	$common->js_location("$PHP_SELF?menushow=$menushow&theme=$theme&cat_flag=$cat_flag&ccode=$ccode");
}else if($action == "in_desc"){
	$sqlstr = "update wizCategory set cat_top = '$cat_top', cat_bottom = '$cat_bottom' where cat_no = '$cat_no' and cat_flag='$cat_flag'";
	$dbcon->_query($sqlstr);
	$common->js_location("$PHP_SELF?menushow=$menushow&theme=$theme&cat_flag=$cat_flag&where=$where&ccode=$ccode&code=$cat_no");
}
?>
<script language="Javascript1.2" >
<!-- // load htmlarea
_editor_url = "../js/";                     // URL to htmlarea files
var win_ie_ver = parseFloat(navigator.appVersion.split("MSIE")[1]);
if (navigator.userAgent.indexOf('Mac')        >= 0) { win_ie_ver = 0; }
if (navigator.userAgent.indexOf('Windows CE') >= 0) { win_ie_ver = 0; }
if (navigator.userAgent.indexOf('Opera')      >= 0) { win_ie_ver = 0; }
if (win_ie_ver >= 5.5) {
  document.write('<scr' + 'ipt src="' +_editor_url+ 'editor.js"');
  document.write(' language="Javascript1.2"></scr' + 'ipt>');  
} else { document.write('<scr'+'ipt>function editor_generate() { return false; }</scr'+'ipt>'); }
//-->
</script>
<SCRIPT LANGUAGE=javascript>
<!--
function actionqry(f,val){
	f.action.value = val;
	f.submit();
}

function cat_manage(code,flag){
	switch(flag){
		case "de":
			location.href = "<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&cat_flag=<?=$cat_flag?>&ccode="+code+"&action="+flag;
		break;
		case "coding":
			location.href = "<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&cat_flag=<?=$cat_flag?>&ccode="+code+"&action="+flag;
			location.href = "<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&cat_flag=<?=$cat_flag?>&ccode="+code+"&action="+flag;
		break;		
		default:
			location.href = "<?=$PHP_SELF?>?menushow=<?=$menushow?>&theme=<?=$theme?>&cat_flag=<?=$cat_flag?>&ccode="+code;
		break;
	}
	
}
//-->
</SCRIPT>
<!-- body start -->
<table class="table_outline">
  <tr>
    <td valign="top"><fieldset class="desc">
						<legend>카테고리 메니저</legend>
						<div id="notice">[note]</div>
						<div id="comment">상품카테고리를 등록, 수정, 변경 삭제 하는 곳입니다. 또한 카테고리별로 별도의 코딩을 
                  하실 수 도 있습니다. <br />
                  ( <img src="img/cat_view.gif" width="16" height="16"> 매장보기 <img src="img/cat_modify.gif" width="16" height="16"> 카테고리등록 및 수정 <img src="img/cat_text.gif" width="16" height="16"> 카테고리별 상,하단 코딩 <img src="img/cat_delete.gif" width="14" height="16"> 카테고리 삭제 ) </div>
						</fieldset>
						<p></p>	
      <table class="table_main">
        <TR>
          <TD bgColor=#ffffff>               <form action='<?=$PHP_SELF?>' method=post enctype="multipart/form-data">
                <input type='hidden' name='menushow' value='<?=$menushow?>'>
                <input type=HIDDEN name="theme" value='<?=$theme?>'>
                <input type=HIDDEN name="action" value='in'>
                <input type=HIDDEN name="cat_flag" value='<?=$cat_flag;?>'>
            <table width="100%" border="0">

                <tr>
                  <td width="170"><input size=26 name="new_category_name"></td>
                  <td width="41"><input name="file[]" type="file" id="file[]"></td>
                  <td width="236"><input type="image" src="img/da.gif" width="84" height="20">
                  </td>
                  <td align="right"><input type="button" name="button3" id="button3" value="전체리스트출력" onClick="location.href = './catmanager/shopmanager1_1.php?DownForExel=yes')" /></td>
                </tr>
              
            </table></form></TD>
        </TR>
      </TABLE>
      <br />
      <table class="table_main">
        <tr align=middle height=22>
          <td colspan="3" bgcolor="#FFFFFF"><table cellspacing=0 bordercolordark=white width="760" bgcolor=#c0c0c0 bordercolorlight=#dddddd border=0 class="s1" cellpadding="0">
              <tr>
                <?
$width = (int)(100/$cat_depth);		
for($i=0; $i<$cat_depth; $i++){

//echo "1번";
	$j = $i+1;
	$bgcolor = $i%2 ? "bgcolor='#B9C2CC'":"bgcolor='#E0E4E8'";
	$c_len = $j*3;
	$p_len = $c_len-3;
	$ccode_len = strlen($ccode);
  ?>
                <td valign="top" bgcolor="#ffffff" width="<?=$width?>%"><!-- 분류 테이블 시작 -->
                  <table width=100% cellspacing=0 cellpadding=0 border=0 class="s1">
                    <tr>
                      <td align="center" <?=$bgcolor?>>
                        <?=$j?>
                        차카테고리</td>
                    </tr>
                    <tr>
                      <td background="img/list_line.gif" height=1></td>
                    </tr>
                    <?
//echo "$ccode_len >= ".$i*3;
if ($ccode_len >= $i*3){
	$orderby = "order by cat_order asc ";
	if ($i > 0){
		$whereis1 = "WHERE LENGTH(cat_no) = ".$c_len." and RIGHT(cat_no, $p_len) = '".substr($ccode, -$p_len)."' and cat_flag='$cat_flag' ";
	}else{
		$whereis1 = "WHERE LENGTH(cat_no) = ".$c_len." and cat_flag='$cat_flag' ";
	}
	$sqlstr1 = "SELECT * FROM wizCategory $whereis1 ".$orderby;
	//echo $sqlstr1;
	$sqlqry1 = $dbcon->_query($sqlstr1);
	while($list1=$dbcon->_fetch_array($sqlqry1)):
		$tccode = $list1["cat_no"];
?>
                    <TR HEIGHT=23>
                      <TD><table width=100% cellspacing=0 cellpadding=0 border=0>
                          <TR HEIGHT=23>
                            <TD style="cursor:pointer" onClick="cat_manage('<?=$tccode?>');"><?
		if(substr($ccode, -$c_len) == $tccode) ECHO "<B>$list1[cat_name]</B></A>\n";
		else ECHO " $list1[cat_name]\n";
?>
                            </TD>
                            <TD ALIGN=RIGHT><A HREF='../wizmart.php?code=<?=$tccode?>' TARGET='_blank'><IMG SRC='./img/cat_view.gif' BORDER='0' alt='보기'></A> <A HREF="javascript:cat_manage('<?=$tccode?>');"><IMG SRC='./img/cat_modify.gif' BORDER='0' alt='등록/수정'></A> <A HREF="javascript:cat_manage('<?=$tccode?>', 'coding');"><IMG SRC='./img/cat_text.gif' BORDER='0' alt='코딩'></A> <A HREF="javascript:cat_manage('<?=$tccode?>', 'de');"><IMG SRC='./img/cat_delete.gif' BORDER='0' alt='삭제'></A> </TD>
                          </TR>
                        </table></TD>
                    </TR>

                    <?
 endwhile;
 
 }//if ($i < 1 ){
?>
                  </table>
                  <!-- 분류 테이블 끝 -->
                </td>
                <?
	}
	?>
              </tr>
            </table></td>
        </tr>
        <tr>
          <td height="50" colspan="3"  bgcolor="#ffffff"><? if($ccode):?>
            <table border="0" cellspacing="0" cellpadding="0">
              <form action='<?=$PHP_SELF?>' method=post enctype="multipart/form-data" name="catfrm">
                <input type='hidden' name='menushow' value='<?=$menushow?>'>
                <input type=HIDDEN name=theme value='<?=$theme?>'>
                <input type=HIDDEN name="action" value=''>
                <input type=HIDDEN name="ccode" value='<?=$ccode?>'>
                <input type=HIDDEN name="cat_flag" value='<?=$cat_flag;?>'>
                <tr>
                  <td><input type=TEXT name="new_category_name" size=13>                  </td>
                  <?
if($CAT_IMG_ATTACHED == "enable"):
?>
                  <td width="10">&nbsp;</td>
                  <td><input name="file[]" type="file" id="file[]"></td>
                  <?
endif;
?>
                  <td width="10">&nbsp;</td>
                  <? if($where != 'sub_regis3'):?>
                  <td><input type="button" name="button" id="button" value="등록" onclick="actionqry(document.catfrm,'in')" /></td>
                  <td width="10">&nbsp;</td>
                  <? endif; ?>
                  <td><input type="button" name="button2" id="button2" value="변경" onclick="actionqry(document.catfrm,'up')" /></td>
                </tr>
              </form>
            </table>
            <? endif;?>
          </td>
        </tr>
        <tr>
          <td align=middle bgcolor="#ffffff">&nbsp;</td>
          <td bgcolor="#ffffff">&nbsp;</td>
          <td align=middle bgcolor="#ffffff"></td>
        </tr>
        <?
if($action == "coding" && $ccode): 
$sqlstr = "SELECT * FROM wizCategory WHERE  cat_no = '$code' and cat_flag='$cat_flag'";
$sqlqry = $dbcon->_query($sqlstr);
$list = $dbcon->_fetch_array($sqlqry);
?>
        <form name = "SaveCatCoding" action="<?=$PHP_SELF?>" method="post">
          <input type="hidden" name="cat_no" value = "<?=$code?>">
          <input type="hidden" name="theme" value = "<?=$theme?>">
          <input type='hidden' name='menushow' value='<?=$menushow?>'>
          <input type="hidden" name="action" value = "in_desc">
          <input type="hidden" name="where" value = "<?=$where?>">
          <input type="hidden" name="ccode" value="<?=$ccode?>">
          <input type=HIDDEN name="cat_flag" value='<?=$cat_flag;?>'>
          <tr>
            <td colspan="3" align=middle bgcolor="#ffffff"><table cellspacing=0 cellpadding=0 width="100%" bgcolor=#ffffff border=0>
                <tr>
                  <td>&nbsp;</td>

                </tr>
                <!--매장카테고리 코딩 시작 -->
                <tr>
                  <td bgcolor="E0E4E8" class="s1">?페이지 
                    html 삽입 : html로 등록해 주시고 등록시 &lt;table&gt;테크를 만들어 넣어 주시기를 추천합니다<br />
                    <font color="#0000FF">줄바꿈 : Shift + Enter &nbsp;&nbsp;&nbsp; 
                    문단바꿈 : Enter </font></td>
                </tr>
              </table>
              <br />
              <span class="s1"><b>상단코딩</b></span><br />
              <textarea name="cat_top" cols=106 rows=5 id="cat_top"><?=$list[cat_top]?>
</textarea>
              <br />
              <script language='javascript1.2'>
		editor_generate('cat_top');
		</script>
              </font><span class="s1"><b><br />
              하단코딩</b></span><br />
              <textarea name="cat_bottom" cols=106 rows=5 id="cat_bottom"><?=$list[cat_bottom]?>
</textarea>
              <br />
              <script language='javascript1.2'>
		editor_generate('cat_bottom');
		</script>
            </td>
          </tr>
          <!--매장 카테고리 코딩 끝 -->
          <br />
          <tr>
            <td  colspan=3 bgcolor="#ffffff"><div align="center">
                <input name="image" type="image" src="img/sul.gif" width="68" height="20">
              </div></td>
          </tr>
        </form>
        <?
endif;
?>
        <tr>
          <td align=middle bgcolor="#ffffff">&nbsp;</td>
          <td bgcolor="#ffffff">&nbsp;</td>
          <td align=middle bgcolor="#ffffff"></td>
        </tr>
      </table></td>
  </tr>
</table>
<!-- body end --------->