<?
/* 
powered by 폰돌
Reference URL : http://www.shop-wiz.com
Contact Email : master@shop-wiz.com
Free Distributer : 
Copyright shop-wiz.com
*** Updating List ***
*/
include "../common/header_pop.php";

include ("../../config/common_array.php");


$flag = "sms";
if($query == "insert"){
	foreach($message as $key=>$value){
		//내용이 있으면 update  아니면 insert
		$sqlstr = "select count(1) from ".$WIZTABLE["MESSAGE"]."  where delivery_status = '$key' and flag='$flag'";
		$result=$dbcon->get_one($sqlstr);
		if($result){//update
			$sqlstr = "update ".$WIZTABLE["MESSAGE"]." set message = '".$message[$key]."', subject = '".$subject[$key]."', enable='".$enable[$key]."' where delivery_status = '$key' and flag='$flag'";
			$dbcon->_query($sqlstr);
		}else{//insert
			$sqlstr = "insert into ".$WIZTABLE["MESSAGE"]." (flag, delivery_status, message, subject, enable) values('$flag','$key','".$message[$key]."','".$subject[$key]."', '".$enable[$key]."')";
			$dbcon->_query($sqlstr);
		}
	
	}
	//스킨을 일괄적으로 업데이트 한다.
	$sqlstr = "update ".$WIZTABLE["MESSAGE"]." set skin = '$MailSkin' where flag = 'mail'";
	$dbcon->_query($sqlstr);	
}
?>
<html>
<head>
<title>위즈몰 - 문자메시지 관리 모드</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<link rel="stylesheet" href="../common/admin.css" type="text/css">
</head>
<script language=javascript>
<!--
var limitlen = 50;//제한글자수

function cutText(v) {
	var tmpStr = v.value;
	var szComplete = "";
	var tcount = 0;
	var onechar;
	
	for (k=0;k<tmpStr.length;k++) {
		onechar = tmpStr.charAt(k);
		
		if (escape(onechar).length > 4) {
			tcount += 2;
		}else if (onechar!='\r') {
			tcount++;
		}
	
		if (tcount > limitlen) {
			tmpStr = szComplete;
			v.value = tmpStr;
			eval("document."+v.form.name+".cbyte.value = limitlen");
			break;
		} else {
			szComplete = szComplete + onechar;
		}
	}
}

function cal_byte(v){
    var tmpStr;
    var temp=0;
    var onechar;
    var tcount;
    tcount = 0;

    tmpStr = new String(v.value);
    temp = tmpStr.length;

    for (k=0;k<temp;k++){
        onechar = tmpStr.charAt(k);

        if (escape(onechar).length > 4) {
            tcount += 2;
        }else if (onechar!='\r') {
            tcount++;
        }
    }

    eval("document."+v.form.name+".cbyte.value = tcount");

    if(tcount>limitlen) {
        reserve = tcount-limitlen;
        alert("메시지 내용은 "+limitlen+"바이트 이상은 전송하실수 없습니다.\r\n 쓰신 메세지는 "+reserve+"바이트가 초과되었습니다.\r\n초과된 부분은 자동으로 삭제됩니다.");
        cutText(v);
        return;
    }
}
//-->
</script>
<body bgcolor="#FFFFFF" text="#000000">
<span class="s1"><br />
SHOPWIZ 메세지 전송 서비스 - 휴대폰 문자전송 </span> 
<table cellspacing=1 bordercolordark=white width="420" bgcolor=#c0c0c0 bordercolorlight=#dddddd 
border=0 class="s1" cellpadding="1">
  <tr  bgcolor=#B9C2CC> 
    <td bgcolor="E0E4E8" colspan="5">무선메시지  </td>
  </tr>
</table>
<br />
<FORM ACTION='<?=$PHP_SELF?>' NAME=msg METHOD=post>
  <INPUT TYPE=HIDDEN NAME="query" VALUE='insert'>
  <table width="420" 
border=0 cellpadding="1" cellspacing=1 bordercolorlight=#dddddd bordercolordark=white bgcolor=#c0c0c0 class="s1">
 <?
$enableMail = array("20","30","40","50");//필요한 주문단계에 따른 메시지창 디스플레이
foreach($enableMail as $key=>$value){
$list = $admin->getmessage_cont($value, $flag);
?>
    <tr  bgcolor=white height=25> 
      <td width=80 bgcolor=#f3f3f3><?=$DeliveryStatusArr[$value]?></td>
      <td> <textarea name="message[<?=$value?>]" cols=40 rows=3 id="MSG1" onKeyUp="javascript:cal_byte(this);" onFocus="javascript:cal_byte(this);"><?=$list["message"];?></textarea> </td>
    </tr>
<?
}//foreach($enableMail as $key=>$value){
?>    
    <tr  bgcolor=white height=25> 
      <td colspan="2" bgcolor=#f3f3f3> 
        <input size=3 name=cbyte>
        /50 bytes</td>
    </tr>
  </table>
  <br />
  <table cellspacing=0 bordercolordark=white width="420" bordercolorlight=#dddddd 
border=0 class="s1" cellpadding="0">
    <tr height=25> 
      <td > <table width="200" border="0" align="center">
          <tr> 
            <td><img src="../img/dada.gif" width="75" height="20" onClick="javascript:document.forms[0].reset()"; style="cursor:pointer"></td>
            <td><input type="image" src="../img/ju.gif" width="75" height="20"></td>
          </tr>
        </table></td>
    </tr>
  </table>
</form>
<br />
<span class="s1">※ 무선메시지는 구매자의 휴대폰으로 문자메시지를 보내는 기능입니다.<br />
※ 문자는 최대 50바이트 이하이어야 합니다.<br />
※ 발송된 문자메세지는 수신까지 대략 10초~2분 정도가 걸립니다.</span> 
</body>
</html>