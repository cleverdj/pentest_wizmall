<?php
/* 
제작자 : 폰돌
제작자 URL : http://www.shop-wiz.com
제작자 Email : master@shop-wiz.com
Free Distributer 

*** Updating List ***
*/

include "./lib/inc.depth0.php";

include "./lib/class.board.php";
$board = new board();
$board->get_object($dbcon, $common);

if(is_file("./config/wizboard/table/config.php")) include "./config/wizboard/table/config.php";//전체환경변수 입력

##클라스에 각종 변수값 입력
$geturl = $common->getdecode($_GET["getdata"]);//get 방식으로 호출된 data값 변환

$BID			= $geturl["BID"]?$geturl["BID"]:$BID;
$GID			= $geturl["GID"]?$geturl["GID"]:$GID;
$cp	= $geturl["cp"] ? $geturl["cp"]:$cp;//현재페이지
$UID			= $geturl["UID"]?$geturl["UID"]:$UID;
$category		= $geturl["category"]?$geturl["category"]:$category;
$mode			= $geturl["mode"]?$geturl["mode"]:$mode;
if(!$mode) $mode = "list";
$adminmode		= $geturl["adminmode"]?$geturl["adminmode"]:$adminmode;
$optionmode		= $geturl["optionmode"]?$geturl["optionmode"]:$optionmode;
$search_term	= $geturl["search_term"]?$geturl["search_term"]:$search_term;
$SEARCHTITLE	= $geturl["SEARCHTITLE"]?$geturl["SEARCHTITLE"]:$SEARCHTITLE;
$searchkeyword	= $geturl["searchkeyword"]?urldecode($geturl["searchkeyword"]):$searchkeyword;
//$RECOMMAND		= $geturl["RECOMMAND"]?$geturl["RECOMMAND"]:$RECOMMAND;
$oderflag		= $geturl["oderflag"]?$geturl["oderflag"]:$oderflag;


$board->bid				= $BID;
$board->gid				= $GID;
$board->page_var["cp"]	= $cp ? $cp:1;//현재페이지
$board->uid				= $UID;
$board->category		= $category;
$board->mode			= $mode;
$board->adminmode		= $adminmode;
$board->optionmode		= $optionmode;
$board->search_term		= $search_term;
$board->SEARCHTITLE		= $SEARCHTITLE;
$board->searchkeyword	= $searchkeyword;
$board->oderflag		= $oderflag;

$optionmodeArr = explode("|", $optionmode);

if(!$BID) $common->js_alert("\\n\\n보드아이디가 존재하지 않습니다.\\n\\n", "cur");
if(!$GID) $common->js_alert("\\n\\n그룹아이디가 존재하지 않습니다.\\n\\n", "cur");
if(!is_dir("./config/wizboard/table/$GID/$BID")) $common->js_alert("\\n\\n폴더가 존재하지 않습니다.\\n\\n", "cur");

$config_include_path = "./config/wizboard/table/$GID/$BID";
include $config_include_path."/config.php";#보드관련 세부 config 관련 정보
if(!$board->listcnt) $board->listcnt = $cfg["wizboard"]["ListNo"];
if(!$board->pagecnt) $board->pagecnt = $cfg["wizboard"]["PageNo"];
$board->cfg = $cfg;//환경설정 파일들을 입력한다.
# 회원모드이면 로그인 상태와 회원등급을 책크하여 읽기/쓰시/수정 권한 책크.
$board->checkperm($cfg["member"]);

#그룹정보가져오기
$sqlstr = "select Grp from wizTable_Main where BID = '$BID' and GID = '$GID'";
$sqlqry=$dbcon->get_one($sqlstr);

#카테고리정보가져오기
//$sqlstr = "select ordernum, catname from wizTable_Category  where bid = '$BID' and gid = '$GID'";
//$sqlqry = $dbcon->_query($sqlstr);
//while($list = $dbcon->get_rows()):
//	$ordernum = $list["ordernum"];
//	$catname = $list["catname"];
///	$categoryname[$ordernum] = $catname;
//endwhile;

include ("./config/cfg.core.php");;



/****[스킨은 다르지만 동일한 데이트를 사용할때, 즉 SameDB가 있을 때] *******/

if(!$SameDB){
	 $tb_name="wizTable_${GID}_${BID}";
	 $UpdirPath = $GID."/".$BID;
}else{
	$tb_name="wizTable_${SameDB}";
	$UpdirPath = $SameDB;
}
$board->boardname = $tb_name;

## RECOMMAND(추천)글이면 추천 RECCOUNT를 1씩 올린다. 비추천이면 NONRECCOUNT를 1씩 올린다.
## 이후 lib/ajax.replevote.php 에서 처리
//if($RECOMMAND) $board->addreccount($RECOMMAND, $UID);
/****[확장DB사용시] *******/
if($ExtendDB && $ExtendDBUse=="checked")
$tb_name="$ExtendDB";
/******************************************************************************/

/* 리플을 등록한다 */
if(!strcmp($REPLE_MODE, "WRITE") || !strcmp($REPLE_MODE, "update")){
//include "./wizboard/func/WRITE_ONELINE_REPLE.php";
	$board->is_spam($spamfree);
	include "./wizboard/func/wizboard_qry.php";
}

if($mode == "view"){//보기상태일경우 일반적인 책크 부분
	if($NoticeBID){ //공지 테이블이 있으면 현재 BID 를 NoticeBID로 교체한다. 
		$tb_name = "wizTable_".$NoticeBID;
		//보드 교체후 view page가 끝나는 곳에서 반드시 원래 보드로 복귀시켜준다.
	}
	/* 잘못된 경로에서의 접근이면 list.php로 돌린다 */
	if(!$UID) ECHO "<script>location.replace('$PHP_SELF')</script>";
	
	
	
	
		
	if(!$RECOMMAND)## recommand 시 중복을 피하기 위해
	{
		$board->MakeChannel();## channel에 카운트 넣기## 보드별 통계치(Channel)를 만든다.
		$board->addviewcount($UID);## COUNT를 1씩 올린다.
	}
	## 이전글 다음글에서 이전글의 UID 와 다음글의 UID를 구한다 

	$board->getpreitem($UID, $cfg["wizboard"]["SubjectLength"]);// 이전글 클라스내에 생성 $listpre
	$board->getpnextitem($UID, $cfg["wizboard"]["SubjectLength"]);//다음글 클라스내에 생성 $listnext

	##  상세보기 관련 모든 내용 가져오기
	$boardview = $board->getview($UID);

	## 비밀글 읽을 권한 책크
	$board->is_secret_perm($boardview["Secret"], $boardview["FID"]);

}

/************************************************ mode가 write일때 **********************************************************/
if(!strcmp($mode,"write") && $bmode=="write"){
	$board->is_spam($spamfree);
	include "./wizboard/func/wizboard_qry.php";
}

/************************************ bmode가 modify일때 ******************************************************************/
if(!strcmp($mode,"modify") && !strcmp($bmode,"modify")){
	include "./wizboard/func/wizboard_qry.php";
}

/**************************************************** mode가 reply일때 *****************************************************/
if(!strcmp($mode,"reply") && !strcmp($bmode,"reply")){
	$board->is_spam($spamfree);
	include "./wizboard/func/wizboard_qry.php";
}


/****************** 본격적으로 본론 진입 ***********************/
if(!strcmp($cfg["wizboard"]["INCLUDE_MALL_SKIN"],"yes") && tableskin!="skip" && $adminmode != "true" && $optionmode != "frame"):/* Board에 스킨 인클루드 책크시나 관리자단에서 보는 것이 아니거나 옵션모드가 프래임(프래임을 이용하여 wizboard삽입)이 아닐경우 */
	if(is_file("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_start.php");
	
	echo "<!-- top menu start -->";
	if (file_exists("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php")) include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_top.php");
	echo "<!-- top menu end -->";
	
	echo "<!-- left menu start -->";
	if ($cfg["skin"]["MenuSkin_Inc"] == 'checked') include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_left.php");
	echo "<!-- left menu end  -->";
	/* Board에 스킨 인클루드 책크시 */
endif;


echo "<!-- main menu start  -->";
if($adminmode == "true" || $optionmode == "frame"){
	include "./wizboard/default/top.php";
}else if(file_exists($config_include_path."/top.php")){
	include $config_include_path."/top.php";
}
?>
  <!-- wizboard 관련하여 공통 자바스크립트 및 css 사용 -->
<script type="text/javascript" language="javascript" src="./js/jquery-1.3.2.js"></script>
<script type="text/javascript" language="javascript" src="./js/wizmall.js"></script>
<script type="text/javascript" language="javascript" src="./js/wizboardjs.php?UID=<?=$UID?>&BID=<?=$BID?>&GID=<?=$GID;?>&BOARD_SKIN_TYPE=<?=$cfg["wizboard"]["BOARD_SKIN_TYPE"]?>"></script>
<link rel="stylesheet" href="./css/board.css" type="text/css" />
<div id="layout_main" style="float:left">
  <div id="wizboardmain" style="width:<?=$cfg["wizboard"]["TABLE_WIDTH"]?><?=$cfg["wizboard"]["TABLE_WIDTH_UNIT"]?>; text-align:<?=$cfg["wizboard"]["TABLE_ALIGN"]?>">
<?
#html 편집기 사용
if($cfg["wizboard"]["editorenable"] == "1"){
echo "<SCRIPT language=\"JavaScript\" src=\"./js/alditor/alditorjs.php?alpath=./js/alditor/\" type=\"text/javascript\"></SCRIPT>";
}
$folder_skin = "./wizboard/skin/".$cfg["wizboard"]["BOARD_SKIN_TYPE"];
$folder_icon = "./wizboard/icon/".$cfg["wizboard"]["ICON_SKIN_TYPE"];
$folder_btnm = "";
$folder_reple = "./wizboard/skin_reple/".$cfg["wizboard"]["REPLE_SKIN_TYPE"];

switch ( $mode ){
	case ( "view" ) :
		$board->getcategorylist(); ## 카테고리정보구하기
		include ($folder_skin."/view.php");
		## 리스트 페이지 삽입 
		if($cfg["wizboard"]["ListEnable"] == "yes"):
			$ThisFileName = basename(__FILE__); // get the file name
			$path = str_replace($ThisFileName,"",__FILE__);   // get the directory path
			include "${path}/list.php"; 
		endif;		
		if($NoticeBID){ //공지테이블에서 원래 테이블로 변경한다. 
			$tb_name = "wizTable_".$BID;
		}
	break;
	case ( "write" ) :
	case ( "reply" ) :
	case ( "modify" ) :
		$board->getcategorylist(); ## 카테고리정보구하기
		include ($folder_skin."/write.php");
	break;
	case ( "delete" ) :
		include ("./wizboard/boarddelete.php");
	break;
	case ( "login" ) :
		include ("./wizboard/member_login.php");
	break;
	case ( "modlogin" ) :
	case ( "secret" ) :
		include ("./wizboard/member_login_secret.php");
	break;
	case ( "down" ) :
		include ("./wizboard/member_login.php");
	break;							
	default ://리스트
		$board->getorderby($oderflag); ##정열값 구하기
		$board->getwhere($skey, $sstr); ## 검색 키워드 및 WHERE 구하기
		$board->get_total_cnt(); ##총갯수 구하기 ($this->page_var["tc"]);
		$board->getpagevar(); ## 페이징 관련 변수 구하기
		$board->getcategorylist(); ## 카테고리정보구하기
		include ($folder_skin."/list.php");
	break;
}
?>
  </div>
  </div>
  <!-- main menu end -->
  <?
if($adminmode == "true" || $optionmode == "frame"){
	include "./wizboard/default/bottom.php";
}else if(file_exists($config_include_path."/bottom.php")){
	include $config_include_path."/bottom.php";
}

if(!strcmp($cfg["wizboard"]["INCLUDE_MALL_SKIN"],"yes") && tableskin!="skip" && $adminmode != "true"  && $optionmode != "frame"):/* Board에 스킨 인클루드 책크시 */				  

echo "<!-- bottom menu start -->";
if (is_file("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php") && tableskin!="skip") include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/menu_bottom.php");
echo "<!-- bottom menu end -->";
include ("./skinwiz/layout/".$cfg["skin"]["LayoutSkin"]."/layout_close.php");
/* Board에 스킨 인클루드 책크시 */
endif;
$dbcon->_close();
?>