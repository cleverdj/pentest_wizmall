<?
include "../../config/db_info.php";
include "../../config/db_connect.php";
include "../AUTH_CHECK.php";
require_once "../../wizavatar/lib/class.avatar.php";
$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;
//PointInsert

if ($query == 'insert'){
	$avatar->user_id = $userid;
	$avatar->content = $content;
	$avatar->point = $point;
	$avatar -> PointInsert();
	
	//exit;
	echo "<html>
	<META http-equiv=\"refresh\" content =\"0;url=$PHP_SELF?userid=$userid\">
	</html>";
	exit;
}else if ($query == 'delete'){
	$avatar->mode = "delete";
	$avatar->uid = $seq;
	$avatar -> PointInsert();
	echo "<html>
	<META http-equiv=\"refresh\" content =\"0;url=$PHP_SELF?userid=$userid&CURRENT_PAGE=$page\">
	</html>";
	exit;
}
?>
<HTML>
<HEAD>
<title>마일리지 정보</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<style type='text/css'>
<!--
body {
	font-family: '굴림';
	font-size: 9pt;
	color:black;
	text-decoration: none;
}
A:link {
	text-decoration:none;
}
A:visited {
	text-decoration:none;
}
A:active {
	text-decoration:none;
}
A:hover {
	text-decoration:none;
}
tr, td {
	font-family: '굴림';
	font-size: 9pt;
	color:black;
	text-decoration: none;
}
//
-->
</style>
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<BODY bgcolor=white topmargin=0 leftmargin=10 marginwidth=0 marginheight=0>
<script>
function frm_val(f){
if(f.content.value==''){
alert('내용이 입력되지 않았습니다.');
f.content.focus();
return false;
}
var Digit = '1234567890'
if(f.point.value==''){
alert('지급 금액을 입력하세요');
return false;
}
else{
var len =f.point.value.length;
var ret;
ret =false;
for(var i=0;i<len;i++){
var ch = f.point.value.substring(i,i+1);
for (var k=0;k<=Digit.length;k++){
if(Digit.substring(k,k+1) == ch)
{
ret = true;
break;
}
}
if (!ret){
//alert('숫자만 입력가능합니다.');
//f.point.focus();
//return false;
}
ret = false;
}
}
}
function delconfirm(seq,page){
	if (confirm('정말로 삭제하시겠습니까?')){
		location.href="<?=$PHP_SELF;?>?query=delete&userid=<?=$userid;?>&seq="+seq+"&page="+page;
	}
}

</script>
<script language=javascript>
function really() {
        if (confirm('\n\n삭제된 데이터는 복구가 불가능합니다.  \n\n정말로 삭제하시겠습니까?  \n\n')) return true;
        return false;
}
</script>
<br>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td><table cellpadding=0 cellspacing=0 border=0 width=100%>
        <tr>
          <td align=left valign=top width=10></td>
          <td align=left valign=top><b>
            <?=$QryPoint[Name];?>
            회원님의 밤톨이현황</b></td>
        </tr>
      </table>
      <hr width='100%' color="gray">
      <form action='<?=$PHP_SELF?>' method=post name=form1 onsubmit='return frm_val(this)'>
        <input type=hidden name=userid value='<?=$userid?>'>
        <input type=hidden name=query value='insert'>
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td align=left><b>내용 :</b>
              <input type=text name=content size=60 maxlength=60>
              <br>
              <b>금액 :</b>
              <input type='text' name='point'  size=12  maxlength=10>
              <input type='submit' value='확 인'>
              (-포인트일경우 -2000원과 같이 입력해주세요) </td>
          </tr>
        </table>
        <p>
        <TABLE cellSpacing=0 borderColorDark=white width="100%" bgColor=#c0c0c0 borderColorLight=#dddddd border=1 class="s1">
          <tr align="center" bgcolor="#B9C2CC">
            <td width="52" height="28"><font color="#FFFFFF"><b>번호</b></font></td>
            <td width="439"><font color="#FFFFFF"><b>적립내역</b></font></td>
            <td width="189"><font color="#FFFFFF"><b>가감 적립금 </b></font></td>
            <td width="86"><font color="#FFFFFF"><b>날짜</b></font></td>
            <td width="86"><font color="#FFFFFF"><b>삭제</b></font></td>
          </tr>
          <tr>
            <td height="1" colspan="7" bgcolor="#dddddd"></td>
          </tr>
          <?
/* 페이징과 관련된 수식 구하기 */
$whereis = "WHERE id = '$userid'";
$sqlstr = "SELECT count(1) FROM ".$WIZTABLE["AVATARPOINT"]." $whereis";
//echo $sqlstr;
$sqlqry = mysql_query($sqlstr);
$list = mysql_fetch_array($sqlqry);
$TOTAL = $list[0];

$totalpoint = $avatar->check_point($userid);


$ListNo = "15";
$PageNo = "20";

if(empty($CURRENT_PAGE) || $CURRENT_PAGE <= 0) $CURRENT_PAGE = 1;
//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CURRENT_PAGE / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */

$START_NO = ($CURRENT_PAGE - 1) * $ListNo;
$BOARD_NO=$TOTAL-($ListNo*($CURRENT_PAGE-1));

$sqlstr = "select * from ".$WIZTABLE["AVATARPOINT"];
$sqlstr .= " $whereis order by uid desc limit $START_NO, $ListNo";

//echo $sqlstr;
$sqlqry = mysql_query($sqlstr);
$SUB_SMONEY = 0;
while($list=mysql_fetch_array($sqlqry)):
?>
          <tr bgcolor="#FFFFFF">
            <td height="26"><div align="center"><B>
                <?=$BOARD_NO?>
                </B></div></td>
            <td><FONT COLOR=BROWN>
              <?
echo $list["contents"];
?>
              </FONT></td>
            <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td align="right"><font color=BROWN>&nbsp; </font><font color=RED><b>
                    <?=number_format(str_replace("-","",$list["point"]))?>
                    </b></font><font color=BROWN>&nbsp; </font></td>
                  <td width="60" align="right"><?
if (eregi("-", $list["point"])) {
ECHO "<OPTION style='color:red;'>감산(-)<OPTION>";
$how = 1;
$ORDER_MSG = "<FONT COLOR=ORANGE>(거래취소)</FONT>";
}
else {
$how = 2;
ECHO "<OPTION style='color:blue;'>가산(+)<OPTION>";
$ORDER_MSG = "(거래완료)";
}
?>
                  </td>
                </tr>
              </table></td>
            <td><font color=BROWN>
              <?=date("Y/m/d", $list["wdate"])?>
              </font></td>
            <td align="center"><A HREF='#' onClick="delconfirm('<?=$list["uid"]?>', '<?=$CURRENT_PAGE?>');">[삭제]</A></td>
          </tr>
          <tr>
            <td height="4" colspan="7" bgcolor="#dddddd"></td>
          </tr>
          <?
$SUB_SMONEY += $list["point"];
$BOARD_NO--;
endwhile;
//echo "totalbamtoly = $totalbamtoly <br>";
?>
        </table>
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td align="right"><B>현재페이지 포인트 : <FONT COLOR=BLUE><?ECHO number_format($SUB_SMONEY);?></FONT> 포인트 | 총 확보포인트 : <FONT COLOR=RED><?ECHO number_format($totalpoint);?></FONT> 포인트</B></td>
          </tr>
          <tr>
            <td height="34" align="center"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$PostValue = "userid=$userid";	  
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo "<a href='$PHP_SELF?menushow=$menushow&theme=member1&CURRENT_PAGE=$PREV_PAGE&$PostValue'>◀</a>";
} else {
echo "◁";
 }

/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CURRENT_PAGE == $i){$NUMBER_SHAPE= "<font color = 'gray'><B>${i}</B></font>";}
else $NUMBER_SHAPE="<font color = 'gray'>".${i}."</font>";
ECHO"&nbsp;<A HREF='$PHP_SELF?menushow=$menushow&theme=member1&CURRENT_PAGE=$i&$PostValue'>$NUMBER_SHAPE</a>";
}

/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO "&nbsp;<a href='$PHP_SELF?menushow=$menushow&theme=member1&CURRENT_PAGE=$NEXT_PAGE&$PostValue'>▶</a>";
} else {
ECHO"&nbsp;▷";
}
?>
            </td>
          </tr>
        </table>
      </FORM></td>
  </tr>
</table>
</body>
</html>
