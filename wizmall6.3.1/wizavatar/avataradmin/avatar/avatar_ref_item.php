<?
include "../common/header_pop.php";

include "../../../lib/class.wizmall.php";
$mall = new mall();
$mall->get_object($dbcon,$common);

//echo "formname = $formname <br>";
function getCategoryName($code){
	global $WIZTABLE;
	$sqlstr = "select cat_name from ".$WIZTABLE["CATEGORY"]." where cat_no = '$code'";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	return $list["cat_name"];
}

/* 카테고리별 정렬일 경우 카테고리를 다시 대/중/소 분류로 나눈단. */
if($category){ 
	$category = substr("000000".$category, -6);
	$big_code = substr($category,-2);
	$mid_code = substr($category, -4, 2);
	$small_code = substr($category, -6, 2);
}
/* end */

if($query == "insert"){
	$leng = count($SelectedLink);
	echo "<script>\n";
		echo "opener.document.".$formname.".".$textname.".options.length = $leng;\n";
		$i=0;
	while(list($key, $value) = each($SelectedLink)):
		echo "opener.document.".$formname.".".$textname.".options[$i].text = '$value'; \n";
		echo "opener.document.".$formname.".".$textname.".options[$i].value = '$key'; \n";
		$i++;
	endwhile;
	echo "self.close();\n";
	echo "</script>\n";
}



?>
<html>
<head>
<title>관리자 페이지</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<link rel="stylesheet" href="../style.css" type="text/css">
<script language="javascript" src="../../../js/jquery.plugins/selectboxes.js"></script>
<script language=javascript>
<!--
function getCategory(v, step) {
	//alert("alue="+v.value+"&step="+step);
	if(step == 1) $("#Category2").removeOption(/./);
	else if(step == 2) $("#Category3").removeOption(/./);
		$.ajax({
		
			type: "GET",
			url: "./search_category.php",
			data: "value="+v.value+"&step="+step,//특정변수값을 주어서 결과를 받을때
			
			dataType: "xml",
			success: function(xml) {
				$(xml).find('channel').each(function(){
					var cat_no = $(this).find('cat_no').text();
					var cat_name = $(this).find('cat_name').text();
					//alert(step);
					if(step == 1) $("#Category2").addOption(cat_no, cat_name, false);
					else if(step == 2) $("#Category3").addOption(cat_no, cat_name, false);	
					
				}); //close each(
			}//close function(xml)
		}); //close $.ajax(

} //close $(

function gotopage(page){
	var f = document.mall_list;
	f.CP.value = page;
	f.submit();

}

function checkField(){
	var f = document.mall_list;
	var chked = 0;
	for(i = 0; i < f.length; i++ ) {
			if(f[i].type == 'checkbox') {
					if(f[i].checked) {
							chked++;
					}
			}
	}
	if( chked < 1 ) {
			alert('아이템을 선택해 주세요');
			return false;
	}else{
	f.query.value = "insert";
	f.submit();
	}
}

function SortbyCat(cat){
	var f = document.SortForm;
	f.category.value = cat.value;
	f.submit();
}
//-->
</script>
</head>

<body>
<table width="600" border="0">
  <tr> 
    <td valign="top"> <table cellspacing=0 bordercolordark=white width="100%" bgcolor=#c0c0c0 bordercolorlight=#dddddd border=1 class="s1">
        <tr> 
          <td bgcolor="#FFFFFF"><table cellspacing=0 cellpadding=0 width="100%" border=0 class="s1">
              <tr> 
                <td width="70" align="center" valign="top"><font color=#ff6600>[note]</font></td>
                <td>제품을 선택후 확인 버튼을 눌러주세요</td>
              </tr>
            </table></td>
        </tr>
      </table>
      <br> <TABLE cellSpacing=0 borderColorDark=white width="100%" bgColor=#c0c0c0 borderColorLight=#dddddd 
border=1 class="s1">
        <TBODY>
          <TR> 
            <TD bgColor=#ffffff><b>총 등록상품</b> : <b> 
              <?=$REALTOTAL?>
              개 | 선택상품수 : 
              <?=$TOTAL?>
              </b></TD>
          </TR>
          <TR> 
            <TD height="53" bgColor=#ffffff> <TABLE cellSpacing=0 cellPadding=0 width="100%" 
border=0 class="s1">
                <TBODY>
                  <TR> 
                    <TD vAlign=top align=right>&nbsp; <table border="0">
                    <form action='<?=$PHP_SELF?>' method="POST" name="list">
                      <!------------------------------- 검색 필드 ------------------------------>
                      <input type="hidden" name=query value='search'>
                      <input type="hidden" name=where value='all'>
                      <input type="hidden" name=sort value='CHECK'>
                      <input type="hidden" name="category" value="<?=$category?>">
					   <input type="hidden" name="textname" value="<?=$textname?>">
					   <input type="hidden" name="formname" value="<?=$formname?>">
<?
if(is_array($SelectedLink)){
	foreach ($SelectedLink as $key => $value){
	echo "<input type='hidden' name='SelectedLink[".$key."]' value='$value'>\n";
	}
}
?>
					  
                      <tr> 
                        <td height="23"> <div align="left">
                          <input size=12 name=keyword class="dd1" />
                        </div></td>
                        <td><input type="submit" name="button" id="button" value="검색"></td>
                        <td>&nbsp;</td>
                        <td> <select name="Category1" onchange="getCategory(this, 1);" id="Category1">
                <option value="" selected>대분류 </option>
                <option value="">----------------</option>
<?
$mall->getSelectCategory("1", $list["Category"], "wizavatar");
?>
              </select> </td>
                        <td> <select name="Category2" id="Category2">
                <option value="" selected>중분류</option>
<?
if($mode == "update"){
$mall->getSelectCategory("2", $list["Category"], "wizavatar");
}
?>				
                <option value="">----------------</option>
            </select> </td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                      </tr>
                    </form>
                  </table></TD>
                  </TR>
                </TBODY>
              </TABLE></TD>
          </TR>
        </TBODY>
      </TABLE>
      <br> 
      <table cellspacing=0 bordercolordark=white width="100%" bgcolor=#c0c0c0 bordercolorlight=#dddddd border=0 class="s1">
        <FORM ACTION='<?=$PHP_SELF?>' NAME='mall_list' method="post">
		 <INPUT TYPE=HIDDEN NAME=query VALUE='save'>
		 <INPUT TYPE=HIDDEN NAME=mode VALUE='<?=$mode?>'>
		<input type="hidden" name="sort" value="<?=$sort?>">
		<input type="hidden" name="sort1" value="<?=$sort1?>">
		<input type="hidden" name="sort2" value="<?=$sort2?>">
		<input type="hidden" name="keyword" value="<?=$keyword?>">
		<input type="hidden" name="mode" value="<?=$mode?>">
		<input type="hidden" name="CP" value=""> 	
		<input type="hidden" name="textname" value="<?=$textname;?>"> 
		<input type="hidden" name="formname" value="<?=$formname?>">
		  
          <tr align=middle height=22> 
            <td width="31" bgcolor="E0E4E8"><font color="#000000">선택</font></td>
            <td align=left bgcolor="E0E4E8"><font color="#000000">아이템명</font></td>
            <td align="center" bgcolor="E0E4E8"><font color="#000000">성별</font></td>
          </tr>
          <tr> 
            <td colspan=3 height=1></td>
          </tr>
 <?
  $ListNo=$pg_counts?$pg_counts:20;
$PageNo = 10;




$whereis = "where 1 and category <> 000000";
if($gender <> "") $whereis .= " and t1.gender = '$gender' ";
if($Category2) $whereis .= " and substr(t1.category, 3, 4) = '".substr($Category2, -4)."' ";
else if($Category1) $whereis .= " and substr(t1.category, 5, 2) = '".substr($Category1, -2)."' ";


/* 총 갯수 구하기 */
$TOTAL_STR = "SELECT count(no) FROM ".$WIZTABLE["AVATARITEM"]." t1 $whereis";
//echo "\$TOTAL_STR = $TOTAL_STR <br>";
$TOTAL_QRY = mysql_query($TOTAL_STR) or die(mysql_error()."<br>".$TOTAL_STR);
$TOTAL = @mysql_result($TOTAL_QRY, 0, 0);
mysql_free_result($TOTAL_QRY);

if(empty($CP) || $CP <= 0) $CP = 1;

//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CP / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */

$START_NO = ($CP - 1) * $ListNo;
$BOARD_NO1=$TOTAL-($ListNo*($CP-1));


	$sqlstr = "select t1.*  from ".$WIZTABLE["AVATARITEM"]." t1 ";
	$sqlstr .= " $whereis ";
	$sqlstr .= " order by t1.no desc limit $START_NO, $ListNo";
	$sqlqry = mysql_query($sqlstr) or die($sqlstr);
$cnt=0;
while($list=@mysql_fetch_array($sqlqry)):
	$code = $list["category"];
	//echo "code = $code <br>";
	$big_code = substr($code, -2);
	$mid_code = substr($code, -4, 2);
	$small_code = substr($code, -6, 2);
	$no = $list["no"];
	if($big_code <> "00"){
		$fcode = "0000".$big_code;
		$codename = getCategoryName($fcode);
	}
	if($mid_code <> "00"){
		$fcode = "00".$mid_code.$big_code;
		$codename .= " &gt; ".getCategoryName($fcode);
	}
	if($small_code <> "00"){
		$fcode = $small_code.$mid_code.$big_code;
		$codename .= " &gt; ".getCategoryName($fcode);
	}	
	$tmpgender = $list["gender"];
	switch($tmpgender){
		case "1":
			$genderstr = "남";
		break;
		case "2":
			$genderstr = "여";
		break;		
		default:
			$genderstr = "공동";
		break;	
	}
	$layer = $list["layer"];
?>
          <tr> 
            <td align=middle bgcolor="#ffffff"><input type=checkbox value='<?=$list[name]?>'
                        name="SelectedLink[<?=$no?>]" <? echo $SelectedLink[$no]?"checked":""; unset($SelectedLink[$no]);?>></td>
            <td bgcolor="#ffffff"> <table width="100%" class="s1">
                <tr> 
                  <td width=50><img src='../../wizavatar/avatarimg/<?=$list["filename1"]?>' width="50" border=0></td>
                  <td><font color="#000000">
                    <?=$list[name]?>
                    </font></td>
                </tr>
              </table></td>
            <td align=center bgcolor="#ffffff">&nbsp; 
              <?=$genderstr?>            </td>
          </tr>
          <tr> 
            <td colspan=3 
                      height=1></td>
          </tr>
<?
$BOARD_NO1--;
$cnt++;
endwhile;
?>
<?
if(is_array($SelectedLink)){
	foreach ($SelectedLink as $key => $value){
	echo "<input type='hidden' name='SelectedLink[".$key."]' value='$value'>\n";
	}
}
?>	
          <tr bgcolor="#FFFFFF"> 
            <td colspan=3 height=25> <table cellspacing=0 cellpadding=0 width="100%" 
                        bgcolor=#ffffff border=0>
                <tr> 
                  <td width=203> <input type="button" name="Button" value="아이템넣기" onClick="checkField()" style="cursor:hand">
                    <input type="button" name="Button" value="닫기" onClick="window.close()" style="cursor:hand"></td>
                  <td width="389" align=middle> <div align="center" class="s1"> 
                      
			  
					  <?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$PostValue = "=$sort&=$sort1&=$sort2&=$keyword&=$mode";	  
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo "<a href=\"javascript:gotopage('$PREV_PAGE')\">◀</a>";
} else {
echo "◀";
 }
/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CURRENT_PAGE == $i){$NUMBER_SHAPE= "<font color = 'gray'><B>${i}</B></font>";}
else $NUMBER_SHAPE="<font color = 'gray'>".${i}."</font>";
ECHO"&nbsp;<A HREF=\"javascript:gotopage('$i')\">$NUMBER_SHAPE</a>";
}
/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO "&nbsp;<a href=\"javascript:gotopage('$NEXT_PAGE')\">▶</a>";
} else {
ECHO"&nbsp;▶";
}
?>
                    </div></td>
                </tr>
              </table></td>
          </tr>
        </form>
      </table></td>
  </tr>
</table>
</body>
</html>
