<?
include "../common/header_pop.php";
include "../../../config/avatar_array.php";
include_once "../../../lib/class.avater.gen.php";
include "../AUTH_CHECK.php";
$gencls = new Gen_Class($MYSQL_HOST, $MYSQL_DB, $MYSQL_ID, $MYSQL_PASSWORD);


if($query == "insert") {
	if(!$reg_name) $reg_name = "위즈아바타";
	if(!$reg_home) $reg_home = "http://avatar.shop-wiz.com";
//이미지 업로딩 시작	
	$gencls->upload_path = "../../../config/wizavatar/avatarimg/";
	$gencls->replacflag = "on";
	$gencls->uploadfile("file");
	$imgname = split("\|", $gencls->attachedfile);
//이미지 업로딩 끝	
	if($Category2) $category = $Category2;
	else if($Category1) $category = $Category1;
	
	unset($reg_option);
	for($i=0; $i < count($reg_optionArr); $i++){
		if(!$Multi_Option[$i]) $Multi_Option[$i] = "0";
		$reg_option .= $Multi_Option[$i]."|";
	}
	$sqlstr = "insert into ".$WIZTABLE["AVATARITEM"]." (name, filename1, filename2, filename3, gender, category, layer,reg_name,reg_id,reg_home,memo,buy_p,sale_p,jaego,face_show,reg_option,ref_item,theme_item,wdate) values ('$itemname','".$imgname[0]."','".$imgname[1]."','".$imgname[2]."','$gender','$category','$layer','$reg_name','$reg_id','$reg_home','$memo','$buy_p','$sale_p','$jaego','$face','$reg_option','$ref_item','$theme_item',".time().")";
	$result = mysql_query($sqlstr );
	
	if($result){
		echo "<script language='javascript'>alert('아이템이 추가되었습니다.');</script>";
		echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme'>");
	}else{
		echo "<script language='javascript'> alert('아이템 추가에 오류가 발생했습니다');history.go(-1)</script>";
		exit;
	}
}else if($query == "delete") {// 파일지우기
	$sqlstr="select filename1, filename2, category from ".$WIZTABLE["AVATARITEM"]." where no=$no";
		//echo "sqlstr = $sqlstr <br>";
	//exit;
	$sqlqry=mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());
	$list=mysql_fetch_array($sqlqry);

	if($list["category"] == "000000"){
		echo "<script>alert('기본아이템은 삭제불가능합니다.');history.go(-1);</script>";
		exit;	
	}else{
		## 등록이미지 삭제
		$imgname = "../../../config/wizavatar/avatarimg/".$list["filename1"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/".$list["filename2"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/".$list["filename3"];
		if(is_file($imgname)) unlink($imgname);	
			
		$sqlstr="delete from ".$WIZTABLE["AVATARITEM"]." where no=$no";
		mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());
		
		## face와 연동시 face 삭제
		
		$sqlstr = "select * from ".$WIZTABLE["AVATARFACE"]." where item_id = '$no'";
		$sqlqry = mysql_query($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face01"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face01a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face02"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face02a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face03"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face03a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face04"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face04a"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face05"];
		if(is_file($imgname)) unlink($imgname);
		$imgname = "../../../config/wizavatar/avatarimg/face_img/".$list["face05a"];
		if(is_file($imgname)) unlink($imgname);	
		
		$sqlstr="delete from ".$WIZTABLE["AVATARFACE"]." where item_id=$no";
		mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());									
	}
	
	echo "<script language='javascript'>alert('삭제 하였습니다!   ');</script>";
	echo("<script>location.href='../main.php?menushow=$menushow&theme=$theme';</script>");

}else if($query == "update"){

	if($Category2) $category = $Category2;
	else if($Category1) $category = $Category1;
	
	unset($reg_option);
	for($i=0; $i < count($reg_optionArr); $i++){
		if(!$Multi_Option[$i]) $Multi_Option[$i] = "0";
		$reg_option .= $Multi_Option[$i]."|";
	}
//이미지 업로딩 시작	
	$gencls->mode = "update";
	$gencls->upload_path = "../../../config/wizavatar/avatarimg/";
	$gencls->replacflag = "on";
	$gencls->old_attachedfile=$oldfilename1;
	$gencls->deletefile = $del_file;
	$gencls->uploadfile("file");
	$imgname = split("\|", $gencls->attachedfile);
//이미지 업로딩 끝
	$sqlstr = "update ".$WIZTABLE["AVATARITEM"]." set category='$category', name='$itemname', filename1='".$imgname[0]."', filename2='".$imgname[1]."', filename3='".$imgname[2]."', gender='$gender', memo='$memo', layer='$layer', buy_p='$buy_p', sale_p='$sale_p', jaego='$jaego', face_show='$face', reg_option='$reg_option', ref_item='$ref_item', theme_item='$theme_item' where no = '$no'";
	//echo "테스트중 .. 잠시만 기다려 주세요 <br>";
	//echo "sqlstr = $sqlstr <br>";
	//exit;
	$result = mysql_query($sqlstr);
	
	if($result) {
		echo "<script language='javascript'>alert('수정 하였습니다');</script>";
		echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme&page=$page&no=$no&Category1=$Category1&Category2=$Category2&gender=$gender'>");
	}else {
		echo "<script language='javascript'>alert('정상적으로 수정 되지 못했습니다.   ');history.go(-1)</script>";
	}
}else if($query == "setup" ) {
/* 기타 관리자 기초 사항을 입력한다. */
$fp = fopen("../../../config/avatar_config.php", "w");
fwrite($fp,"<?
## 아바타 기본 환경설정
\$avatar_skin = \"$avatar_skin\";
\$display_zero_money = \"$display_zero_money\";
?>"); 
fclose($fp); 
echo "<script language='javascript'>alert('수정 하였습니다');</script>";
echo("<meta http-equiv='Refresh' content='0;URL=../main.php?menushow=$menushow&theme=$theme&page=$page&no=$no'>");
}
?>
