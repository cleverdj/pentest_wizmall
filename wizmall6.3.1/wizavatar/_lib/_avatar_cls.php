<?
class Avatar_Class{
	var $totalcnt=0;
	var $num_rows = 0;
	var $my_layer = 0;
	var $my_gender = 0;
	var $result = 0;
	var $item_no = 0;	
	var $avatarpath = "";
	var $avatar_no = "";
	var	$mode = "";
	var $WIZTABLE = array(); 
	var $avatarimg = array();
	var $items = array();//xml용
	var $tmp = ""; //임시변수용
	var $avatar_userpoint = "";
	var $avatar_usergener = "";
	var $avatar_usergrade = "";
	var $avatar_userid = "";
		
	function Avatar_Class($dbhost, $dbname, $dbuser, $dbpwd){
		$this->MYSQL_HOST=$dbhost;
		$this->MYSQL_DB = $dbname;
		$this->MYSQL_ID = $dbuser;
		$this->MYSQL_PASSWORD = $dbpwd;
	}
	
	function db_connect(){
		$this->dbcon=mysql_connect($this->MYSQL_HOST,  $this->MYSQL_ID, $this->MYSQL_PASSWORD);
		mysql_select_db($this->MYSQL_DB, $this->dbcon);
		if ( !$this->dbcon ) {
			echo "mysql 데이터 베이스에 연결할 수 없습니다."; 
			exit;
		}	
	}
	
	function dberror($str){
		die($str."<br>".mysql_error());
	}
	
	function js_alert($str, $goto=null){
		if($goto == "cur"){
			echo "<script>alert('$str');</script>";
			return false;
			exit;
		}else if($goto == "close"){
			echo "<script>alert('$str');self.close();</script>";
			return false;
			exit;
		}else{
			echo "<script>alert('$str');history.go(-1);</script>";
			return false;
			exit;
		}
	}	
####################################################################################
#### XML관련 클라스 모음 
####################################################################################
	function outputXml(){
		header("Content-type: text/xml");
		printf("<?xml version=\"1.0\" encoding=\"%s\" ?>\n","EUC-KR");
		print("<rss version=\"2.0\">\n");

		$this->printChannel();

		print("</rss>\n");
	}
	
	function printChannel(){
		foreach($this->items as $item){
		//print_r($item);
			print("<channel>\n");
			while (list($name,$value) = each($item)) {
				//echo "name=".$item[$name]."<br>";
				//if(!empty($item[$name])){ 
					$value = htmlspecialchars($value);
					printf("<%s>%s</%s>\n",$name,$value,$name); 
				//}
			}
			print("</channel>\n");
		}
	}

	
	function addItem($item){
	//echo $item;
		array_push($this->items,$item);
		//$this->items=$item;
	}
	
		
####################################################################################
#### 아바타 초기화 하기 : 신규회원가입일경우
####################################################################################
	function InitAvatar() {
		$this->deleteAllSessionFile();
		$ava17 = $ava9 = $ava12 = $ava10 = 0;
		$userid = $this->user_id;
		$gender = $this->user_gender;
		$username = $this->user_name;
		$userpoint = $this->user_point;
		$usergrade = $this->user_grade;
		$sqlstr = "select count(*) from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$count = mysql_result($sqlqry, 0, 0);
		if(!$count){
			//성별, 등급에 따라 기본 의상을 따로 둔다.
## 기본아바타 정의
## 1:남자기본얼굴, 2:남자기본상체, 3:남자기본하체, 
## 4:여자기본얼굴, 5:여자기본상체, 6:여자기본하체	
## 7:기본테마(남학생), 8:기본테마(여학생), 9:기본테마(남), 10:기본테마(여), 11:기본테마(남선생), 12:기본테마(여선생)	
		
			switch($gender){
				case "1"://남성
					switch($usergrade){
						case "9"://학생신분
							$ava9 = "1";//남자기본얼굴
							$ava10 = "2";//남자기본상체
							$ava12 = "3";//남자기본하체
							$ava17 = "19";
						break;
						case "7"://학부모신분
							$ava9 = "7";//남자기본얼굴
							$ava10 = "8";//남자기본상체
							$ava12 = "9";//남자기본하체
							$ava17 = "21";
						break;
						case "5"://선생신분
							$ava9 = "13";//남자기본얼굴
							$ava10 = "14";//남자기본상체
							$ava12 = "15";//남자기본하체
							$ava17 = "23";
						break;
						default:
							$ava9 = "1";//남자기본얼굴
							$ava10 = "2";//남자기본상체
							$ava12 = "3";//남자기본하체
							$ava17 = "19";
						break;									
					}
				break;
				case "2"://여성
					switch($usergrade){
						case "9"://학생신분
							$ava9 = "4";//여자기본얼굴
							$ava10 = "5";//여자기본상체
							$ava12 = "6";//여자기본하체
							$ava17 = "20";
						break;
						case "7"://학부모신분
							$ava9 = "10";//여자기본얼굴
							$ava10 = "11";//여자기본상체
							$ava12 = "12";//여자기본하체
							$ava17 = "22";
						break;
						case "5"://선생신분
							$ava9 = "16";//여자기본얼굴
							$ava10 = "17";//여자기본상체
							$ava12 = "18";//여자기본하체
						break;
						default:
							$ava9 = "4";//여자기본얼굴
							$ava10 = "5";//여자기본상체
							$ava12 = "6";//여자기본하체
							$ava17 = "24";

						break;									
					}
				break;
				default:
					$ava9 = "1";//남자기본얼굴
					$ava10 = "2";//남자기본상체
					$ava12 = "3";//남자기본하체	
					$ava17 = "19";		
				break;		
			}
			
			$sqlstr = "insert into ".$this->WIZTABLE["AVATARMEMCONFIG"]."";
			$sqlstr .= " (user_id,name,point,gender,ava1,ava2,ava3,ava4,ava5,ava6,ava7,ava8,ava9,ava10,ava11,ava12,ava13,ava14,ava15,ava16,ava17,ava18,ava19) ";
			$sqlstr .= " values ('$userid','$username','$userpoint','$gender',0,0,0,0,0,0,0,0,'$ava9','$ava10',0,'$ava12',0,'0',0,0,0,0,0)";
			

			mysql_query($sqlstr) or $this->dberror($sqlstr);
			
			## 기본 선물아이템 넣기
			if($ava17){
				//$this->inputwardrobe($userid,$ava17);
			}
		}
	}
	//$ava17 = $ava9 = $ava10 = $ava13 = 0;


	
####################################################################################
####
####################################################################################
	function getavatarImg($no){
		#orderflag = 0 : 실제아바타, 1 : 아바타이미지
		if($no){
			$this->avatarimg = array();
			$sqlstr = "select filename1, filename2, filename3 from ".$this->WIZTABLE["AVATARITEM"]." where no = '$no'";
			$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
			$list = mysql_fetch_array($sqlqry);
			$this->avatarimg[0] = $list["filename1"]?$list["filename1"]:"default_blank.gif";
			$this->avatarimg[1] = $list["filename2"]?$list["filename2"]:"default_blank.gif";
			$this->avatarimg[2] = $list["filename3"]?$list["filename3"]:"default_blank.gif";
		}else{
			$this->avatarimg[0] = "default_blank.gif";
			$this->avatarimg[1] = "default_blank.gif";
			$this->avatarimg[2] = "default_blank.gif";
		}
	}

####################################################################################
#### 현재착용한 정보가져오기
####################################################################################
	function getItemNo($no){
		$sqlstr = "select item_no from ".$this->WIZTABLE["AVATARMERCHANT"]." where no = '$no'";
//		echo "sqlstr = $sqlstr <br>";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
//echo $list["item_no"];
		$this->avatar_no = $list["item_no"];
	}

####################################################################################
#### 현재착용한 정보가져오기
####################################################################################
	function getMyItem($no){
		$this->getItemNo($no);
		$list = $this->buy_find_no($this->avatar_no);
		return $list;
	}
	function getMyItemInfo($no){
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARMERCHANT"]." where no = '$no'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}	
####################################################################################
#### 아이템의 레이어 정보 가져오기
####################################################################################
	function getItemLayer($no){
		$sqlstr = "select layer from ".$this->WIZTABLE["AVATARITEM"]." where no = '$no'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		$this->ItemLayer_no = $list[0];
		return $list[0];		
	}	
####################################################################################
#### 현재아이템의 기본 정보 가져오기(모두가져오기)
####################################################################################
	function getItemInfo($no){
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARITEM"]." where no = '$no'";
		//echo $sqlstr;
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;	
	}	
	
	function buy_find_item($item){//되도록 사용금지
		$sqlstr = "select name, no, buy_p, sale_p from ".$this->WIZTABLE["AVATARITEM"]." where file1 = '$item'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		
		return $list;
	}
	
	function buy_find_no($no){//getItemInfo것으로 추후 대처
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARITEM"]." where no = '$no'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}	
####################################################################################
#### 내옷장의 no 정보로서 실제 아바타아이템의 고유 키값을 가져온다.
####################################################################################
	function buy_find_myno($no){
		$this->getItemNo($no);
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARITEM"]." where no = '".$this->avatar_no."'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}	
		
####################################################################################
#### 아이템 착용하기
####################################################################################
	function InputMyItem($no, $userid){
		$layer_no = $this->getItemLayer($no);
		$this->LayerFieldName = "ava".$layer_no;
		if($layer_no == "13" || $layer_no == "17"){
		/*
			$tmpgender = $this->getavatarmeminfo2($userid, "gender");
			$gender = $tmpgender ? $tmpgender:"1";
			
			switch($layer_no){
				case "13"://한벌의상
					if($gender = "1"){
						$ava9 = "1";
						$ava10 = "2";
						$ava12 = "3";
					}else{
						$ava9 = "4";
						$ava10 = "5";
						$ava12 = "6";
					}
				break;
				case "17":// 테마의상
					if($gender = "1"){
						$ava9 = "1";
						$ava10 = "2";
						$ava12 = "3";
					}else{
						$ava9 = "4";
						$ava10 = "5";
						$ava12 = "6";
					}
				break;		
			}
			*/
			
			$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." set ".$this->LayerFieldName." = '$no', ava9='0', ava10='0', ava12='0', ava16='0' where user_id = '$userid'";
			mysql_query($sqlstr) or $this->dberror($sqlstr);
//		}else if($layer_no=="9"){//얼굴이면 뒷헤어정보도 가져와 update
		##헤어정보 가져오기
//			$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." set ".$this->LayerFieldName." = '$no', ava16='".$this->avatarimg[2]."' where user_id = '$userid'";
//			mysql_query($sqlstr) or $this->dberror($sqlstr);
		}else{
			$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." set ".$this->LayerFieldName." = '$no' where user_id = '$userid'";
			mysql_query($sqlstr) or $this->dberror($sqlstr);
		}
	}	
####################################################################################
#### 입고있는 정보를 기준으로 dbupdate 하기
####################################################################################
	function InitialUpdate($fullsrc, $user_id){
		for($i=0; $i<=19; $i++){
			$tmpava[$i] = str_replace("/", "",strrchr($fullsrc[$i], "/"));
			$sqlstr = "select no from ".$this->WIZTABLE["AVATARITEM"]." where filename2 = '".$tmpava[$i]."'";
			$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
			$list = mysql_fetch_array($sqlqry);
			$ava[$i] = $list[0]?$list[0]:0;
		}
		
		if($ava[13] == 0 || $ava[17] == 0){
	
			$tmpgender = $this->getavatarmeminfo2($user_id, "gender");
			$gender = $tmpgender ? $tmpgender:"1";
			switch($gender){
				case "1":
					if($ava[13] == 0){
						if($ava[10] == 0) $ava[10] = 2;
						if($ava[12] == 0) $ava[12] = 3;
						if($ava[9] == 0) $ava[9] = 1;
					}else if($ava[17] == 0){
						if($ava[10] == 0) $ava[10] = 2;
						if($ava[12] == 0) $ava[12] = 3;
						if($ava[9] == 0) $ava[9] = 1;
					}
				break;
				case "2":
					if($ava[13] == 0){
						if($ava[10] == 0) $ava[10] = 5;
						if($ava[12] == 0) $ava[12] = 6;
						if($ava[9] == 0) $ava[9] = 4;
					}else if($ava[17] == 0){
						if($ava[10] == 0) $ava[10] = 5;
						if($ava[12] == 0) $ava[12] = 6;
						if($ava[9] == 0) $ava[9] = 4;
					}				
				break;			
			}

		}
		$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." set ava1='".$ava[1]."', ava2='".$ava[2]."', ava3='".$ava[3]."', ava4='".$ava[4]."', ava5='".$ava[5]."', ava6='".$ava[6]."', ava7='".$ava[7]."', ava8='".$ava[8]."', ava9='".$ava[9]."', ava10='".$ava[10]."', ava11='".$ava[11]."', ava12='".$ava[12]."', ava13='".$ava[13]."', ava14='".$ava[14]."', ava15='".$ava[15]."', ava16='".$ava[16]."', ava17='".$ava[17]."', ava18='".$ava[18]."', ava19='".$ava[19]."' where user_id = '$user_id'";
		//echo "sqlstr = $sqlstr <br>";
		mysql_query($sqlstr) or $this->dberror($sqlstr);
	}		
####################################################################################
#### 포인트가져오기
####################################################################################	
	function check_point($avatar_id){
		## 회원테이블에 따라 다양한 포인트 계산하기 default : wizMembers
		if(!$avatar_id){
		echo "<script>alert('아이디가 존재하지 않습니다.')</script>";
		return $point;
		}
		switch ($this->WIZTABLE["AVATARMEMBER"]){
			case "wizMembers":##위즈솔루션 사용일경우
				$sqlstr = "select mpoint from ".$this->WIZTABLE["AVATARMEMBER"]." where mid ='".$avatar_id."'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				$point = $list["mpoint"];
			break;				
			default:##회원 db와 연동되지 않을경우 자체 point 테이블에서 가져옮
				$sqlstr = "select sum(point) as mpoint from ".$this->WIZTABLE["AVATARPOINT"]." where id ='".$avatar_id."'  and flag='1'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				$point = $list["mpoint"];
			break;
		
		}	
	
	  return $point;
	}	
####################################################################################
#### 로그인책크
####################################################################################
	function avatar_login($avatar_id, $avatar_pwd){ //나중에 시간날때..ㅠ.ㅠ
		$this->deleteAllSessionFile();
		switch ($this->WIZTABLE["AVATARMEMBER"]){
			case "wizMembers"://wizSolution 사용시
				$sqlstr = "select m.mid, m.mname, m.mgrade, m.mpoint, i.gender, i.jumin2 
							from ".$this->WIZTABLE["AVATARMEMBER"]." m
							left join wizMembers_ind i on m.mid = i.id
							where m.mid ='".$avatar_id."' and m.mpasswd='".$avatar_pwd."'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				$this->user_id = $list["mid"];
				$this->user_gender = $list["gender"];
				$this->user_point = $list["mpoint"];
				$this->user_grade = $list["mgrade"];//등급에 따른 다양한 아바타를 표시하기위해	
				$this->user_name = $list["mname"];		
			break;			
			case "MemberInfo"://사용자정의테이블
				$sqlstr = "select userid, jumin, namekr, grade from ".$this->WIZTABLE["AVATARMEMBER"]." where userid ='".$avatar_id."' and userpw ='".$avatar_pwd."'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				$this->user_id = $list["userid"];
				$this->user_grade = $list["grade"];
				$this->user_name = $list["namekr"];
				$tmpgender = substr($list["jumin"], -7, 1);
				if($this->user_id){
					switch($tmpgender){
						case "2":
						case "4":
							$this->user_gender = 2;
						break;
						default:
							$this->user_gender = 1;
						break;
					}
				}			
			break;		
			default:
				$sqlstr = "select user_id, name, gender, point, user_pwd from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id ='".$avatar_id."' and user_pwd='".$avatar_pwd."'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				$this->user_id = $list["user_id"];
				$this->user_gender = $list["gender"];
				$this->user_point = $list["point"];		
				$this->user_name = $list["name"];	

			break;
		}

		if($this->user_id){
			##경우에 대비하여 세션과 쿠키값을 동시 생성
			//$str = $avatar_point."|".$avatar_gender."|".$avatar_grade."|".$avatar_id;	
			$str = $this->check_point($avatar_id)."|".$this->user_gender."|".$this->user_grade."|".$avatar_id."|".$avatar_name;	
			$_SESSION["wizavatar"] = $str;
			setcookie("wizavatar", "$str", 0, "/");
			//echo $str;
		   // exit;
		}
	}	
####################################################################################
####  회원정보가져오기(이름)
####################################################################################
	function getlogininfo($wizavatar=null, $userid=null){
		if(!$wizavatar){
			$wizavatar = $_SESSION["wizavatar"];
		}
		$tmp = split("\|", $wizavatar);
		$this->avatar_userpoint = $tmp[0];
		$this->avatar_usergener = $tmp[1];
		$this->avatar_usergrade = $tmp[2];
		$this->avatar_userid = $tmp[3];
		$this->avatar_username = $tmp[4];
	}

	function get_MemInfo($avatar_id, $flag){
		##$flag : 가져올 필드를 입력 (name, id, passwd, gender....)

		switch($flag){
			case "name":
				switch ($this->WIZTABLE["AVATARMEMBER"]){
					case "MemberInfo":
						$sqlstr = "select namekr from ".$this->WIZTABLE["AVATARMEMBER"]." where userid ='".$avatar_id."'";
						$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
						$list = mysql_fetch_array($sqlqry);
						$returnvalue = $list[0];
					break;		
					default:##wizMembers//나중에 처리
						$sqlstr = "select name from ".$this->WIZTABLE["AVATARMEMBER"]." where mid ='".$avatar_id."' and mpasswd='".$avatar_pwd."'";
						$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
						$list = mysql_fetch_array($sqlqry);
						$returnvalue = $list[0];
					break;
				
				}
			break;
		}
	
	  return $returnvalue;
	}



####################################################################################
#### TEXT 글자수 제한
####################################################################################
	function strCutting( $str, $strlen, $abbreviate=null){
		$str  = trim( $str ); 
		for( $i=0 ; $i < $strlen ; $i++ ){ 
			if( ord( $str[$i] ) >= 128 ){
				$KOR++;
			}else{
				$ENG++;
			} 
		}
		
		if( strlen( $str ) > $strlen ){ 
			if( $KOR % 2 == 1 ){ 
				$strlen = $strlen - 1; 
			} 
			$rtn_str = substr( $str , 0 , $strlen ); 
			return "${rtn_str}${abbreviate}"; 
		}else {
			$rtn_str = substr( $str , 0 , $strlen ); 
			return "$rtn_str"; 
		}
	}
	
	
	function cal_point($f, $s) {
	  $sum = $f - $s;
	  if($sum < 0 ) {	$c_point = "0";}
	  else { $c_point = "1";}
	  
	  return $point = array($sum, $c_point);
	}
####################################################################################
#### 아바타디스플레이
####################################################################################
	
	function show_avatar($avatar_id){
		//echo "mode = ".$this->mode ."<br>";
		if ($this->mode == "photo"){
			$list = $this->getavatarmeminfo1($avatar_id);//포토앨범에서 유니크값으로 가져오기
			$layerid = "photoChar";
			$width = "140";
			$height = "200";
		}elseif ($this->mode == "sphoto"){
			$list = $this->getavatarmeminfo1($avatar_id);//포토앨범에서 유니크값으로 가져오기
			$layerid = "photoChar";
			$width = "100";
			$height = "143";
		}else{
			$list = $this->getavatarmeminfo($avatar_id);//회원아바타테이블에서 회원정보로 가져오기
			$layerid = "ImgChar";
			$width = "140";	
			$height = "200";
		}
		
		for($i=1; $i <= 19; $i++){
			$ava = "ava".$i;
			
			if($i == 9){//얼굴이면
				
				$this->getavatarImg($list[$ava]);
				$avatar[$i] = $this->avatarimg[1];
				$avatar[16] = $this->avatarimg[2];//뒷헤어입력
				
			}else if($list[$ava] <> 0 && $i <> 16){
				$this->getavatarImg($list[$ava]);
				$avatar[$i] = $this->avatarimg[1];
			}else if($i <> 16){
				$avatar[$i] = "default_blank.gif";
				//echo "i = $i <br>";
			}
		}
		if($list["ava13"]){//한벌의상
			$avatar[8] = "default_blank.gif";//프론트헤어
			$avatar[10] = "default_blank.gif";//상의
			$avatar[12] = "default_blank.gif";//하의(신발포함)
			$avatar[9] = "default_blank.gif";//얼굴
			$avatar[15] = "default_blank.gif";//신발
			$avatar[16] = "default_blank.gif";//뒷헤어
			$avatar[17] = "default_blank.gif";//테마의상
			$this->faceid = $list["ava13"];
			$this->facelayer = "13";
		}else if($list["ava17"]){//테마의상
			$avatar[8] = "default_blank.gif";//프론트헤어
			$avatar[10] = "default_blank.gif";//상의
			$avatar[12] = "default_blank.gif";//하의(신발포함)
			$avatar[13] = "default_blank.gif";//한벌의상
			$avatar[9] = "default_blank.gif";//얼굴
			$avatar[15] = "default_blank.gif";//신발
			$avatar[16] = "default_blank.gif";//뒷헤어
			$this->faceid = $list["ava17"];
			$this->facelayer = "17";
		}else{
			if(!$list["ava9"]){//얼굴이 없을 경우
				$avatar[9] = $this->getDefault($list["gender"],"face",$grade);
			}
			if(!$list["ava10"]){//상의가 없을 경우
				$avatar[10] = $this->getDefault($list["gender"],"top",$grade);
			}
			if(!$list["ava12"]){//하의가 없을 경우
				$avatar[12] = $this->getDefault($list["gender"],"bottom",$grade);
			}
			$this->faceid = $list["ava9"];
			$this->facelayer = "9";
		}
		
		
		$returnDiv = "<DIV id=\"character\" style=\"position:relative; width:".$width."; height:".$height."; overflow:hidden;\">\n";
		for($i=1; $i<=19; $i++){
			$zindex = 20-$i;
			$returnDiv .= "<div id=\"layer".$i."\" style=\"position:absolute; left:0; top:0; z-index:".$zindex.";\"><img id=\"$layerid".$i."\" src=\"".$this->avatarpath.$avatar[$i]."\" border=\"0\" width=\"".$width."\"></div>\n";
		}
		$returnDiv .= "</DIV>\n";
		return $returnDiv;
	}


	function getDefault($gender,$type,$grade=null){//버그에 의한 디폴트가 미 디스플레이시 
		//$gender : 1 : 남, 2, 여, $type : face, top, bottom,
		switch($gender){
			case "2"://여성
				switch ($grade){
					case "5"://선생
						switch($type){
							case "face":
								return "default_w_head5.gif";
							break;
							case "top":
								return "default_w_top5.gif";
							break;
							case "bottom":
								return "default_w_bottom5.gif";
							break;							
						}
					break;
					case "7"://학부모
						switch($type){
							case "face":
								return "default_w_head7.gif";
							break;
							case "top":
								return "default_w_top7.gif";
							break;
							case "bottom":
								return "default_w_bottom7.gif";
							break;							
						}					
					break;
					default:
						switch($type){
							case "face":
								return "default_w_head9.gif";
							break;
							case "top":
								return "default_w_top9.gif";
							break;
							case "bottom":
								return "default_w_bottom9.gif";
							break;							
						}						
					break;													
				}
			break;
			default://남성
				switch ($grade){
					case "5"://선생
						switch($type){
							case "face":
								return "default_m_head5.gif";
							break;
							case "top":
								return "default_m_top5.gif";
							break;
							case "bottom":
								return "default_m_bottom5.gif";
							break;							
						}						
					break;
					case "7"://학부모
						switch($type){
							case "face":
								return "default_m_head7.gif";
							break;
							case "top":
								return "default_m_top7.gif";
							break;
							case "bottom":
								return "default_m_bottom7.gif";
							break;							
						}						
					break;
					default:
						switch($type){
							case "face":
								return "default_m_head9.gif";
							break;
							case "top":
								return "default_m_top9.gif";
							break;
							case "bottom":
								return "default_m_bottom9.gif";
							break;							
						}					
					break;													
				}				
			break;
			
		}
	}
####################################################################################
#### 아바타 테마 디스플레이
####################################################################################
	
	function show_avatar_theme($ref_item){
		$ref_item_arr = split("\|", $ref_item);
		// 모든 레이어 초기화
		for($i=1; $i<=19; $i++){
			$avatar[$i] = "default_blank.gif";
		}
		
		
		foreach($ref_item_arr as $key=>$value){
			$list = $this->getThemInfo($value);
			$layerno = $list["layer"];
			$imgno = $list["filename2"];
			$avatar[$layerno] = $imgno;
		}
		

		$returnDiv = "<DIV id=\"themecharacter\" style=\"position:relative; width:140; height:200; overflow:hidden;\">\n";
		for($i=1; $i<=19; $i++){
			$zindex = 20-$i;
			$returnDiv .= "<div id=\"themelayer".$i."\" style=\"position:absolute; left:0; top:0; z-index:".$zindex.";\"><img id=\"themeImgChar".$i."\" src=\"".$this->avatarpath.$avatar[$i]."\" border=\"0\" width=\"140\" height=\"200\"></div>\n";
		}
		$returnDiv .= "</DIV>\n";
		return $returnDiv;
	}
	
	function getThemInfo($no){
		$sqlstr = "select layer, filename2 from ".$this->WIZTABLE["AVATARITEM"]." where no = '$no'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}		
####################################################################################
#### 아바타표정디스플레이
####################################################################################
	function getFaceList($item_id, $layer_no=null){
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARFACE"]." where item_id = '$item_id'";
		//echo "sqlstr = $sqlstr <br>";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		if($layer_no) $this->facelayer = $layer_no;
		$facelist[0][0] = $this->facelayer;
		$facelist["i"][1] = $list["face01"];
		$facelist["a"][1] = $list["face01a"];
		$facelist["i"][2] = $list["face02"];
		$facelist["a"][2] = $list["face02a"];
		$facelist["i"][3] = $list["face03"];
		$facelist["a"][3] = $list["face03a"];
		$facelist["i"][4] = $list["face04"];
		$facelist["a"][4] = $list["face04a"];
		$facelist["i"][5] = $list["face05"];
		$facelist["a"][5] = $list["face05a"];
		$this->item_id = $item_id;
		return $facelist;
	}
	
	function getFaceList1(){
		return $this->getFaceList($this->faceid);
	}
	
	function getFaceImgName($item_id, $no){
		$fieldname = "face0".$no."a";
		$sqlstr = "select $fieldname from ".$this->WIZTABLE["AVATARFACE"]." where item_id = '$item_id'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}	
####################################################################################
#### 입고있는 아바타 정보가져오기
####################################################################################
	function getavatarmeminfo($user_id){
		$sqlstr = "select gender,ava1,ava2,ava3,ava4,ava5,ava6,ava7,ava8,ava9,ava10,ava11,ava12,ava13,ava14,ava15,ava16,ava17,ava18,ava19    from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$user_id'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}

	function getavatarmeminfo1($no){	
		$sqlstr = "select ava1,ava2,ava3,ava4,ava5,ava6,ava7,ava8,ava9,ava10,ava11,ava12,ava13,ava14,ava15,ava16,ava17,ava18,ava19    from ".$this->WIZTABLE["AVATARALBUM"]." where no = '$no'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list;
	}

	function getavatarmeminfo2($user_id, $field){	
		$sqlstr = "select $field from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$user_id'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}
		
####################################################################################
#### 포인트관련
####################################################################################
	//function PointInsert($id, $uid=null, $detail, $point, $flag=1, $mode="insert"){
	function PointInsert(){
		$mode = $this->mode ? $this->mode : "insert";
		##delete는 관리자 모드에서 포인트 삭제시 실행
		$flag = $this->flag ? $this->flag : 1;
		$id = $this->user_id;
		$content = $this->content;
		$point = $this->point;
		$uid = $this->uid;
		$wdate = time();
		switch ($this->WIZTABLE["AVATARMEMBER"]){
			case "wizMembers"://위즈솔루션과연동
				if($mode == "delete"){
					##기존 포인트 정보를 가져온다.
					$sqlstr = "select point, flag, id from ".$this->WIZTABLE["AVATARPOINT"]." where uid = '$uid'";
					$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
					$list = mysql_fetch_array($sqlqry);
					$point = $list["point"];
					$id = $list["id"];
					
					##기존 포인트 정보삭제
					$sqlstr = "delete from ".$this->WIZTABLE["AVATARPOINT"]."  where uid = '$uid'";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					
					##회원테이블의 포인트 업데이트
					$sqlstr = "update ".$this->WIZTABLE["AVATARMEMBER"]." SET mpoint=mpoint - $point where mid = '$id'";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
				}else{		
					$sqlstr = "insert into wizPoint (id, contents, point,flag,wdate) values ('$id','$content','$point','$flag','$wdate')";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					
					if($flag <> "0"){//포인트신청일경우
						$sqlstr = "update ".$this->WIZTABLE["AVATARMEMBER"]." SET mpoint=mpoint + $point where mid = '$id'";
						$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					}
				}
			break;
			case "userMemberTable"://사용자정의테이블	
				//사용자정의일경우 이곳에 코딩
				//위의 userMemberTable 을 config 에서 정의된 파일명으로 대처후 코딩시작
			break;							
			default:##기본처리
				if($mode == "delete"){
					##기존 포인트 정보를 가져온다.
					$sqlstr = "select point, flag, id from ".$this->WIZTABLE["AVATARPOINT"]." where uid = '$uid'";
					$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
					$list = mysql_fetch_array($sqlqry);
					$point = $list["point"];
					$id = $list["id"];
					
					##기존 포인트 정보삭제
					$sqlstr = "delete from ".$this->WIZTABLE["AVATARPOINT"]."  where uid = '$uid'";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					
					##회원테이블의 포인트 업데이트
					$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." SET point=point - $point where user_id = '$id'";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
				}else{
					$sqlstr = "insert into wizPoint (id, contents, point,flag,wdate) values ('$id','$content','$point','$flag','$wdate')";
					$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					if($flag <> "0"){//포인트신청일경우
						$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." SET point=point + $point where user_id = '$id'";
						$result = mysql_query($sqlstr) or $this->dberror($sqlstr);
					}						
				}
			break;
		}
		##세션을 업데이트 한다.
		$this->getlogininfo();
		if($this->avatar_userid == $id){//세션정보와 현재 아이디 정보가 일치할경우(일치하지 않을 경우는 타인이 포인트 제공)
			$str = $this->check_point($id)."|".$this->user_gender."|".$this->user_grade."|".$this->avatar_userid;	
			$_SESSION["wizavatar"] = $str;
			setcookie("wizavatar", "$str", 0, "/");
		}
	}	
####################################################################################
#### 회원존재여부
####################################################################################

	function is_member($id){
		switch ($this->WIZTABLE["AVATARMEMBER"]){
			case "MemberInfo"://	
				$sqlstr = "select count(*) from ".$this->WIZTABLE["AVATARMEMBER"]." where userid = '$id'";
				$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
				$list = mysql_fetch_array($sqlqry);
				return $list[0];
			break;		
			default:##wizMembers//나중에 처리
			break;
		}
	}

####################################################################################
#### 동일아바타소유여부
####################################################################################
	function have_item($user_id, $item_no){
		$sqlstr = "select count(*) from ".$this->WIZTABLE["AVATARMERCHANT"]." where item_no = '$item_no' and user_id = '$user_id'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		if($list[0]){
			return true;
		}else{
			return false;
		}
	}

####################################################################################
#### 특정 테이블의 특정 필드값 가져오기
####################################################################################
	function getEachField($tablename, $fieldname, $where){
		$sqlstr = "select $fieldname from $tablename $where";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}

####################################################################################
#### 아바타 구매하기
####################################################################################
	function inputwardrobe($user_id,$item_no,$p_user_id=null,$flag=null){//옷장에 넣기
		//$flag = shop : 숍에서 구매하여 보내기, $flag = wardrobe : 옷장에서 보내기(선물하기)
		
		##옷장에서 보내기일 경우 현재 구매일을 옷장에 보관된 기일을 기준으로 하고 아닐경우 현재 날짜를 넣는다.
		if($flag == "wardrobe"){
			//echo "flag = $flag <br>";
			$b_date = $this->getEachField($this->WIZTABLE["AVATARMERCHANT"], "b_date", "where item_no = '$item_no' and user_id = '$p_user_id'");
		}else{
			$b_date = time();
		}
		$p_date = time();
		$p_flag = 1;//선물로 받은것

		$sqlstr = "insert into ".$this->WIZTABLE["AVATARMERCHANT"]." (user_id,item_no,b_date,p_flag,p_user_id,p_read,p_date)";
		$sqlstr .= " values ";
		$sqlstr .= " ('$user_id','$item_no','$b_date','$p_flag','$p_user_id','$p_read','$p_date')";
		mysql_query($sqlstr) or $this->dberror($sqlstr);
	}
####################################################################################
#### 제고에서 빼기
####################################################################################
	function minusstock($no){
		$sqlstr = "update ".$this->WIZTABLE["AVATARITEM"]." set jaego=jaego-1 where no='$no'";
		mysql_query($sqlstr) or $this->dberror($sqlstr);

	}
	function plusstock($no){
		$sqlstr = "update ".$this->WIZTABLE["AVATARITEM"]." set jaego=jaego+1 where no='$no'";
		mysql_query($sqlstr) or $this->dberror($sqlstr);

	}	
####################################################################################
#### 옷장에서 삭제하기
####################################################################################
	function deletefromwardrobe($item_no, $my_item_no, $layer, $user_id){
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARMERCHANT"]." where no='$my_item_no' and user_id = '$user_id'";
		mysql_query($sqlstr) or $this->dberror($sqlstr);

	}
####################################################################################
#### 입고 있는 옷에서 삭제
####################################################################################
	function deletefrommyon($item_no, $my_item_no, $layer, $user_id){
		## 입고있는 곳의 필드값 확인
		$sqlstr = "select * from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$user_id'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry, MYSQL_ASSOC);
		foreach($list as $key => $value){
			if($value == $item_no){
				$fieldname = $key;
				break;
			}
		}
		if($fieldname){
			$this->result = 1;
			$this->my_gender = $list["gender"];
			//$this->my_layer = $fieldname;
			$this->my_layer = str_replace("ava", "", $fieldname);
			$this->item_no = $item_no;
			$sqlstr = "update ".$this->WIZTABLE["AVATARMEMCONFIG"]." set $fieldname = 0 where user_id = '$user_id'";
			//echo "$sqlstr";
			mysql_query($sqlstr) or $this->dberror($sqlstr);
		}
	}	
####################################################################################
#### 포토앨범 저장갯수 구하기
####################################################################################
	function getphotono($user_id){
		$sqlstr = "select count(*) from ".$this->WIZTABLE["AVATARALBUM"]." where (user_id = '$avatar_id' and parent = 0 and contest = 0 and view = 0)";
		mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}
####################################################################################
#### 포토앨범에 저장사기
####################################################################################
	function insertalbum($user_id, $memo=null){
		$list = $this->getavatarmeminfo($user_id);
		$date = time();
		$sqlstr = "insert into ".$this->WIZTABLE["AVATARALBUM"]." (user_id, date, memo, ava1, ava2, ava3, ava4, ava5, ava6, ava7, ava8, ava9, ava10, ava11, ava12, ava13, ava14, ava15, ava16, ava17, ava18, ava19)";
		$sqlstr .= " values ";
		$sqlstr .= "('$user_id',$date,'$memo','$list[ava1]','$list[ava2]','$list[ava3]','$list[ava4]','$list[ava5]','$list[ava6]','$list[ava7]','$list[ava8]','$list[ava9]','$list[ava10]','$list[ava11]','$list[ava12]','$list[ava13]','$list[ava14]','$list[ava15]','$list[ava16]','$list[ava17]','$list[ava18]','$list[ava19]')";
		
		mysql_query($sqlstr) or $this->dberror($sqlstr);
	}

####################################################################################
#### 아바타 세션
####################################################################################
	function sessionproc($flag, $item_no){
		$list = $this->getItemInfo($item_no);
		$filename2 = $list["filename2"];
		$filename3 = $list["filename3"];
		$gender = $list["gender"];
		$layer_no = $list["layer"];
		$this->makeSessionDir();
		
		if($flag == "plus"){
			$this->makeSessionFile($flag, $layer_no, "tmpItem", $gender,$filename2,$filename3,$item_no);
			
					
			//$this->makeSessionFile($flag, $layer_no, "\$wizAvatarSession[\"tmpItem\"][$layer_no][\"gender\"] = \"$gender\";");
			//$this->makeSessionFile($flag, $layer_no, "\$wizAvatarSession[\"tmpItem\"][$layer_no][\"a_src\"] = \"$filename2\";");
			//$this->makeSessionFile($flag, $layer_no, "\$wizAvatarSession[\"tmpItem\"][$layer_no][\"a_src1\"] = \"$filename3\";");
			//$this->makeSessionFile($flag, $layer_no, "\$wizAvatarSession[\"tmpItem\"][$layer_no][\"item_no\"] = \"$item_no\";");
			
			
			//$tmpItem = $_SESSION["tmpItem"];
			//$tmpItem[$layer_no]["gender"] = $gender;
			//$tmpItem[$layer_no]["a_src"] = $filename2;
			//$tmpItem[$layer_no]["a_src1"] = $filename3;
			//$tmpItem[$layer_no]["item_no"] = $item_no;
			switch($layer_no){
				case "9"://얼굴
				case "10"://상의
				case "12"://하의
				/*
					$this->minusItemnoFromSession("13");//한벌의상
					$this->minusItemnoFromSession("17");//테마의상
				*/
					$this->deleteSessionFile("13");
					$this->deleteSessionFile("17");
				break;
				case "13"://한벌의상
				/*
					$this->minusItemnoFromSession("9");//얼굴
					$this->minusItemnoFromSession("10");//상의
					$this->minusItemnoFromSession("12");//하의
					$this->minusItemnoFromSession("16");//뒷헤어
					$this->minusItemnoFromSession("17");//테마의상
				*/
				
					$this->deleteSessionFile("9");
					$this->deleteSessionFile("10");
					$this->deleteSessionFile("12");
					$this->deleteSessionFile("16");
					$this->deleteSessionFile("17");	
																	
			    break;
				case "17"://테마의상
				/*
					$this->minusItemnoFromSession("9");//얼굴
					$this->minusItemnoFromSession("10");//상의
					$this->minusItemnoFromSession("12");//하의
					$this->minusItemnoFromSession("13");//한벌의상
					$this->minusItemnoFromSession("16");//뒷헤어
					*/
					$this->deleteSessionFile("9");
					$this->deleteSessionFile("10");
					$this->deleteSessionFile("12");
					$this->deleteSessionFile("13");
					$this->deleteSessionFile("16");
					
			    break;				
			}

			 //$_SESSION["tmpItem"] = $tmpItem;

		}else{//minus
			//$this->minusSession($layer_no);
			$this->deleteSessionFile($layer_no);
		}
	}



/*
	function getItemnoFromSession($layer_no){
		foreach($_SESSION["tmpItem"] as $key => $value){
			foreach($value as $key1 => $value1){
				if($layer_no == $value1){
					return $item_no;
				}
			}
		}	
	}
	
	function minusSession ($layer_no){
			$tmpItem = $_SESSION["tmpItem"];
			$tmpItem[$layer_no] = "";
			//session_register(tmpItem);
			$_SESSION["tmpItem"] = "";	
	}
	
	function minusItemnoFromSession($layer_no){
		$this->minusSession($this->getItemnoFromSession($layer_no));	
	}
	*/
####################################################################################
#### 아바타 찜하기
####################################################################################
	function insertZzim($item_no, $user_id){
		$sqlstr = "insert into ".$this->WIZTABLE["AVATARZZIM"]." (user_id, item_no, wdate) values ('$user_id', '$item_no',".time().") ";
		$result = mysql_query($sqlstr);// or $this->dberror($sqlstr);
		return $result;
	}
####################################################################################
#### 찜에 동일 아이템 중복책크
####################################################################################
	function getZzim($item_no, $user_id){
		$sqlstr = "select count(*) from ".$this->WIZTABLE["AVATARZZIM"]." where user_id = '$user_id' and item_no = '$item_no'";
		$sqlqry = mysql_query($sqlstr);// or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}	
####################################################################################
#### 아이템 파일 명으로 부터 item_id 구하기
####################################################################################
	function getItemidFromfilename($filename){
		$sqlstr = "select i.no from ".$this->WIZTABLE["AVATARITEM"]." i ";
		$sqlstr .= " left join ".$this->WIZTABLE["AVATARFACE"]." f ";
		$sqlstr .= " on i.no = f.item_id ";
		$sqlstr .= " where f.face01a = '$filename' or f.face02a = '$filename' or f.face03a = '$filename' or f.face04a = '$filename' or f.face05a = '$filename' or filename2 = '$filename'";
		//echo "sqlstr = $sqlstr <br>";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		return $list[0];
	}
####################################################################################
#### 세션관련 폴더 및 파일 생성
####################################################################################
	function makeSessionDir(){
		//global $_SERVER["DOCUMENT_ROOT"];
		$root = $_SERVER["DOCUMENT_ROOT"]."/wizavatar/session";
		$this->getlogininfo($_SESSION["wizavatar"]);
		$id = $this->avatar_userid;
		$strlen = strlen($id);
		$this->SessionFolder = $root;
		for($i=0; $i<$strlen; $i++){
			$this->SessionFolder .= "/".substr($id, $i, 1);
			if(!file_exists($this->SessionFolder)){
				mkdir($this->SessionFolder);
			}
		}
	}
	
	function makeSessionFile($flag,$layer_no,$kind=null, $gender=null, $a_src=null, $a_src1=null, $item_no=null){
		## $flag : minus , plus
		$this->getSessionDir();
		if(is_file($this->SessionFolder."/sessionfile.php")){
			include $this->SessionFolder."/sessionfile.php";
		}
		$wizAvatarSession["tmpItem"][$layer_no]["gender"]=$gender;
		$wizAvatarSession["tmpItem"][$layer_no]["a_src"]=$a_src;
		$wizAvatarSession["tmpItem"][$layer_no]["a_src1"]=$a_src1;
		$wizAvatarSession["tmpItem"][$layer_no]["item_no"] = $item_no;
		
		$fp = fopen($this->SessionFolder."/sessionfile.php", "w");
		
		fwrite($fp,"<?\n");
		if(is_array($wizAvatarSession)){//기존 세션 불러오기
			//reset($wizAvatarSession);
			ksort($wizAvatarSession["tmpItem"]);
			foreach($wizAvatarSession as $key => $value){
				foreach($value as $key1 => $value1){
					foreach($value1 as $key2 => $value2){
						$str = "\$wizAvatarSession[\"$key\"][$key1][\"$key2\"]=\"$value2\";\n";
						fwrite($fp,$str);
					}
				}
			}
		}
		
		if($flag == "plus"){
			$str = "$input_str\n";
			//echo "str = $str <br>";
			fwrite($fp,$str);
		}
		fwrite($fp,"?>");	
		fclose($fp);
		
	}
	
	function deleteSessionFile($layer_no){
		$this->getSessionDir();
		if(is_file($this->SessionFolder."/sessionfile.php")){
			include $this->SessionFolder."/sessionfile.php";
		}	
		$fp = fopen($this->SessionFolder."/sessionfile.php", "w");
		
		fwrite($fp,"<?\n");
		if(is_array($wizAvatarSession)){//기존 세션 불러오기
			//reset($wizAvatarSession);
			ksort($wizAvatarSession["tmpItem"]);
			foreach($wizAvatarSession as $key => $value){
				foreach($value as $key1 => $value1){
					if($key1 != $layer_no){
						foreach($value1 as $key2 => $value2){
							$str = "\$wizAvatarSession[\"$key\"][$key1][\"$key2\"]=\"$value2\";\n";
							fwrite($fp,$str);
						}
					}
				}
			}
		}
		fwrite($fp,"?>");	
		fclose($fp);
	}
	
	function deleteAllSessionFile(){
		$this->getSessionDir();
		if(is_file($this->SessionFolder."/sessionfile.php")){
			unlink ($this->SessionFolder."/sessionfile.php");
		}	
	}
	
	function getSessionDir(){
		$root = $_SERVER["DOCUMENT_ROOT"]."/wizavatar/session";
		$this->getlogininfo($_SESSION["wizavatar"]);
		$id = $this->avatar_userid;
		$strlen = strlen($id);
		$this->SessionFolder = $root;
		for($i=0; $i<$strlen; $i++){
			$this->SessionFolder .= "/".substr($id, $i, 1);
		}
	}

	function getAvatarSession(){
		$this->getSessionDir();
		if(is_file($this->SessionFolder."/sessionfile.php")){
			include $this->SessionFolder."/sessionfile.php";
		}	
		if(is_array($wizAvatarSession["tmpItem"])){
			foreach($wizAvatarSession["tmpItem"] as $key=>$value){
				$a_src = $value["a_src"];
				$a_src1 = $value["a_src1"];
				$gender = $value["gender"];	
				$item_no = $value["item_no"];
				echo "take_avatar('$a_src','$key','$gender','$item_no','$a_src1');\n";
			}
		}	
	}
####################################################################################
#### 세션관련 폴더 및 파일 생성
####################################################################################
	function deleteUser($userid){
		$this->db_connect();
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARALBUM"]." where user_id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARMEMCONFIG"]." where user_id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARCOMMENT"]." where user_id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARMERCHANT"]." where user_id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARZZIM"]." where user_id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
		
		$sqlstr = "delete from ".$this->WIZTABLE["AVATARPOINT"]." where id='$userid'";
		$sqlqry = mysql_query($sqlstr) or $this->dberror($sqlstr);
	}
}	
?>
