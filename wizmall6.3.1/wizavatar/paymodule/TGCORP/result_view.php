<?
@session_start();

/*
if($ck_userid ==""){
	echo "
	<script>
		alert('로그아웃 상태이거나 잘 못된 경로로 들어왔습니다.');
	</script>
	";
	exit;
}
*/
    if (phpversion() >= 4.2) { // POST, GET 방식에 관계 없이 사용하기 위해서
        if (count($_POST)) extract($_POST, EXTR_PREFIX_SAME, 'VARS_');
        if (count($_GET)) extract($_GET, EXTR_PREFIX_SAME, '_GET');
    }

  //  $Sname = "신용카드"; 
    if($Smode!=null) {
        if($Smode=="3001"||$Smode=="3005"||$Smode=="3007") $Sname = "신용카드";
        else if($Smode=="2500"||$Smode=="2501") $Sname = "계좌이체";  // 금결원
        else if($Smode=="2201"||$Smode=="2401") $Sname = "계좌이체";  // 핑거, 뱅크타운
        else if($Smode=="6101") $Sname = "휴대폰결제";
        else if($Smode=="8801") $Sname = "ARS전화결제";
        else if($Smode=="2601") $Sname = "가상계좌";
        else if($Smode=="5101") $Sname = "도서상품권";
        else if($Smode=="5301") $Sname = "복합결제";
        else if($Smode=="0001") $Sname = "현금영수증";
    }  
	
	

?>

<HTML>
<HEAD>
<TITLE>:::::TGCORP 결과 확인:::::</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=<?=$cfg["common"]["lan"]?>"/>
<STYLE type="text/css">
    BODY { 
        scrollbar-3dlight-color:#888888;
        scrollbar-arrow-color:#888888;
        scrollbar-track-color:#FFFFFF;
        scrollbar-darkshadow-color:#888888;
        scrollbar-face-color:#FFFFFF;
        scrollbar-highlight-color:#FFFFFF;
        scrollbar-shadow-color:#FFFFFF
    }
    BODY { font-family:돋움; font-size:9pt;color:#000000; text-decoration:none;}
    TD { font-family:돋움; font-size:9pt;color:#000000; text-decoration:none;}
</STYLE>
</HEAD>
<?
include $DOCUMENT_ROOT."/library/dbconnect.php";
include $DOCUMENT_ROOT."/config/db_info.php";
include $DOCUMENT_ROOT."/config/db_connect.php";
require_once $DOCUMENT_ROOT."/wizboard/lib/paycal_class.php"; 
require_once $DOCUMENT_ROOT."/wizboard/lib/bamtoly_class.php"; 

$paycls = new PayCalulation_Class($MYSQL_HOST,$MYSQL_DB,$MYSQL_ID,$MYSQL_PASSWORD);
$bamcls = new Bamtoly_Class($MYSQL_HOST,$MYSQL_DB,$MYSQL_ID,$MYSQL_PASSWORD);

$table="Amount";
if($ReplyCode!=null && ($ReplyCode=="00003000" ||  (($Smode=="2601" || $Smode=="6101") && $ReplyCode=="00004000"))) { 
	$insert="insert into $table (userid,result_no, result_amount,  result_code, reslut_message, result_reg) values('$ck_userid','$MxIssueNO','$Amount' ,'$ReplyCode','$ReplyMessage','$MxIssueDate')";
	mysql_query($insert, $connect);
	//echo"$insert";
	if($MSTR2 == "member"){ //회원가입시
		switch($Amount){
			case "5000";
				$adddate = 60*60*24*30;
			break;
			case "10000";
				$adddate = 60*60*24*30*2;
			break;
			case "50000";
				$adddate = 60*60*24*30*12;
			break;						
		}
		
		
		$sqlstr = "select expiredate from Coupon  where pkey='$MxIssueNO'";
		$sqlqry = mysql_query($sqlstr);
		$list = mysql_fetch_array($sqlqry);
		$expiredate = $list["expiredate"];
		if($expiredate <= time()) $expiredate = time() + $adddate;
		else $expiredate += $adddate;
		
		$sqlstr = "update Coupon set expiredate = $expiredate where pkey='$MxIssueNO'";
		mysql_query($sqlstr);
		
		$paycls->updatePayinfo($ck_userid);//지불결과를 저장한다.
		
		echo("<Script>
				alert('결제가 성공되었습니다.');
				location.href='/member.htm?pg=pg3';
			</script>
			");
	}else{
		
		$bam_point = $Amount;
		$reg_day=time();
		if($Smode=="3001"){
			 $flag = "1"; 
			 $detail= "신용카드결제";
		}elseif($Smode=="6101"){
			 $flag="5"; 
			 $detail="휴대폰결제";
		}
		
		//중복 입력 체크한다.
		$sqlstr = "select userid From bamtoly where userid='$ck_userid' and regdate='$reg_day'";
		$qrystr = mysql_query($sqlstr);
		$total_num =  mysql_num_rows($qrystr);
		if($total_num < 1){
			#밤톨이 업데이트
			$bamcls->flag = $flag;
			$bamcls->type = 40;
			$bamcls->subtype = "밤톨이구매";
			$detail = "밤톨이 구매 획득";			
			$bamcls->insert($ck_userid,$bam_point,$detail);

			echo("<Script>
					alert('결제가 성공되었습니다.\\n\\n캐쉬 및 밤톨이 현황에서 확인하실 수 있습니다.');
					opener.location.reload();
					window.close()
				</script>
				");
			exit;
		}else{
#프로그램 완료시 아래 세션생성은 삭제		
			###################   밤톨이 세션을 지운다. ###########################
			@session_unregister(ck_bamtoli);
			################## 밤톨이 세션 등록####################################
			$querybam = "select sum(bamtoly) as totalbam from bamtoly where userid='".$ck_userid."' and (flag='0' or flag='1' or flag='2' or flag='3'  or flag=5) and flag_ok='1'"; //flag=1 , flag=2 만 체크해서 합산함. flag=3은 계좌이체 미 결제
			$resultbam = mysql_query($querybam) or die (mysql_error());
			$resultrow = mysql_fetch_array($resultbam);
			$ck_bamtoli = $resultrow[totalbam];
			@session_register(ck_bamtoli);
			#####################################################################
			echo("<Script>
					alert('결제가 성공되었습니다.\\n\\n캐쉬 및 밤톨이 현황에서 확인하실 수 있습니다.');
					opener.location.reload();
					window.close()
				</script>
				");
			exit;
		}
	}
}else{
	echo("
		<Script>
			alert('결제가 실패되었습니다.');
			opener.location.reload();
			window.close()
		</script>
		
	");
	
}
?>
