<?
@session_start();
//$bam_num = "5000000";
//include $_SERVER['DOCUMENT_ROOT']."/library/dbconnect.php";
include $_SERVER['DOCUMENT_ROOT']."/config/db_info.php";
include $_SERVER['DOCUMENT_ROOT']."/config/db_connect.php";
if($ck_bamtoli < $bam_num){
	$type_tab = "1";
}else{
	$type_tab = "2";
}

if($mode =="input_bam" && $type_tab=="2"){
	require_once $DOCUMENT_ROOT."/wizboard/lib/bamtoly_class.php"; 
	$bamcls = new Bamtoly_Class($MYSQL_HOST,$MYSQL_DB,$MYSQL_ID,$MYSQL_PASSWORD);
	
	$reg_day = mktime();
	$content = addslashes($content);
	$insert = "insert into bamtory_present(type, userid, re_userid, point, content, reg_day) values('1', '$ck_userid', '$userid', '$bam_num','$content','$reg_day')";	
	mysql_query($insert);

	// 받을 밤톨이 더하기(아래것과 순서가 바뀌면 session이 잘못먹음으로 순서 바뀌지 않게 주의
	$bamcls->type="80";
	$detail = "{$ck_userid}님에게 선물받음";
	$bamcls->subtype = "밤톨이 선물";
	$bamcls->insert($userid, $bam_num, $detail);	
	// 밤톨이 빼기
	$bam_num_m = "-".$bam_num;
	$detail = "{$userid}님에게 포인트 선물";
	$bamcls->insert($ck_userid, $bam_num_m, $detail);

	
	echo "<script>alert('$userid 님에게 $bam_num_re 밤톨이를 선물하였습니다.');opener.location.reload(); window.close();</script>";
	
}
//아래처럼 보유 밤톨이를 세션으로 처리할 경우 뚫릴 확률이 있슴
// 이후 문제가 발생하면 프로그램 수정
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>:::::밤톨이 선물하기:::::</title>
<link rel="stylesheet" type="text/css" href="http://xman.co.kr/css/css.css">
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">

</head>
<script language="javascript">
<!--
	function chk_id(){
		var type_tab_ja = <?=$type_tab;?>;
		if(type_tab_ja =='1'){
			alert('보유한 밤톨이가 부족합니다.');
			return ;
		}else if(type_tab_ja =="2"){
			if(document.add_form.userid.value ==""){
				alert("받을 아이디를 입력하세요.");
				return;
			}else{
				var userid_ck = document.add_form.userid.value;
				location.href='<?=$_SERVER['PHP_SELF'];?>?mode=id_check&userid='+document.add_form.userid.value+"&bam_num=<?=$bam_num;?>";
			}
		}
	}
	
	function go_bamtory(){
		if(document.add_form.chk_item.checked == true){
				document.add_form.action = "<?=$_SERVER['PHP_SELF'];?>?mode=input_bam";
				document.add_form.submit();		
		}
	}
	
	function go_location(){
			
			location.href='./cash_03.php';
			//window.close()
	}
	
	
	function PreventSubmitOnEnter()
	{
		if(event.keyCode==13)
		{
			return false;
		}
	}
	
	function Load()
	{
		var inputs = document.getElementsByTagName("INPUT")         
		for(var i = 0; i < inputs.length ; i++)
		{               
			if(inputs[i].type == "text")
			{           
				inputs[i].attachEvent("onkeypress", PreventSubmitOnEnter);      
			}
		}
	}


	
	
//-->
</script>

<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onLoad="Load()">

<form name="add_form" method="post">
<table width="385" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td colspan="3"><img src="img/img01.gif" width="385" height="100"></td>
  </tr>
  <tr> 
    <td width="136"><img src="img/img02.gif" width="136" height="117"></td>
    <td width="214" bgcolor="E2F2FC"><table width="90%" border="0" align="center" cellpadding="5" cellspacing="0">
        <tr> 
          <td><img src="img/img07.gif" width="131" height="23"></td>
        </tr>
        <tr> 
            <td><strong>&nbsp;&nbsp;보유 밤톨이 : 
              <?=number_format($ck_bamtoli);?>
              개</strong></td>
        </tr>
        <tr> 
            <td><strong>&nbsp;&nbsp;선물 밤톨이 : 
              <?=number_format($bam_num);?>
              개</strong></td>
        </tr>
      </table></td>
    <td width="35"><img src="img/img03.gif" width="35" height="117"></td>
  </tr>
  <tr> 
    <td colspan="3"><img src="img/img08.gif" width="385" height="41"></td>
  </tr>
</table>
<table width="385" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td><img src="img/img09.gif" width="34" height="187"></td>
    <td width="316" bgcolor="FAFAF9" valign="top"> <!---받을 아이디 테이블 시작--><table width="303" height="40" border="0" align="center" cellpadding="3" cellspacing="0">
        <tr> 
          <td width="89"><img src="img/img12.gif" width="82" height="20"></td>
          <td width="105"><input name="userid" type="text" size="15"></td>
          <td width="48"><a href="javascript:chk_id()" onFocus="this.blur()"><img src="img/b_idok.gif" alt="id확인" width="48" height="20" border="0"></a></td>
          <td width="43" height="35">&nbsp;</td>
        </tr>
<?
	if($mode=="id_check"){
		$sqlstr ="select userid, namekr from MemberInfo where userid='$userid'";
		//echo $sqlstr;
		$qrystr = mysql_query($sqlstr);
		$mylist = mysql_fetch_array($qrystr);
		$total  = mysql_num_rows($qrystr);
		if($total =="0"){	
		$rows="3";
?>	     <tr>
          <td height="50" colspan="4" align="center"><b>등록된 회원이 없습니다.</b></td>
          </tr>
<?
	}else{
		$chk_item="ok";
?>
		  <tr>
          <td height="25" colspan="4" align="left"><input type=checkbox name=chk_item checked="checked"> &nbsp; <b><?=$mylist[userid];?> ( <?=$mylist[namekr];?> )</b> 님은 엑스맨 회원입니다.</td>
          </tr>
		  <input type=hidden name="userid" value="<?=$mylist[userid];?>">
		  <input type=hidden name="bam_num" value="<?=$bam_num;?>">
<?
		$rows="5";
	}
}
?>
      </table>
    <!---받을 아이디 테이블 끝-->
	<!---전하는 한마디 테이블 시작-->
      <table width="300" height="40" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr>
          <td height="35"><img src="img/img13.gif" width="95" height="20"></td>
          <td></td>
        </tr>
        <tr>
			<? if($rows =="") $rows="7";?>
       
      <!---전하는 한마디 테이블 끝-->
		<!---밤톨이 충전 여부 물어보는 안내글  테이블 시작-->
<?
	if($type_tab =="1"){ //보유 밤톨이가 부족할때
?>
	   <td colspan="2"><textarea name="content" rows="2" cols="40"></textarea></td>
          </tr>
      </table>
      <table width="300" height="70" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr>
          <td><div align="center"><strong><font color="CC634B"><br>
            밤톨이가 부족합니다.<br>
              부족한 밤톨이를 충전 후에 보내시겠습니까?</font></strong></div></td>
        </tr>
      </table>
<?
}elseif($type_tab =="2"){//보유 밤톨이가 더 많을 때
?>	  
   <td colspan="2"><textarea name="content" rows="<?=$rows;?>" cols="40"></textarea></td>
          </tr>
      </table>

<?
}
?>
	  <!---밤톨이 충전 여부 물어보는 안내글  테이블 끝--></td>
    <td><img src="img/img10.gif" width="35" height="187"></td>
  </tr>
  <tr> 
    <td  background="img/img11.gif" height="74" colspan="3"> 
 <table border="0" align="center" cellpadding="5" cellspacing="0">
        <tr>
<?
 if($type_tab =="1"){
?>
		  <td><a href="javascript:go_location()" onFocus="this.blur()"><img src="img/b_yes.gif" alt="예" width="53" height="19" border="0"></a></td>
          <td><a href="javascript:window.close()" onFocus="this.blur()"><img src="img/b_no.gif" alt="아니요" width="53" height="19" border="0"></a></td>
<?
}elseif($type_tab =="2" and $chk_item=="ok"){
?>
		   <td><img src="img/b_ok.gif" alt="확인" width="53" height="19" border="0" onClick="go_bamtory()" style="cursor:hand"></td>	
<?
}elseif($type_tab=="2" and $chk_itme==""){
?>
			 <td><img src="img/b_ok.gif" alt="확인" width="53" height="19" border="0" onClick="alert('밤톨이 선물 할 ID를 확인하세요.')" style="cursor:hand"></td>			
<? } ?>
        </tr>
      </table>
    </td>
  </tr>
</table>
</form>
</body>
</html>
