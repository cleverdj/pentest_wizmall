<?
/*
## 타 페이지(wizavatar.php외의 파일)에도 별도로 사용할 경우 아래를 활성화 시키고 경로를 맞추어 준다.
require_once $DOCUMENT_ROOT."/config/db_info.php";
require_once $DOCUMENT_ROOT."/config/avatar_config.php";
require_once $DOCUMENT_ROOT."/lib/class.avatar.php";
$avatar_skin_path = $DOCUMENT_ROOT."/config/wizavatar/avatar_skin/".$avatar_skin;
$avatar = new avatar();
$avatar->WIZTABLE = $WIZTABLE;

include "./lib/class.common.php";
$common = new common();
$cfg["member"] = $common->getLogininfo();//로그인 정보를 가져옮
$common->db_connect($dbcon);

*/

##########################################
############ 아바타관련시작 ##############
##########################################

if ($cfg["member"]){
	//$point = $avatar->check_point($avatar->avatar_userid);//직접db에서 가지고 오는 방식
	$point = $cfg["member"]["mpoint"];//세션에서 가져오는 방식

## 소유아이템 갯수 구하기
//	$sqlstr = "select count(1) from ".$WIZTABLE["AVATARMERCHANT"]." where user_id = '".$avatar->avatar_userid."'";
//	$sqlqry = mysql_query($sqlstr) or die(mysql_error()."<br>".$sqlstr);
//	$h_item = mysql_num_rows($sqlqry);//소유아이템갯수

## 착용아이템 정보구하기	
	$sqlstr = "select * from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '".$cfg["member"]["mid"]"'";
	echo "sqlstr = $sqlstr <br>";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	$avatar_gender = $list["gender"];
	$avatar->getavatarImg($list["ava1"]);
	$avatarimg[1] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava2"]);
	$avatarimg[2] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava3"]);
	$avatarimg[3] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava4"]);
	$avatarimg[4] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava5"]);
	$avatarimg[5] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava6"]);
	$avatarimg[6] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava7"]);
	$avatarimg[7] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava8"]);
	$avatarimg[8] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava9"]);
	$avatarimg[9] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava10"]);
	$avatarimg[10] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava11"]);
	$avatarimg[11] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava12"]);
	$avatarimg[12] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava13"]);
	$avatarimg[13] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava14"]);
	$avatarimg[14] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava15"]);
	$avatarimg[15] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava16"]);
	$avatarimg[16] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava17"]);
	$avatarimg[17] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava18"]);
	$avatarimg[18] = $avatar->avatarimg[1];
	$avatar->getavatarImg($list["ava19"]);
	$avatarimg[19] = $avatar->avatarimg[1];

	if(!isset($c_gender)) $c_gender = $avatar_gender;
}
##########################################
############ 아바타관련  끝 ##############
##########################################
?>

<script language="javascript">
<!--
var xmlHttp;

function createXMLHttpRequest() {
	if (window.ActiveXObject) {
		xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
	} 
	else if (window.XMLHttpRequest) {
		xmlHttp = new XMLHttpRequest();                
	}
}

function createQueryString() {
    var userid = document.getElementById("userid").value;
    var passwd = document.getElementById("passwd").value;
    var saveid ;
	var mode = document.getElementById("mode").value;
    
	if (document.getElementById("saveid").checked == true){ 
		saveid = 1;
		
	}else saveid = 0;
	
	
    var queryString = "userid=" + userid + "&passwd=" + passwd + "&saveid=" + saveid + "&mode=" + mode + "&type=ajax";
    //alert(queryString);
    return queryString;
}

function validate(f) {
	//form check 하기
	if(f.userid.value == ""){
		alert('아이디를 입력하세요');
		f.userid.focus();
	}else if(f.passwd.value == ""){
		alert('패스워드를 입력하세요');
		f.passwd.focus();
	}else{//ajax 시작
		createXMLHttpRequest();
		var url = "/member/member_process.php";
		var queryString = createQueryString();
		
		xmlHttp.open("POST", url, true);
		xmlHttp.onreadystatechange = handleStateChangeLogin;
		xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");    
		xmlHttp.send(queryString);
	}
}

function handleStateChangeLogin() {
    if(xmlHttp.readyState == 4) {
        if(xmlHttp.status == 200) {
					var result = xmlHttp.responseXML.getElementsByTagName("flag")[0].firstChild.data;
					var mes = xmlHttp.responseXML.getElementsByTagName("str")[0].firstChild.data;
					if(result == 0){
						alert(mes);
					}else{
						document.location.reload();
					}
        }
    }
}

/// 아래는 아바타 관련
function ch_face(item_id,face_no,a_src,face_layer){
		createXMLHttpRequest();
		var url = "/wizavatar/avatarProc.php";
		var queryString = "mode=changFace&item_id="+item_id+"&face_no="+face_no+"&a_src="+a_src+"&face_layer="+face_layer ;
		//alert(queryString)
		xmlHttp.open("POST", url, true);
		//xmlHttp.onreadystatechange = handleStateChange;
		xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");    
		xmlHttp.send(queryString);
		document.images["ImgChar"+face_layer].src= "/wizavatar/avatarimg/face_img/"+a_src
		//alert(document.images["ImgChar9"].src);
		
}
//-->
</script>
<!-- 아바타 관련 시작 -->
<script language="JavaScript" src="/wizavatar/avatarjs.php"></script>
<script>
<!--

<?
switch($avatar_gender){
	case "2"://여성
		switch ($avatar_grade){
			case "4"://선생
				$avatarIniimg[0] = "default_w_top5.gif";
				$avatarIniimg[1] = "default_w_bottom5.gif";
				$avatarIniimg[2] = "default_w_head5.gif";
			break;
			case "1"://학부모
				$avatarIniimg[0] = "default_w_top7.gif";
				$avatarIniimg[1] = "default_w_bottom7.gif";
				$avatarIniimg[2] = "default_w_head7.gif";
			break;
			default:
				$avatarIniimg[0] = "default_w_top9.gif";
				$avatarIniimg[1] = "default_w_bottom9.gif";
				$avatarIniimg[2] = "default_w_head9.gif";
			break;													
		}
	break;
	case "1"://남성
		switch ($avatar_grade){
			case "4"://선생
				$avatarIniimg[0] = "default_m_top5.gif";
				$avatarIniimg[1] = "default_m_bottom5.gif";
				$avatarIniimg[2] = "default_m_head5.gif";
			break;
			case "1"://학부모
				$avatarIniimg[0] = "default_m_top7.gif";
				$avatarIniimg[1] = "default_m_bottom7.gif";
				$avatarIniimg[2] = "default_m_head7.gif";
			break;
			default:
				$avatarIniimg[0] = "default_m_top9.gif";
				$avatarIniimg[1] = "default_m_bottom9.gif";
				$avatarIniimg[2] = "default_m_head9.gif";
			break;													
		}				
	break;
	default:
		$avatarIniimg[0] = "default_m_top9.gif";
		$avatarIniimg[1] = "default_m_bottom9.gif";
		$avatarIniimg[2] = "default_m_head9.gif";
	break;		
}
?>
naked_avatar = new Array(20);
<?
echo "naked_avatar[10] = '".$avatarIniimg[0]."';\n";	
echo "naked_avatar[12] = '".$avatarIniimg[1]."';\n";
echo "naked_avatar[9] = '".$avatarIniimg[2]."';\n";
?>


function origin_avatar() {
<?
	for($i=1; $i<=19; $i++){
		switch($i){
			case "10"://상의
				switch($avatar_gender){
					case "2"://여성
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_w_top9.gif";
					break;
					default:
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_m_top9.gif";
					break;
				}
			break;
			case "12"://하의
				switch($avatar_gender){
					case "2"://여성
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_w_bottom9.gif";
					break;
					default:
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_m_bottom9.gif";		
					break;
				}			
			break;
			case "9"://얼굴
				switch($avatar_gender){
					case "2"://여성
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_w_head9.gif";
					break;
					default:
						$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_m_head9.gif";
					break;
				}			
			break;	
			default:
				$avatarimg[$i] = $avatarimg[$i]!="default_blank.gif"?$avatarimg[$i]:"default_blank.gif";	
			break;
		}
		echo "origin_ch('".$avatarimg[$i]."','".$i."');\n";	
	}
		
?>
	avatar_trim();//레이어의 중첩여부를 책크하여 아바타의 중복을 피한다	
	item = new Array(20);//현재 배열에 담긴 아바타 초기화
	ResetPresentAvatar();//세션에 담긴 아바타 초기화
}
<?
	for($i=1; $i<=19; $i++){
		$avatarimg[$i] = $avatarimg[$i]?$avatarimg[$i]:"default_blank.gif";
		echo "origin_avatar_".$i."_src = '".$avatarimg[$i]."';\n";
	}
?>

function AvatarSave(){
	var url = "<?=$avatar_skin_path?>/avatar_album_save.php?mode=insertAlbum";
	window.open(url,'avatar_album','left=50,top=50,width=360,height=450,toolbar=no,scrollbars=no');
}
function AvatarSaveConfirm(){
	if(confirm('구매하지 않은 아이템에 대해서는 저장되지 않습니다\n저장하시겠습니까?')){
		AvatarSave()
	}

}
//-->
</script>
<?
$avatar->avatarpath = "/wizavatar/avatarimg/";
$avatar_view =$avatar->show_avatar($avatar->avatar_userid);
?>
<? if(!$_SESSION["wizavatar"]){ ?>
<script language="javascript">
<!--			
function loginformcheck(ff){
	var ff = document.login_form;
	
	if(ff.insert_id.value == ""){
		alert("아이디를 입력하세요.");
		ff.insert_id.focus();
		return false;
	}

	if(ff.insert_passwd.value == ""){
		alert("비밀번호를 입력하세요.");
		ff.insert_passwd.focus();
		return false; 
	}
	return true;		
}


function enter_onkeypress() {
	if( event.keyCode == 13 ) {
	f_chk();
	return false ;
	}
}	
//-->
</script><? } else { ?>

<table border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td height="6"></td>
  </tr>
  <tr>
    <td  style="padding-left:6px;"><table border="1" cellpadding="0" cellspacing="0" bordercolor="dddddd" bgcolor="#FFFFFF">
        <tr>
          <td><?=$avatar_view?></td>
        </tr>
      </table><script language="javascript">
<!--
<?
$avatar->getAvatarSession();

if($_SESSION["avatar_face"]["name"]){
	echo "document.images[\"ImgChar".$_SESSION["avatar_face"]["layer"]."\"].src= \"/wizavatar/avatarimg/face_img/".$_SESSION["avatar_face"]["name"]."\"";
}
?>
	
faceimg0 = new Array(5);
faceimg1 = new Array(5);
function changeFaceBox(item_id,facelayer,faceimg0, faceimg1){
	var faceBox="";
	//alert(item_id+","+facelayer+","+faceimg0+","+faceimg1)
	
	faceBox = "<table width='100%' border='0' cellspacing='0' cellpadding='0'>"+
				"<tr>"+
				"<td bgcolor='#ffd8f0'><table width='100%' border='0' cellspacing='0' cellpadding='0'>"+
				"<tr>"+
				"<td align='center'><img id='ImgFace1' src='/wizavatar/avatarimg/face_img/"+faceimg0[0]+"' width='26' height='27' border='0' alt='기본' style='cursor:pointer' onclick='ch_face("+item_id+",\"0\",\""+faceimg1[0]+"\", "+facelayer+");'></td>"+
				"<td width='2' bgcolor='#FFFFFF'> </td>"+
				"<td align='center'><img id='ImgFace2' src='/wizavatar/avatarimg/face_img/"+faceimg0[1]+"' width='26' height='27' border='0' alt='웃음' style='cursor:pointer' onclick='ch_face("+item_id+",\"1\",\""+faceimg1[1]+"\", "+facelayer+");'></td>"+
				"<td width='2' bgcolor='#FFFFFF'> </td>"+
				"<td align='center'><img id='ImgFace3' src='/wizavatar/avatarimg/face_img/"+faceimg0[2]+"' width='26' height='27' border='0' alt='울음' style='cursor:pointer' onclick='ch_face("+item_id+",\"2\",\""+faceimg1[2]+"\", "+facelayer+");'></td>"+
				"<td width='2' bgcolor='#FFFFFF'> </td>"+
				"<td align='center'><img id='ImgFace4' src='/wizavatar/avatarimg/face_img/"+faceimg0[3]+"' width='26' height='27' border='0' alt='화남' style='cursor:pointer' onclick='ch_face("+item_id+",\"3\",\""+faceimg1[3]+"\", "+facelayer+");'></td>"+
				"<td width='2' bgcolor='#FFFFFF'> </td>"+
				"<td align='center'><img id='ImgFace5' src='/wizavatar/avatarimg/face_img/"+faceimg0[4]+"' width='26' height='27' border='0' alt='황당' style='cursor:pointer' onclick='ch_face("+item_id+",\"4\",\""+faceimg1[4]+"\", "+facelayer+");'></td>"+
				"</tr>"+
				"</table></td>"+
				"</tr>"+
				"<tr>"+
				"<td height='1' bgcolor='#ffd8f0'></td>"+
				"</tr>"+
				"</table>";
				
   if (document.layers){  
        document.layers.ImgFace.document.write(faceBox);  
        document.layers.ImgFace.document.close();  
    }else{  
        if (document.all){  
            ImgFace.innerHTML = faceBox;
        }  
    }				
}

//alert(document.images["ImgChar9"].src);
function getAvatarFilename(src){
	var to_length = src.lastIndexOf("/");
	var full_length = src.length;
	var src_file_name = src.substring(to_length+1,full_length);
	return src_file_name
}

function getInitAvatarFace(src_name,layer_no){
	createXMLHttpRequest();
	var url = "/wizavatar/avatarProc.php";
	var queryString = "mode=getAvatarFacebyimgname&src_name="+src_name+"&layer_no="+layer_no;
	//alert(queryString);
	xmlHttp.open("POST", url, true);
	xmlHttp.onreadystatechange = getInitAvatarFaceResult;
	xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");    
	xmlHttp.send(queryString);
}	

function getInitAvatarFaceResult(){
	//alert(xmlHttp.readyState);
    if(xmlHttp.readyState == 4) {
        if(xmlHttp.status == 200) {
			var item_no = xmlHttp.responseXML.getElementsByTagName("item_no")[0].firstChild.data;	
			var layer_no = xmlHttp.responseXML.getElementsByTagName("layer_no")[0].firstChild.data;
			faceimg0[0] = xmlHttp.responseXML.getElementsByTagName("facei1")[0].firstChild.data;
			faceimg1[0] = xmlHttp.responseXML.getElementsByTagName("facea1")[0].firstChild.data;
			faceimg0[1] = xmlHttp.responseXML.getElementsByTagName("facei2")[0].firstChild.data;
			faceimg1[1] = xmlHttp.responseXML.getElementsByTagName("facea2")[0].firstChild.data;
			faceimg0[2] = xmlHttp.responseXML.getElementsByTagName("facei3")[0].firstChild.data;
			faceimg1[2] = xmlHttp.responseXML.getElementsByTagName("facea3")[0].firstChild.data;
			faceimg0[3] = xmlHttp.responseXML.getElementsByTagName("facei4")[0].firstChild.data;
			faceimg1[3] = xmlHttp.responseXML.getElementsByTagName("facea4")[0].firstChild.data;
			faceimg0[4] = xmlHttp.responseXML.getElementsByTagName("facei5")[0].firstChild.data;
			faceimg1[4] = xmlHttp.responseXML.getElementsByTagName("facea5")[0].firstChild.data;
			//alert(item_no+', '+layer_no+', '+faceimg0[0]+', '+faceimg0[1]);
			//alert(item_no);
			changeFaceBox(item_no,layer_no,faceimg0,faceimg1)				
        }else{
			alert('./wizavatar/avatarPorc.php\n접속실패');
		}
    }
}


if(getAvatarFilename(document.images["ImgChar13"].src) != "default_blank.gif" ){//한벌의상이면
	getInitAvatarFace(getAvatarFilename(document.images["ImgChar13"].src),'13');
}else if(getAvatarFilename(document.images["ImgChar9"].src) != "default_blank.gif"){//얼굴이면
	getInitAvatarFace(getAvatarFilename(document.images["ImgChar9"].src),'9');
}else if(getAvatarFilename(document.images["ImgChar17"].src) != "default_blank.gif"){//테마의상
	getInitAvatarFace(getAvatarFilename(document.images["ImgChar17"].src),'17');
}

<?
$facelist = $avatar->getFaceList1();
for($i=0; $i<5; $i++){
	$j = $i+1;
	echo "faceimg0[$i] = \"".$facelist["i"][$j]."\";\n";
	echo "faceimg1[$i] = \"".$facelist["a"][$j]."\";\n";
}
?>
//-->
</script></td>
  </tr>
  <tr>
    <td height="34"  style="padding-left:6px;"><span id="ImgFace"></span></td>
  </tr>
  <tr>
    <td  style="padding-left:6px;"><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td width="30"><img src="<?=$cfg["common"]["path"]?>/images/icon_bam.gif" width="30" height="15" /></td>
          <td><span class="style3">밤톨이 :</span> <span class="style4"><?=number_format($point);?>개</span></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td width="157" height="48" background="<?=$cfg["common"]["path"]?>/images/left_bg_01.gif" align="center"><table border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td><img src="<?=$cfg["common"]["path"]?>/images/icon_01.gif" alt="선물보관함" width="34" height="34" border="0" onClick="viewPresentWindow('receiveP');" style="cursor:pointer"></td>
          <td width="12"></td>
          <td><a href="<?=$cfg["common"]["path"]?>/wizavatar.php?skinmode=waredrobe" onFocus="blur()"><img src="<?=$cfg["common"]["path"]?>/images/icon_02.gif" alt="나의옷장" width="34" height="34" border="0" /></a></td>
          <td width="12"></td>
          <td><a href="<?=$cfg["common"]["path"]?>/wizavatar.php?skinmode=album" onFocus="blur()"><img src="<?=$cfg["common"]["path"]?>/images/icon_03.gif" alt="내 앨범" width="34" height="34" border="0" /></a></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td height="3"></td>
  </tr>
  <tr>
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td><img src="<?=$cfg["common"]["path"]?>/images/icon_04.gif" alt="장착한 아이템구매" width="50" height="28" border="0" onClick="buy_item();" style="cursor:pointer"></td>
          <td width="3"></td>
          <td><img src="<?=$cfg["common"]["path"]?>/images/icon_05.gif" alt="현재모습 저장" width="50" height="28" border="0" onClick="AvatarSaveConfirm()" style="cursor:pointer" onFocus="this.blur()"></td>
          <td width="3"></td>
          <td><img src="<?=$cfg["common"]["path"]?>/images/icon_06.gif" alt="원래대로" width="50" height="28" border="0" onClick="origin_avatar();" style="cursor:pointer" onFocus="this.blur()"></td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td height="6"></td>
  </tr>
</table>
<? } ?>
