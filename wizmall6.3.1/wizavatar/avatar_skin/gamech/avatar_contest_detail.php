<?
session_start();
include_once "../../../config/db_info.php";

include_once "../../../config/avatar_config.php"; 
//include_once "../../../wizboard/func/function_general.php";
include_once "../../lib/class.avatar.php";
$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;
$avatar->avatarpath = "../../../wizavatar/avatarimg/";
$avatar->getlogininfo($_SESSION["wizavatar"]);
$avatar_id = $avatar->avatar_userid;

if($query == "insert_score"){
	## 인서트
	$sqlstr = "insert into ".$WIZTABLE["AVATARSCORE"]." (ano,user_id,score,wdate) values ($no,'$avatar_id',$score,".time().")";
	$result  = @mysql_query($sqlstr);
	if($result){//$WIZTABLE["AVATARALBUM"] 테이블의 스코어 업데이트
		$sqlstr = "update ".$WIZTABLE["AVATARALBUM"]." set score = score + $score where no = '$no'";
		mysql_query($sqlstr);	
	}
}elseif($query == "insert"){
	## 현재face 정보를 가져온다.
	$sqlstr = "select * from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$avatar_id'";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	if($list["ava13"]){//한벌의상
		$default_face = $list["ava13"];
	}else if($list["ava17"]){//테마의상
		$default_face = $list["ava17"];
	}else{//ava9 : 얼굴
		$default_face = $list["ava9"];
	}
	$sqlstr = "select face01 from ".$WIZTABLE["AVATARFACE"]." where item_id = '$default_face'";
	$sqlqry = mysql_query($sqlstr);
	$list = mysql_fetch_array($sqlqry);
	$faceicon = $list["face01"];
	
	
	## 데이타 입력
	$name = $ck_username;
	$memo = addslashes($memo);
	$sqlstr = "insert into ".$WIZTABLE["AVATARCOMMENT"]." (ano,user_id,name,memo,faceicon,wdate) values ($no,'$avatar_id','$name','$memo','$faceicon',".time().")";
	//echo $sqlstr;
	$result  = mysql_query($sqlstr);
}else if($query == "delete"){
	$sqlstr = "delete from ".$WIZTABLE["AVATARCOMMENT"]." where no = '$cno'";
	mysql_query($sqlstr);
}
	
	


$whereis = "where no = $no";
$sqlstr = "select no, user_id, cdate,score, contest_memo from ".$WIZTABLE["AVATARALBUM"]." $whereis order by score desc";
//echo $sqlstr;
$sqlqry = mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());
$avatar->mode = "photo";
$list=@mysql_fetch_array($sqlqry);
$contest_view = $avatar->show_avatar($list[no]);
$no = $list["no"];
$user_id = $list["user_id"];
$name = $avatar->get_MemInfo($user_id, "name");
$cdate = $list["cdate"];
$score = $list["score"];
$contest_memo = $list["contest_memo"];
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>상세보기</title>
<meta http-equiv="Content-Type" content="text/html; charset=<?=$cfg["common"]["lan"]?>">
<link rel="stylesheet" type="text/css" href="http://xman.co.kr/css/css.css">
<script language="javascript">
<!--
function checkScore(){
	var f=document.estimForm;
	var tmp;
	for(i=0; i<f.score.length; i++){ if(f.score[i].checked) tmp = "truevalue";}
	if(tmp != "truevalue"){ 
		alert('점수를 선택하세요'); 
		return false;
	}
}

function checkForm(){
	var f = document.WriteForm;
	if(f.memo.value == ""){
		alert('내용을 입력하세요');
		f.memo.focus();
		return false;
	}
}

function del_confirm(no){
	location.href="<?=$PHP_SELF;?>?query=delete&no=<?=$no;?>&cno="+no

}
//-->
</script>
</head>

<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<table width="550" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td><img src="img/co_img19.gif" width="550" height="136"></td>
  </tr>
  <tr> 
    <td><table width="550" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td width="53" background="img/co_img20.gif">&nbsp;</td>
          <td width="140" align="center"><?=$contest_view?></td>
          <td width="41" background="img/co_img21.gif">&nbsp;</td>
          <td width="276"><? echo nl2br($contest_memo); ?></td>
          <td width="40" background="img/co_img22.gif">&nbsp;</td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td><img src="img/co_img23.gif" width="550" height="14"></td>
  </tr>
  <tr> 
    <td height="80" background="img/co_img24.gif"><table width="550" border="0" cellspacing="0" cellpadding="0">
	<form name="estimForm" method="post" action="<?=$PHP_SELF;?>" onSubmit="return checkScore();">
	<input type="hidden" name="query" value="insert_score">
	<input type="hidden" name="no" value="<?=$no;?>">
        <tr>
          <td width="53">&nbsp;</td>
          <td width="140" align="center">
<table border="0" cellpadding="2" cellspacing="0">
              <tr> 
                <td align="center"><strong><font color="#000000"><?=$name?> (<?=$user_id?>)</font></strong></td>
              </tr>
              <tr> 
                <td align="center">점수 : <?=number_format($score)?>점</td>
              </tr>
              <tr> 
                <td align="center">등록일 : <?=date("Y-m-d", $cdate)?></td>
              </tr>
            </table>
          </td>
          <td width="23">&nbsp;</td>
          <td width="179"><table border="0" cellspacing="0" cellpadding="2">
              <tr>
                <td><input type="radio" name="score" value="1"></td>
                <td><img src="img/star1.gif" width="13" height="12"></td>
                <td><input type="radio" name="score" value="2"></td>
                <td><img src="img/star2.gif" width="25" height="12"></td>
                <td><input type="radio" name="score" value="3"></td>
                <td><img src="img/star3.gif" width="39" height="12"></td>
              </tr>
            </table>
            <table border="0" cellspacing="0" cellpadding="2">
              <tr>
                <td width="20"><input type="radio" name="score" value="4"></td>
                <td width="51"><img src="img/star4.gif" width="51" height="12"></td>
                <td width="20"><input type="radio" name="score" value="5"></td>
                <td width="64"><img src="img/star5.gif" width="64" height="12"></td>
              </tr>
            </table></td>
          <td width="129" align="center"><? if($avatar_id == ""){ ?><img src="img/co_img25.gif" alt="점수주기" width="116" height="32" border="0" onClick="alert('로그인후 이용해 주세요');" style="cursor:pointer"><? }else{ ?><input type="image" src="img/co_img25.gif" alt="점수주기" width="116" height="32" border="0"><? } ?></td>
          <td width="26">&nbsp;</td>
        </tr></form>
      </table></td>
  </tr>
  <tr> 
    <td background="img/co_img27.gif">
      <P style="MARGIN-TOP: 7px"> 
	  <table border="0" align="center" cellpadding="2" cellspacing="0">
<form method="post" name="WriteForm" action="<?=$PHP_SELF;?>" onSubmit="return checkForm()">
			<input type="hidden" name="no" value="<?=$no;?>">
			<input type="hidden" name="query" value="insert">
        <tr>
          <td><input name="memo" type="text" size="67"></td>
          <td><? if($avatar_id == ""){ ?><img src="img/co_img26.gif" alt="입력" width="46" height="19" border="0" onClick="alert('로그인후 이용해 주세요');" style="cursor:pointer"><? }else{ ?>
            <input type="image" src="img/co_img26.gif" alt="입력" width="46" height="19" border="0"><? } ?></td>
        </tr></form>
      </table>
      <P style="MARGIN-TOP: 7px"> 
      <table width="502" border="0" align="center" cellpadding="3" cellspacing="0">
        <tr bgcolor="e0e0e0">
          <td height="1" colspan="2"></td>
        </tr>
        <tr bgcolor="f2f2f2"> 
          <td width="170" align="center"><font color="646464">작성자</font></td>
          <td width="332" align="center"><font color="646464">한마디 내용</font></td>
        </tr>
      </table>
      <table width="502" border="0" align="center" cellpadding="3" cellspacing="0">
<? 

/* 총 갯수 구하기 */
$ListNo = 10;
$PageNo = 10;

$WHERE = " where ano = '$no'";
$sqlstr = "SELECT count(no) FROM ".$WIZTABLE["AVATARCOMMENT"]." $WHERE";
$sqlqry = mysql_query($sqlstr);
$TOTAL = mysql_result($sqlqry, 0, 0);

if(empty($CURRENT_PAGE) || $CURRENT_PAGE <= 0) $CURRENT_PAGE = 1;

//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CURRENT_PAGE / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */
//--페이지링크를 작성하기--


$START_NO = ($CURRENT_PAGE - 1) * $ListNo;
$BOARD_NO1=$TOTAL-($ListNo*($CURRENT_PAGE-1));
$orderby = "order by wdate desc ";
$SELECT_STR="SELECT * from ".$WIZTABLE["AVATARCOMMENT"]." $WHERE $orderby LIMIT $START_NO, $ListNo";
//echo $SELECT_STR;
$SELECT_QRY=mysql_query($SELECT_STR);
while($list=@mysql_fetch_array($SELECT_QRY)):
?> 	  
        <tr> 
          <td width="29" height="26"><? if($list["faceicon"]):?><img src="../../../wizavatar/avatarimg/face_img/<?=$list["faceicon"]?>" width="26" height="26"><? endif; ?></td>
          <td width="65"><?=$list["name"]?></td>
          <td width="390" style="word-break:break-all;"><?=$common->strCutting($list["memo"], 200);?>  <? if($list["user_id"] == $avatar_id){?><img src="img/delate.gif" alt="삭제" width="9" height="9" border="0" onClick="del_confirm(<?=$list["no"]?>)"; style="cursor:pointer"><? } ?></td>
        </tr>
        <tr bgcolor="e0e0e0"> 
          <td height="1" colspan="3"></td>
        </tr>
<?
$BOARD_NO1--;
endwhile;
?>		

      </table><table width="502" border="0" align="center" cellpadding="3" cellspacing="0">
        <tr> 
          <td align="center"><?
$BOTTOM_SKIN_TYPE = "xman_type1";
$TransData = "no=$no";
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo " <a href='$PHP_SELF?CURRENT_PAGE=$PREV_PAGE&$TransData' class='over' onFocus='this.blur()'><img src='./images/pre.gif' border='0'></a> ";
} else {
echo " <img src='./images/pre.gif' border='0'> ";
 }

# 한페이지 이전
if ( $CURRENT_PAGE > 1 ) {
$PREV_PAGE = $CURRENT_PAGE - 1;
//echo " <a href='$PHP_SELF?CURRENT_PAGE=$PREV_PAGE&$TransData' class='over' onFocus='this.blur()'><img src='./images/pre1.gif' border='0'></a> ";
} else {
//echo " <img src='./images/pre1.gif' border='0'> ";
 }

/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CURRENT_PAGE == $i){$NUMBER_SHAPE= "<font color='#FF6600'>${i}</font>";}
else $NUMBER_SHAPE=${i};
ECHO" <A HREF='$PHP_SELF?CURRENT_PAGE=$i&$TransData'>$NUMBER_SHAPE</a> ";
}
# 한페이지 다음
if ($CURRENT_PAGE < $TP) {
$NEXT_PAGE = $CURRENT_PAGE + 1;
//ECHO " <a href='$PHP_SELF?CURRENT_PAGE=$NEXT_PAGE&$TransData' class='over' onFocus='this.blur()'><img src='./images/next1.gif' border='0'></a> ";
} else {
//ECHO" <img src='./images/next1.gif' border='0' >";
}

/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO " <a href='$PHP_SELF?CURRENT_PAGE=$NEXT_PAGE&$TransData' class='over' onFocus='this.blur()'><img src='./images/next.gif' border='0'></a> ";
} else {
ECHO" <img src='./images/next.gif' border='0'> ";
}
?></td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td><img src="img/co_img28.gif" width="550" height="25"></td>
  </tr>
</table>
</body>
</html>
