<?
$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;
$avatar->avatarpath = "./wizavatar/avatarimg/";
$avatar->mode = "photo";


$thisYear = $thisYear ? $thisYear : date("Y");
$thisMonth = $thisMonth ? $thisMonth : date("m");

$thisdate = mktime(0,0,1,$thisMonth, 1, $thisYear);
$sqlstr = "select attached from ".$WIZTABLE["AVATARCONTESTTERM"]." where $thisdate between sdate and edate";
$sqlqry = mysql_query($sqlstr);
$list = mysql_fetch_array($sqlqry);
$attachedimg = split("\|", $list["attached"]);
?>
<script language="javascript">
<!--
	function openContestWindow(no){
		window.open('<?=$avatar_skin_path?>/avatar_contest_detail.php?no='+no,'ContestWindow','width=570, height=639, scrollbars=1');
	}
	
	function gotoContest(){
		var f = document.ContestForm;
		f.submit();
	}	
//-->
</script>
<table width="686" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="33"><img src="image/xgame/sub_title2.gif" width="105" height="18"></td>
    <td><div align="right"><img src="common/home.gif" width="14" height="9">홈 
        &gt; XMAN 놀이터 &gt; 아바타 세상<font color="ff8233"> &gt; 콘테스트</font></div></td>
  </tr>
</table>
<table width="686" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td width="120" height="2" bgcolor="cc53c2"></td>
    <td width="566" bgcolor="e4dfca"></td>
  </tr>
</table>
<P style="MARGIN-TOP: 20px">
  <? 
			  include $avatar_skin_path."/xman_inc2.php";
			  ?>
<P style="MARGIN-TOP: 20px">
  <? 
			  include $avatar_skin_path."/xman_inc3.php";
			  ?>
<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="3" cellspacing="0">
  <tr>
    <td height="30"><img src="image/xgame/avatar_skin/img09.gif" width="113" height="16"></td>
    <td width="78"><img src="image/xgame/avatar_skin/button1.gif" alt="참여하기" width="75" height="20" border="0"  onClick="AvatarSaveConfirm()" style="cursor:pointer"> </td>
    <td width="75"><div align="right"><a href="<?=$PHP_SELF;?>?skinmode=contestmain" onFocus="this.blur()"><img src="image/xgame/avatar_skin/button2.gif" alt="아바타짱" width="75" height="20" border="0"></a> </div></td>
  </tr>
</table>
<table width="656" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="30" colspan="3"><img src="image/xgame/avatar_skin/img10.gif" width="95" height="13"></td>
  </tr>
  <tr>
    <td colspan="3"><img src="image/xgame/avatar_skin/img11.gif" width="656" height="3"></td>
  </tr>
  <tr>
    <td width="3"><img src="image/xgame/avatar_skin/img13.gif" width="3" height="69"></td>
    <td width="650"><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr>
          <td width="287"><img src="./wizavatar/avatarimg/etc_img/<?=$attachedimg[0]?>" width="287" height="69"></td>
          <td><div align="center"><img src="image/xgame/avatar_skin/img17.gif" width="327" height="53"></div></td>
        </tr>
      </table></td>
    <td width="3"><img src="image/xgame/avatar_skin/img14.gif" width="3" height="69"></td>
  </tr>
  <tr>
    <td colspan="3"><img src="image/xgame/avatar_skin/img12.gif" width="656" height="3"></td>
  </tr>
</table>
<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="39" background="image/xgame/avatar_skin/img15.gif"><table border="0" align="right" cellpadding="3" cellspacing="0">
        	  <form name="ContestForm" action="<?=$PHP_SELF;?>" method="post">
	  <input type="hidden" name="skinmode" value="<?=$skinmode;?>"><tr>
          <td><select name="thisYear">
<?
for($i=2007; $i<=date("Y"); $i++){
	$selected = $thisYear == $i ? "selected":"";
	echo "<option value='$i' $selected>".$i."년</option>";
}
?>		  
            
          </select></td>
          <td><select name="thisMonth">
<?
for($i=1; $i<=12; $i++){
	$j = sprintf("%02d", $i);
	$selected = $thisMonth == $j ? "selected":"";
	echo "<option value='$i' $selected>".$j."월</option>";
}
?>			
            </select></td>
          <td><img src="image/button/see2.gif" alt="보기" width="36" height="20" border="0" style="cursor:pointer" onclick="gotoContest();"></td>
          <td><strong>아이디</strong></td>
          <td><input name="textfield" type="text" class="input" size="20"></td>
          <td><a href="#" onFocus="this.blur()"><img src="image/button/find.gif" alt="검색" width="45" height="20" border="0"></a></td>
          <td width="5">&nbsp;</td>
        </tr></form>
      </table></td>
  </tr>
</table>
<table width="670" border="0" align="center" cellpadding="5" cellspacing="0">
  <tr>
<?
$ListNo=$pg_counts?$pg_counts:20;
$PageNo = 10;


$sdate = mktime(0,0,0,$thisMonth, 1, $thisYear);
$edate = mktime(0,0,-1,$thisMonth+1, 1, $thisYear);
$whereis = "where contest = 1 and cdate between $sdate and $edate ";

//$whereis = "where contest = 1";

/* 총 갯수 구하기 */

$TOTAL_STR = "select count(no) from ".$WIZTABLE["AVATARALBUM"]." $whereis ";
//echo "\$TOTAL_STR = $TOTAL_STR <br>";
$TOTAL_QRY = mysql_query($TOTAL_STR) or die(mysql_error()."<br>".$TOTAL_STR);
$TOTAL = @mysql_result($TOTAL_QRY, 0, 0);
mysql_free_result($TOTAL_QRY);

if(empty($CP) || $CP <= 0) $CP = 1;

//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CP / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */

$START_NO = ($CP - 1) * $ListNo;
$BOARD_NO1=$TOTAL-($ListNo*($CP-1));

### 신규등록된 아바타 가져오기

$sqlstr = "select no, user_id, cdate,score from ".$WIZTABLE["AVATARALBUM"]." $whereis order by cdate desc limit $START_NO, $ListNo";
$sqlqry = mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());

$cnt=0;
while($list=@mysql_fetch_array($sqlqry)):
	$contest_view = $avatar->show_avatar($list[no]);
	$no = $list["no"];
	$user_id = $list["user_id"];
	$name = $avatar->get_MemInfo($user_id, "name");
	$cdate = $list["cdate"];
	$score = $list["score"];
?>	  
    <td width="157" align="center" valign="top"><table width="140" border="0" align="center" cellpadding="3" cellspacing="1" bgcolor="dddddd">
        <tr>
          <td align="center" bgcolor="#FFFFFF"><?=$contest_view?></td>
        </tr>
      </table>
      <table width="140" border="0" align="center" cellpadding="3" cellspacing="0">
        <tr>
          <td align="center"><strong><font color="ff8233">
            <?=$user_id?>
          </font></strong></td>
        </tr>
        <tr>
          <td align="center"><img src="image/xgame/avatar_skin/button3.gif" alt="상세보기" width="58" height="20" border="0" onClick="openContestWindow(<?=$no?>);" style="cursor:pointer"></td>
        </tr>
    </table></td>
<?
	$cnt++;
	if(!($cnt%4)){
		echo "</tr>
</table>
<P style='MARGIN-TOP: 20px'>
<table width='670' border='0' align='center' cellpadding='5' cellspacing='0'>
<tr>";
	}//else echo "<td width='4'>&nbsp;</td>";

endwhile;
	$tmpcnt = $cnt%4;
	if($tmpcnt){
		for($i=$tmpcnt; $i<4; $i++){
			echo "<td width='157' align='center'>&nbsp;</td>";
		}
	}
?>	
  </tr>
</table>
<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="50" align="center"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$TransData = "skinmode=$skinmode&code=$code&c_gender=$c_gender&thisYear=$thisYear&thisMonth=$thisMonth";	
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo " <img src='image/button/pre.gif' width='6' height='5' border='0'></a> ";
} else {
echo " <img src='image/button/pre.gif' width='6' height='5' border='0'> ";
 }


/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CP == $i){$NUMBER_SHAPE= "<B>${i}</B>";}
else $NUMBER_SHAPE=${i};
ECHO" <A HREF='$PHP_SELF?CP=$i&$TransData'>$NUMBER_SHAPE</a> ";
}

/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO " <a href='$PHP_SELF?CP=$NEXT_PAGE&$TransData'><img src='image/button/next.gif' width='6' height='5' border='0'></a> ";
} else {
ECHO" <img src='image/button/next.gif' width='6' height='5' border='0'> ";
}
?></td>
  </tr>
</table>
