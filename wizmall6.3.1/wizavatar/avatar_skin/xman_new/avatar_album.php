<?
$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;
$avatar->avatarpath = "./wizavatar/avatarimg/";



if($guest_open == "N" && !$avatar_id) 
{
  echo "
    <script>
      top.location.href='./avatar_login.php?go_url=avatar_album.php';
    </script>
   ";
  exit;
} 


//if($a_header) { include $a_header; }  // 헤더파일 인쿠르드

if($album_id)
{
  $data = mysql_num_rows(mysql_query("select no from ".$WIZTABLE["AVATARALBUM"]." where user_id = '$album_id' and contest = 0 and view = 0"));
  if(!$data) 
  {
    echo "<script>alert('앨범에 저장된 사진이 없습니다!   '); self.close(); history.go(-1);</script>";
    exit;
  }
  $photo_id = $album_id;
}
else $photo_id = $avatar_id;

$is_me = FALSE;

if(!$album_id)
{ 
  $is_me = TRUE;
  $name = $avatar->get_MemInfo($avatar_id, "name");
}
else $name = $avatar->get_MemInfo($album_id, "name");

$sqlstr = "select no from ".$WIZTABLE["AVATARALBUM"]." where (user_id = '$album_id' and no = parent)";
$sqlqry = mysql_query($sqlstr) or die(mysql_error()."<br>".$sqlstr);
$tmp1 = mysql_num_rows($sqlqry);  // 미니샷

$sqlstr = "select no from ".$WIZTABLE["AVATARALBUM"]." where (user_id = '$album_id' and parent = 0 and contest = 0 and view = 0)";
$sqlqry = mysql_query($sqlstr) or die(mysql_error()."<br>".$sqlstr);
$tmp2 = mysql_num_rows($sqlqry);  // 독사진

if(!$class)
{
  if($tmp2 == 0 and $tmp1 != 0) $class = "minishot";
  else $class = "photo";
}

if(!$page) $page=1;
?>
<SCRIPT LANGUAGE="JavaScript">
<!--

function confirm_del(no){
	if(confirm('등록된 컨테스트에서 삭제합니다.\n\n정말로 삭제하시겠습니까?')){
		location.href="./wizavatar/avatarProc.php?mode=albumdel&no="+no;
	}
}

function regToContest(no){
	wizwindow('<?=$avatar_skin_path?>/contestAttend.php?no='+no,'ContestWindow','width=550, height=455');

}
//-->
</script>
<!--<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onMouseUp="hidemenu();">-->
<?
  $avatar_view = $avatar->show_avatar($photo_id);
  $point = $avatar->check_point($avatar_id);
  $h_item = mysql_num_rows(mysql_query("select no from ".$WIZTABLE["AVATARMERCHANT"]." where user_id = '$avatar_id'"));


?>
<?

    $offset = $photo_list_count*($page-1);
?>
<table width="686" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="33"><img src="image/xgame/sub_title2.gif" width="105" height="18"></td>
    <td><div align="right"><img src="common/home.gif" width="14" height="9">홈 
        &gt; XMAN 놀이터 &gt; 아바타 세상<font color="ff8233"> &gt; 나의앨범</font></div></td>
  </tr>
</table>
<table width="686" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td width="120" height="2" bgcolor="cc53c2"></td>
    <td width="566" bgcolor="e4dfca"></td>
  </tr>
</table>
<P style="MARGIN-TOP: 20px">
<? 
			  include $avatar_skin_path."/xman_inc2.php";
			  ?>
<P style="MARGIN-TOP: 20px">
<? 
			  include $avatar_skin_path."/xman_inc3.php";
			  ?>
<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="3" cellspacing="0">
  <tr>
    <td height="30"><img src="image/xgame/avatar_skin/img23.gif" width="85" height="14"><strong> </strong><strong> </strong><strong> </strong></td>
    <td align="right"><a href="<?=$PHP_SELF;?>?skinmode=mycontest" onFocus="this.blur()"><img src="image/xgame/avatar_skin/button4.gif" alt="나의 콘테스트 리스트 보기" width="166" height="20" border="0"></a> </td>
  </tr>
</table>
<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="5" cellspacing="0">
  <tr>
<?

## 금번달 컨테스트 등록여부 확인
$thisYear = date("Y");
$thisMonth = date("m");
$start = mktime(0,0,0,$thisMonth,1,$thisYear);
$end = mktime(0,0,-1,$thisMonth+1,1,$thisYear);
$sqlstr = "select count(1) from ".$WIZTABLE["AVATARALBUM"]." where user_id = '$avatar_id' and cdate between $start and $end ";
$sqlqry = mysql_query($sqlstr);
$list = mysql_fetch_array($sqlqry);
$isreg = $list[0];


$ListNo=$pg_counts?$pg_counts:8;
$PageNo = 10;

$whereis = " where user_id = '$photo_id'";

/* 총 갯수 구하기 */

$TOTAL_STR = "select count(no) from ".$WIZTABLE["AVATARALBUM"]." $whereis ";
//echo "\$TOTAL_STR = $TOTAL_STR <br>";
$TOTAL_QRY = mysql_query($TOTAL_STR) or die(mysql_error()."<br>".$TOTAL_STR);
$TOTAL = @mysql_result($TOTAL_QRY, 0, 0);
mysql_free_result($TOTAL_QRY);

if(empty($CP) || $CP <= 0) $CP = 1;

//--페이지 나타내기--
/* 하단 페이지수 표시 for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) */
$TP = ceil($TOTAL / $ListNo) ; /* 총페이지수(Total Page) : 총게시물수 / 페이지당 리스트수  */
$CB = ceil($CP / $PageNo); /* 현재블록(Current Block) : 현재페이지 / 표시되는 페이지 수 */
$SP = ($CB - 1) * $PageNo + 1; /* 블록의 처음 페이지(Start Page) 구하기 */
$EP = ($CB * $PageNo); /*블록의 마지막 페이지(End Page) : 현재 블록 * 표시되는 페이지수 */
$TB = ceil($TP / $PageNo); /* 총블록수(Total Block) : 총페이지수 / 표시되는 페이지 수 */

$START_NO = ($CP - 1) * $ListNo;
$BOARD_NO1=$TOTAL-($ListNo*($CP-1));
$sqlstr = "select no,user_id,date,memo,cdate from ".$WIZTABLE["AVATARALBUM"]." $whereis order by date desc limit $START_NO, $ListNo";
$sqlqry = mysql_query($sqlstr) or die($sqlstr."<br>".mysql_error());


//echo "sqlstr = $sqlstr <br>";
$cnt=0;
while($list=@mysql_fetch_array($sqlqry)):
      $check++;
      $total_comment = mysql_num_rows(mysql_query("select no from ".$WIZTABLE["AVATARCOMMENT"]." where ano = '$list[no]'"));
      if($total_comment) $total_comment = "[".$total_comment."]";
      else $total_comment="";
      $memo= str_replace("\r\n","&nbsp;",$list[memo]);
	  $avatar->mode = "photo";
	  $photo_view = $avatar->show_avatar($list[no]);
	  $cdate = $list["cdate"];
  $check++;
?>  
    <td width="157" align="center" valign="top"><table width="140" border="0" align="center" cellpadding="3" cellspacing="1" bgcolor="dddddd">
        <tr>
          <td bgcolor="#FFFFFF"><?=$photo_view?></td>
        </tr>
      </table>
      <table width="140" border="0" align="center" cellpadding="3" cellspacing="0">
        <tr>
          <td align="center"><? echo date("Y-m-d H:i:s",$list[date]);?><br>
            <?=$memo?>
              <span style="font-size:7pt;color:#990099;font-family:Tahoma;">
              <?=$total_comment?>
              </span></td>
        </tr>
        <tr>
          <td align="center"><? if($isreg){ ?><img src="image/button/b_contest.gif" alt="콘테스트 등록" width="77" height="14" border="0" onclick="javascript:alert('금번달에는 이미 콘테스트에 등록하셨습니다.')" style="cursor:pointer"><? }else if($cdate) { ?><img src="image/button/b_contest.gif" alt="콘테스트 등록" width="77" height="14" border="0" onclick="javascript:alert('이미 콘테스트에 등록한 앨범입니다.')" style="cursor:pointer"><? }else{ ?><img src="image/button/b_contest.gif" alt="콘테스트 등록" width="77" height="14" border="0" onclick="regToContest(<?=$list[no]?>)" style="cursor:pointer"><? } ?> <img src="image/button/my_img12.gif" alt="삭제" width="30" height="14" border="0" onClick="confirm_del(<?=$list[no]?>)" style="cursor:pointer"> </td>
        </tr>
      </table></td>
<?
	$cnt++;
	if(!($cnt%4)){
		echo "</tr>
</table>
<P style='MARGIN-TOP: 20px'>
<table width='670' border='0' align='center' cellpadding='5' cellspacing='0'>
<tr>";
	}//else echo "<td width='4'>&nbsp;</td>";

endwhile;
	$tmpcnt = $cnt%4;
	if($tmpcnt){
		for($i=$tmpcnt; $i<4; $i++){
			echo "<td width='159' align='center' valign='top'></td>";
		}
	}
?>	
  </tr>
</table>

<P style="MARGIN-TOP: 20px">
<table width="670" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="50" align="center"><?
/* 페이지 번호 리스트 부분 */
/* PREVIOUS or First 부분 */
$TransData = "skinmode=$skinmode&code=$code&c_gender=$c_gender";	
if ( $CB > 1 ) {
$PREV_PAGE = $SP - 1;
echo " <a href='$PHP_SELF?CP=$PREV_PAGE&$TransData'><img src='image/button/pre.gif' width='6' height='5' border='0'></a> ";
} else {
echo " <img src='image/button/pre.gif' width='6' height='5' border='0'> ";
 }


/* LISTING NUMBER PART */
for ($i = $SP; $i <= $EP && $i <= $TP ; $i++) {
if($CP == $i){$NUMBER_SHAPE= "<B>${i}</B>";}
else $NUMBER_SHAPE=${i};
ECHO" <A HREF='$PHP_SELF?CP=$i&$TransData'>$NUMBER_SHAPE</a> ";
}

/* NEXT or END PART */
if ($CB < $TB) {
$NEXT_PAGE = $EP + 1;
ECHO " <a href='$PHP_SELF?CP=$NEXT_PAGE&$TransData'><img src='image/button/next.gif' width='6' height='5' border='0'></a> ";
} else {
ECHO" <img src='image/button/next.gif' width='6' height='5' border='0'> ";
}
?></td>
  </tr>
</table>
