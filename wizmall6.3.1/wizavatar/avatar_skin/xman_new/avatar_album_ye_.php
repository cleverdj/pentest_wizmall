<?
include_once "../../../config/db_info.php";

include_once "../../../config/avatar_config.php"; 
include_once "../../lib/class.avatar.php";
$avatar = new avatar();
$avatar->get_object($dbcon, $common);
$avatar->WIZTABLE = $WIZTABLE;

$sqlstr = "select guest, max_photo_num from ".$WIZTABLE["AVATARALBUMADMIN"];
$sqlqry = mysql_query($sqlstr) or die(mysql_error()."<br>".$sqlstr);
$list = mysql_fetch_array($sqlqry);
$guest_open = $list[guest];
$max_photo_num = $list[max_photo_num];

$res = time();
$today = date('Y년m월d일 H:i:s', $res);
$reg_date = date('Y년m월d일 H:i:s', $date);

if($guest_open == "N" && !$avatar_id) 
{
  echo "<script>alert('잘못된 페이지입니다'); parent.window.close(); history.go(-1); </script>"; 
  exit;
}

if($winmode == 'save')
{
  $tmp_num = mysql_num_rows(mysql_query("select no from ".$WIZTABLE["AVATARALBUM"]." where (user_id = '$avatar_id' and parent = 0 and contest = 0 and view = 0)"));
  if($max_photo_num <= $tmp_num)
  {
    echo "<script>alert('앨범은 최대 $max_photo_num 개 까지만 저장이 가능합니다!   '); self.window.close();</script>";
    exit;
  }
}

if($winmode == 'info' || $winmode == 'modify') 
{ 
  $album = mysql_fetch_array(mysql_query("select user_id,date,memo from ".$WIZTABLE["AVATARALBUM"]." where no = '$no'")) or die(mysql_error());

  $date = $album[date];
  $memo = $album[memo];
  //$photo_name = add_member_info($album[user_id]);

  $html_title = $_SESSION["avatar_id"]."님의 아바타 사진";
} 
elseif($winmode == 'save') 
{
 // $photo_name = add_member_info($avatar_id);
  $html_title = $_SESSION["avatar_id"]."님의 아바타";
}
?>
<html>
<head>
<title><?=$html_title?></title>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html;charset=<?=$cfg["common"]["lan"]?>">
<link rel="stylesheet" href="avatar.css" type="text/css">
<STYLE type="text/css">
BODY, TD{ font-family: "돋움";color: #333333; text-decoration: none; font-size: 10pt;}
.name { font-family: "돋움"; color: #AF7313; text-decoration: none; font-size: 10pt; font-weight: bold;line-height: 13pt; }
.date { font-family: "Tahoma", "돋움"; color: black; text-decoration: none; font-size: 8pt; line-height: 13pt; }
.memo { font-family: "돋움"; color: black; text-decoration: none; font-size: 9pt; line-height: 13pt; }
.textbox { background-color: #FFFFFF; border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; color: black; font-size: 9pt; }
</STYLE>
<?
if($winmode == 'save' or $winmode == 'modify') 
{
?>
<script>
function check(form) 
{
  if(!document.avatarsave.avatarmemo.value) 
  {
    alert('아바타에 대한 간단한 메세지를 적어주세요!');
    document.avatarsave.avatarmemo.focus();
    return false;
  }
  return true;
}
</script>
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<?
  if($mode == 'mod') 
  { 
    $top_title = "★ 독사진 메세지 수정하기";
    if($class == 'minishot') 
    {
      $top_title = "★ 미니샷 메세지 수정하기";
      $input_hidden_minishot = "<input type='hidden' name='class' value='minishot'>";
    }
    $reg_date = date("Y-m-d H:i:s",$date);
    if($class == "minishot") $photo_view = $pre.$photo;
    else $photo_view = show_photo($no);
  } 
  else 
  {
    $top_title = "★ 아바타 앨범에 저장하기";
    echo("<input type='hidden' name='mode' value='new'><input type='hidden' name='winmode' value='ok'><input type='hidden' name='reg_time' value='$res'>");
    $reg_date = $today;
  }

  if($class != "minishot") 
  {
    if($winmode == "save")
    {
		$avatar->avatarpath = "../../avatarimg/";
      $photo_view = $avatar->show_avatar($avatar_id);
    }
    else
    {
      $photo_view = show_photo($no);
    }
  }
  else 
  {
    $tmp_photo = show_minishot($no);
    $photo_view = $tmp_photo[0];
    $photo_name = $tmp_photo[1];
  }
    $a_photo_save = "<a href=\"javascript:document.avatarsave.submit();\" onClick=\"return check(avatarsave);\" onMouseOver=\"window.status=('저장하기'); return true;\">";


?>  
<table width="100%" cellpadding="0" cellspacing="0" border="0" align="center">
  <tr>
    <td><table width="100%" border="0" align="center" bgcolor="#EEEEEE">
        <tr>
          <td height="36"><b>
            <?=$top_title?>
            </b> </td>
        </tr>
      </table></td>
  </tr>
  <form method="post" name="avatarsave">
    <input type='hidden' name='mode' value='mod'>
    <input type='hidden' name='winmode' value='ok'>
    <input type='hidden' name='no' value='<?=$no?>'>
    <tr>
      <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
          <tr>
            <?=$input_hidden_minishot?>
            <td valign="middle"><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
                <tr>
                  <td height="40"></td>
                </tr>
                <tr>
                  <td align="center"><table border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <td bgcolor="white"><?=$photo_view?>
                        </td>
                      </tr>
                    </table></td>
                </tr>
                <tr>
                  <td align="center"><table border="0" cellspacing="0" cellpadding="0" valign="top" width="240">
                      <tr>
                        <td height="30"> ·&nbsp;<span class="memo">날 &nbsp;&nbsp;짜 :</span> </td>
                        <td>&nbsp;<span class="date">
                          <?=$reg_date?>
                          </span> </td>
                      </tr>
                      <tr>
                        <td height="25"> ·&nbsp;<span class="memo">메세지 : </span> </td>
                        <td>&nbsp;<span class="memo">
                          <input type="text" name="avatarmemo" size="30" class="textbox" maxlength="30" value="<?=$memo?>" style="width:180;">
                          </span> </td>
                      </tr>
                      <tr>
                        <td height="30" colspan="2">※ 사진의 간단한 메세지를 남기세요</td>
                      </tr>
                      <tr>
                        <td height="20"></td>
                      </tr>
                    </table></td>
                </tr>
              </table></td>
          </tr>
        </table></td>
    </tr>
    <tr>
      <td><table width="100%" border="0" align="center">
          <tr>
            <td height="30" align="center" valign="middle"><?=$a_photo_save?>
              <img src="./images/pop_save.gif" width="48" height="22" border="0" alt="저장"></a>&nbsp;&nbsp; <a href="javascript:window.close();"><img src="./images/pop_cancel.gif" width="48" height="22" border="0" alt="창 닫기"></a> </td>
          </tr>
        </table></td>
  </form>
  </tr>
  
</table>
<?

} 
elseif($winmode == 'info') 
{ 
  if($avatar_id) 
  {
    $face_data = mysql_fetch_array(mysql_query("select ava1, ava5 from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$avatar_id'")) or die(mysql_error());
    if($face_data[ava1] == "img_blank.gif") $s_face = "z_".$face_data[ava5];
    else $s_face = "z_".$face_data[ava1];
    $c_face_image = "<img src=\"./charimg/$s_face\" border=\"0\" align=\"absmiddle\">";
    $my_name=$c_face_image."&nbsp;".add_member_info($avatar_id); 
  }
  else
  {
    $c_face_image = "<img src=\"./charimg/blank_face.gif\" border=\"0\" align=\"absmiddle\">";
    $my_name=$c_face_image."&nbsp;"."<input type=text name=c_name size=8 maxlength=10 class=input>";
  }
?>
<SCRIPT LANGUAGE="JavaScript">  
function del_check() 
{
  var answer = confirm('정말 삭제하시겠습니까?');
  if (answer == true)
     return true;
  else
    return false;
}
function modify_check() 
{
  var answer = confirm('정말 수정하시겠습니까?');
  if (answer == true)
     return true;
  else
    return false;
}
</SCRIPT> 
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" <?if($c_mode=="c_modify"){?>onLoad="document.comment.comment.focus();"<?}?>>
<?
  if($mode == "me") $top_title = "★ 아바타 앨범 상세 정보";
  elseif($mode == "member") $top_title = "★ <strong>꼬리말 보기</strong>";
  $photo_name = "";

  if($class == "minishot") 
  {
    $tmp_photo = show_minishot($no);
    $photo_view = $tmp_photo[0];
    $photo_name = $tmp_photo[1];
  }
  else $photo_view = show_photo($no);

  if($mode == "member") 
  {
    $reg_date = date("Y-m-d",$date);
    if($class == "minishot") $reg_date = "[".$reg_date."]";

    include "./photo_comment_view.php";

    $c_sql = mysql_query("select no,user_id,name,memo,reg_date from ".$WIZTABLE["AVATARCOMMENT"]." where parent = $no order by no asc") or die(mysql_error());;
    while($c_album = mysql_fetch_array($c_sql)) 
    {
      $c_data = mysql_num_rows(mysql_query("select no from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$c_album[user_id]'")) or die(mysql_error());;
      if($c_data) 
      {        
        $c_face_data = mysql_fetch_array(mysql_query("select ava1, ava5 from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '$c_album[user_id]'")) or die(mysql_error());
        if($c_face_data[ava1] == "img_blank.gif") $c_s_face = "z_".$c_face_data[ava5];
        else $c_s_face = "z_".$c_face_data[ava1];
        $c_c_face_image = "<img src=\"./charimg/$s_face\" border=\"0\" align=\"absmiddle\">";
        $c_name=$c_c_face_image."&nbsp;".$c_album[name]; 
      }
      else
      {
        $c_c_face_image = "<img src=\"./charimg/blank_face.gif\" border=\"0\" align=\"absmiddle\">";
        $c_name=$c_c_face_image."&nbsp;".$c_album[name];
      }
      $c_photo_memo = nl2br($c_album[memo]);
      $c_date_mem = date("Y-m-d",$c_album[reg_date]);

      $show_comment_manage_begin = "<!--";
      $show_comment_manage_end = "-->";
      if($avatar_id == $c_album[user_id]|| $avatar_admin) 
      { 
        $c_modify = "<a onfocus=blur() href=\"./avatar_album_ye.php?winmode=info&mode=member&c_mode=c_modify&c_no=$c_album[no]&no=$no";
        if($class=="minishot") $c_modify .= "&class=minishot";
        $c_modify .= "\" onClick=\"return modify_check();\" title=\"수정하기\"><font color=#CC99FF>±</font></a>";

        $c_delete ="<a onfocus=blur() href=\"./avatar_album_ye.php?winmode=ok&mode=c_del&c_no=$c_album[no]&no=$no";
        if($class=="minishot") $c_delete .= "&class=minishot";
        $c_delete .= "\" onClick=\"return del_check();\" title=\"삭제하기\"><font color=red>×</font></a>";

        $show_comment_manage_begin = "";
        $show_comment_manage_end = "";
      }
      include "./photo_comment_view_comment.php";
    }
    if($c_mode == "c_modify")
    {
      $c_mod_data = mysql_fetch_array(mysql_query("select memo from ".$WIZTABLE["AVATARCOMMENT"]." where no = $c_no")) or die(mysql_error());;
      $c_memo = $c_mod_data[memo];

      $comment_mode = "c_modify";
      $submit_value = "꼬리말 수정";
    }
    else 
    {
      $comment_mode = "comment";
      $submit_value = "꼬리말";
    }
    if($class == 'minishot') $input_hidden_minishot = "<input type='hidden' name='class' value='minishot'>";

    include "./photo_comment_view_foot.php";
  }elseif($mode == "me"){
    $reg_date = date("Y-m-d H:i:s",$date);
    if($class == "minishot") $reg_date = "[".$reg_date."]";

    $a_photo_delete = "<a href=\"javascript:document.avatardel.submit();\" onClick=\"return del_check();\" onMouseOver=\"window.status=('삭제하기'); return true;\">";
    $a_photo_modify = "<a onfocus=blur() href=\"./avatar_album_ye.php?winmode=modify&no=$no&mode=mod";
    if($class == 'minishot')
    {
      $input_hidden_minishot = "<input type='hidden' name='class' value='minishot'>";
      $a_photo_modify .= "&class=minishot";
    }
    $a_photo_modify .= "\" onMouseOver=\"window.status=('수정하기'); return true;\">";

    include "./photo_detail_info.php";
  }
}elseif($winmode == 'ok'){ 
	if($mode == "mod"){
		if($class != "minishot"){
			mysql_query("update ".$WIZTABLE["AVATARALBUM"]." set memo = '$avatarmemo' where no = $no") or die(mysql_error());
		}else{
			mysql_query("update ".$WIZTABLE["AVATARALBUM"]." set memo = '$avatarmemo' where parent = $no") or die(mysql_error());
		}
		echo "<script>self.window.close(); opener.window.location.reload();</script>";
	}else if($mode == "del"){
		if($class != "minishot"){
			mysql_query("delete from ".$WIZTABLE["AVATARALBUM"]." where no = $no") or die(mysql_error()); 
			mysql_query("delete from ".$WIZTABLE["AVATARCOMMENT"]." where parent = $no") or die(mysql_error());
		}else{
			mysql_query("delete from ".$WIZTABLE["AVATARALBUM"]." where parent = $no") or die(mysql_error()); 
			mysql_query("delete from ".$WIZTABLE["AVATARCOMMENT"]." where parent = $no") or die(mysql_error());
		}
		echo "<script>self.window.close(); opener.window.location.reload();</script>";
	}elseif($mode == "new"){
		if($avatar_id){
			$photonum = $avatar->getphotono($user_id);
			if($max_photo_num <= $photonum){
				echo "<script>alert('앨범은 최대 $max_photo_num 개 까지만 저장이 가능합니다!   '); self.window.close();</script>";
				exit;
			}
			$avatar->insertalbum($avatar_id, $avatarmemo);
			echo "<script>self.window.close(); opener.window.location.reload();</script>";
		}else{
			echo "<script>alert('저장이 되질 않았습니다!   '); parent.window.close(); opener.window.location.reload();</script>";
		}
}else if($mode == "comment") 
	{
    $reg_time = time();
    $name = add_member_info($avatar_id);

    @mysql_query("insert into ".$WIZTABLE["AVATARCOMMENT"]." (user_id, name, parent, memo, reg_date) values ('$avatar_id','$name', $no, '$comment', $reg_time)") or die(mysql_error()); 
    if($class == 'minishot') 
      echo "<script>opener.window.location.reload(); window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member&class=minishot';</script>";
    else
      echo "<script>opener.window.location.reload(); window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member';</script>";
  }else if($mode == "c_modify"){
      $reg_time = time();
       mysql_query("update ".$WIZTABLE["AVATARCOMMENT"]." set memo = '$comment', reg_date = $reg_time where no = $c_no") or die(mysql_error()); 
      if($class == 'minishot') 
        echo "<script>window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member&class=minishot';</script>";
      else
        echo "<script>window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member';</script>";
  }else if($mode == "c_del"){
      mysql_query("delete from ".$WIZTABLE["AVATARCOMMENT"]." where no = $c_no") or die(mysql_error()); 
      if($class == 'minishot') 
        echo "<script>opener.window.location.reload(); window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member&class=minishot';</script>";
      else
        echo "<script>opener.window.location.reload(); window.location.href= 'avatar_album_ye.php?winmode=info&no=$no&mode=member';</script>";
  }else if($mode == "change"){
    $str = mysql_query("select * from ".$WIZTABLE["AVATARALBUM"]." where no = '$no'");
    $data = mysql_fetch_array($str);

    $item = mysql_query("select b.file1 as file1 from ".$WIZTABLE["AVATARMERCHANT"]." a, ".$WIZTABLE["AVATARITEM"]." b where a.user_id = '$avatar_id' and a.item_no = b.no" );
    while($idata=mysql_fetch_array($item)) 
    {
       $jdata .= $idata[file1]."|";
    }
    $kdata = explode("|", $jdata);
    $i = 1;
    while($i < 10) 
    {
      for($z = 0; $z < count($kdata); $z++)
      {
        $ava = "ava".$i;
        if(trim($data[$ava]) == 'img_blank.gif') { $err = "false"; break; }
        else 
        {
          if(trim($data[$ava]) == trim($kdata[$z])) { $err = "false"; break;}
          else $err = "true";
        }
      }
      $i++;
    }
    if($err == "true") 
    {
      echo "<script>alert('이 사진에 있는 아이템을 가지고 있지 않습니다!   '); history.go(-1);</script>";
    } 
    else 
    { 
       mysql_query("update ".$WIZTABLE["AVATARMEMCONFIG"]." set ava1 = '$data[ava1]', ava2 = '$data[ava2]', ava3 = '$data[ava3]', ava4 = '$data[ava4]', ava5 = '$data[ava5]', ava6 = '$data[ava6]', ava7 = '$data[ava7]', ava8 = '$data[ava8]', ava9 = '$data[ava9]' where user_id = '$avatar_id'") or die(mysql_error()); 
        echo "<script>window.location.href= 'avatar_album.php'</script>";
    }
  }else if($mode == "contest"){
    include "./_head.php";
    include "./contest_config.php";  // 아바타 컨테스트 설정 파일 인쿠르드

    global $member, $HTTP_SESSION_VARS;

    $contest_count = con_round();
    $jdata = p_join($member[user_id]);
    $score = p_score($no);
    if(!$score) $score = 0;
    $grade = p_grade($contest_count,$member[user_id],$score);

      if($contest_board_name && !$jdata) {                           // 컨테스트 참가 여부 판단 시작
        $t_category = "zetyx_board_category";
        $t_board = "zetyx_board";
        $id = $contest_board_name;
        $score = "0|".$contest_count;
        $reg_date=time();

        $data = mysql_fetch_array(mysql_query("select user_id, date, memo, ava1, ava2, ava3, ava4, ava5, ava6, ava7, ava8, ava9, contest from ".$WIZTABLE["AVATARALBUM"]." where no = '$no'"));

         mysql_query("insert into ".$WIZTABLE["AVATARALBUM"]." (user_id, date, memo, ava1, ava2, ava3, ava4, ava5, ava6, ava7, ava8, ava9, contest, score) values ('$member[user_id]',$reg_date,'$data[memo]','$data[ava1]','$data[ava2]','$data[ava3]','$data[ava4]','$data[ava5]','$data[ava6]','$data[ava7]','$data[ava8]','$data[ava9]', 1, '$score')") or die(mysql_error()); 
         $y = mysql_insert_id();

      // 컨테스트 게시판형을 위한 코드
         $con_data = mysql_fetch_array(mysql_query("select no from $t_category"."_$id where no = '$contest_count'",$connect));
         $con_cat = $con_data[no];
         if(!$con_cat) {                              // 새로운 컨테스트 시작
            if(!$contest_subject) $contest_subject = "컨테스트";   // 컨테스트 주제가 없을 때 Defalut 설정
            mysql_query("insert into $t_category"."_$id (name) values ('$contest_subject')") or die(mysql_error());
          }
         $category = $contest_count;
         $ip=$REMOTE_ADDR;                  // 아이피값 구함;;

         // 헤드넘+1 한값을 가짐
         $max_headnum=mysql_fetch_array(mysql_query("select min(headnum) from $t_board"."_$id where headnum>-2000000000")); 
         $headnum=$max_headnum[0]-1; 

         // 다음글을 구함
         $next_data=mysql_fetch_array(mysql_query("select no,headnum,division from $t_board"."_$id where headnum='$max_headnum[0]' and arrangenum='0'"));
         if(!$next_data[0]) $next_data[0]="0";
         $next_no=$next_data[0];
         $password = $member[password];
         $name = $member[name];
         $con_day = explode("|", con_day());

         mysql_query("insert into $t_board"."_$id (headnum,next_no,ismember,memo,ip,password,name,homepage,email,subject,category,sitelink1,sitelink2,x,y,reg_date,islevel) values ('$headnum','$next_no','$member[no]','$data[memo]','$ip','$member[password]','$member[name]','$member[homepage]','$member[email]','contest','$category','$con_day[0]','$con_day[1]','11','$y','$reg_date','$member[is_admin]')") or die(mysql_error());

         mysql_query("update $t_category"."_$id set num=num+1 where no='$category'",$connect);

        echo "<script>alert('컨테스트 참가 신청을 성공적으로 하셨습니다!   '); opener.window.location.reload(); self.window.close();</script>";
    } else {
       if($jdata) {
         echo "<script>alert(\"현재 컨테스트 참가 중입니다!  현재 ".$score."점으로 ".$grade."위입니다!  \"); self.close(); history.go(-1);</script>";
       } else if(!$contest_board_name) {
         echo "<script>alert(\"컨테스트 설정 파일이 잘못되었습니다!  \n확인해주세요!  \"); history.go(-1);</script>"; 
       }
    }     // 컨테스트 참가 여부 판단 끝  
}
else {
  echo "<script>alert('잘못된 페이지입니다  '); self.window.close(); history.go(-1);</script>"; 
}
  } 
?>
