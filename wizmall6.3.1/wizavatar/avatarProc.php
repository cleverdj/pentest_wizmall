<?
include "./include/inc.depth1.php";
include ("../lib/class.xml.php");
$xml_c = new xmlcreate();


$mypoint = $avatar->check_point($cfg["member"]["mid"]);//현재 포인트 책크
$total_item_point = 0;
$mode = trim($mode);
if ($mode == "avatartest"){
	$avatar->sessionproc("plus","50", $src);
}else if($mode == "avatarTmpSave"){
	//if($flag == "minus") $avatar->deletefrommyon($layer, $avatar_id);//장착한 옷에서 삭제
	$avatar->sessionproc($flag, $layer, $src);
}else if($mode == "avatarSave"){
	$avatar->saveavatar($avatar_id);	
}else if($mode == "avatarTmpReset"){
	//session_unregister(tmpItem);
}else if($mode == "inisession"){
	$avatar->iniSessionFile();
}else if($mode == "getbuyitem"){

}else if($mode == "buy"){
	$arr_item = split("\-",$buy_item); 
	$total_item_point = 0;

	//포인트 책크
	if($mypoint < $total_item_point) $common->js_alert("포인트가 부족합니다!");


	$sqlstr = "select gender from ".$WIZTABLE["AVATARMEMCONFIG"]." where user_id = '".$avatar_id."'";
	$c_gender = $dbcon->get_one($sqlstr);// 구매할 사람의 성별 체크
	
	foreach($arr_item as $key=>$value){
		if($value){
			$list = $avatar->getItemInfo($value);//아이템 정보 가져오기
			$layer = $list["layer"];
			// 잔액 체크
			$item_point = $list["buy_p"];

			if($mypoint < $item_point) $common->js_alert("포인트가 부족합니다!");
			
			if($list[jaego] <= 0 ) { $j_check = 1; }
			$total_item_point += $item_point;
			$b_date = time();
			
			$sqlstr = "insert into ".$WIZTABLE["AVATARMERCHANT"]." (user_id, item_no, b_date) values ('".$avatar_id."','$value','$b_date')";
			$dbcon->_query($sqlstr);
			
			$sqlstr = "update ".$WIZTABLE["AVATARITEM"]." set jaego=jaego-1 where no=$value";
			$dbcon->_query($sqlstr);
	
			// 바로 저장하기.
			if($ison == "1") {
				##현재 정보를 가져온다.
				$myavatar = array();
				$sqlstr = "select avatar from wizAvatarMemConfig where user_id = '".$avatar_id."'";
				$useravatar = $dbcon->get_one($sqlstr);
				$myavatar = explode(",", $useravatar);
				$myavatar[$layer] = $value;
				$value = implode(",",$myavatar);
				
				$sqlstr = "update ".$WIZTABLE["AVATARMEMCONFIG"]." set avatar = '$value' where user_id = '".$avatar_id."'";
				$dbcon->_query($sqlstr);
				
				$avatar->iniSessionFile();

			}//if($ison == "1") {
		}//if($value){
	}//foreach($arr_item as $key=>$value){


	$mypoint = -$total_item_point;
	$avatar->point = $mypoint;
	//$avatar->user_id = $avatar_id;
	$avatar->content = "아바타 구매";
	$avatar -> PointInsert();	
	//exit;
	//session_unregister(tmpItem);
	//$avatar->deleteAllSessionFile($cfg["member"]["mid"]);
	$common->js_windowclose("구매 하였습니다","reload");
}else if($mode == "sale"){
###############################################################################################################################
########################## 아이템 팔기
###############################################################################################################################

	$c_gender = $avatar->getEachField($WIZTABLE["AVATARMEMCONFIG"], "gender", "where user_id = '".$avatar_id."'");
	$list = $avatar->getMyItemInfo($my_item_no);
	if($list["p_date"]){
		$common->js_windowclose("선물받은건 팔 수 없습니다.","reload");
	}else if(!$list[0]){
		$common->js_windowclose("아이템이 존재하지 않습니다.","reload");
	}else{
	//deletefrommyon($item_no,$user_id)
		$avatar->deletefrommyon($layer, $avatar_id);//장착한 옷에서 삭제
		$avatar->deletefromwardrobe($my_item_no, $avatar_id);//내옷장에서 삭제
		$avatar->sessionproc("minus", $layer,$src);
		$list = $avatar->getItemInfo($item_no); //아이템 기본 정보 가져오기
		$avatar->plusstock($item_no);//제고에서 플러스 하기
		//포인트 적립해주기
		$point = $list["sale_p"];
		$avatar->point = $point;
		//$avatar->user_id = $avatar_id;
		$avatar->content = "아바타 판매";
		$avatar -> PointInsert();			
		$common->js_windowclose("판매 하였습니다","reload");
		//echo "<script>alert('아이템을 판매하였습니다.');opener.take_off('".$list["filename2"]."','".$list["layer"]."','$c_gender','$item_no');opener.window.location.reload();self.close();< /script>";
		//exit;			
	}
}else if($mode == "present"){
#####################################################################################################################################################
########################## 아이템 선물하기
#####################################################################################################################################################
	$user_id = $keyword;
	//받는 사람 id를 한번더 책크
	if(!($avatar->is_member($user_id))) $common->js_windowclose("받을분이 존재하지 않습니다.","reload");

    // 잔액 체크
	if($mypoint < $buy_p) $common->js_alert("포인트가 부족합니다!");


    // 아이템 소유 여부 체크
	$result = $avatar->have_item($user_id, $item_no);
	if($result) $common->js_alert($user_id."님은 아이템을 이미 가지고 있습니다!");

	//선물받을 분의 성별 체크
	//echo "user_id = $user_id <br>";
	$c_gender = $avatar->getEachField($WIZTABLE["AVATARMEMCONFIG"], "gender", "where user_id = '$user_id'");//getEachField($tablename, $fieldname, $where)


	if($c_gender == ""){
		$common->js_windowclose("받을 분의 아바타가 \\n\\n 등록되지 않았습니다.","reload");
	}else if($c_gender == $avatargender || $avatargender == "0"){   // 아이템의 성별과 선물 받을 사람의 성별이 같거나 남여공용 아이템이면	
		if(!$my_item_no){ //아바타샵에서 구매한 경우
			$avatar->inputwardrobe($user_id,$item_no,$avatar_id,"shop");//inputwardrobe($user_id,$item_no,$p_user_id=null,$p_date=null)	
			$avatar->minusstock($item_no);//제고에서 마이너스 하기
			$point = -$buy_p;
			$avatar->point = $point;
			//$avatar->user_id = $avatar_id;
			$avatar->content = "아바타 선물";
			$avatar -> PointInsert();	
			$common->js_windowclose("선물 하였습니다.");
		
		}else{//내옷장에서 선물을 줄 경우 내 선물을 뺀다.
			$avatar->inputwardrobe($user_id,$item_no,$avatar_id,"wardrobe");//inputwardrobe($user_id,$item_no,$p_user_id=null,$p_date=null)	
			$avatar->deletefrommyon($layer, $avatar_id);//장착한 옷에서 삭제
			$avatar->deletefromwardrobe($my_item_no, $avatar_id);//내옷장에서 삭제
			$avatar->sessionproc("minus", $layer,$src);
			echo "<script>alert('선물 하였습니다.');opener.take_off('".$list["filename2"]."','".$list["layer"]."','$c_gender','$item_no');opener.window.location.reload();self.close();</script>";
			exit;			
		}
    }else{
		$common->js_windowclose("선물 받을 분이 현재 아바타상품과\\n\\n 성별이 같지 않습니다.","reload");
    }	

}else if($mode == "del") {
#####################################################################################################################################################
########################## 아이템 삭제하기//{mode:"del",my_item_no:my_item_no,layer:layer}
#####################################################################################################################################################
	$avatar->deletefrommyon($layer, $avatar_id);//장착한 옷에서 삭제
	$avatar->deletefromwardrobe($my_item_no, $avatar_id);//내옷장에서 삭제
	//$item = array("result"=> $avatar->result,	"layer"=> $avatar->my_layer, "gender"=> $avatar->my_gender, "item_no"=> $avatar->item_no);
	//$avatar->addItem($item);
	//$avatar->outputXml();
	exit;
}else if($mode == "updatemyon"){
#####################################################################################################################################################
########################## 옷장에서 아이템 입기
#####################################################################################################################################################
//mode=updatemyon&a_src="+a_src + "&layer="+layer;
	//$avatar->getavatarImg($no);##	이미지 가져오기	$this->avatarimg[0] = $list["filename1"]; $this->avatarimg[1] = $list["filename2"];
	$avatar->InputMyItem($no, $avatar_id);//아이템 착용하기: db_update
	//session_unregister(tmpItem);
	$avatar_src = $avatar->getavatarImg($no, 1);
	echo "$avatar_src|$layer";
//	$item = array("flag"=> "1",	"src0"=>$avatar->avatarimg[0], "src1"=>$avatar->avatarimg[1], "src2"=>$avatar->avatarimg[2], "layer"=>$avatar->ItemLayer_no);//xml 출력
//	$avatar->addItem($item);
//	$avatar->outputXml();
}else if($mode == "InitialUpdate"){
#####################################################################################################################################################
########################## 현재 착용한 정보로 db 초기화 하기
#####################################################################################################################################################
	$avatar->InitialUpdate($fullsrc, $avatar_id);

}else if($mode=="changFace"){
	$_SESSION["avatar_face"]["layer"] = $face_layer;
	$_SESSION["avatar_face"]["name"] = $a_src;
}else if($mode=="zzim"){
	$result = $avatar->insertZzim($item_no, $avatar_id);
	if(!$result){
		$common->js_alert("이미 존재하는 아이템이거나\\n트랙픽으로 인해 저장되지 않았습니다");
	}else{
		$common->js_location("./avatar_skin/$avatar_skin/avatar_pop.php?mode=zzim");
	}
}else if($mode=="zzimdelete"){
	foreach($checkList as $key=>$value){
		$sqlstr = "delete from ".$WIZTABLE["AVATARZZIM"]." where user_id ='".$avatar_id."' and no = $key";
		$dbcon->_query($sqlstr);
	}
	$common->js_location("./avatar_skin/$avatar_skin/avatar_pop.php?mode=zzim");

}else if($mode == "insertAlbum"){
	if($avatar_id){
		$photonum = $avatar->getphotono($avatar_id);
		$max_photo_num =20;
		if($max_photo_num <= $photonum){
			$common->js_windowclose("앨범은 최대 $max_photo_num 개 까지만 저장이 가능합니다!");
		}
		$avatar->insertalbum($avatar_id, $avatarmemo);
		$common->js_windowclose(NULL,"../wizavatar.php?skinmode=album");
	}else{
		$common->js_windowclose("저장이 되질 않았습니다!","reload");
	}
}else if($mode == "getAvatarFace"){
	$facelist = $avatar->getFaceList($item_no,$layer);

	//print_r($facelist);
	$item = array("item_no"=> $item_no,	"layer"=>$layer, "facei1"=>$facelist["i"][1], "facea1"=>$facelist["a"][1], "facei2"=>$facelist["i"][2], "facea2"=>$facelist["a"][2], "facei3"=>$facelist["i"][3], "facea3"=>$facelist["a"][3], "facei4"=>$facelist["i"][4], "facea4"=>$facelist["a"][4], "facei5"=>$facelist["i"][5], "facea5"=>$facelist["a"][5]);//xml 출력
	//$avatar->addItem($item);
	//$avatar->outputXml();	
}else if($mode == "getAvatarFacebyimgname"){

	$item_no = $avatar->getItemidFromfilename($src_name);
	$facelist = $avatar->getFaceList($item_no,$layer);

		//echo "<br>$item_no,$layer<br>";
	//print_r($facelist);
	$item = array("item_no"=> $item_no,	"layer"=>$layer, "facei1"=>$facelist["i"][1], "facea1"=>$facelist["a"][1], "facei2"=>$facelist["i"][2], "facea2"=>$facelist["a"][2], "facei3"=>$facelist["i"][3], "facea3"=>$facelist["a"][3], "facei4"=>$facelist["i"][4], "facea4"=>$facelist["a"][4], "facei5"=>$facelist["i"][5], "facea5"=>$facelist["a"][5]);//xml 출력
//print_r($item);
	
	//$xml_c->addItem($item);
	//$xml_c->outputXml();	
	exit;
}else if($mode == "albumdel"){

	$sqlstr = "delete from ".$WIZTABLE["AVATARALBUM"]." where no='$no'";
	$dbcon->_query($sqlstr);
	$common->js_location("../wizavatar.php?skinmode=album");
}else if($mode == "contestdel"){
	//컨테스트 초기화
	$sqlstr = "update ".$WIZTABLE["AVATARALBUM"]." set contest='0', cdate='', score = 0, adminscore = '0', contest_memo='' where no = $no";
	$dbcon->_query($sqlstr);
	//커멘트 초기화
	$sqlstr = "delete from ".$WIZTABLE["AVATARCOMMENT"]." where ano = $no";
	$dbcon->_query($sqlstr);
	$common->js_location("../wizavatar.php?skinmode=mycontest");
}else if($mode == "getnaked"){//초기 설정 아바타값을 가져온다.
	$iniarr = $avatar->getinit();//초기 값을 가져온다.
	$str = "";
	for($i=0; $i<$avatar->getlayercnt();$i++){
		$str .= $avatar->getavatarImg($iniarr[$i], 1).",";
	}
	$avatar-> mkSessionFile($str);
	
	$blankarr = explode(",", $avatar->blanklayer());//초기 값을 가져온다.

	foreach($blankarr as $key=>$value) $blankarr[$key] = $avatar->getavatarImg($iniarr[$key], 1);
	echo implode("|", $blankarr);
}
?>
