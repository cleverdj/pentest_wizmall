<?
	/*****************************************************
	* 함수 정의 
	* 2005-05
	* Kang Shin Do
	*****************************************************/
	###################################################################
	# 아바타 관련 함수
	###################################################################

	// 아바타 인벤토리에 갖고 있는 총갯수
	function max_item($user_seq)
	{
		$sql = "select UI_Owner,UI_Shop from AV_Inven where UI_Owner = '$user_seq'";
		$result = mysql_query($sql);
		$row = mysql_fetch_row($result);
		$UI_Owner = $row[0];
		$UI_Shop = $row[1];

		if($UI_Owner != "")
		{
			$UI_Shop = explode( "/", $UI_Shop );
			$no = count($UI_Shop);
		}
		else
		{
			$no = 0;
		}
		return $no;
	}


	// 아바타 이미지 변환
	function avatar($code ,$mode) // 아바타 그림 img src 할때 사용
	{
		if ( $mode == 0 )
		{
			return 	"http://ad.mud4u.com/datas/family/avatar/item/".en($code).".gif";
		}	
		else{
			return "http://ad.mud4u.com/datas/family/avatar/preview/".en($code).".gif";
		}
	}

	// 암호화 (아바타 이름 및 기타)
	function en($name)
	{
		$name = base64_encode ( $name );
		$name = "MUD4U@".$name."@FA";
		return base64_encode ( base64_encode ( $name ) );
	}

	// 직업 주기
	function job($code) 
	{
		if ( $code == 1 ) $job = "전사";
		if ( $code == 2 ) $job = "도적";
		if ( $code == 3 ) $job = "마법사";
		if ( $code == 4 ) $job = "엘프";
		
		if ( $code == 90 ) $job = "[M4]도우미";
		if ( $code == 91 ) $job = "[M4]마스터";
		if ( $code == 92 ) $job = "";
		if ( $code == 93 ) $job = "";
		if ( $code == 94 ) $job = "";
		if ( $code == 95 ) $job = "[M4]화가";
		if ( $code == 96 ) $job = "[M4]운영자";
		if ( $code == 97 ) $job = "[M4]개발자";
		if ( $code == 98 ) $job = "[M4]관리자";
		if ( $code == 99 ) $job = "[M4]머드포유";

		return $job;
	}

	// 아바타 정보 구하기
	function info($mode,$no) 
	{
		global $sell_percent; // 되팔기 %
		global $SESSION_SEX; // 아바타 성별 쿠키 가져온다.
		global $SESSION_LEVEL; // 맴버 레벨 가져온다.
		global $SESSION_JOB; // 직업 쿠키 가져온다.
		global $SESSION_EXP; // 게임 겸험치 가져온다.
		global $data; // 함수 불러들이기전에 아이템 정보 다 불러드린다

		switch($mode){
			case 0 : // 아바타 정보 만들기
			/******************************************************
			* 조합, 퀘스트 아이템이면 아이템명 바꿘다.
			******************************************************/
			if ( $data[SD_Category] == 28 ) {
				$titlecolor="FF8400";
			}else{
				$titlecolor="black";
			}

			/******************************************************
			* msg 입력 - 제목라인
			******************************************************/
			$msg = "<table width=200><tr height=2 bgcolor=AAAAAA><td colspan=3></td></tr><tr><td colspan=3 align=center><font size=2 color=$titlecolor><b>$data[SD_Name]</b></font><td></tr><tr height=2 bgcolor=DDDDDD><td colspan=3></td></tr>";

			/******************************************************
			* 설명있으면 추가
			******************************************************/
			$msg .= ($data[SD_Detail] != "") ? "<tr><td colspan=3 align=center>$data[SD_Detail]<td></tr><tr height=2 bgcolor=DDDDDD><td colspan=3></td></tr>" : "" ;

			/******************************************************
			* 카테고리명 추가
			******************************************************/
			$msg .= "<tr valign=top><td width=100 align=center>";
			$msg .= $data[CA_Name]."<br>";

			/******************************************************
			* 한손장비인지 확인
			******************************************************/
			if ( $data[SD_Layer] == 23 ) $msg .= "한손 장비<br>";
			else if ( $data[SD_Layer] == 24 ) $msg .= "양손 장비<br>";	
			$msg .= "</td><td width=1 bgcolor=DDDDDD></td><td width=100 align=center>";

			/******************************************************
			* 성별
			******************************************************/
			if ( $data[SD_Sex] == 1 ) $sex = "남성";
			else if ( $data[SD_Sex] == 2 ) $sex = "여성";

			// 성별이 있으면 
			if ( $sex != "" )
			{
				$msg .= ( $SESSION_SEX != $data[SD_Sex] ) ? "<font color=darkred>" :  "<font color=0066cc>" ;
				$msg .= "$sex 전용</font><br>";
			}

			/******************************************************
			* 레벨 보여주기
			******************************************************/
			$limit = explode ( "/" , $data[SD_Limit] );

			// 머드포유 레벨이 되는지 확인
			if ( $limit[0] >= 2 )
			{
				$msg .= ($limit[0] > $SESSION_LEVEL ) ? "<font color=darkred>" : "<font color=0066cc>";
				$msg = $msg."<img src=http://www.mud4u.com/images/basic/avatar/m_lv.gif align=absBottom> $limit[0] 이상</font><br>";
			}

			$msg .= "팔기:".(int)(($data[SD_M4_Price]*$sell_percent)/100) ." Fm<br>";

			$msg .= "</td></tr><tr height=2 bgcolor=AAAAAA><td colspan=3></td></tr></table>";
			break;
		} // swtich end
		
		return $msg;
	} // info end


	// 아바타 아이템 지급 item : 아이템 번호, user_seq : 맴버 번호, zone : 지급된곳, num : 갯수 , code : usehouse :인벤토리
	function get_item($item, $user_seq, $zone, $num)
	{
		$table = "AV_Inven";
		
		//아이템정보 
		$sql  = " select ";
		$sql .= " SD_No ";
		$sql .= ",SD_Category ";
		$sql .= " from AV_Itemdata ";
		$sql .= " where SD_No='$item' ";
		$result = mysql_query($sql);
		$row = mysql_fetch_row($result);
		$SD_No = $row[0];
		$SD_Category = $row[1];

		//인벤토리 혹은 창고
		$sql  = " select ";
		$sql .= " UI_Owner ";
		$sql .= ",UI_Shop ";
		$sql .= ",UI_Cnt ";
		$sql .= ",UI_Category ";
		$sql .= ",UI_Getzone ";
		$sql .= " from $table ";
		$sql .= " where UI_Owner='$user_seq' ";
		$result = mysql_query($sql);
		$row = mysql_fetch_row($result);
		$UI_Owner = $row[0];
		$UI_Shop = explode( "/", $row[1] );
		$UI_Cnt = explode( "/", $row[2] );
		$UI_Category = explode( "/", $row[3] );
		$UI_Getzone = explode( "/", $row[4]);

		//-----------------------------------------------------------------------------------
		// 회원이 갖고있는 아이템의 갯수가 몇개인지 출력...
		//-----------------------------------------------------------------------------------
		if( $UI_Owner != "" )
		{

			for( $i=0; $i <= count($UI_Shop); $i++ )
			{
				$date1_array[$i] = $UI_Shop[$i];
				$date2_array[$i] = $UI_Cnt[$i];
				$date3_array[$i] = $UI_Category[$i];
				$date4_array[$i] = $UI_Getzone[$i];

				//-----------------------------------------------------------------------------------
				// 자신이 소유한 아이템이 있을 경우 해당 아이템 UPDATE cnt + $num
				//-----------------------------------------------------------------------------------
				if( $date1_array[$i] == $item )
				{
					$date2_array[$i] = $date2_array[$i] + $num;
				}
				$Shop_num .= $date1_array[$i] . "/";
				$Cnt_num .= $date2_array[$i] . "/";
				$Category .= $date3_array[$i] . "/";
				$Getzone .= $date4_array[$i] . "/";
			}

			//-----------------------------------------------------------------------------------
			// 자신이 소유한 아이템이 없을 경우 해당 아이템 INSERT
			//-----------------------------------------------------------------------------------
			$check = "/" . $Shop_num;
			if ( eregi ( "/$item/", $check ) )
			{
				$Shop_in = "";
				$Cnt_in = "";
				$Category_in = "";
				$Getzone_in = "";
			}
			else
			{
				$Shop_in = $SD_No . "/";
				$Cnt_in = $num . "/";
				$Category_in = $SD_Category . "/";
				$Getzone_in = "선물" . "/";
			}

			$Shop_num = $Shop_in . $Shop_num;
			$Cnt_num = $Cnt_in . $Cnt_num;
			$Category = $Category_in . $Category;
			$Getzone = $Getzone_in . $Getzone;

			$Shop_num = substr($Shop_num, 0, -2);
			$Cnt_num = substr($Cnt_num, 0, -2);
			$Category = substr($Category, 0, -2);
			$Getzone = substr($Getzone, 0, -2);

			$Shop_num = trim($Shop_num);
			$Cnt_num = trim($Cnt_num);
			$Category = trim($Category);
			$Getzone = trim($Getzone);

			// 업데이트 하기
			$sql  = " update $table set ";
			$sql .= " UI_Shop='$Shop_num' ";
			$sql .= ",UI_Cnt='$Cnt_num' ";
			$sql .= ",UI_Category='$Category' ";
			$sql .= ",UI_Getzone='$Getzone' ";
			$sql .= " where UI_Owner='$user_seq' ";
//			echo($sql);
			mysql_query($sql);

		}
		else
		{
			$Shop_num = $SD_No;
			$Cnt_num = $num;
			$Category = $SD_Category;
			$Getzone = "선물";

			$Shop_num = trim($Shop_num);
			$Cnt_num = trim($Cnt_num);
			$Category = trim($Category);
			$Getzone = trim($Getzone);

			// 업데이트 하기
			$sql  = " insert into $table ( ";
			$sql .= " UI_Owner ";
			$sql .= ",UI_Shop ";
			$sql .= ",UI_Cnt ";
			$sql .= ",UI_Category ";
			$sql .= ",UI_Getzone ";
			$sql .= " ) values ( ";
			$sql .= " '$user_seq' ";
			$sql .= ",'$Shop_num' ";
			$sql .= ",'$Cnt_num' ";
			$sql .= ",'$Category' ";
			$sql .= ",'$Getzone' )";
//			echo($sql);
			mysql_query($sql);
		}
	}

	// 아바타 인벤토리에서 삭제
	function delete_item($item, $user_seq, $num)
	{
		global $master_db; // DB 클래스 공유
		$table = "AV_Inven";
		
		//아이템정보 
		$sql  = " select ";
		$sql .= " UI_Owner ";
		$sql .= ",UI_Shop ";
		$sql .= ",UI_Cnt ";
		$sql .= ",UI_Category ";
		$sql .= ",UI_Getzone ";
		$sql .= " from avatar.$table ";
		$sql .= " where UI_Owner='$user_seq' ";
		$master_db->query($sql);

		$row = $master_db->fetch("row");
		$UI_Owner = $row[0];
		$UI_Shop = $row[1];
		$UI_Cnt = $row[2];
		$UI_Category = $row[3];
		$UI_Getzone = $row[4];
		
		// 회원이 갖고있는 아이템의 갯수가 몇개인지 출력...
		if($user_seq != "")
		{
			$UI_Owner = $UI_Owner;
			$UI_Shop = explode( "/", $UI_Shop );
			$UI_Cnt = explode( "/", $UI_Cnt );
			$UI_Category = explode( "/", $UI_Category );
			$UI_Getzone = explode( "/", $UI_Getzone );

			for( $i=0; $i <= count($UI_Shop); $i++ )
			{
				$date1_array[$i] = $UI_Shop[$i];
				$date2_array[$i] = $UI_Cnt[$i];
				$date3_array[$i] = $UI_Category[$i];
				$date4_array[$i] = $UI_Getzone[$i];

				//-----------------------------------------------------------------------------------
				// 자신이 소유한 아이템을 DELETE
				//-----------------------------------------------------------------------------------
				if( $date1_array[$i] == $item )
				{
					if($date2_array[$i] > $num)
					{
						$date2_array[$i] = $date2_array[$i] - $num;
					}
					else
					{
						$date1_array[$i] = "0001/";
						$date2_array[$i] = "0001/";
						$date3_array[$i] = "0001/";
						$date4_array[$i] = "0001/";
					}
				}
				$Shop_num .= $date1_array[$i] . "/";
				$Cnt_num .= $date2_array[$i] . "/";
				$Category .= $date3_array[$i] . "/";
				$Getzone .= $date4_array[$i] . "/";
			}
			//-----------------------------------------------------------------------------------
			// str_replace()
			//-----------------------------------------------------------------------------------
			$check = "/" . $Shop_num;
			if ( eregi ( "/0001//" , $check ) )
			{
				$Shop_num = str_replace("0001//", "", $Shop_num);
				$Cnt_num = str_replace("0001//", "", $Cnt_num);
				$Category = str_replace("0001//", "", $Category);
				$Getzone = str_replace("0001//", "", $Getzone);
			}
			else if ( eregi ( "/0001/" , $check ) )
			{
				$Shop_num = str_replace("0001/", "", $Shop_num);
				$Cnt_num = str_replace("0001/", "", $Cnt_num);
				$Category = str_replace("0001/", "", $Category);
				$Getzone = str_replace("0001/", "", $Getzone);
			}

			$Shop_num = substr($Shop_num, 0, -2);
			$Cnt_num = substr($Cnt_num, 0, -2);
			$Category = substr($Category, 0, -2);
			$Getzone = substr($Getzone, 0, -2);

			$Shop_num = trim($Shop_num);
			$Cnt_num = trim($Cnt_num);
			$Category = trim($Category);
			$Getzone = trim($Getzone);

			//아이템정보 
			$sql  = " update avatar.$table set ";
			$sql .= " UI_Shop='$Shop_num' ";
			$sql .= ",UI_Cnt='$Cnt_num' ";
			$sql .= ",UI_Category='$Category' ";
			$sql .= ",UI_Getzone='$Getzone' ";
			$sql .= " where UI_Owner='$user_seq'";
			$master_db->query($sql);
		}
	}

	// 래벨에 따른 훈장 번호
	function medal($exp)
	{
		if ( $exp <= 839  ) {
			$no = 26;
		}else if ( $exp <= 2359  ) {
			$no = 528;		
		}else if ( $exp <= 5459  ) {	
			$no = 529;		
		}else if ( $exp <= 11039  ) {	
			$no = 530;		
		}else if ( $exp <= 20215  ) {	
			$no = 89;		
		}else if ( $exp <= 34319  ) {	
			$no = 531;		
		}else if ( $exp <= 58336  ) {	
			$no = 532;		
		}else if ( $exp <= 100805  ) {	
			$no = 533;		
		}else if ( $exp <= 174193  ) {	
			$no = 534;		
		}else if ( $exp <= 301006  ) {	
			$no = 535;		
		}else if ( $exp <= 520140  ) {	
			$no = 536;		
		}else if ( $exp <= 898802  ) {	
			$no = 538;		
		}else if ( $exp <= 1553131  ) {	
			$no = 537;		
		}else if ( $exp >= 1553132  ) {	
			$no = 90;		
		}
		
		return $no ;
	}

	// 게임 레벤 봔한
	function GameLevel($exp) 
	{
		if( $exp < 390 ) $i = 1;
		else if( $exp < 810 ) $i = 2;
		else if( $exp < 1650 ) $i = 3;
		else if( $exp < 3050 ) $i = 4;
		else if( $exp < 5150 ) $i = 5;
		else if( $exp < 8090 ) $i = 6;
		else if( $exp < 12010 ) $i = 7;
		else if( $exp < 17050 ) $i = 8;
		else if( $exp < 23350 ) $i = 9;
		else if( $exp < 31050 ) $i = 10;
		else if( $exp < 40290 ) $i = 11;
		else if( $exp < 51210 ) $i = 12;
		else if( $exp < 63950 ) $i = 13;
		else if( $exp < 78650 ) $i = 14;
		else if( $exp < 95450 ) $i = 15;
		else if( $exp < 114490 ) $i = 16;
		else if( $exp < 135910 ) $i = 17;
		else if( $exp < 159850 ) $i = 18;
		else if( $exp < 186450 ) $i = 19;
		else if( $exp < 215850 ) $i = 20;
		else if( $exp < 248190 ) $i = 21;
		else if( $exp < 283610 ) $i = 22;
		else if( $exp < 322250 ) $i = 23;
		else if( $exp < 364250 ) $i = 24;
		else if( $exp < 409750 ) $i = 25;
		else if( $exp < 458890 ) $i = 26;
		else if( $exp < 511810 ) $i = 27;
		else if( $exp < 568650 ) $i = 28;
		else if( $exp < 629550 ) $i = 29;
		else if( $exp < 694650 ) $i = 30;
		else if( $exp < 764090 ) $i = 31;
		else if( $exp < 838010 ) $i = 32;
		else if( $exp < 916550 ) $i = 33;
		else if( $exp < 999850 ) $i = 34;
		else if( $exp < 1088050 ) $i = 35;
		else if( $exp < 1181290 ) $i = 36;
		else if( $exp < 1279710 ) $i = 37;
		else if( $exp < 1383450 ) $i = 38;
		else if( $exp < 1492650 ) $i = 39;
		else if( $exp < 1607450 ) $i = 40;
		else if( $exp < 1727990 ) $i = 41;
		else if( $exp < 1854410 ) $i = 42;
		else if( $exp < 1986850 ) $i = 43;
		else if( $exp < 2125450 ) $i = 44;
		else if( $exp < 2270350 ) $i = 45;
		else if( $exp < 2421690 ) $i = 46;
		else if( $exp < 2579610 ) $i = 47;
		else if( $exp < 2744250 ) $i = 48;
		else if( $exp < 2915750 ) $i = 49;
		else if( $exp < 3094250 ) $i = 50;
		else if( $exp < 3279890 ) $i = 51;
		else if( $exp < 3472810 ) $i = 52;
		else if( $exp < 3673150 ) $i = 53;
		else if( $exp < 3881050 ) $i = 54;
		else if( $exp < 4096650 ) $i = 55;
		else if( $exp < 4320090 ) $i = 56;
		else if( $exp < 4551510 ) $i = 57;
		else if( $exp < 4791050 ) $i = 58;
		else if( $exp < 5038850 ) $i = 59;
		else if( $exp < 5294900 ) $i = 60;
		else if( $exp < 5559640 ) $i = 61;
		else if( $exp < 5833060 ) $i = 62;
		else if( $exp < 6115300 ) $i = 63;
		else if( $exp < 6406500 ) $i = 64;
		else if( $exp < 6706800 ) $i = 65;
		else if( $exp < 7016340 ) $i = 66;
		else if( $exp < 7335260 ) $i = 67;
		else if( $exp < 7663700 ) $i = 68;
		else if( $exp < 8001800 ) $i = 69;
		else if( $exp < 8349700 ) $i = 70;
		else if( $exp < 8707540 ) $i = 71;
		else if( $exp < 9075460 ) $i = 72;
		else if( $exp < 9453600 ) $i = 73;
		else if( $exp < 9842100 ) $i = 74;
		else if( $exp < 10241100 ) $i = 75;
		else if( $exp < 10650740 ) $i = 76;
		else if( $exp < 11071160 ) $i = 77;
		else if( $exp < 11502500 ) $i = 78;
		else if( $exp < 11944900 ) $i = 79;
		else if( $exp < 12398500 ) $i = 80;
		else if( $exp < 12863440 ) $i = 81;
		else if( $exp < 13339860 ) $i = 82;
		else if( $exp < 13827900 ) $i = 83;
		else if( $exp < 14327700 ) $i = 84;
		else if( $exp < 14839400 ) $i = 85;
		else if( $exp < 15363140 ) $i = 86;
		else if( $exp < 15899060 ) $i = 87;
		else if( $exp < 16447300 ) $i = 88;
		else if( $exp < 17008000 ) $i = 89;
		else if( $exp < 17581300 ) $i = 90;
		else if( $exp < 18167340 ) $i = 91;
		else if( $exp < 18766260 ) $i = 92;
		else if( $exp < 19378200 ) $i = 93;
		else if( $exp < 20003300 ) $i = 94;
		else if( $exp < 20641700 ) $i = 95;
		else if( $exp < 21293540 ) $i = 96;
		else if( $exp < 21958960 ) $i = 97;
		else if( $exp < 22638100 ) $i = 98;
		else if( $exp < 23331100 ) $i = 99;
		else $i = 100;
		return $i;
	}
	###################################################################


	###################################################################
	# 머드포유 관련 함수
	###################################################################

	// 이미지 작게 하기..
	function resizeimage($smallfile,$picture,$rewidth="",$reheight=""){

		$picsize=getimagesize($picture);


		// 크기가 없을때는 50% 줄인다.
		if($rewidth == "" || $reheight = ""){
			$div = round((150/$picsize[0])*100,0);
			$rewidth = round((($div/100)*$picsize[0]),0);
			$reheight = round((($div/100)*$picsize[1]),0);
		}

		// 60 이하이면 줄일필요없음
		if($picsize[0] > 140){


			if($picsize[0]>$rewidth){
					$width=$picsize[0]-$rewidth;
					$aa=$width/$picsize[0];
					$picsize[0]=intval($picsize[0]-$picsize[0]*$aa);
					$picsize[1]=intval($picsize[1]-$picsize[1]*$aa);
			}

			if($picsize[1]>$reheight){
					$height=$picsize[1]-$reheight;
					$bb=$height/$picsize[1];
					$picsize[0]=intval($picsize[0]-$picsize[0]*$bb);
					$picsize[1]=intval($picsize[1]-$picsize[1]*$bb);
			}


			if($picsize[2]===1) {
	//            @header("Content-Type: imgage/gif");
					$dstimg=imagecreatetruecolor ($rewidth,$reheight);
					$srcimg=@ImageCreateFromGIF($picture);
					ImageCopyResized($dstimg, $srcimg,0,0,0,0,$rewidth,$reheight,ImageSX($srcimg),ImageSY($srcimg));
					Imagegif($dstimg,$smallfile,76);
			}
			elseif($picsize[2]===2) {
	 //              @header("Content-Type: images/jpeg");
					$dstimg=imagecreatetruecolor ($rewidth,$reheight);
					$srcimg=ImageCreateFromJPEG($picture);
					ImageCopyResized($dstimg, $srcimg,0,0,0,0,$rewidth,$reheight,ImageSX($srcimg),ImageSY($srcimg));
					Imagejpeg($dstimg,$smallfile,76);
			}
			elseif($picsize[2]===3) {
	//                @header("Content-Type: images/png");
					$dstimg=imagecreatetruecolor ($rewidth,$reheight);
					$srcimg=ImageCreateFromPNG($picture);
					ImageCopyResized($dstimg, $srcimg,0,0,0,0,$rewidth,$reheight,ImageSX($srcimg),ImageSY($srcimg));
					Imagepng($dstimg,$smallfile,76);
			}
			# 다른 형식의 애러 문제로 인한 @ 추가
			@ImageDestroy($dstimg);
			@ImageDestroy($srcimg); 
		}
	}


	// alert창 뛰우기
	function alert_msg($msg , $url = "" ) {
		// 메시지만 나온다..
		if( $url == "msg" ){
			echo("<script>alert('$msg');</script>");
		}else if( $url == "close" ){  // 메시지후 닫기
			echo("<script>alert('$msg'); self.close();</script>");
		}else if( $url != "" ){ // 해당 URL 팅기기
			echo("<script>alert('$msg'); location.replace('$url');</script>");
		}else{ // 메시지 후 빽
			echo("<script>alert('$msg'); history.back();</script>");
		}
	}

	// alert창 뛰우고 닫기
	function alert_msg_close($msg) {
		echo("<script>alert('$msg'); self.close();</script>");
	}

	// 패스워드 암호화 8자리이상 안됌
	function encodePass($Passwd){
		return crypt($Passwd,"yoon");
	}

	/* 글자 자르기
	function cut_str($str, $length) {
		if(strlen($str) > $length) {

			$count = 0;
			for($i = 0; $i < $length ; $i++) { 

				$cut = ord(substr($str, $i, 1)); 

				if($cut > 127) { 
					$count++; 
				} 
			}
			
			$mod = $count % 2; 

			if($mod == 0) {		
				$str = substr($str, 0, $length); 
				$str = $str . ".."; 
			} else { 
				$length = $length + 1; 
				$str = substr($str, 0, $length); 
				$str = $str . ".."; 
			} 
		} 
		return $str;
	}*/

	// Level에 따른 명칭 ( $seq:맴버번호 , $operator :'-'차감|'+'증감 , $level:현재 레벨, $now_fm:현재Fm ,  $add_fm:지급될Fm , $now_point:현재 point ,  $add_point:지급될 point )
	function MemberSupply( $seq , $operator , $now_level , $now_fm , $add_fm , $now_point , $add_point ) {

		// 디비 정보 가져오기
		global $master_db; 
		// 레벨별로 Fm 지급되는 배열
		$LevelToFm = array(10,15,20,25,40,45,50,65,70,75,90,95,100,115,120,125,140,145,150,200,220,240,280,320,380,420,500,550,620,700,780,880,950,1100,1200,1400,1600,1800,2000,4000);
		
		//  맴버번호 있는지
		if( $seq == "" ) {
			$error["msg"] = " 맴버정보가 잘못되었습니다.\\n\\n관리자에게 문의하세요! ";
			return $error;
		}
			
		//  차감 타입 맞는지
		if( $operator != "+" && $operator != "-" ) {
			$error["msg"] = " 차감 타입이 잘못되었습니다.\\n\\n관리자에게 문의하세요! ";
			return $error;
		}

		// FM 없다는것은 안쓴다는애기
		if ( $now_fm == "" || $add_fm == "" ) {
			$now_fm = 0;
			$add_fm = 0;
		}

		if ( $add_point == "" ){
			$add_point = 0;
		}



		// 증가인지 차감인지 확인후 처리
		switch( $operator ){

			case "+":
			
				if ( $now_point != "" && $add_point != "" ) {

					$new_point = $now_point + $add_point;
					$new_level = PointLevel($new_point);
					
					if( $now_level < $new_level ){
						$add_fm = $add_fm + $LevelToFm[$new_level-1]; //래밸별 FM
					}

				}else{
					$new_level = $now_level;
				}
				
				$sql  = "  update mud4u2005.MD_Member set ";
				$sql .= "  MB_Fm = MB_Fm+$add_fm ";
				$sql .= " ,MB_Point = MB_Point+$add_point ";
				$sql .= " ,MB_Level = $new_level ";
				$sql .= " where MB_Seq = '$seq' ";
				$master_db->query($sql);
				
				break;

			case "-":

				if ( $now_point != "" && $add_point != "" ) {

					$new_point = $now_point - $add_point;
					$new_level = PointLevel($new_point);
					
					if( $now_level > $new_level ){
						$add_fm = $add_fm - $LevelToFm[$new_level-1]; //래밸별 FM
					}

				}else{
					$new_level = $now_level;
				}
				
				$sql  = "  update mud4u2005.MD_Member set ";
				$sql .= "  MB_Fm = MB_Fm-$add_fm ";
				$sql .= " ,MB_Point = MB_Point-$add_point ";
				$sql .= " ,MB_Level = $new_level ";
				$sql .= " where MB_Seq = '$seq' ";
				$master_db->query($sql);
				
				break;
		}

		return true;
	}

	// Level에 따른 명칭
	function MemberLevel($level) {
		if($level  < 1 ) $name = "범죄자";
		if($level  >= 1 && $level  <= 3) $name = "평민";
		if($level >= 4 && $level <= 6 ) $name = "견습생";
		if($level >= 7 && $level <= 9 ) $name = "수습기사";
		if($level >= 10 && $level <= 12 ) $name = "기사";
		if($level >= 13 && $level <= 15 ) $name = "기사단장";
		if($level >= 16 && $level <= 18 ) $name = "근위대장";
		if($level >= 19 && $level <= 21 ) $name = "친위대장";
		if($level >= 22 && $level <= 24 ) $name = "남작";
		if($level >= 25 && $level <= 27 ) $name = "백작";
		if($level >= 28 && $level <= 30 ) $name = "후작";
		if($level >= 31 && $level <= 33 ) $name = "공작";
		if($level >= 34 && $level <= 36 ) $name = "왕";
		if($level >= 37 && $level <= 39 ) $name = "황제";
		if($level >= 40 ) $name = "드래곤슬레이어";

		return $name;
	}

	// 포인트에 따른 레벨
	function PointLevel($point) {
		if($point < 372) $return_value = 1;
		if($point >= 372 && $point < 560 )	$return_value = 2;
		if($point >= 560 && $point < 840 )	$return_value = 3;
		if($point >= 840 && $point < 1242 )	$return_value = 4;
		if($point >= 1242 && $point < 1716 ) $return_value = 5;
		if($point >= 1716 && $point < 2360 ) $return_value = 6;
		if($point >= 2360 && $point < 3216 ) $return_value = 7;
		if($point >= 3216 && $point < 4200 ) $return_value = 8;
		if($point >= 4200 && $point < 5460 ) $return_value = 9;
		if($point >= 5460 && $point < 7050 ) $return_value = 10;
		if($point >= 7050 && $point < 8040 ) $return_value = 11;
		if($point >= 8040 && $point < 11040 ) $return_value = 12;
		if($point >= 11040 && $point < 13716 ) $return_value = 13;
		if($point >= 13716 && $point < 16680 ) $return_value = 14;
		if($point >= 16680 && $point < 20216 ) $return_value = 15;
		if($point >= 20216 && $point < 24402 ) $return_value = 16;
		if($point >= 24402 && $point < 28980 )	$return_value = 17;
		if($point >= 28980 && $point < 34320 )	$return_value = 18;
		if($point >= 34320 && $point < 40512 )	$return_value = 19;
		if($point >= 40512 && $point < 48614 )	$return_value = 20;
		if($point >= 48614 && $point < 58337 )	$return_value = 21;
		if($point >= 58337 && $point < 70004 )	$return_value = 22;
		if($point >= 70004 && $point < 84005 )	$return_value = 23;
		if($point >= 84005 && $point < 100806 )	$return_value = 24;
		if($point >= 100806 && $point < 120968 ) $return_value = 25;
		if($point >= 120968 && $point < 145161 ) $return_value = 26;
		if($point >= 145161 && $point < 174194 ) $return_value = 27;
		if($point >= 174194 && $point < 209033 ) $return_value = 28;
		if($point >= 209033 && $point < 250839 ) $return_value = 29;
		if($point >= 250839 && $point < 301007 ) $return_value = 30;
		if($point >= 301007 && $point < 361209 ) $return_value = 31;
		if($point >= 361209 && $point < 433450 ) $return_value = 32;
		if($point >= 433450 && $point < 520141 ) $return_value = 33;
		if($point >= 520141 && $point < 624169 ) $return_value = 34;
		if($point >= 624169 && $point < 749003 ) $return_value = 35;
		if($point >= 749003 && $point < 898803 ) $return_value = 36;
		if($point >= 898803 && $point < 1078564 ) $return_value = 37;
		if($point >= 1078564 && $point < 1294277 ) $return_value = 38;
		if($point >= 1294277 && $point < 1553132 ) $return_value = 39;
		if($point >= 1553132 ) $return_value = 40;

		return $return_value;
	}

	function MaxPoint($point) {
		if($point < 372) $return_value = 1;
		if($point >= 372 && $point < 560 )	$return_value = 560;
		if($point >= 560 && $point < 840 )	$return_value = 840;
		if($point >= 840 && $point < 1242 )	$return_value = 1242;
		if($point >= 1242 && $point < 1716 ) $return_value = 1716;
		if($point >= 1716 && $point < 2360 ) $return_value = 2360;
		if($point >= 2360 && $point < 3216 ) $return_value = 3216;
		if($point >= 3216 && $point < 4200 ) $return_value = 4200;
		if($point >= 4200 && $point < 5460 ) $return_value = 5460;
		if($point >= 5460 && $point < 7050 ) $return_value = 7050;
		if($point >= 7050 && $point < 8040 ) $return_value = 8040 ;
		if($point >= 8040 && $point < 11040 ) $return_value = 11040;
		if($point >= 11040 && $point < 13716 ) $return_value = 13716;
		if($point >= 13716 && $point < 16680 ) $return_value = 16680;
		if($point >= 16680 && $point < 20216 ) $return_value = 20216;
		if($point >= 20216 && $point < 24402 ) $return_value = 24402;
		if($point >= 24402 && $point < 28980 )	$return_value = 28980;
		if($point >= 28980 && $point < 34320 )	$return_value = 34320;
		if($point >= 34320 && $point < 40512 )	$return_value = 40512;
		if($point >= 40512 && $point < 48614 )	$return_value = 48614;
		if($point >= 48614 && $point < 58337 )	$return_value = 58337;
		if($point >= 58337 && $point < 70004 )	$return_value = 70004;
		if($point >= 70004 && $point < 84005 )	$return_value = 84005;
		if($point >= 84005 && $point < 100806 )	$return_value = 100806;
		if($point >= 100806 && $point < 120968 ) $return_value = 120968;
		if($point >= 120968 && $point < 145161 ) $return_value = 145161;
		if($point >= 145161 && $point < 174194 ) $return_value = 174194;
		if($point >= 174194 && $point < 209033 ) $return_value = 209033;
		if($point >= 209033 && $point < 250839 ) $return_value = 250839;
		if($point >= 250839 && $point < 301007 ) $return_value = 301007;
		if($point >= 301007 && $point < 361209 ) $return_value = 361209;
		if($point >= 361209 && $point < 433450 ) $return_value = 433450;
		if($point >= 433450 && $point < 520141 ) $return_value = 520141;
		if($point >= 520141 && $point < 624169 ) $return_value = 624169;
		if($point >= 624169 && $point < 749003 ) $return_value = 749003;
		if($point >= 749003 && $point < 898803 ) $return_value = 898803;
		if($point >= 898803 && $point < 1078564 ) $return_value = 1078564;
		if($point >= 1078564 && $point < 1294277 ) $return_value = 1294277;
		if($point >= 1294277 && $point < 1553132 ) $return_value = 1553132;
		if($point >= 1553132 ) $return_value = 2553132;

		return $return_value;
	}


	// 공백만 있는지 확인
	function isblank($str) {
		$temp=str_replace("　","",$str);
		$temp=str_replace("\n","",$temp);
		$temp=strip_tags($temp);
		$temp=str_replace("&nbsp;","",$temp);
		$temp=str_replace(" ","",$temp);
		if(eregi("[^[:space:]]",$temp)) return 0;
		return 1;
	}

	// 욕체크
	function is_fuck($str,$fil){
		$fil=explode(',',$fil);
		$replace_str=asc_hex($str);
		$filter_str='/(';
		for($i=0;$i<count($fil);$i++){
			if($i>0)$filter_str.='|';
			$filter_str.=asc_hex($fil[$i]);
		}
		$filter_str.=')+/';

		if( preg_match($filter_str, $replace_str, asc_hex($str)) ) return $filter_str;
		return "NULL";
	}

	//헥사 코드 문자열을 아스키 코드 문자열로
	function hex_asc($str){
		$word_length=strlen($str);

		for($i = 0;$i<$word_length;$i+=5){
			$tmp1=HexDec(substr($str,$i,2));
			if($tmp1==0){
				$tmp2=HexDec(substr($str,$i+2,2));
				$str2.=chr($tmp2);
			}else{
				$tmp2=HexDec(substr($str,$i+2,2));
				$str2.=chr($tmp1).chr($tmp2);
			}
		}
		return $str2;
	}

	//아스키 문자열을 헥사 코드로..
	function asc_hex($char){
		$j = 0;
		$word_length=strlen($char);

		for($i = 0;$i<$word_length;$i++) {
			if($j == 0){
				if(ord(substr($char,$i,1)) > 0xa1 && ord(substr($char,$i,1)) <= 0xfe) {
				if($i>0)$str .= ' ';
					$j = 1; $str = $str.bin2hex(substr($char,$i,1));
				}else{
					if($i>0)$str .= ' ';
					$str = $str.'00'.bin2hex(substr($char,$i,1));
				}
			}else{
				$str = $str.bin2hex(substr($char,$i,1));
				$j = 0;
			}
		}
		return $str;
	}

	// 이번년도 몇째주인지 알아내는 함수 get_week_number()
	function is_leap_year($year) { 
		if ((($year % 4) == 0 and ($year % 100)!=0) or ($year % 400)==0) { 
				return 1; 
		} else { 
				return 0; 
		} 
	} 

	function iso_week_days($yday, $wday) { 
		return $yday - (($yday - $wday + 382) % 7) + 3; 
	} 

	function get_week_number($timestamp) { 

		$d = getdate($timestamp); 

		$days = iso_week_days($d["yday"], $d["wday"]); 

		if ($days < 0) { 
				$d["yday"] += 365 + is_leap_year(--$d["year"]); 
				$days = iso_week_days($d["yday"], $d["wday"]); 
		} else { 
				$d["yday"] -= 365 + is_leap_year($d["year"]); 
				$d2 = iso_week_days($d["yday"], $d["wday"]); 
				if (0 <= $d2) { 
						/* $d["year"]++; */ 
						$days = $d2; 
				} 
		} 

	return (int)($days / 7) + 1; 
	} 

	// Byte로 표시
	function To_Byte($bit){
		if($bit < 1000) {
			$re_size = $bit."Byte";
		} elseif($bit >=1000 && $bit < 1000000) {
			$re_size = sprintf("%0.0f", $bit/1000)." KByte";
		} elseif($bit >= 1000000) {
			$re_size = sprintf("%0.0f", $bit/1000000)." MByte";
		}
	
	return $re_size;
	}

	// 신도 추가 (2006-01 : 내용중 공통 삭제)
	// 이미지 테그 삭제
	function str_delete($str){
		$str = str_replace("::img1::","", $str);
		$str = str_replace("::img2::","", $str);
		$str = str_replace("::img3::","", $str);
		$str = str_replace("::img4::","", $str);
		$str = str_replace("::img5::","", $str);

	return $str;
	}

	// 사이즈 표시
	function getfilesize($size) {
		if(!$size) return "0 Byte";
		if($size<1024) { 
			return ($size." Byte");
		} elseif($size >1024 && $size< 1024 *1024)  {
			return sprintf("%0.1f KB",$size / 1024);
		}
		else return sprintf("%0.2f MB",$size / (1024*1024));
	}
?>