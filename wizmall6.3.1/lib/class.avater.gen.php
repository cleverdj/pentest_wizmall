<?
class Gen_Class{
	var	$mode = "";
		
	function Avatar_Class($dbhost, $dbname, $dbuser, $dbpwd){
		$this->MYSQL_HOST=$dbhost;
		$this->MYSQL_DB = $dbname;
		$this->MYSQL_ID = $dbuser;
		$this->MYSQL_PASSWORD = $dbpwd;
	}
	
	function db_connect(){
		$this->dbcon=mysql_connect($this->MYSQL_HOST,  $this->MYSQL_ID, $this->MYSQL_PASSWORD);
		mysql_select_db($this->MYSQL_DB, $this->dbcon);
		if ( !$this->dbcon ) {
			echo "mysql 데이터 베이스에 연결할 수 없습니다."; 
			exit;
		}	
	}
	
	function dberror($str){
		die($str."<br>".mysql_error());
	}
	
	function js_alert($str, $goto=null){
		if($goto == "cur"){
			echo "<script>alert('$str');</script>";
			return false;
			exit;
		}else if($goto == "close"){
			echo "<script>alert('$str');self.close();</script>";
			return false;
			exit;
		}else{
			echo "<script>alert('$str');history.go(-1);</script>";
			return false;
			exit;
		}
	}	
	
####################################################################################
#### 일반 클라스 모음 
####################################################################################
	function file_uploade($file){
		$this->file_name=$_FILES[$file]['name'];
		$this->file_type=$_FILES[$file]['type'];
		$this->file_error=$_FILES[$file]['error'];
		$this->file_size=$_FILES[$file]['size'];
		$this->file_tmp_name=$_FILES[$file]['tmp_name'];
	}
	
	
	function uploadfile($file){
		$mode = $this->mode?$this->mode:"insert";
		$prohibitextension = split("\,", $this->prohibitextension);
		if($mode == "insert"){
		
// 사용예(insert)
//	$gencls->upload_path = "../../wizavatar/avatarimg/";
//	$gencls->replacflag = "on";
//	$gencls->uploadfile("file");
//	$imgname = split("\|", $gencls->attachedfile);
	
//사용예(update)
//	$gencls->mode = "update";
//	$gencls->upload_path = "../../wizavatar/avatarimg/";
//	$gencls->replacflag = "on";
//	$gencls->old_attachedfile=$oldfilename1;
//	$gencls->deletefile = $del_file;
//	$gencls->uploadfile("file");
//	$imgname = split("\|", $gencls->attachedfile);


// 사용되는 옵션값
//	$gencls->upload_path = "../../wizavatar/avatarimg/";//저장이미지경로
//	$gencls->replacflag = "on";//파일명 치환옵션
//	$gencls->uploadfile("file");//"file"첨부파일필드명(배열)
//	$gencls->prohibitextension; //금지확장자 "exe, text,, ...."
//	$imgname = split("\|", $gencls->attachedfile);(실제 저장파일명)
//	$gencls->attachedname  //실제 첨부파일명
//	$gencls->deletefile  //첨부된 파일의 키값
//	$gencls->old_attachedfile //기존 첨부값 "||||" 와같이 값전달
//	$gencls->old_attachedname //기존 첨부값 "||||" 와같이 값전달


			$this->file_uploade($file);//register global on에서 작동되게 설계
			while(is_array($this->file_name) && list($att_key, $att_value) = each($this->file_name)):
			$MicroTsmp = split(" ",microtime());
			$newFileName = str_replace(".", "", $MicroTsmp[0]);
				if($this->file_tmp_name[$att_key]!="none" && $this->file_tmp_name[$att_key]){
					$extention = strrchr($this->file_name[$att_key], ".");
					if(in_array($extention, $prohibitextension)) {
						echo "<script>window.alert('시스템에 손상을 주는 파일이 첨부되었습니다.');history.go(-1);</script>";
						return false;
						exit;
					}
					$this->attachedname .=$this->file_name[$att_key]."|"; /* 원래 파일명만 넣어둠*/
					if($this->replacflag) $this->file_name[$att_key]=time()."".$extention;
					if (file_exists($this->upload_path."/".$this->file_name[$att_key])) {
						if(!$this->replacflag){
	
							$this->file_name[$att_key] = date("is")."_".$this->file_name[$att_key];
						}else{
							$this->file_name[$att_key] = $newFileName."_".$this->file_name[$att_key];
						}
					}    
					if(!move_uploaded_file($this->file_tmp_name[$att_key], $this->upload_path."/".$this->file_name[$att_key])) {
						echo "<script>window.alert('파일 업로딩에 실패하였습니다.\\n에러:\\ntmp_file = ".$this->file_tmp_name[$att_key]."\\nuploadpath=".$this->upload_path."/".$this->file_name[$att_key]."');history.go(-1);</script>";
						return false;
						exit;
					}
				}
				$this->attachedfile .=$this->file_name[$att_key]."|";
			endwhile;//while(list($att_key, $att_value) = each($file_name)):
		}else if($mode == "update"){//if($mode == "insert"){
			$this->file_uploade($file);
			$oldfile1 = split("\|", $this->old_attachedfile);
			$oldfile2 = split("\|", $this->old_attachedname);
			while(is_array($this->file_name) && list($att_key, $att_value) = each($this->file_name)):
				$MicroTsmp = split(" ",microtime());
				$newFileName = str_replace(".", "", $MicroTsmp[0]);
				if($this->file_tmp_name[$att_key]!="none" && $this->file_tmp_name[$att_key]){
					$extention = strrchr($this->file_name[$att_key], ".");
						if(in_array($extention, $prohibitextension)) {
							echo "<script>window.alert('시스템에 손상을 주는 파일이 첨부되었습니다.');history.go(-1);</script>";
							return false;
							exit;
						}	
					$Tmp1[$att_key]=$this->file_name[$att_key];	
					if($oldfile1[$att_key]) unlink($this->upload_path."/".$oldfile1[$att_key]);
					if($this->replacflag) $this->file_name[$att_key]=time()."".$extention;
					if (file_exists($this->upload_path."/".$this->file_name[$att_key])) {
						if(!$this->replacflag){
							$this->file_name[$att_key] = date("is")."_".$this->file_name[$att_key];
						}else{
							$this->file_name[$att_key] = $newFileName."_".$this->file_name[$att_key];
						}
					}    
					if(!move_uploaded_file($this->file_tmp_name[$att_key], $this->upload_path."/".$this->file_name[$att_key])) {
						echo "<script>window.alert('파일 업로딩에 실패하였습니다.\\n에러:\\ntmp_file = ".$this->file_tmp_name[$att_key]."\\nuploadpath=".$this->upload_path."/".$this->file_name[$att_key]."');history.go(-1);</script>>";
						return false;
						exit;
					}
					$Tmp[$att_key]=$this->file_name[$att_key];
				}else if($this->deletefile[$att_key] && $oldfile1[$att_key]){ //파일 삭제 옵션이 책크 되어 있으면
					unlink($this->upload_path."/".$oldfile1[$att_key]);
				}else {
					$Tmp[$att_key]=$oldfile1[$att_key];
					$Tmp1[$att_key]=$oldfile2[$att_key];
				}
				$this->attachedfile .= $Tmp[$att_key]."|";
				$this->attachedname .= $Tmp1[$att_key]."|";
			endwhile;
		}//}else if($mode == "update"){//if($mode == "insert"){
	}//function uploadfile($file){
	
	function selectdatefnc($returnyear, $returnmonth, $returnday, $startyear, $endyear,$regdate){
		//echo ("$returnyear, $returnmonth, $returnday, $startyear, $endyear,$regdate");
		$ThisYear = date("Y");
		$ThisMonth = date("m");
		$ThisDay = date("d");
	
		if(!$regdate){
			$regyear = $ThisYear;
			$regmonth = $ThisMonth;
			$regday = $ThisDay;
		}else{
			$regyear = date("Y", $regdate);
			$regmonth = date("m", $regdate);
			$regday = date("d", $regdate);
		}
		//echo "regyear = $regyear <br>";
	
	/* display select box for year */
	
		echo "<select name='$returnyear'>\n";
			for($i=$startyear; $i <= $endyear; $i++){
				if($regyear == $i) $selected = 'selected';
				else unset($selected);
				echo "<option value='$i' $selected>$i</option>\n";
			}
		echo "</select>년\n";
	
	/* display select box for month */
		echo "<select name='$returnmonth'>\n";
		for($i=01; $i < 13; $i++){
		$k = substr('0'.$i, -2);
		if($regmonth == $k) $selected = 'selected';
		else unset($selected);
		 echo "<option value='$k' $selected>$k</option>\n";
		}
		echo "</select>월\n";
	
	/* display select box for day */
		echo "<select name='$returnday'>\n";
		for($i=01; $i < 32; $i++){
		$k = substr('0'.$i, -2);
		if($regday == $k) $selected = 'selected';
		else unset($selected);
		 echo "<option value='$k' $selected>$k</option>\n";
		}
		echo "</select>일\n";
	}	
}
?>
