<?
class MessageClass{
	var $contentlist = array();
	var $dbcon;//db connect 관련 외부 클라스 받기
	var $cfg;//외부 $cfg 관련 배열
## 다중 클라스 함수 호출용
	function get_object(&$dbcon=null, &$common=null){//
		if($dbcon) $this->dbcon	= $dbcon;
		if($common) $this->common	= $common;
	}
####################################################################################
#### 세션관련 폴더 및 파일 생성
####################################################################################
	function makeMessageDir($userid){
		//global $_SERVER["DOCUMENT_ROOT"];
		$rootFolder = $_SERVER["DOCUMENT_ROOT"]."/config/message";
		$strlen = strlen($userid);
		$this->MessageFolder = $rootFolder;
		for($i=0; $i<$strlen; $i++){
			##한글일때의 폴더기준변경
			if(ord( substr($userid, $i, 1) ) >= 128){
				$this->MessageFolder .= "/".substr($userid, $i, 2);
				$i++;
			}else{
				$this->MessageFolder .= "/".substr($userid, $i, 1);
			}
			if(!file_exists($this->MessageFolder)){
				mkdir($this->MessageFolder);
			}
		}
		//echo "MessageFolder=".$this->MessageFolder;
	}
	
	function getMessageList($userid=null){
		##send : 0: 메시지타입 1:메시지종류, 2:받는아이디, 3:받는이름, 4:내용, 5:카드no, 6:보낸날짜,  7:수신여부, 8:저장flag, 9:microtime
		##receive : 0:메시지종류, 1:메시지종류, 2:보낸아이디, 3:보낸이름, 4:내용, 5:카드no, 6:수신날짜, 7:수신여부, 8:저장flag, 9:microtime
		# 메시지타입 : r : 수신, s : 발신
		# 메시지종류 : 0 : 일반, 1 :카드
		unset($contentlist);
		$contentlist = array();
		//if(!$this->MessageFolder) 
		if($userid) $this->makeMessageDir($userid);
		$this->filemake($this->MessageFolder."/messagelist.php");
		$file = file($this->MessageFolder."/messagelist.php");
		$cnt=0;
		//echo $this->MessageFolder."/messagelist.php";
		foreach($file as $line){
			if(trim($line)){
				//$splitline = explode(":sp:", $line);
				$splitline = unserialize($line);
				foreach($splitline as $key=>$value){
					$contentlist[$cnt][$key] = trim($value);
				}
				$cnt++;	
			}
		}
		$this->contentlist = $contentlist;
		$this->newcnt = $newcnt;
	}
	
	function getMessageFlagList($userid, $flag){//flag 별 메시지를 리스팅
		## flag : s : 보낸쪽지함, r : 받은 쪽지함, f : 영구보관함
		$this->getMessageList($userid);//return $this->contentlist 
		//echo $this->MessageFolder;
		$cnt=0;
		foreach($this->contentlist as $key=>$value){
			if($flag == "f"){
				if($value[0] == "sf" || $value[0] == "rf"){
					$returnlist[$cnt] = $value;
					$cnt++;
				}
			}else{
				if($value[0] == $flag){
					$returnlist[$cnt] = $value;
					$cnt++;
				}
			}
		}
		return $returnlist;
	}	
	
	function getMessage($userid, $wdate){//특정 메시지 가져오기
		## flag : s : 보낸쪽지함, r : 받은 쪽지함, f : 영구보관함
		$this->getMessageList($userid);//return $this->contentlist 
		//echo $this->MessageFolder;
		$cnt=0;
		foreach($this->contentlist as $key=>$value){
			if($value[9] == $wdate){
				##상세내용도 가져오기
				$messagefolder = substr($value[0],0, 1) == "s" ? "sendlist" : "receivelist";
				$cont_dir = $this->MessageFolder."/$messagefolder/".$value[9].".php";
				if(file_exists($cont_dir)) array_push($value,  file_get_contents($cont_dir));//현재 배열의 제일 마지막에 추가

				$returnlist = $value;
			}
		}
		return $returnlist;
	}	
## 새로운 쪽지수 구하기
	function getnewMessageCnt($userid){
		##send : 0: 메시지타입 1:메시지종류, 2:받는아이디, 3:받는이름, 4:내용, 5:카드no, 6:보낸날짜,  7:수신여부, 8:저장flag, 9:microtime, 10:subject
		##receive : 0:메시지종류, 1:메시지종류, 2:보낸아이디, 3:보낸이름, 4:내용, 5:카드no, 6:수신날짜, 7:수신여부, 8:저장flag, 9:microtime, 10:subject
		# 메시지타입 : r : 수신, s : 발신
		# 메시지종류 : 0 : 일반, 1 :카드
		unset($contentlist);
		$contentlist = array();
		$this->makeMessageDir($userid);//메시지 폴더 경로를 리턴 $this->MessageFolder
		$this->filemake($this->MessageFolder."/messagelist.php");//파일이 존재하지 않으면 파일 생성
		$file = file($this->MessageFolder."/messagelist.php");
		$cnt=0;
		$newcnt = 0; //읽지않은 메시지 갯수를 구한다.
		foreach($file as $line){
			if(trim($line)){
				//$splitline = explode(":sp:", $line);
				$splitline = unserialize($line);
				if($splitline[7] == "0" && substr($splitline[0], 0, 1) == "r") $newcnt++;
				$cnt++;	
				//echo $splitline[7].",".$newcnt.",".substr($splitline[1], 0, 1)."<br>";
			}
		}
		return $newcnt;
	}
	
	function addMessageList($type){
		##send : 0: 메시지타입 1:메시지종류, 2:받는아이디, 3:받는이름, 4:내용, 5:카드no, 6:보낸날짜,  7:수신여부, 8:저장flag, 9:microtime, 10:subject
		##receive : 0:메시지종류, 1:메시지종류, 2:보낸아이디, 3:보낸이름, 4:내용, 5:카드no, 6:수신날짜, 7:수신여부, 8:저장flag, 9:microtime, 10:subject
		# 메시지타입 : r : 수신, s : 발신
		# 메시지종류 : 0 : 일반, 1 :카드
		$messageflag = $this->card_no ? 1:0;
		$userid = $type == "r" ? $this->senderid : $this->receiverid;
		$username = $type == "r" ? $this->sendername : $this->receivername;
		$addlist = array(
			0=>$type,
			1=>$messageflag,
			2=>$userid,
			3=>$username,
			4=>"",
			5=>$this->card_no,
			6=>time(),
			7=>0,
			8=>"",
			9=>$this->savetime, 
			10=>$this->subject
		);
		//if($type == "s"){
		//print_r($addlist);
		//exit;
		//}
		//echo "contentlist = ".$this->contentlist;
		array_unshift ($this->contentlist, $addlist);
		
		reset($this->contentlist);

		$str = "";
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");		
		foreach($this->contentlist as $key => $value){
			//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
			$str .= serialize($value)."\n";
		}
		fwrite($fp,$str);
		fclose($fp);
		//echo $this->MessageFolder."/messagelist.php" ."<br>";
	}	
	
	function saveMessage(){
		$receiveridArr = explode(",", $this->receiver);
		//echo $this->receiver;
		foreach($receiveridArr as $receiverid){
			$MicroTsmp = explode(" ",microtime());
			$this->savetime = $MicroTsmp[1].str_replace(".", "", $MicroTsmp[0]);		
			$this->receiverid = $receiverid = trim($receiverid);//
			if(trim($receiverid)){
				
//				$this->getReciverinfo($receiverid); //수신자의 수신상태 여부 책크 및 수신자 이름을 구해옮 $this->rejectflag 리턴 true, false  
//				if($this->rejectflag){
					//받은내용 저장					
					$this->makeMessageDir($receiverid);
					//echo "MessageFolder=".$this->MessageFolder."<br>";
					$this->getMessageList();
					$this->addMessageList('r');
					//echo $receiverid;
					//echo "MessageFolder=".$this->MessageFolder."<br>";
					if(!file_exists($this->MessageFolder."/receivelist")){
						mkdir($this->MessageFolder."/receivelist");
					}		
					$fp = fopen($this->MessageFolder."/receivelist/".$this->savetime.".php", "w");
					fwrite($fp,$this->memo);
					fclose($fp);
					
					if($this->SendBoxSave == "1"){
						//보낸내용 저장
						$this->makeMessageDir($this->senderid);
						$this->getMessageList();
						$this->addMessageList('s');
						//echo $this->MessageFolder;
						
						if(!file_exists($this->MessageFolder."/sendlist")){
							mkdir($this->MessageFolder."/sendlist");
						}
	
						$fp = fopen($this->MessageFolder."/sendlist/".$this->savetime.".php", "w");
						fwrite($fp,$this->memo);
						fclose($fp);
					}
//				}
			}
		}
	}
	//어드민에서 메시지 보내기
	function AdminSendMsg($mgrade, $ToUser="", $content){
		//개별 보내기일때
		if($mgrade =="11"){//개별메일보내기
			$this->receiver = $ToUser;
			$this->senderid = "xman7";
			$this->sendername = "엑스맨";
			$this->memo = $content;
			$this->SendBoxSave = "1"; //보낸내용저장
			$this->saveMessage();
		}else{//단체보내기
		
			if($mgrade =="0"){
				$sqlstr = "select userid, namekr from MemberInfo order by regdate desc";
			}else if($mgrade =="15"){//보내기 테스트용
				$sqlstr = "select userid, namekr from MemberInfo where userid='winkzone' or userid='winkzonep' order by regdate desc";
			}else{
				$sqlstr = "select userid, namekr from MemberInfo where mgrade='$mgrade' order by regdate desc";
			}
			$qrystr = mysql_query($sqlstr, $this->dbcon);
			$cnt=1;
			echo $sqlstr;
			##공통부분 시작
			$this->senderid = "xman7";
			$this->sendername = "엑스맨";
			$this->memo = $content;
			$this->SendBoxSave = "0"; //보낸내용저장			
			while($mylist = mysql_fetch_array($qrystr)):
				$this->receiverid = $receiverid = $mylist["userid"];
				$this->receivername = $mylist["namekr"];					
				//받은내용 저장
				$this->makeMessageDir($receiverid);
				$this->getMessageList();
				$this->addMessageList('r');
				if(!file_exists($this->MessageFolder."/receivelist")){
					mkdir($this->MessageFolder."/receivelist");
				}		
				$fp = fopen($this->MessageFolder."/receivelist/".$this->savetime.".php", "w");
				fwrite($fp,$this->memo);
				fclose($fp);
			if($cnt % 1000 =="0"){	
				sleep(1);
			}
			$cnt++;
			endwhile;
		}
		## 보낸 내용 저장 (1회만 저장);
		switch($mgrade){
			case "0":
				$mgradestr = "전체";
			break;
			case "9":
				$mgradestr = "학생";
			break;
			case "7":
				$mgradestr = "학부모";
			break;
			case "5":
				$mgradestr = "교사";
			break;
			case "15":
				$mgradestr = "보내기 테스트용";
			break;					
			default:
				$mgradestr = "NONE";
			break;								
		}
		$this->receiverid = $this->receivername = $mgradestr;
		$this->makeMessageDir($this->senderid);
		$this->getMessageList();
		$this->addMessageList('s');			
		if(!file_exists($this->MessageFolder."/sendlist")){
			mkdir($this->MessageFolder."/sendlist");
		}

		$fp = fopen($this->MessageFolder."/sendlist/".$this->savetime.".php", "w");
		fwrite($fp,$this->memo);
		fclose($fp);
		
	}
	//수신자의 수신상태 및 이름을 구해온다.
	function getReciverinfo($receiverid){
		$this->db_connect();
		unset($this->rejectflag);
		unset($this->receivername);
		//수신 거부 상태 인지 확인한다.
		$sqlstr = "select count(1) From MessageRejectList where userid='".$this->senderid."' and rejectid='$receiverid'";
		$sqlqry = mysql_query($sqlstr) or dberror($sqlstr); 
		$list = mysql_fetch_array($sqlqry);
		if($list[0]){
			$this->rejectflag = false;
		}else{
			$sqlstr = "select namekr from MemberInfo where userid='$receiverid'";
			$sqlqry = mysql_query($sqlstr) or dberror($sqlstr); 
			$list = mysql_fetch_array($sqlqry);
			$this->receivername = $list["namekr"];
			$this->rejectflag = true;		
			
		}
	}
	
	
## 메시지 삭제
	function delMsg($userid, $wdate, $type){
		##	messagelist 중 리스트 삭제		
		$this->getMessageList($userid);//return $this->contentlist
		
		//print_r($this->contentlist);
		foreach($this->contentlist as $key => $value){
			if($value[9] <> $wdate){
				//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
				$str .= serialize($value)."\n";
			}
		}
		//echo "adfa=".$str;
		//exit;
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");	
		fwrite($fp,$str);
		fclose($fp);
		## 메시지 내용 삭제
		$type = substr($type, 0, 1);
		if($type == "s"){
			@unlink($this->MessageFolder."/sendlist/".$wdate.".php");
		}else if($type == "r"){
			@unlink($this->MessageFolder."/receivelist/".$wdate.".php");
		}
		//echo $userid.", ".$wdate.", ".$type;
		//exit;
	}
		
## 영구보관함으로 메시지 이동
	function saveMsg($userid, $wdate){
		##	messagelist 중 리스트 삭제		
		$this->getMessageList($userid);//return $this->contentlist
		foreach($this->contentlist as $key => $value){
			if($value[9] == "$wdate"){
				$value[0] = substr($value[0], 0, 1)."f";
			}
			//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
			$str .= serialize($value)."\n";
		}
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");	
		fwrite($fp,$str);
		fclose($fp);
	}
	
## 메시지 읽은 상태로 변경
	function readcheckMsg($userid, $wdate){
		$this->getMessageList($userid);//return $this->contentlist
## 현재에 포함된 값을 가져온다.
		foreach($this->contentlist as $key => $value){
			if($value[9] == "$wdate"){
				$returnvalue = $value;
				if($value[7] == "1") $this->refleshflag = "0";//변경이 없을 경우 opener reload disable 하게 설정
				$value[7] = 1;
				
			}
			//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
			$str .= serialize($value)."\n";
		}
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");	
		fwrite($fp,$str);
		fclose($fp);
		//echo $str."<br>".
		
##상대의 아이디를 구하여 상기와 동일한 방법으로 업데이트 시킨다.		
		//echo $returnvalue;
		$remoteid = $returnvalue[2];
		$remoteunique = $returnvalue[9];
		$this->getMessageList($remoteid);
		//echo "remoteid = $remoteid <br>";
		$str = "";
		foreach($this->contentlist as $key => $value){
			if($value[9] == "$remoteunique"){
				$returnvalue = $value;
				$value[7] = 1;
			}
			//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
			$str .= serialize($value)."\n";
		}
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");	
		fwrite($fp,$str);
		fclose($fp);	
		//echo $str."<br>".
##이전상태로 자료를 돌려둔다.		
	$this->getMessageList($userid);//return $this->contentlist	
	}
	
			
	function filemake($file){
		//echo "file:$file <br>";
		if(!is_file($file)){
			touch($file);
		}
	}
	
	//수신 거부 설정하기
	function MsgReject($ck_userid, $rejectid){ //
		//수신 거부상태 인지 확인한다.
		$sqlstr  = "select count(1) from MessageRejectList where userid='$ck_userid' and rejectid='$rejectid'";
		$qrystr  = mysql_query($sqlstr, $this->dbcon) or die(mysql_error());
		$total  = @mysql_result($qrystr, 0,0);

		if($total > 0){
			echo "<script>
				//alert('$rejectid 님은 이미 수신 거부 상태 입니다.');
				location.href='./Message.php?pg=ReceiveBoxList';
			   </script>";
			exit;
		}else{
			$regday = mktime();
			$insert = "insert into MessageRejectList(userid, rejectid, regday)";//mstatus, 삭제
			$insert .=" values('$ck_userid', '$rejectid', '$regday')";		
			mysql_query($insert , $this->dbcon) or die(mysql_error());
			echo "<script>location.href='./Message.php?pg=MessageSet';</script>";
			exit;
		}
	}
	
	//수신차단 해제
	function MsgRejectOff($userid, $seq){
		$delete ="delete from MessageRejectList where userid='$userid' and seq='$seq'";
		//echo $delete;
		//exit;
		mysql_query($delete);
		echo "<script>location.href='./Message.php?pg=MessageSet';</script>";
		exit;		
	}	
	
	
	
	
	###################################################################################################
	
	function transdbtofile($pkey, $m_status, $m_flag, $card_no, $from_userid, $from_name, $from_time, $title, $contents, $to_userid, $to_name, $to_time, $save, $save1, $del_flag){//기존 db를 파일로 전환하는 함수
		$this->savetime = $pkey;
		$this->memo = stripslashes($contents);
		$this->senderid = $from_userid;
		$this->sendername = $from_name;
		$this->receiverid = $to_userid = trim($to_userid);//
		$this->receivername = $to_name;
		$this->messageflag = $m_flag;
		$this->card_no = $card_no;
		$this->inputtime = $from_time;
		$this->receivetime = $to_time;
		$this->save = $save;
		$this->save1 = $save1;
		
		if($del_flag <> "1"){
				//받은내용 저장
			$this->makeMessageDir($to_userid);
			$this->getMessageList();
			$this->addfullmessage('r');
			if(!file_exists($this->MessageFolder."/receivelist")){
				mkdir($this->MessageFolder."/receivelist");
			}		
			$fp = fopen($this->MessageFolder."/receivelist/".$this->savetime.".php", "w");
			fwrite($fp,$this->memo);
			fclose($fp);
		}
		if($del_flag <> "2"){
			//보낸내용 저장
			$this->makeMessageDir($this->senderid);
			$this->getMessageList();
			$this->addfullmessage('s');
			//echo $this->MessageFolder;
			
			if(!file_exists($this->MessageFolder."/sendlist")){
				mkdir($this->MessageFolder."/sendlist");
			}

			$fp = fopen($this->MessageFolder."/sendlist/".$this->savetime.".php", "w");
			fwrite($fp,$this->memo);
			fclose($fp);
		}
	}
	
		function addfullmessage($type){
		##send : 0: 메시지타입 1:메시지종류, 2:받는아이디, 3:받는이름, 4:내용, 5:카드no, 6:보낸날짜,  7:수신여부, 8:저장flag, 9:microtime
		##receive : 0:메시지종류, 1:메시지종류, 2:보낸아이디, 3:보낸이름, 4:내용, 5:카드no, 6:수신날짜, 7:수신여부, 8:저장flag, 9:microtime
		# 메시지타입 : r : 수신, s : 발신
		# 메시지종류 : 0 : 일반, 1 :카드
		$userid = $type == "r" ? $this->senderid : $this->receiverid;
		$username = $type == "r" ? $this->sendername : $this->receivername;
		$saveflag = $type == "r" ? $this->save : $this->save1;
		if($type == "r" && $this->save <> "0"){
			$type1 = "rf";
		}else if($type == "r"){
			$type1 = "r";
		}else if($type == "s" && $this->save1 <> "0"){
			$type1 = "sf";
		}else if($type == "s"){
			$type1 = "s";
		}
		
		$saveflag = $type == "r" ? $this->save1 : $this->save;
		$addlist = array(
		0=>$type1,
		1=>$this->messageflag,
		2=>$userid,
		3=>$username,
		4=>"",
		5=>$this->card_no,
		6=>$this->inputtime,
		7=>0,
		8=>"",
		9=>$this->savetime
		);
		//if($type == "s"){
		//print_r($addlist);
		//exit;
		//}
		//echo "contentlist = ".$this->contentlist;
		array_unshift ($this->contentlist, $addlist);
		
		reset($this->contentlist);

		$str = "";
		$fp = fopen($this->MessageFolder."/messagelist.php", "w");		
		foreach($this->contentlist as $key => $value){
			//$str .= $value[0].":sp:".$value[1].":sp:".$value[2].":sp:".$value[3].":sp:".$value[4].":sp:".$value[5].":sp:".$value[6].":sp:".$value[7].":sp:".$value[8].":sp:".$value[9]."\n";
			$str .= serialize($value)."\n";
		}
		fwrite($fp,$str);
		fclose($fp);
		//echo $this->MessageFolder."/messagelist.php" ."<br>";
	}	
	
	###################################################################################################
	####### 그룹관리시작
	###################################################################################################
	//그룹 추가 부분
	function GroupAdd($ChkMember, $type, $groupname="", $ck_userid="", $groupid=""){
		if($type=="1"){
			$MemberCounter = substr_count($ChkMember, ",");
			$MemberNum = $MemberCounter - 1;
			list($MemberFirst) = explode(",",$ChkMember);
			$sqlstr = "select namekr from MemberInfo where userid ='$MemberFirst'";
			$qrystr = mysql_query($sqlstr, $this->dbcon) or die(mysql_error());
			$mylist = mysql_fetch_array($qrystr);
			//echo $sqlstr;
			echo $MemberFirst."(".$mylist[namekr].")외 ".$MemberNum." 명";
			//echo $this->MemberInsertInfo;
		}elseif($type=="2"){
			$MemberCounter = substr_count($ChkMember, ",");
			$regday = mktime();
			
			$MemberFirst = explode(",",$ChkMember);
			//echo $MemberCounter;
			for($i=0; $i< $MemberCounter; $i++){
				$sqlstr = "select count(*) from MessageGroupDetail where muserid ='$MemberFirst[$i]'";
				$qrystr = mysql_query($sqlstr, $this->dbcon) or die(mysql_error());
				$total = @mysql_result($qrystr,0,0);
				//echo $sqlstr."<br>";
				if($total < 1){
					$insert = "insert into MessageGroupDetail(groupid, userid, muserid, regday) values('$groupid','$ck_userid','$MemberFirst[$i]','$regday')";
					mysql_query($insert);
					//echo $insert."<br>";
				}
			}
			
			echo "
					<script>	
							if(confirm('[$groupname] 그룹에 등록되었습니다.\\n지금 확인 하시겠습니까?')){
								opener.location.href='./MessageGroup.php';
								window.close();
							}else{
								window.close();
							}
					</script>";
						
		}
	}
	
	//그룹으로 친구를 이동
	function GroupFriendAdd($ChkMember, $groupname="", $ck_userid="", $groupid=""){

			$MemberCounter = substr_count($ChkMember, ",");
			$regday = mktime();
			$MemberFirst = explode(",",$ChkMember);
			//echo $MemberCounter;
			for($i=0; $i< $MemberCounter; $i++){
					$update = "update  MessageGroupDetail set groupid='$groupid' where muserid='$MemberFirst[$i]' and userid='$ck_userid'";
					//echo $update."<br>";
					mysql_query($update);
				}
		
			echo "
					<script>	
							if(confirm('[$groupname] 그룹에 명을 이동했습니다..\\n지금 확인 하시겠습니까?')){
								opener.location.href='./MessageGroup.php';
								window.close();
							}else{
								opener.window.close();
								window.close();
							}
					</script>";
						
	}
	
	// 친구 리스트에서 삭제하기
	function FriendDel($ChkMember, $ck_userid=""){

			$MemberCounter = substr_count($ChkMember, ",");
			$regday = mktime();
			$MemberFirst = explode(",",$ChkMember);
			//echo $MemberCounter;
			for($i=0; $i< $MemberCounter; $i++){
					$delete = "delete  from MessageGroupDetail where muserid='$MemberFirst[$i]' and userid='$ck_userid'";
					//echo $update."<br>";
					mysql_query($delete);
				}
		
			echo "
					<script>	
							if(confirm('친구를 리스에서 삭제하였습니다.\\n지금 확인 하시겠습니까?')){
								opener.location.href='./MessageGroup.php';
								window.close();
							}else{
								opener.location.href='./MessageGroup.php';
								opener.window.close();
								window.close();
							}
					</script>";
						
	}	
		//그룹 셀렉트 부분
	function GroupSelect($ck_userid, $ntype=""){
		$sqlstr = "select *from MessageGroup where userid='$ck_userid' order by regday asc";
		$qrystr = mysql_query($sqlstr, $this->dbcon);
		$total = mysql_num_rows($qrystr);
		//echo $sqlstr;
		if($total < 1){ //그룹이 없다면 새그룹이란 mgroup 0 번을 생성한다.
			$regday = mktime();
			$insertg = "insert into MessageGroup(groupid, groupname, userid, regday) values('0', '새그룹', '$ck_userid', '$regday')";
			mysql_query($insertg);
			echo "<script>location.reload();</script>	";
		}
		if(!$ntype){
			echo "<select name='GroupSelect'>";
			while($mylist = mysql_fetch_array($qrystr)):
				echo "<option value='$mylist[groupname]'>$mylist[groupname]</option>";				
			endwhile;
			echo "</select>";
		}
	} 
	
	
	//그룹 관리 갯수
	function GroupSubTotal($ck_userid, $groupid){
		$sqlstr = "select count(*) from MessageGroupDetail where userid='$ck_userid' and groupid='$groupid'";
		$qrystr = mysql_query($sqlstr, $this->dbcon);
		$total = @mysql_result($qrystr, 0,0);
		echo $total;
	}
	
	//그룹 추가하기
	function NewGrouAdd($GroupName, $ck_userid){
		//Max 넘버를 가지고 온다. 
		$sqlstr = "select max(groupid) as maxgroupid from MessageGroup where userid='$ck_userid'";
		$qrystr = mysql_query($sqlstr, $this->dbcon);
		$mylist = mysql_fetch_array($qrystr);
		
		//중복인지 확인한다.
		$sql = "select count(*) from MessageGroup where userid='$ck_userid' and groupname='$GroupName'";
		$qry = mysql_query($sql, $this->dbcon);
		$total = @mysql_result($qry, 0,0);
		
		$maxid =  $mylist[maxgroupid]+1;
		if($maxid > 4){
			echo "<script>alert('그룹은 최대 5개까지 생성할 수 있습니다.');location.href='./MessageGroup.php';</script>";
			exit;
		}elseif($total > 0){
			echo "<script>alert('$GroupName 그룹은 이미 생성되어있습니다.\\n확인해주세요.');location.href='./MessageGroup.php';</script>";
			exit;
		}else{
			$regday = mktime();	
			$insertg = "insert into MessageGroup(groupid, groupname, userid, regday) values('$maxid', '$GroupName', '$ck_userid', '$regday')";
			mysql_query($insertg);
			echo "<script>location.href='./MessageGroup.php';</script>	";
		}
		
		
	}
	//그룹 삭제 및 그룹 리스트 삭제
	function DelGroupList($GroupId, $ck_userid){
		$delete = "delete from MessageGroup where groupid='$GroupId' and userid='$ck_userid'";
		$delete1 = "delete from MessageGroupDetail where groupid='$GroupId' and userid='$ck_userid'";
			
		mysql_query($delete, $this->dbcon);
		mysql_query($delete1, $this->dbcon);	
		//그룹id를 업그레이드 한다. 
		$update = "update MessageGroup set groupid = groupid-1 where groupid > $GroupId and userid='$ck_userid'";
		mysql_query($update, $this->dbcon);
		
		echo "<script>location.href='./MessageGroup.php';</script>	";
	}
	
}
?>